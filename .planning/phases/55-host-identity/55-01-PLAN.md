---
phase: 55-host-identity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/run.clj
autonomous: true

must_haves:
  truths:
    - "get-uid returns '1000' on Windows without calling 'id -u'"
    - "get-gid returns '1000' on Windows without calling 'id -g'"
    - "get-uid still calls 'id -u' on Unix (no regression)"
    - "get-gid still calls 'id -g' on Unix (no regression)"
    - "read-git-identity works cross-platform (unchanged)"
    - "Containers start with correct LOCAL_UID/LOCAL_GID on all platforms"
  artifacts:
    - path: "src/aishell/docker/run.clj"
      provides: "Platform-aware UID/GID extraction with Windows defaults"
      contains: "\"1000\""
  key_links:
    - from: "src/aishell/docker/run.clj get-uid/get-gid"
      to: "build-docker-args-internal LOCAL_UID/LOCAL_GID env vars"
      via: "let binding in build-docker-args-internal"
      pattern: "LOCAL_UID.*get-uid"
---

<objective>
Replace Phase 53 platform guard exceptions in `get-uid` and `get-gid` with Windows-compatible default values ("1000"), completing the UID/GID detection requirement for Windows support.

Purpose: Windows has no `id -u`/`id -g` commands and no UID/GID concept. Linux containers standardize on UID/GID 1000 for the first non-root user (Debian/Ubuntu default). Phase 53 added guards that throw exceptions pointing to this phase; now we implement the actual defaults.

Output: Modified `src/aishell/docker/run.clj` with working UID/GID extraction on all platforms.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/aishell/docker/run.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace UID/GID platform guards with Windows defaults</name>
  <files>src/aishell/docker/run.clj</files>
  <action>
In `src/aishell/docker/run.clj`, modify the `get-uid` and `get-gid` functions to return "1000" on Windows instead of throwing exceptions.

**get-uid (lines 28-32)** — Replace:
```clojure
(defn- get-uid []
  (if (fs/windows?)
    (throw (ex-info "UID detection not supported on Windows. See: Phase 55 (Host Identity)"
                    {:platform :windows}))
    (-> (p/shell {:out :string} "id" "-u") :out str/trim)))
```
With:
```clojure
(defn- get-uid []
  (if (fs/windows?)
    "1000"
    (-> (p/shell {:out :string} "id" "-u") :out str/trim)))
```

**get-gid (lines 34-38)** — Replace:
```clojure
(defn- get-gid []
  (if (fs/windows?)
    (throw (ex-info "GID detection not supported on Windows. See: Phase 55 (Host Identity)"
                    {:platform :windows}))
    (-> (p/shell {:out :string} "id" "-g") :out str/trim)))
```
With:
```clojure
(defn- get-gid []
  (if (fs/windows?)
    "1000"
    (-> (p/shell {:out :string} "id" "-g") :out str/trim)))
```

Do NOT modify `read-git-identity` — it already works cross-platform (Git for Windows provides identical CLI to Unix Git, and try/catch handles missing Git gracefully).
  </action>
  <verify>
1. File loads in Babashka: `bb -e "(require '[aishell.docker.run])"`
2. CLI still works: `bb aishell.clj --help`
3. Grep confirms no remaining Phase 55 exception references: `grep -n "Phase 55" src/aishell/docker/run.clj` returns nothing
4. Grep confirms "1000" default present: `grep -n "1000" src/aishell/docker/run.clj` shows both get-uid and get-gid
5. read-git-identity unchanged: `grep -A5 "defn read-git-identity" src/aishell/docker/run.clj` shows original implementation
  </verify>
  <done>
- get-uid returns "1000" on Windows (no throw), calls "id -u" on Unix (unchanged)
- get-gid returns "1000" on Windows (no throw), calls "id -g" on Unix (unchanged)
- read-git-identity untouched (already cross-platform)
- No remaining Phase 55 placeholder exceptions in codebase
- CLI functional on Unix (no regression)
  </done>
</task>

</tasks>

<verification>
1. `bb -e "(require '[aishell.docker.run])"` — File loads without SCI errors
2. `bb aishell.clj --help` — CLI functional (no regression)
3. `grep -rn "Phase 55" src/` — No remaining placeholder exceptions referencing Phase 55
4. `grep -n "1000" src/aishell/docker/run.clj` — Both get-uid and get-gid return "1000" on Windows
5. `grep -c "fs/windows?" src/aishell/docker/run.clj` — Platform checks still present (guard pattern preserved)
</verification>

<success_criteria>
- get-uid and get-gid return "1000" on Windows without exceptions
- Unix behavior unchanged (id -u / id -g still called)
- read-git-identity unchanged (already cross-platform)
- All Babashka file loads pass
- CLI help works without errors
</success_criteria>

<output>
After completion, create `.planning/phases/55-host-identity/55-01-SUMMARY.md`
</output>
