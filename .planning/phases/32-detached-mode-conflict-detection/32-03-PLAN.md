---
phase: 32-detached-mode-conflict-detection
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/aishell/docker/templates.clj]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "tmux starts successfully inside containers regardless of host terminal"
    - "Containers launched from Ghostty terminal run without TERM errors"
    - "All container modes (shell, harness, detached) auto-start tmux successfully"
  artifacts:
    - path: "src/aishell/docker/templates.clj"
      provides: "TERM validation before tmux exec"
      contains: "infocmp.*TERM"
      min_lines: 235
  key_links:
    - from: "src/aishell/docker/templates.clj"
      to: "tmux new-session"
      via: "TERM validation fallback"
      pattern: "infocmp.*xterm-256color"
---

<objective>
Add TERM validation to container entrypoint to prevent tmux failures with unsupported terminal types.

Purpose: Fix blocker issues where containers fail to start when launched from terminals with custom TERM values (e.g., xterm-ghostty from Ghostty terminal) that lack terminfo entries in the Debian base image.

Output: Updated entrypoint script that validates TERM before executing tmux, falling back to xterm-256color if terminfo entry is missing.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/jonasrodrigues/projects/harness/.planning/PROJECT.md
@/home/jonasrodrigues/projects/harness/.planning/ROADMAP.md
@/home/jonasrodrigues/projects/harness/.planning/STATE.md
@/home/jonasrodrigues/projects/harness/.planning/phases/32-detached-mode-conflict-detection/32-UAT.md
@/home/jonasrodrigues/projects/harness/.planning/debug/tmux-ghostty-terminal.md
@/home/jonasrodrigues/projects/harness/.planning/phases/32-detached-mode-conflict-detection/32-01-SUMMARY.md
@/home/jonasrodrigues/projects/harness/.planning/phases/32-detached-mode-conflict-detection/32-02-SUMMARY.md

## Gap Context

**Root Cause:** Container inherits TERM from host (xterm-ghostty) but Debian bookworm-slim lacks the terminfo entry. tmux validates TERM against /usr/share/terminfo and fails.

**Affected Tests:** UAT test 2 (tmux auto-start) and test 3 (detached mode) both blocked by same issue.

**Existing Behavior:**
- `src/aishell/docker/run.clj` line 202: Passes host TERM to container via `-e TERM=...`
- `src/aishell/docker/templates.clj` line 234: Executes tmux without validating TERM
- Fallback in run.clj only applies if TERM unset, not if TERM is unsupported

**Fix Location:** Entrypoint script (templates.clj) before tmux exec line
</context>

<tasks>

<task type="auto">
  <name>Add TERM validation before tmux execution</name>
  <files>src/aishell/docker/templates.clj</files>
  <action>
In the `entrypoint-script` string definition, add TERM validation logic immediately before the final `exec gosu...tmux` line (currently line 234).

Add these lines before the exec statement:

```bash
# Validate TERM has terminfo entry; fallback to xterm-256color if missing
# Prevents tmux failure with custom terminals (e.g., xterm-ghostty from Ghostty)
if command -v infocmp >/dev/null 2>&1 && ! infocmp "$TERM" >/dev/null 2>&1; then
    export TERM=xterm-256color
fi
```

**Why this approach:**
- `infocmp "$TERM"` checks if terminfo entry exists for current TERM value
- Exit code 0 = terminfo found, 1 = not found
- `command -v infocmp` ensures infocmp exists before using it (defensive)
- xterm-256color is universally available in Debian base images
- Runs after gosu setup, before tmux exec (right place in lifecycle)

**What NOT to do:**
- Do NOT modify src/aishell/docker/run.clj (keep host TERM passthrough behavior)
- Do NOT install additional terminfo packages (bloats image)
- Do NOT hardcode TERM=xterm-256color for all cases (breaks intentional TERM choices)

Implementation:
1. Locate line 234: `exec gosu "$USER_ID:$GROUP_ID" tmux new-session...`
2. Insert validation block immediately above (lines 229-233)
3. Preserve all existing exec line content (flags, variables, quoting)
4. Maintain proper bash string escaping in Clojure multiline string
  </action>
  <verify>
```bash
# Verify TERM validation exists in entrypoint
grep -A2 "infocmp" src/aishell/docker/templates.clj

# Verify it's positioned before tmux exec
grep -B5 "exec gosu.*tmux" src/aishell/docker/templates.clj | grep -q "infocmp"

# Rebuild image to include updated entrypoint
bb build

# Test with custom TERM (simulate Ghostty)
TERM=xterm-ghostty bb run claude -- tmux ls

# Should see 'main' session without errors
```
  </verify>
  <done>
- Entrypoint script contains TERM validation using infocmp
- Validation positioned immediately before tmux exec line
- Image rebuilds successfully
- Container starts with TERM=xterm-ghostty without tmux errors
- `tmux ls` shows 'main' session when run from container
  </done>
</task>

<task type="auto">
  <name>Verify gap closure via UAT re-test</name>
  <files>.planning/phases/32-detached-mode-conflict-detection/32-UAT.md</files>
  <action>
Re-run the previously blocked UAT tests to confirm gaps are closed.

**Test 2 - Tmux Session Auto-Start:**
```bash
# Launch container in foreground
aishell claude

# Inside container, verify tmux session
tmux ls
# Expected: shows session 'main' with window 0

# Detach from tmux to verify session persists
# Ctrl+B D

# Re-attach to verify session
tmux attach -t main
```

**Test 3 - Detached Mode Launch:**
```bash
# Launch detached from host shell
aishell claude --detach

# Verify container stays running
docker ps | grep aishell-
# Expected: shows running container (not exited)

# Attach to container
docker exec -it <container-name> bash

# Inside container, verify tmux session exists
tmux ls
# Expected: shows session 'main'
```

**Test 4 - Short Detach Flag:**
```bash
# Clean up any existing containers
docker stop $(docker ps -q --filter "name=aishell-") 2>/dev/null || true

# Launch with short flag
aishell claude -d

# Verify container running
docker ps | grep aishell-
```

Update 32-UAT.md with results:
- Change test 2 status to 'pass' if tmux session exists
- Change test 3 status to 'pass' if container stays running with tmux
- Change test 4 from 'skipped' to 'pass' if -d flag works
- Update summary counts (passed, issues, skipped)
- Change overall status from 'diagnosed' to 'complete' if all tests pass
  </action>
  <verify>
```bash
# All three tests should pass
grep "result: pass" .planning/phases/32-detached-mode-conflict-detection/32-UAT.md | wc -l
# Expected: at least 5 (original 2 + newly fixed 3)

# No blocker issues remain
grep "severity: blocker" .planning/phases/32-detached-mode-conflict-detection/32-UAT.md
# Expected: no matches (or matches in completed/resolved sections)

# Status changed to complete
grep "status: complete" .planning/phases/32-detached-mode-conflict-detection/32-UAT.md
```
  </verify>
  <done>
- Test 2 (tmux auto-start) passes without terminal errors
- Test 3 (detached mode) passes with container staying running
- Test 4 (short flag) passes identically to --detach
- UAT.md updated with pass results
- No blocker-severity issues remain
- UAT status changed from 'diagnosed' to 'complete'
  </done>
</task>

</tasks>

<verification>
Overall phase verification after gap closure:

```bash
# All UAT tests passing
cat .planning/phases/32-detached-mode-conflict-detection/32-UAT.md | grep -E "^result:" | grep -v "pass" | wc -l
# Expected: 0 (all results are 'pass')

# No gaps remain
grep "status: failed" .planning/phases/32-detached-mode-conflict-detection/32-UAT.md
# Expected: no matches

# Container works with various TERM values
for term in xterm-ghostty xterm-kitty xterm-256color screen-256color; do
    echo "Testing TERM=$term"
    TERM=$term bb run claude -- tmux ls || echo "FAIL: $term"
done
# Expected: All succeed or fallback to xterm-256color gracefully
```
</verification>

<success_criteria>
Phase 32 gaps fully closed when:
- Container entrypoint validates TERM before tmux execution
- Unsupported TERM values fallback to xterm-256color automatically
- Containers launched from Ghostty terminal start successfully
- Detached containers stay running (no immediate exit from tmux failure)
- UAT test 2 (tmux auto-start) passes
- UAT test 3 (detached mode) passes
- UAT test 4 (short flag) passes
- UAT overall status changed to 'complete'
- No blocker-severity gaps remain
</success_criteria>

<output>
After completion, create `.planning/phases/32-detached-mode-conflict-detection/32-03-SUMMARY.md`
</output>
