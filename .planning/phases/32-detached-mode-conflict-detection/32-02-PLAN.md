---
phase: 32-detached-mode-conflict-detection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/cli.clj
  - src/aishell/run.clj
  - src/aishell/docker/run.clj
autonomous: true

must_haves:
  truths:
    - "All containers (foreground and detached) get named containers via --name flag"
    - "Conflict detection runs before every docker run (error if running, auto-remove if stopped)"
    - "--detach flag runs container in background and prints attach instructions"
    - "Foreground mode behavior is unchanged (backwards compatible)"
    - "Shell mode gets named containers (name='shell')"
  artifacts:
    - path: "src/aishell/cli.clj"
      provides: "--detach flag extraction before pass-through"
      contains: "--detach"
    - path: "src/aishell/run.clj"
      provides: "Named container and conflict detection integration"
      contains: "ensure-name-available!"
    - path: "src/aishell/docker/run.clj"
      provides: "Docker args with --name and --detach flags"
      contains: "--detach"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/run.clj"
      via: ":detach key in opts map"
      pattern: ":detach"
    - from: "src/aishell/run.clj"
      to: "src/aishell/docker/naming.clj"
      via: "ensure-name-available! call before docker run"
      pattern: "naming/ensure-name-available!"
    - from: "src/aishell/run.clj"
      to: "src/aishell/docker/run.clj"
      via: ":detach and :container-name keys passed to build-docker-args"
      pattern: ":detach"
---

<objective>
Add --detach flag support, integrate named containers and conflict detection into the run flow, and add --name/--detach to docker args construction.

Purpose: This is the core wiring that enables detached mode, named containers for all modes, and pre-flight conflict detection.
Output: Modified cli.clj, run.clj, and docker/run.clj with full detach + naming + conflict support.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-detached-mode-conflict-detection/32-CONTEXT.md
@.planning/phases/32-detached-mode-conflict-detection/32-RESEARCH.md
@src/aishell/cli.clj
@src/aishell/run.clj
@src/aishell/docker/run.clj
@src/aishell/docker/naming.clj
@src/aishell/output.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --detach flag extraction to CLI dispatch</name>
  <files>src/aishell/cli.clj</files>
  <action>
In `dispatch` function (cli.clj L274-310), add --detach/-d flag extraction alongside the existing --unsafe and --name extraction.

After the --unsafe extraction (L276-277) and before the --name extraction (L280-288), add:

```clojure
;; Extract --detach/-d flag before pass-through
detach? (boolean (some #{"-d" "--detach"} clean-args))
clean-args (vec (remove #{"-d" "--detach"} clean-args))
```

Then pass `:detach detach?` in every `run/run-container` call. Update all harness dispatch cases (claude, opencode, codex, gemini, gitleaks) AND the default shell cases to include `:detach detach?` in the opts map.

Specifically update these lines:
- L294-295 (claude): add `:detach detach?`
- L296-297 (opencode): add `:detach detach?`
- L298-299 (codex): add `:detach detach?`
- L300-301 (gemini): add `:detach detach?`
- L302-303 (gitleaks): add `:detach detach?`
- L307 (--unsafe shell): add `:detach detach?`

Also update the shell mode in `handle-default` (L250) to pass detach: `(run/run-container nil [] {:detach false})` -- actually this path doesn't have access to detach?, so leave handle-default as-is since it goes through standard dispatch (no --detach support needed for bare `aishell` without pre-dispatch).

Note: `-d` short form must NOT conflict with any harness flags. Claude uses `--dangerously-skip-permissions` (long form only). OpenCode, Codex, Gemini don't use `-d`. Safe to use.
  </action>
  <verify>
1. Grep cli.clj for `--detach` -- should appear in flag extraction and be removed from args
2. Grep cli.clj for `:detach` -- should appear in all run-container calls
3. Verify `-d` short form is also extracted
  </verify>
  <done>
--detach/-d flag is extracted in dispatch function and passed as :detach to all run-container calls.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire named containers, conflict detection, and detach into run flow</name>
  <files>src/aishell/run.clj, src/aishell/docker/run.clj</files>
  <action>
**In run.clj `run-container` function:**

1. Add conflict detection BEFORE docker run. After the container-name-str binding (L81-82), add a call to `naming/ensure-name-available!`:

```clojure
;; Pre-flight conflict check: error if running, auto-remove if stopped
_ (naming/ensure-name-available! container-name-str (or (:container-name opts) cmd "shell"))
```

2. Pass `:detach` and `:container-name-str` to `build-docker-args`. Update the docker-args binding (L155-160) to include these:

```clojure
docker-args (docker-run/build-docker-args
              {:project-dir project-dir
               :image-tag image-tag
               :config cfg
               :git-identity git-id
               :skip-pre-start (:skip-pre-start opts)
               :detach (:detach opts)
               :container-name container-name-str})
```

3. Handle detached mode execution differently. After building docker-args, the current code uses `p/exec` for non-gitleaks commands (L197). For detached mode, we need `p/shell` instead of `p/exec` so we can print feedback after the container starts:

Replace the final execution block (L185-197) with logic that checks for detach mode:

```clojure
(if (= cmd "gitleaks")
  ;; ... existing gitleaks handling unchanged ...
  (if (:detach opts)
    ;; Detached mode: use p/shell so we can print feedback
    (let [result (apply p/shell {:out :string :err :string :continue true}
                        (concat docker-args container-cmd))]
      (if (zero? (:exit result))
        (let [container-id (clojure.string/trim (:out result))
              name-part (or (:container-name opts) cmd "shell")]
          (println (str "Container started: " container-name-str))
          (println)
          (println (str "  Attach:  aishell attach --name " name-part))
          (println (str "  Shell:   docker exec -it " container-name-str " /bin/bash"))
          (println (str "  Stop:    docker stop " container-name-str))
          (println (str "  List:    aishell ps")))
        (do
          (binding [*out* *err*]
            (print (:err result)))
          (System/exit (:exit result)))))
    ;; Foreground mode: exec (replaces process) - existing behavior
    (apply p/exec (concat docker-args container-cmd))))
```

**In docker/run.clj `build-docker-args-internal` function:**

4. Accept `:detach` and `:container-name` in the destructured map (L186).

5. Add `--name` flag after the `--init` flag in the docker args vector. Add it to the initial vector construction:

```clojure
(-> ["docker" "run" "--rm" "--init"]
    (into tty-flags)
    (cond-> container-name (into ["--name" container-name]))
    (cond-> detach (conj "--detach"))
    ...)
```

6. Update `build-docker-args` public function (L252-273) to accept and pass through `:detach` and `:container-name`:

```clojure
(defn build-docker-args
  [{:keys [project-dir image-tag config git-identity skip-pre-start detach container-name]}]
  (build-docker-args-internal
    {:project-dir project-dir
     :image-tag image-tag
     :config config
     :git-identity git-identity
     :skip-pre-start skip-pre-start
     :detach detach
     :container-name container-name
     :tty-flags ["-it"]}))
```

Key implementation notes:
- `--name` flag goes BEFORE the image tag in docker args (required by Docker)
- `--detach` flag goes BEFORE the image tag in docker args
- The `-it` flags are kept for both foreground AND detached (Docker ignores `-t` for detached but `-i` is harmless)
- `--rm` works with `--detach` in modern Docker (container removed when it stops)
- For detached mode, `p/shell` is used instead of `p/exec` so we can capture the container ID output and print feedback
  </action>
  <verify>
1. Grep run.clj for `ensure-name-available!` -- should appear before docker args construction
2. Grep docker/run.clj for `--name` and `--detach` -- should appear in args builder
3. Grep run.clj for `"Container started:"` -- should appear in detached feedback
4. Verify the non-detached (foreground) path still uses `p/exec` (backwards compatible)
5. `bb -e '(require (quote aishell.docker.run)) (println (aishell.docker.run/build-docker-args {:project-dir "/tmp" :image-tag "test" :config nil :git-identity {} :detach true :container-name "aishell-abc-claude"}))'` should show --name and --detach in output
  </verify>
  <done>
- All containers get --name flag in docker args
- Conflict detection via ensure-name-available! runs before every docker run
- --detach flag adds --detach to docker args and uses p/shell for launch feedback
- Foreground mode unchanged (still uses p/exec)
- Detached launch prints container name, attach command, shell command, stop command, and ps command
  </done>
</task>

</tasks>

<verification>
1. CLI extracts --detach/-d flag and passes :detach to run-container
2. run-container calls ensure-name-available! before docker run
3. Docker args include --name for all containers
4. Docker args include --detach when :detach is true
5. Detached mode prints user-friendly feedback after launch
6. Foreground mode is unchanged (p/exec, no feedback)
7. No regressions in existing harness dispatch (claude, opencode, codex, gemini, gitleaks)
</verification>

<success_criteria>
- `aishell claude` runs in foreground with named container (backwards compatible)
- `aishell claude --detach` runs in background, prints attach instructions
- `aishell claude --name reviewer --detach` uses custom name, prints instructions
- Duplicate running container produces clear error with attach hint
- Stopped duplicate container is auto-removed before new launch
</success_criteria>

<output>
After completion, create `.planning/phases/32-detached-mode-conflict-detection/32-02-SUMMARY.md`
</output>
