---
phase: 32-detached-mode-conflict-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/templates.clj
autonomous: true

must_haves:
  truths:
    - "All container commands (harness and shell) auto-start inside a tmux session named 'main'"
    - "Entrypoint wraps the final exec in tmux new-session -A -s main"
    - "tmux runs as the user (via gosu), not as root"
  artifacts:
    - path: "src/aishell/docker/templates.clj"
      provides: "Entrypoint script with tmux auto-start wrapping"
      contains: "tmux new-session -A -s main"
  key_links:
    - from: "entrypoint-script"
      to: "tmux"
      via: "exec gosu + tmux new-session wrapping"
      pattern: "exec gosu.*tmux new-session -A -s main"
---

<objective>
Modify the entrypoint script to auto-start all container commands (harness and shell) inside a tmux session named "main".

Purpose: Enables tmux-based session management for all container modes, which is the foundation for attach/detach functionality in Phase 33.
Output: Modified entrypoint-script in templates.clj that wraps the final exec with tmux.

**Context overrides:**
- ROADMAP success criterion #2 ("Shell mode does NOT auto-start tmux") is overridden per CONTEXT.md decision: "ALL modes auto-start inside tmux (harness, shell, foreground, detached)." This was an explicit user decision during phase discussion to ensure consistency across all modes.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-detached-mode-conflict-detection/32-CONTEXT.md
@.planning/phases/32-detached-mode-conflict-detection/32-RESEARCH.md
@src/aishell/docker/templates.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify entrypoint to auto-start tmux session</name>
  <files>src/aishell/docker/templates.clj</files>
  <action>
In `entrypoint-script` (templates.clj), replace the final exec line (line 229-230 in the string):

```bash
# Execute command as the user via gosu
exec gosu "$USER_ID:$GROUP_ID" "$@"
```

With tmux-wrapped version:

```bash
# Execute command as the user via gosu, auto-start in tmux session
# -A: attach if session exists, create if not (idempotent)
# -s main: session named "main" (consistent naming for attach command)
# -c "$PWD": start in working directory (set by docker run -w)
# "$@": the actual command (bash, claude, opencode, codex, gemini)
exec gosu "$USER_ID:$GROUP_ID" tmux new-session -A -s main -c "$PWD" "$@"
```

Key points:
- `gosu` MUST come before `tmux` so the tmux socket is owned by the user, not root (avoids permission errors on attach)
- `-A` flag makes this idempotent: creates session if not exists, attaches if exists
- `-s main` names the session consistently for the attach command (Phase 33)
- `-c "$PWD"` ensures tmux starts in the project directory
- `"$@"` passes through the command (bash for shell, claude for harness, etc.)
- This applies to ALL modes: shell, harness, foreground, detached

Also update the bashrc source check comment to note tmux context. Since all modes now start in tmux, the bashrc source block (lines 207-212) that checks for `"$1" = "/bin/bash"` should be kept as-is - it correctly detects when bash is the command being run inside tmux.

Do NOT change the Dockerfile CMD or ENTRYPOINT directives - those remain as-is.
  </action>
  <verify>
1. `bb -e '(require (quote aishell.docker.templates)) (println (subs aishell.docker.templates/entrypoint-script (- (count aishell.docker.templates/entrypoint-script) 200)))'` shows the tmux new-session line at the end
2. Grep for "tmux new-session -A -s main" in the entrypoint-script string
3. Grep confirms "exec gosu" still precedes "tmux" (correct order for socket permissions)
4. No changes to base-dockerfile or bashrc-content strings
  </verify>
  <done>
The entrypoint-script string in templates.clj ends with `exec gosu "$USER_ID:$GROUP_ID" tmux new-session -A -s main -c "$PWD" "$@"` and the Dockerfile/bashrc strings are unchanged.
  </done>
</task>

</tasks>

<verification>
1. Read templates.clj and confirm only entrypoint-script was modified
2. Confirm the tmux wrapping line is present: `exec gosu "$USER_ID:$GROUP_ID" tmux new-session -A -s main -c "$PWD" "$@"`
3. Confirm gosu precedes tmux (socket permission correctness)
4. Confirm base-dockerfile still has `CMD ["/bin/bash"]` unchanged
</verification>

<success_criteria>
- entrypoint-script wraps all commands in tmux session named "main"
- gosu runs before tmux (user-owned socket)
- No changes to Dockerfile or bashrc content
</success_criteria>

<output>
After completion, create `.planning/phases/32-detached-mode-conflict-detection/32-01-SUMMARY.md`
</output>
