---
phase: 05-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - aishell
  - install.sh
autonomous: true

must_haves:
  truths:
    - "User can run curl ... | bash and install the tool"
    - "After installation, aishell command is available in ~/.local/bin"
    - "aishell --version shows version number"
    - "Installation warns if Docker not found (but continues)"
  artifacts:
    - path: "aishell"
      provides: "Self-contained launcher script with embedded heredocs"
      contains: "write_dockerfile"
    - path: "install.sh"
      provides: "curl|bash installer script"
      contains: "main"
  key_links:
    - from: "install.sh"
      to: "raw.githubusercontent.com"
      via: "curl download of aishell"
      pattern: "curl.*githubusercontent.*aishell"
    - from: "aishell"
      to: "mktemp/Dockerfile"
      via: "heredoc extraction at build time"
      pattern: "write_dockerfile.*DOCKERFILE_EOF"
---

<objective>
Create distribution infrastructure for aishell: a self-contained script with embedded heredocs and a curl|bash installer.

Purpose: Enable users to install aishell with a single command (`curl ... | bash`) and have it available in PATH without manual configuration. This completes the distribution requirements (DIST-01, DIST-03).

Output:
- Refactored `aishell` script with Dockerfile, entrypoint.sh, and bashrc.aishell embedded as heredocs
- New `install.sh` script for curl|bash installation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-distribution/05-CONTEXT.md
@.planning/phases/05-distribution/05-RESEARCH.md

# Current source files to refactor
@aishell
@Dockerfile
@entrypoint.sh
@bashrc.aishell
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor aishell to embed build files as heredocs</name>
  <files>aishell</files>
  <action>
    Refactor the aishell script to be self-contained:

    1. Add heredoc extraction functions that write embedded content to temp directory:
       - `write_dockerfile()` - Embeds full content of Dockerfile
       - `write_entrypoint()` - Embeds full content of entrypoint.sh
       - `write_bashrc()` - Embeds full content of bashrc.aishell

    2. Modify `ensure_image()` to use heredoc extraction:
       - Create temp directory with `mktemp -d`
       - Call write_* functions to extract files to temp dir
       - Build from temp dir instead of script_dir
       - Clean up temp dir after build (trap on EXIT)

    3. Keep VERSION at top (already exists as 0.1.0)

    Heredoc pattern (from RESEARCH.md):
    ```bash
    write_dockerfile() {
        cat > "$1/Dockerfile" << 'DOCKERFILE_EOF'
    # ... full Dockerfile content ...
    DOCKERFILE_EOF
    }
    ```

    IMPORTANT: Use quoted heredoc marker ('DOCKERFILE_EOF') to prevent variable expansion.

    The script_dir reference is still needed for project extensions (.aishell/Dockerfile),
    but base image builds should use the embedded heredocs.
  </action>
  <verify>
    Run these commands:
    1. `grep -c "DOCKERFILE_EOF" aishell` returns 2 (start and end markers)
    2. `grep -c "ENTRYPOINT_EOF" aishell` returns 2
    3. `grep -c "BASHRC_EOF" aishell` returns 2
    4. `grep "write_dockerfile" aishell` shows function definition
    5. `./aishell --version` shows version
    6. Create test: `rm -f aishell.bak && cp aishell aishell.bak && docker rmi aishell:base 2>/dev/null || true && ./aishell --with-claude --version` (should build from heredocs)
  </verify>
  <done>
    aishell script is self-contained with Dockerfile, entrypoint.sh, and bashrc.aishell
    embedded as heredocs. Image builds correctly without requiring separate files in
    script directory.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create install.sh installer script</name>
  <files>install.sh</files>
  <action>
    Create curl|bash installer following patterns from RESEARCH.md:

    1. Header:
       - Shebang: `#!/bin/bash`
       - Strict mode: `set -euo pipefail`
       - VERSION variable matching aishell
       - INSTALL_DIR="${HOME}/.local/bin"
       - REPO_URL pointing to raw.githubusercontent.com/OWNER/REPO/main/aishell
         (Use placeholder: https://raw.githubusercontent.com/jonasrodrigues/harness/main/aishell)

    2. Color support functions (from RESEARCH.md):
       - `supports_color()` - Check TTY, NO_COLOR, tput colors
       - `setup_colors()` - Set BLUE, GREEN, RED, BOLD, NC variables
       - `info()` - Blue arrow prefix
       - `success()` - Green arrow prefix
       - `error()` - Red prefix, write to stderr
       - `warn()` - Yellow prefix

    3. Core functions:
       - `check_docker()` - Warn if docker not found or not running (continue anyway)
       - `ensure_install_dir()` - mkdir -p ~/.local/bin
       - `download_script()` - curl -fsSL to INSTALL_DIR/aishell, chmod +x
       - `check_path()` - If ~/.local/bin not in PATH, print suggestion

    4. Main function (called at end of script):
       ```bash
       main() {
           setup_colors
           info "Installing aishell v${VERSION}..."
           check_docker
           ensure_install_dir
           download_script
           success "Installed aishell v${VERSION} to ${INSTALL_DIR}/aishell"
           check_path
       }
       main "$@"
       ```

    5. PATH suggestion (when ~/.local/bin not in PATH):
       ```
       Note: $HOME/.local/bin is not in your PATH.
       Add the following to your shell profile (~/.bashrc, ~/.zshrc, or ~/.profile):

         export PATH="$HOME/.local/bin:$PATH"

       Then restart your shell or run: source ~/.bashrc
       ```

    Per CONTEXT.md: Overwrite always, no checksum verification for V1, verbose progress.
  </action>
  <verify>
    1. `bash -n install.sh` (syntax check passes)
    2. `grep -q "set -euo pipefail" install.sh` (strict mode)
    3. `grep -q "main.*@" install.sh` (main called at end)
    4. `grep -q "NO_COLOR" install.sh` (respects NO_COLOR)
    5. `grep -q "\.local/bin" install.sh` (correct install path)
    6. `grep -q "check_docker" install.sh` (Docker check exists)
    7. Test dry run: `INSTALL_DIR=/tmp/test-aishell bash -x install.sh` (verify flow)
  </verify>
  <done>
    install.sh exists with function-wrapped installer, color support, Docker warning,
    PATH detection, and verbose progress output. Ready for curl|bash usage.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Self-contained aishell test:
   ```bash
   # Remove base image, verify rebuild works from heredocs
   docker rmi aishell:base 2>/dev/null || true
   ./aishell --version
   # Should build and show version
   ```

2. Installer test (local simulation):
   ```bash
   # Create temp install dir
   mkdir -p /tmp/test-install
   INSTALL_DIR=/tmp/test-install bash install.sh
   ls -la /tmp/test-install/aishell
   /tmp/test-install/aishell --version
   rm -rf /tmp/test-install
   ```

3. Full curl|bash test (requires git push):
   - After committing and pushing, test: `curl -fsSL https://raw.githubusercontent.com/jonasrodrigues/harness/main/install.sh | bash`
   - Verify: `~/.local/bin/aishell --version`
</verification>

<success_criteria>
- [ ] aishell contains embedded heredocs for Dockerfile, entrypoint.sh, bashrc.aishell
- [ ] aishell builds image correctly without separate files
- [ ] install.sh passes syntax check
- [ ] install.sh downloads to ~/.local/bin and sets executable
- [ ] install.sh warns if Docker not found (but continues)
- [ ] install.sh suggests PATH fix if ~/.local/bin not in PATH
- [ ] DIST-01 satisfied: curl|bash installation works
- [ ] DIST-03 satisfied: command available in PATH location
</success_criteria>

<output>
After completion, create `.planning/phases/05-distribution/05-01-SUMMARY.md`
</output>
