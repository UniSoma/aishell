---
phase: 22-gitleaks-integration
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/aishell/gitleaks/scan_state.clj
  - src/aishell/gitleaks/warnings.clj
  - src/aishell/config.clj
  - src/aishell/run.clj
  - src/aishell/core.clj
autonomous: true

must_haves:
  truths:
    - "Last gitleaks scan timestamp is tracked in state file"
    - "User sees warning on claude/opencode/shell if gitleaks hasn't been run recently"
    - "Warning includes command to run gitleaks scan"
    - "User can disable freshness warning via config.yaml"
    - "Timestamp is only updated after completed scan"
  artifacts:
    - path: "src/aishell/gitleaks/scan_state.clj"
      provides: "Per-project scan timestamp persistence in XDG state directory"
      contains: "gitleaks-scans.edn"
    - path: "src/aishell/gitleaks/warnings.clj"
      provides: "Freshness warning display with actionable message"
      contains: "aishell gitleaks"
    - path: "src/aishell/config.clj"
      provides: "gitleaks_freshness_check config key"
      contains: "gitleaks_freshness_check"
  key_links:
    - from: "src/aishell/run.clj"
      to: "src/aishell/gitleaks/warnings.clj"
      via: "display-freshness-warning before container launch"
      pattern: "gitleaks.*warning"
    - from: "src/aishell/gitleaks/warnings.clj"
      to: "src/aishell/gitleaks/scan_state.clj"
      via: "stale? check against threshold"
      pattern: "stale\\?"
    - from: "src/aishell/run.clj"
      to: "src/aishell/gitleaks/scan_state.clj"
      via: "write-scan-timestamp after successful gitleaks scan"
      pattern: "write-scan-timestamp"
---

<objective>
Implement scan freshness tracking and staleness warnings for the gitleaks command.

Purpose: Encourage users to run periodic gitleaks scans by showing a warning when the last scan is stale (default: 7 days) or has never been run. This completes the gitleaks integration by providing ongoing reminders without blocking execution.

Output: Users see a warning before container launch when gitleaks scan is stale. Last scan timestamp is recorded in XDG state directory after successful scans.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-gitleaks-integration/22-CONTEXT.md
@.planning/phases/22-gitleaks-integration/22-RESEARCH.md
@.planning/phases/22-gitleaks-integration/22-01-SUMMARY.md

@src/aishell/util.clj
@src/aishell/state.clj
@src/aishell/config.clj
@src/aishell/run.clj
@src/aishell/output.clj
@src/aishell/core.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scan_state.clj for timestamp persistence</name>
  <files>src/aishell/gitleaks/scan_state.clj</files>
  <action>
Create new namespace `aishell.gitleaks.scan-state` for per-project scan timestamp tracking.

```clojure
(ns aishell.gitleaks.scan-state
  "Per-project gitleaks scan timestamp persistence.
   Stores timestamps in XDG state directory, keyed by absolute project path."
  (:require [babashka.fs :as fs]
            [clojure.edn :as edn]
            [aishell.util :as util]))

;; State file location: ~/.local/state/aishell/gitleaks-scans.edn
;; Format: {"/path/to/project" {:last-scan "2026-01-23T10:00:00Z"} ...}

(defn scan-state-file []
  (str (fs/path (util/state-dir) "gitleaks-scans.edn")))

(defn read-scan-state []
  (let [path (scan-state-file)]
    (if (fs/exists? path)
      (try
        (edn/read-string (slurp path))
        (catch Exception _ {}))
      {})))

(defn write-scan-timestamp [project-dir]
  (let [abs-path (str (fs/absolutize project-dir))
        current-state (read-scan-state)
        new-state (assoc current-state abs-path {:last-scan (str (java.time.Instant/now))})]
    (util/ensure-dir (util/state-dir))
    (spit (scan-state-file) (pr-str new-state))))

(defn get-last-scan [project-dir]
  (let [abs-path (str (fs/absolutize project-dir))
        state (read-scan-state)
        timestamp-str (get-in state [abs-path :last-scan])]
    (when timestamp-str
      (java.time.Instant/parse timestamp-str))))

(defn days-since-scan [project-dir]
  (when-let [last-scan (get-last-scan project-dir)]
    (let [now (java.time.Instant/now)
          duration (java.time.Duration/between last-scan now)]
      (.toDays duration))))

(defn stale? [project-dir threshold-days]
  (let [days (days-since-scan project-dir)]
    (cond
      (nil? days) true  ; Never scanned = stale
      (>= days threshold-days) true
      :else false)))
```

Use absolute paths as keys for debuggability (user can inspect state file).
  </action>
  <verify>
Create directory and verify file parses:
```bash
mkdir -p src/aishell/gitleaks
bb -e "(require '[aishell.gitleaks.scan-state])"
```
  </verify>
  <done>
scan_state.clj exists with read/write functions for per-project timestamps.
Functions: scan-state-file, read-scan-state, write-scan-timestamp, get-last-scan, days-since-scan, stale?
  </done>
</task>

<task type="auto">
  <name>Task 2: Create warnings.clj for freshness warning display</name>
  <files>src/aishell/gitleaks/warnings.clj</files>
  <action>
Create new namespace `aishell.gitleaks.warnings` for displaying freshness warnings.

```clojure
(ns aishell.gitleaks.warnings
  "Freshness warning display for gitleaks scans.
   Shown before container launch when scan is stale (default: 7 days)."
  (:require [aishell.output :as output]
            [aishell.gitleaks.scan-state :as scan-state]))

(def default-threshold-days 7)

(defn display-freshness-warning
  "Display warning if gitleaks scan is stale (older than threshold).
   Called before container launch. Advisory only - does not block.

   Arguments:
   - project-dir: Project directory path
   - config: Loaded config map (to check gitleaks_freshness_check toggle)
   - threshold-days: Optional threshold override (default: 7)"
  [project-dir config & [threshold-days]]
  ;; Check if freshness check is disabled in config
  (when (not= false (:gitleaks_freshness_check config))
    (let [threshold (or threshold-days default-threshold-days)]
      (when (scan-state/stale? project-dir threshold)
        (let [days (scan-state/days-since-scan project-dir)
              never-scanned? (nil? days)]
          (println)
          (binding [*out* *err*]
            (println (str output/YELLOW "Warning:" output/NC " Gitleaks scan is "
                         (if never-scanned?
                           "missing"
                           (str "stale (" days " days old)"))))
            (println (str "Run: " output/CYAN "aishell gitleaks" output/NC " to scan for secrets"))
            (println)))))))
```

Warning follows existing output patterns (YELLOW for warning, CYAN for command).
Config can disable via `gitleaks_freshness_check: false`.
  </action>
  <verify>
Verify file parses:
```bash
bb -e "(require '[aishell.gitleaks.warnings])"
```
  </verify>
  <done>
warnings.clj exists with display-freshness-warning function.
Warning shows "missing" for never-scanned or "stale (N days old)" for old scans.
Includes actionable command: "Run: aishell gitleaks to scan for secrets"
  </done>
</task>

<task type="auto">
  <name>Task 3: Add gitleaks_freshness_check to config known-keys and integrate warnings</name>
  <files>src/aishell/config.clj, src/aishell/run.clj, src/aishell/core.clj</files>
  <action>
1. In config.clj, add :gitleaks_freshness_check to known-keys set:
```clojure
(def known-keys
  #{:mounts :env :ports :docker_args :pre_start :extends :harness_args
    :gitleaks_freshness_check})
```

2. In run.clj, integrate freshness warning display:
   - Add require for aishell.gitleaks.warnings and aishell.gitleaks.scan-state
   - Before container launch (after detection warnings, before docker-args building):
     - Show freshness warning for shell/claude/opencode (NOT for gitleaks command itself)
   - After gitleaks command completes successfully, update timestamp:
     - The gitleaks command uses p/exec which replaces the process, so we need a different approach
     - Use babashka.process/shell instead of exec for gitleaks, then call write-scan-timestamp on success

For gitleaks timestamp update, change the execution pattern:
```clojure
;; For gitleaks, use shell instead of exec so we can update timestamp after
(when (= cmd "gitleaks")
  (let [result (apply p/shell {:inherit true} (concat docker-args container-cmd))]
    (when (zero? (:exit result))
      (scan-state/write-scan-timestamp project-dir))
    (System/exit (:exit result))))
```

3. In core.clj, add static require for gitleaks namespaces (for uberscript):
```clojure
(require '[aishell.gitleaks.scan-state]
         '[aishell.gitleaks.warnings])
```
  </action>
  <verify>
Run tests to confirm integration:
```bash
bb -e "(require '[aishell.core] '[aishell.run] '[aishell.config])"
grep -n "gitleaks_freshness_check" src/aishell/config.clj
grep -n "gitleaks" src/aishell/run.clj
```
  </verify>
  <done>
gitleaks_freshness_check config key is recognized.
Freshness warning displays before shell/claude/opencode container launch.
Scan timestamp updates after successful gitleaks scan.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Gitleaks namespaces exist and parse:
```bash
bb -e "(require '[aishell.gitleaks.scan-state] '[aishell.gitleaks.warnings])"
```

2. Config recognizes gitleaks_freshness_check:
```bash
grep "gitleaks_freshness_check" src/aishell/config.clj
```

3. Run.clj integrates freshness warnings:
```bash
grep -n "gitleaks" src/aishell/run.clj
```

4. Core.clj includes static requires:
```bash
grep -n "gitleaks" src/aishell/core.clj
```

5. All namespaces load without error:
```bash
bb -e "(require '[aishell.core])"
```
</verification>

<success_criteria>
- src/aishell/gitleaks/scan_state.clj exists with read/write/stale? functions
- src/aishell/gitleaks/warnings.clj exists with display-freshness-warning function
- gitleaks_freshness_check added to config.clj known-keys
- run.clj displays freshness warning before shell/claude/opencode (not gitleaks)
- run.clj updates scan timestamp after successful gitleaks command
- core.clj includes static requires for gitleaks namespaces
- All files parse without syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-gitleaks-integration/22-02-SUMMARY.md`
</output>
