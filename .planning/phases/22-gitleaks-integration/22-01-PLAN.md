---
phase: 22-gitleaks-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/templates.clj
  - src/aishell/cli.clj
  - src/aishell/run.clj
  - src/aishell/docker/run.clj
autonomous: true

must_haves:
  truths:
    - "Gitleaks binary is available in the base container image"
    - "User can run `aishell gitleaks` to perform scan of project directory"
    - "Gitleaks runs inside container without executing pre_start hooks"
    - "All gitleaks flags are passed through to the underlying binary"
  artifacts:
    - path: "src/aishell/docker/templates.clj"
      provides: "Gitleaks installation in base-dockerfile"
      contains: "gitleaks"
    - path: "src/aishell/cli.clj"
      provides: "Gitleaks command dispatch"
      contains: "gitleaks"
    - path: "src/aishell/run.clj"
      provides: "Gitleaks container execution with skip-pre-start"
      contains: ":skip-pre-start"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/run.clj"
      via: "run/run-container with :skip-pre-start option"
      pattern: "run-container.*gitleaks.*:skip-pre-start"
    - from: "src/aishell/run.clj"
      to: "src/aishell/docker/run.clj"
      via: "build-docker-args with PRE_START unset"
      pattern: "PRE_START"
---

<objective>
Add Gitleaks binary to the base container image and create the `aishell gitleaks` command with full passthrough.

Purpose: Enable users to run deep content-based secret scanning inside the container using the industry-standard gitleaks tool.

Output: Users can run `aishell gitleaks` (or `aishell gitleaks dir .` etc.) and have all arguments passed through to the underlying binary. The gitleaks command runs without triggering pre_start hooks for fast execution.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-gitleaks-integration/22-CONTEXT.md
@.planning/phases/22-gitleaks-integration/22-RESEARCH.md

@src/aishell/docker/templates.clj
@src/aishell/cli.clj
@src/aishell/run.clj
@src/aishell/docker/run.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Gitleaks installation to base Dockerfile</name>
  <files>src/aishell/docker/templates.clj</files>
  <action>
Modify `base-dockerfile` in templates.clj to install Gitleaks binary:

1. Add after the gosu installation block (before Claude Code conditional install):

```dockerfile
# Install Gitleaks for secret scanning
ARG GITLEAKS_VERSION=8.30.0
RUN set -eux; \
    dpkgArch=\"$(dpkg --print-architecture)\"; \
    case \"${dpkgArch##*-}\" in \
        amd64) glArch='x64' ;; \
        arm64) glArch='arm64' ;; \
        armhf) glArch='armv7' ;; \
        *) echo \"unsupported architecture: $dpkgArch\"; exit 1 ;; \
    esac; \
    curl -fsSL \"https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_${glArch}.tar.gz\" \
    | tar -xz -C /usr/local/bin gitleaks; \
    chmod +x /usr/local/bin/gitleaks; \
    gitleaks version
```

Use the same multi-architecture pattern as gosu (dpkgArch case statement).
Pin version to 8.30.0 (latest stable as of research).
  </action>
  <verify>
Run `bb src/aishell/docker/templates.clj` to check for syntax errors.
Grep for "gitleaks" in templates.clj to confirm addition.
  </verify>
  <done>
base-dockerfile string contains Gitleaks installation with multi-arch support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add gitleaks command dispatch in CLI</name>
  <files>src/aishell/cli.clj</files>
  <action>
Modify the `dispatch` function to handle gitleaks as a pass-through command:

1. Add "gitleaks" to known-commands in output.clj (for typo suggestions)

2. In cli.clj dispatch function, add gitleaks case alongside claude/opencode:

```clojure
(case (first clean-args)
  "claude" (run/run-container "claude" (vec (rest clean-args)) {:unsafe unsafe?})
  "opencode" (run/run-container "opencode" (vec (rest clean-args)) {:unsafe unsafe?})
  "gitleaks" (run/run-container "gitleaks" (vec (rest clean-args)) {:unsafe unsafe? :skip-pre-start true})
  ;; Standard dispatch for other commands
  ...)
```

Key: Pass `:skip-pre-start true` in opts to signal pre_start hooks should not run.

3. Update print-help to include gitleaks in the Commands section:
```clojure
(println (str "  " output/CYAN "gitleaks" output/NC "   Run Gitleaks secret scanner"))
```
  </action>
  <verify>
Run `bb -m aishell.core --help` and confirm gitleaks appears in command list.
  </verify>
  <done>
`aishell gitleaks` is dispatched to run-container with skip-pre-start flag.
Help output shows gitleaks command.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement skip-pre-start in run.clj and docker/run.clj</name>
  <files>src/aishell/run.clj, src/aishell/docker/run.clj</files>
  <action>
1. In run.clj `run-container` function:
   - Accept `:skip-pre-start` in opts
   - Pass it through to build-docker-args when building docker args
   - Add gitleaks case to container-cmd building (pure passthrough, no defaults merging):

```clojure
;; In container-cmd case statement:
"gitleaks"
(into ["gitleaks"] harness-args)  ; No defaults, pure passthrough
```

2. In docker/run.clj `build-docker-args` function:
   - Accept `:skip-pre-start` in opts
   - When true, add `-e PRE_START=` to docker args to unset the env var
   - This prevents entrypoint.sh from running the pre_start command

The change should be minimal - add one conditional that appends `-e PRE_START=` to the args list when skip-pre-start is true.

3. For gitleaks, skip the sensitive file detection scan (it would be redundant):
   - Detection happens for shell/claude/opencode but not for gitleaks command
  </action>
  <verify>
Read the modified files and confirm:
- run-container accepts :skip-pre-start option
- build-docker-args adds `-e PRE_START=` when skip-pre-start is true
- gitleaks case exists in container-cmd building
  </verify>
  <done>
Gitleaks command runs inside container without executing pre_start hooks.
Pre_start is disabled via `-e PRE_START=` docker arg which unsets the env var.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Dockerfile contains gitleaks installation:
```bash
grep -n "gitleaks" src/aishell/docker/templates.clj
```

2. CLI dispatches gitleaks command:
```bash
grep -n "gitleaks" src/aishell/cli.clj
```

3. Run module handles gitleaks and skip-pre-start:
```bash
grep -n "gitleaks\|skip-pre-start" src/aishell/run.clj src/aishell/docker/run.clj
```

4. All Clojure files parse without error:
```bash
bb -e "(require '[aishell.cli] '[aishell.run] '[aishell.docker.run] '[aishell.docker.templates])"
```
</verification>

<success_criteria>
- base-dockerfile string in templates.clj includes Gitleaks v8.30.0 installation with multi-arch support
- `aishell gitleaks` dispatches to run-container with skip-pre-start flag
- build-docker-args adds `-e PRE_START=` when skip-pre-start is true
- Container command for gitleaks is pure passthrough (no defaults merging)
- All source files parse without syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-gitleaks-integration/22-01-SUMMARY.md`
</output>
