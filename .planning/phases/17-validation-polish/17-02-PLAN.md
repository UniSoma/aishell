---
phase: 17-validation-polish
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/aishell/validation.clj
  - src/aishell/run.clj
autonomous: true

must_haves:
  truths:
    - "User is warned when docker_args contains dangerous patterns like --privileged"
    - "User is warned when Dockerfile changed since last build (stale image)"
    - "Warnings are advisory only (execution continues)"
    - "Security warnings list specific patterns detected"
  artifacts:
    - path: "src/aishell/validation.clj"
      provides: "Dangerous docker_args pattern checking"
      exports: ["check-dangerous-args", "warn-dangerous-args"]
    - path: "src/aishell/run.clj"
      provides: "Stale image detection and security warnings on run"
      contains: "check-dockerfile-stale"
  key_links:
    - from: "src/aishell/run.clj:run-container"
      to: "src/aishell/validation.clj:warn-dangerous-args"
      via: "calls with docker_args from config"
      pattern: "validation/warn-dangerous-args"
    - from: "src/aishell/run.clj:run-container"
      to: "state.edn"
      via: "compares :dockerfile-hash"
      pattern: ":dockerfile-hash"
---

<objective>
Implement security warnings for dangerous Docker options and stale image detection.

Purpose: Alert users to potentially insecure configurations and outdated images without blocking execution (advisory warnings).

Output: New validation.clj module for dangerous pattern checking, updated run.clj with stale image and security warnings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-validation-polish/17-CONTEXT.md
@.planning/phases/17-validation-polish/17-RESEARCH.md

@src/aishell/run.clj
@src/aishell/config.clj
@src/aishell/output.clj
@src/aishell/docker/hash.clj
@src/aishell/docker/templates.clj
@src/aishell/state.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation.clj with dangerous pattern checking</name>
  <files>
    - src/aishell/validation.clj
  </files>
  <action>
  Create new file `src/aishell/validation.clj`:

  ```clojure
  (ns aishell.validation
    "Security validation for Docker configurations.
     Checks for dangerous patterns and provides advisory warnings."
    (:require [clojure.string :as str]
              [aishell.output :as output]))

  ;; Dangerous docker_args patterns from v1.2 bash implementation
  ;; These reduce container isolation and should be used with caution
  (def dangerous-patterns
    [{:pattern "--privileged"
      :message "--privileged: Container has full host access"}
     {:pattern "docker.sock"
      :message "docker.sock mount: Container can control Docker daemon"}
     {:pattern #"--cap-add=(SYS_ADMIN|ALL)"
      :message "Elevated capabilities: Increases container escape risk"}
     {:pattern #"(apparmor|seccomp)=unconfined"
      :message "Disabled security profiles: Reduces container isolation"}])

  (defn check-dangerous-args
    "Check docker_args string for dangerous patterns.
     Returns seq of warning messages, or nil if none found."
    [docker-args]
    (when (and docker-args (not (str/blank? docker-args)))
      (seq
        (keep
          (fn [{:keys [pattern message]}]
            (when (if (string? pattern)
                    (str/includes? docker-args pattern)
                    (re-find pattern docker-args))
              message))
          dangerous-patterns))))

  (defn warn-dangerous-args
    "Warn about dangerous docker_args if any found.
     Advisory only - does not block execution."
    [docker-args]
    (when-let [warnings (check-dangerous-args docker-args)]
      (println)  ; Blank line before warning block
      (output/warn "Security notice: Potentially dangerous Docker options detected")
      (doseq [msg warnings]
        (binding [*out* *err*]
          (println (str "  - " msg))))
      (binding [*out* *err*]
        (println)
        (println "These options reduce container isolation. Use only if necessary.")
        (println))))
  ```

  Key implementation notes:
  - Patterns match v1.2 bash implementation (lines 152-182)
  - Both string patterns (simple contains) and regex patterns (for OR cases)
  - check-dangerous-args returns seq for testing, warn-dangerous-args for display
  - Advisory only - prints warnings but never exits
  </action>
  <verify>
  - File exists at src/aishell/validation.clj
  - `bb -e "(require '[aishell.validation :as v]) (v/check-dangerous-args \"--privileged\")"` returns warning
  - `bb -e "(require '[aishell.validation :as v]) (v/check-dangerous-args \"--network=host\")"` returns nil (not dangerous)
  </verify>
  <done>
  - validation.clj exists with check-dangerous-args and warn-dangerous-args functions
  - Patterns match v1.2 bash: --privileged, docker.sock, --cap-add=SYS_ADMIN|ALL, apparmor/seccomp=unconfined
  </done>
</task>

<task type="auto">
  <name>Task 2: Add stale image detection and security warnings to run.clj</name>
  <files>
    - src/aishell/run.clj
  </files>
  <action>
  1. Add requires to run.clj:
     ```clojure
     [aishell.validation :as validation]
     [aishell.docker.hash :as hash]
     [aishell.docker.templates :as templates]
     ```

  2. Create check-dockerfile-stale function:
     ```clojure
     (defn- check-dockerfile-stale
       "Check if embedded Dockerfile changed since build, warn if so.
        Advisory only - does not block execution."
       [state]
       (when-let [stored-hash (:dockerfile-hash state)]
         (let [current-hash (hash/compute-hash templates/base-dockerfile)]
           (when (not= stored-hash current-hash)
             (output/warn "Image may be stale. Run 'aishell update' to rebuild.")))))
     ```

  3. In run-container, after loading config but before building docker args:
     - Check for stale dockerfile:
       ```clojure
       ;; Check for stale image
       (check-dockerfile-stale state)
       ```
     - Check for dangerous docker_args:
       ```clojure
       ;; Warn about dangerous docker_args
       (when-let [docker-args (:docker_args cfg)]
         (validation/warn-dangerous-args docker-args))
       ```

  4. Place both checks after the verbose output for config loading but before docker-args construction.
     Order: stale check first, then security warnings (stale is more actionable).
  </action>
  <verify>
  1. Stale image warning:
     - `./aishell build --with-claude`
     - Manually modify templates/base-dockerfile (add comment)
     - `./aishell claude` shows "Image may be stale" warning
     - Revert the template change

  2. Security warnings:
     - Create `.aishell/config.yaml` with: `docker_args: "--privileged"`
     - `./aishell` shows "Security notice: Potentially dangerous Docker options detected"
     - Remove the test config
  </verify>
  <done>
  - run.clj checks dockerfile hash on every run command
  - run.clj warns about dangerous docker_args patterns
  - Both warnings are advisory (execution continues)
  </done>
</task>

</tasks>

<verification>
1. Dangerous args warning:
   - Create test config: `mkdir -p .aishell && echo 'docker_args: "--privileged"' > .aishell/config.yaml`
   - `./aishell` shows security warning
   - `rm -rf .aishell` (cleanup)

2. Stale image detection:
   - `./aishell build --with-claude`
   - `cat ~/.aishell/state.edn | grep dockerfile-hash` shows hash
   - (In production, modifying templates would trigger warning - not easily testable without code change)

3. Warnings don't block:
   - Both warnings print to stderr and execution continues
   - Shell/claude/opencode commands complete normally after warnings
</verification>

<success_criteria>
- [ ] validation.clj exists with dangerous pattern checking
- [ ] run.clj warns when Dockerfile hash differs from state
- [ ] run.clj warns when docker_args contains dangerous patterns
- [ ] All warnings are advisory only (don't exit)
- [ ] Patterns match v1.2 bash implementation
</success_criteria>

<output>
After completion, create `.planning/phases/17-validation-polish/17-02-SUMMARY.md`
</output>
