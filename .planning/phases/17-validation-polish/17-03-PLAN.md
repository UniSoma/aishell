# Phase 17 Plan 03: Fix UAT Gaps

**Gap closure plan for UAT test 4 and test 6 failures**

## Context

Two gaps identified during UAT:
1. **Gap 1 (blocker):** docker_args vector crashes check-dangerous-args
2. **Gap 2 (major):** Version changes don't trigger cache invalidation

## Tasks

### Task 1: Fix check-dangerous-args to handle vector input

**File:** `src/aishell/validation.clj`

**Root cause:** Function uses `str/blank?` and `str/includes?` which require strings, but YAML config provides vector.

**Change:** Normalize `docker-args` to string at function start

```clojure
;; Before (lines 19-31):
(defn check-dangerous-args
  "Check docker_args string for dangerous patterns.
   Returns seq of warning messages, or nil if none found."
  [docker-args]
  (when (and docker-args (not (str/blank? docker-args)))
    (seq
      (keep
        (fn [{:keys [pattern message]}]
          (when (if (string? pattern)
                  (str/includes? docker-args pattern)
                  (re-find pattern docker-args))
            message))
        dangerous-patterns))))

;; After:
(defn check-dangerous-args
  "Check docker_args for dangerous patterns.
   Accepts string or vector of args.
   Returns seq of warning messages, or nil if none found."
  [docker-args]
  (let [args-str (if (sequential? docker-args)
                   (str/join " " docker-args)
                   docker-args)]
    (when (and args-str (not (str/blank? args-str)))
      (seq
        (keep
          (fn [{:keys [pattern message]}]
            (when (if (string? pattern)
                    (str/includes? args-str pattern)
                    (re-find pattern args-str))
              message))
          dangerous-patterns)))))
```

**Commit:** `fix(validation): handle vector docker_args in security check`

---

### Task 2: Add version comparison to cache invalidation

**File:** `src/aishell/docker/build.clj`

**Root cause:** `needs-rebuild?` only checks dockerfile hash, not version changes.

**Change:** Add function to compare requested opts against stored state.

```clojure
;; Add new function after needs-rebuild? (around line 37):
(defn version-changed?
  "Check if requested harness versions differ from stored state.
   Returns true if rebuild needed due to version change."
  [opts state]
  (or
    ;; Claude version changed
    (and (:with-claude opts)
         (not= (:claude-version opts) (:claude-version state)))
    ;; OpenCode version changed
    (and (:with-opencode opts)
         (not= (:opencode-version opts) (:opencode-version state)))
    ;; Harness added that wasn't in previous build
    (and (:with-claude opts) (not (:with-claude state)))
    (and (:with-opencode opts) (not (:with-opencode state)))))
```

**Update build-base-image:** Pass state to needs-rebuild check (around line 114).

```clojure
;; Before:
(if-not (needs-rebuild? base-image-tag force)

;; After - read state and check versions too:
(let [state (require-and-call 'aishell.state/read-state)]
  (if-not (or (needs-rebuild? base-image-tag force)
              (version-changed? opts state))
```

Note: Need to require state namespace or pass state as parameter to avoid circular dependency.

**Cleaner approach:** Add state parameter to build-base-image, caller (cli.clj) passes it.

**Commit:** `fix(build): invalidate cache when harness version changes`

---

## Verification

### Test 1 (Gap 1):
1. Create config.yaml with `docker_args: ["--privileged"]`
2. Run `./aishell`
3. Should see security warning, then container starts (no crash)

### Test 2 (Gap 2):
1. Run `./aishell build --with-claude=1.0.0`
2. Run `./aishell build --with-claude=1.0.1`
3. Should trigger rebuild (not "up to date")

## Success Criteria

- [ ] check-dangerous-args accepts both string and vector input
- [ ] Security warning displays for `["--privileged"]`
- [ ] Execution continues after warning
- [ ] Changing --with-claude version triggers rebuild
- [ ] Changing --with-opencode version triggers rebuild
- [ ] Adding harness that wasn't previously built triggers rebuild
