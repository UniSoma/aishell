---
phase: 17-validation-polish
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/run.clj
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Security warning displays for vector docker_args"
    - "Execution continues without crash after warning"
    - "Both string and vector docker_args formats work"
  artifacts:
    - path: "src/aishell/docker/run.clj"
      provides: "tokenize-docker-args handles both formats"
      contains: "sequential?"
  key_links:
    - from: "src/aishell/docker/run.clj"
      to: "config :docker_args"
      via: "tokenize-docker-args normalization"
      pattern: "if.*sequential"
---

<objective>
Fix tokenize-docker-args crash when docker_args is a vector.

Purpose: UAT test 1 passes security check (validation.clj already fixed) but crashes when building docker args because tokenize-docker-args assumes string input.

Output: Both string and vector docker_args formats work end-to-end.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-validation-polish/17-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix tokenize-docker-args to handle vector input</name>
  <files>src/aishell/docker/run.clj</files>
  <action>
Update tokenize-docker-args (lines 121-126) to handle both string and vector inputs.

Current code crashes because str/trim expects string but receives vector:
```clojure
(defn- tokenize-docker-args
  "Split docker_args string into individual args.
   Simple whitespace split - complex quoting not supported (documented limitation)."
  [docker-args-str]
  (when (and docker-args-str (not (str/blank? docker-args-str)))
    (str/split (str/trim docker-args-str) #"\s+")))
```

Fix: If input is sequential (vector/list), return it as-is - it's already tokenized.
If input is string, split on whitespace (current behavior).

```clojure
(defn- tokenize-docker-args
  "Tokenize docker_args into individual args.
   Accepts string (splits on whitespace) or vector (returns as-is).
   Complex quoting in strings not supported (documented limitation)."
  [docker-args]
  (cond
    (sequential? docker-args) (vec docker-args)
    (and docker-args (not (str/blank? docker-args)))
    (str/split (str/trim docker-args) #"\s+")
    :else nil))
```

This follows the same pattern established in validation.clj but is more efficient - no need to join and re-split a vector.
  </action>
  <verify>
1. Test with vector config:
```bash
cd /tmp && mkdir -p test-project && cd test-project
cat > config.yaml << 'EOF'
docker_args:
  - "--privileged"
EOF
# Run aishell - should show warning AND continue (no crash)
```

2. Test with string config:
```bash
cat > config.yaml << 'EOF'
docker_args: "--memory=1g --cpus=2"
EOF
# Run aishell - should work without crash
```
  </verify>
  <done>
- tokenize-docker-args handles both string and vector inputs
- Vector docker_args: warning displays AND execution continues (no crash)
- String docker_args: continues to work as before
  </done>
</task>

</tasks>

<verification>
Run the exact failing UAT scenario:

1. Create test project with vector docker_args:
```bash
mkdir -p /tmp/uat-test && cd /tmp/uat-test
cat > config.yaml << 'EOF'
docker_args:
  - "--privileged"
EOF
```

2. Run aishell and verify:
- Security warning displays (from validation.clj - already working)
- NO crash with "LazySeq cannot be cast to CharSequence"
- Container starts (or would start if image exists)
</verification>

<success_criteria>
- [ ] tokenize-docker-args uses sequential? check
- [ ] Vector input returns vector as-is (no join/split)
- [ ] String input splits on whitespace (existing behavior)
- [ ] UAT test 1 passes completely (warning + no crash)
</success_criteria>

<output>
After completion, create `.planning/phases/17-validation-polish/17-04-SUMMARY.md`
</output>
