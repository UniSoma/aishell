---
phase: 45-documentation-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - README.md
  - docs/CONFIGURATION.md
autonomous: true

must_haves:
  truths:
    - "README.md describes --with-gitleaks as opt-in flag, not default behavior"
    - "README.md Gitleaks section explains conditional availability (requires --with-gitleaks)"
    - "CONFIGURATION.md --without-gitleaks section replaced with --with-gitleaks section"
    - "CONFIGURATION.md gitleaks_freshness_check section notes it requires --with-gitleaks"
  artifacts:
    - path: "README.md"
      provides: "Updated user-facing documentation with opt-in Gitleaks semantics"
      contains: "--with-gitleaks"
    - path: "docs/CONFIGURATION.md"
      provides: "Updated configuration reference with opt-in Gitleaks semantics"
      contains: "--with-gitleaks"
  key_links:
    - from: "README.md"
      to: "docs/CONFIGURATION.md"
      via: "Cross-reference link in Gitleaks section"
      pattern: "docs/CONFIGURATION.md"
---

<objective>
Update README.md and docs/CONFIGURATION.md to reflect Gitleaks opt-in default from Phase 44.

Purpose: Users reading these primary docs must understand that Gitleaks is NOT installed by default and requires `--with-gitleaks` at build time. These are the two highest-priority docs (user-facing overview + reference).
Output: Updated README.md and docs/CONFIGURATION.md with consistent opt-in messaging.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/45-documentation-updates/45-RESEARCH.md
@README.md
@docs/CONFIGURATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update README.md Gitleaks references to opt-in semantics</name>
  <files>README.md</files>
  <action>
Update 4 sections in README.md. Use the exact current text to locate each section.

1. **Line 112 — Features list:** Change from:
   ```
   - **Gitleaks integration** - Deep content-based secret scanning with `aishell gitleaks`
   ```
   To:
   ```
   - **Gitleaks integration** - Opt-in deep content-based secret scanning with `aishell gitleaks` (requires `--with-gitleaks`)
   ```

2. **Line 223 — Check command description:** Change from:
   ```
   Checks Docker availability, build state, image existence, configuration validity, mount paths, sensitive files, and gitleaks scan freshness.
   ```
   To:
   ```
   Checks Docker availability, build state, image existence, configuration validity, mount paths, sensitive files, and gitleaks scan freshness (when installed).
   ```

3. **Lines 299-310 — Gitleaks section:** Replace the entire section from `### Gitleaks` through the link to Configuration docs. The new section should be:
   ```markdown
   ### Gitleaks (Optional)

   Gitleaks is opt-in. Enable it at build time:

   ```bash
   aishell setup --with-claude --with-gitleaks
   ```

   Then use `aishell gitleaks` for content-based secret detection inside the container:

   ```bash
   aishell gitleaks detect
   aishell gitleaks detect --verbose --no-git
   ```

   aishell tracks when you last ran gitleaks and reminds you if it's been more than 7 days.

   For custom detection patterns, allowlists, and freshness configuration, see [Configuration docs](docs/CONFIGURATION.md).
   ```

4. **Line 424 — Foundation image contents:** Change from:
   ```
   - Gitleaks v8.30.0 (secret scanning)
   ```
   To:
   ```
   - Gitleaks v8.30.0 (optional, via `--with-gitleaks`)
   ```

**Important:** Do NOT change section headings beyond adding "(Optional)" to the Gitleaks heading. Do NOT change any other sections. Preserve all existing formatting and whitespace.
  </action>
  <verify>
Run: `grep -n "without-gitleaks" README.md` — should return no matches.
Run: `grep -n "with-gitleaks" README.md` — should return matches at the updated locations.
Run: `grep -n "Gitleaks (Optional)" README.md` — should return the section heading.
Run: `grep -n "opt-in\|Opt-in" README.md` — should return at least 2 matches (features list + Gitleaks section).
  </verify>
  <done>README.md contains no references to --without-gitleaks, describes Gitleaks as opt-in with --with-gitleaks flag, and section heading says "(Optional)".</done>
</task>

<task type="auto">
  <name>Task 2: Update docs/CONFIGURATION.md Gitleaks references to opt-in semantics</name>
  <files>docs/CONFIGURATION.md</files>
  <action>
Update 4 areas in docs/CONFIGURATION.md.

1. **Lines 1169-1201 — Rename and rewrite the `--without-gitleaks` section.** Replace the entire section from `### --without-gitleaks` through the Note line (ending before the `---` separator at line 1203). The new section should be:

   ```markdown
   ### --with-gitleaks

   **Purpose:** Install Gitleaks during build for content-based secret scanning.

   **Usage:**
   ```bash
   aishell setup --with-claude --with-gitleaks
   ```

   **Behavior:**
   - By default, aishell does NOT install Gitleaks
   - `--with-gitleaks` enables Gitleaks installation (~15MB added to foundation image)
   - Build state records installation status in `~/.aishell/state.edn`
   - `aishell --help` shows the `gitleaks` command only when installed

   **State tracking:**
   ```bash
   # Check what was installed
   cat ~/.aishell/state.edn
   # Shows :with-gitleaks true or false
   ```

   **When to use:**
   - **Content scanning:** You want deep secret detection beyond filename patterns
   - **Pre-commit safety:** Run scans before AI agents see your code
   - **Compliance:** Your workflow requires secret scanning

   **Image size impact:**
   - Without Gitleaks (default): ~265MB
   - With Gitleaks: ~280MB
   - Cost: ~15MB

   **Note:** Without `--with-gitleaks`, the `aishell gitleaks` command is not available.
   ```

2. **Lines 641-673 — gitleaks_freshness_check section.** Add a note after the `**Default:** \`true\`` line (line 647). Insert:
   ```markdown

   **Requires:** `--with-gitleaks` build flag. When Gitleaks is not installed, this setting has no effect (no warnings are shown).
   ```

3. **Lines 203-216 — Example config comment block.** Update the comment at line 205 from:
   ```
   # When true (default), warns before container launch if the gitleaks
   ```
   To:
   ```
   # When true (default), warns before container launch if the gitleaks scan
   # is stale. Requires --with-gitleaks build flag; has no effect without it.
   ```
   And update line 209 from:
   ```
   # The warning reminds you to run: aishell gitleaks dir .
   ```
   To:
   ```
   # When Gitleaks is installed, the warning reminds you to run: aishell gitleaks dir .
   ```

4. **Line 1258 — Gitleaks installation status under aishell update.** Change from:
   ```
   - Gitleaks installation status
   ```
   To:
   ```
   - Gitleaks installation status (`--with-gitleaks` opt-in)
   ```

**Important:** Do NOT change the TOC entry at line 22. Do NOT change the merge strategy table at line 71. Preserve all existing formatting.
  </action>
  <verify>
Run: `grep -n "without-gitleaks" docs/CONFIGURATION.md` — should return no matches.
Run: `grep -n "with-gitleaks" docs/CONFIGURATION.md` — should show the updated section heading, usage, and references.
Run: `grep -c "opt-in\|Opt-in\|NOT install\|not available\|not installed\|no effect" docs/CONFIGURATION.md` — should return at least 3 matches indicating opt-in language.
  </verify>
  <done>CONFIGURATION.md section renamed from --without-gitleaks to --with-gitleaks, default behavior described as "NOT installed", freshness check notes dependency on --with-gitleaks flag.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -rn "without-gitleaks" README.md docs/CONFIGURATION.md` — zero matches
2. `grep -rn "with-gitleaks" README.md docs/CONFIGURATION.md` — matches in both files
3. `grep -n "by default.*install\|default.*NOT" README.md docs/CONFIGURATION.md` — confirms default is "not installed"
4. No broken Markdown formatting (headings, code blocks, links all valid)
</verification>

<success_criteria>
- README.md describes Gitleaks as opt-in with --with-gitleaks flag (DOCS-01)
- CONFIGURATION.md explains Gitleaks configuration with opt-in semantics (DOCS-02)
- No references to --without-gitleaks remain in either file
- All existing sections preserved, only content updated
</success_criteria>

<output>
After completion, create `.planning/phases/45-documentation-updates/45-01-SUMMARY.md`
</output>
