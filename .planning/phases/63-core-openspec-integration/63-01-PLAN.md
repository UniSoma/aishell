---
phase: 63-core-openspec-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/volume.clj
  - src/aishell/cli.clj
  - src/aishell/state.clj
autonomous: true
requirements: [BUILD-01, BUILD-02, BUILD-03, VOL-01, VOL-02]

must_haves:
  truths:
    - "User can pass --with-openspec flag to aishell setup and it is recognized"
    - "User can pass --with-openspec=1.2.3 to pin a specific OpenSpec version"
    - "OpenSpec enabled/version state is persisted in state.edn after setup"
    - "OpenSpec npm package (@fission-ai/openspec) is included in volume install commands when enabled"
    - "Volume hash changes when OpenSpec is toggled or its version changes"
    - "aishell update shows OpenSpec version when enabled"
  artifacts:
    - path: "src/aishell/docker/volume.clj"
      provides: "OpenSpec registered as npm harness for volume installation and hash computation"
      contains: ":openspec"
    - path: "src/aishell/cli.clj"
      provides: "CLI flag parsing, setup handler, update handler for OpenSpec"
      contains: ":with-openspec"
    - path: "src/aishell/state.clj"
      provides: "State schema documentation including OpenSpec keys"
      contains: ":with-openspec"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/docker/volume.clj"
      via: "state-map passed to vol/compute-harness-hash and vol/populate-volume"
      pattern: ":with-openspec.*state-map"
    - from: "src/aishell/cli.clj"
      to: "src/aishell/state.clj"
      via: "state/write-state persists openspec keys"
      pattern: ":with-openspec.*:openspec-version"
---

<objective>
Register OpenSpec as an npm-installed tool in the harness volume system and wire the `--with-openspec` build flag through CLI parsing, state persistence, and volume installation.

Purpose: Enable the core setup path so `aishell setup --with-openspec` installs @fission-ai/openspec into the /tools volume and persists the configuration in state.edn.

Output: OpenSpec fully wired into setup, update, and volume systems following the exact Pi/Claude/Codex/Gemini pattern.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-core-openspec-integration/63-CONTEXT.md

# Key source files (follow existing harness patterns exactly)
@src/aishell/docker/volume.clj
@src/aishell/cli.clj
@src/aishell/state.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register OpenSpec in harness volume system</name>
  <files>src/aishell/docker/volume.clj, src/aishell/state.clj</files>
  <action>
In `src/aishell/docker/volume.clj`:

1. Add `:openspec` to the `harness-keys` vector (maintain alphabetical order among existing keys: `:claude :codex :gemini :opencode :openspec :pi`).

2. Add `:openspec` to the `harness-npm-packages` map with value `"@fission-ai/openspec"`. This ensures `build-install-commands` will include `@fission-ai/openspec@VERSION` in the npm install when `:with-openspec` is truthy in state.

Both changes follow the exact pattern used by `:pi` (added in v3.5.0). The `normalize-harness-config` function already derives `:with-openspec` and `:openspec-version` keys automatically from `harness-keys`, so no additional changes needed there.

In `src/aishell/state.clj`:

3. Update the `write-state` docstring schema comment to include `:with-openspec false` (boolean) and `:openspec-version nil` (string or nil) entries, following the existing pattern of other harnesses. No code changes needed in this file — just documentation of the schema.
  </action>
  <verify>
Run `grep -n "openspec" src/aishell/docker/volume.clj src/aishell/state.clj` to confirm:
- `:openspec` appears in `harness-keys` vector
- `"@fission-ai/openspec"` appears in `harness-npm-packages` map
- `:with-openspec` and `:openspec-version` appear in state.clj docstring
  </verify>
  <done>OpenSpec is registered as an npm harness in the volume system. When state contains `:with-openspec true`, the volume hash includes it and `populate-volume` installs the npm package.</done>
</task>

<task type="auto">
  <name>Task 2: Wire --with-openspec through CLI setup and update</name>
  <files>src/aishell/cli.clj</files>
  <action>
Follow the exact pattern used for Pi (`:with-pi`) across all locations in `src/aishell/cli.clj`:

1. **setup-spec**: Add `:with-openspec {:desc "Include OpenSpec (optional: =VERSION)"}` to the spec map, after `:with-pi`.

2. **handle-setup**: Add `openspec-config (parse-with-flag (:with-openspec opts))` alongside the other harness configs. Add `_ (validate-version (:version openspec-config) "OpenSpec")` alongside other validations.

3. **state-map in handle-setup**: Add `:with-openspec (:enabled? openspec-config)` and `:openspec-version (:version openspec-config)` to the state-map.

4. **Volume population trigger in handle-setup**: Add `:with-openspec` to the `(some #(get state-map %) [...])` check that gates volume creation. Also add `:openspec` to the `harness-list` computation (the `keep` form over the map).

5. **handle-update**: Add `(when (:with-openspec state) (println (str "  OpenSpec: " (or (:openspec-version state) "latest"))))` alongside other harness version displays. Add `:with-openspec` to the `harnesses-enabled?` check `(some #(get state %) [...])`. Add `:openspec` to the harness-list computation in the update path.

6. **print-setup-help**: Add an example line: `(println (str "  " output/CYAN "aishell setup --with-openspec" output/NC "            Include OpenSpec"))`.

7. **installed-harnesses**: Add `(:with-openspec state) (conj "openspec")` to the cond-> form. NOTE: OpenSpec does NOT get an `aishell openspec` command (it's not a harness), but tracking it in installed-harnesses ensures `aishell check` can display its status.

8. **print-help**: Do NOT add an "openspec" harness command line — OpenSpec is not a harness and has no `aishell openspec` subcommand. Users access it via `openspec` command inside the container after `aishell shell`.

IMPORTANT: Do NOT add OpenSpec to the `dispatch` case statement or `run-container` dispatch — OpenSpec is NOT a harness with its own aishell subcommand.
  </action>
  <verify>
Run `bb -cp src -e "(require '[aishell.cli]) (println (:with-openspec aishell.cli/setup-spec))"` to confirm the flag is registered in the spec.

Also verify with grep:
- `grep -c "openspec" src/aishell/cli.clj` should show 10+ matches
- `grep "with-openspec" src/aishell/cli.clj` should show flag in setup-spec, handle-setup, state-map, volume trigger, update, and installed-harnesses
- `grep -c "\"openspec\"" src/aishell/cli.clj | head` — should NOT appear in dispatch table (not a harness command)
  </verify>
  <done>The `--with-openspec` and `--with-openspec=VERSION` flags are fully wired through CLI parsing, version validation, state persistence, volume population triggers, and update display. OpenSpec is NOT exposed as an `aishell openspec` subcommand.</done>
</task>

</tasks>

<verification>
1. `grep -rn "openspec" src/` shows OpenSpec references in volume.clj, cli.clj, and state.clj only
2. `grep ":with-openspec" src/aishell/cli.clj` shows flag in setup-spec, handle-setup, state-map, volume trigger, update handler, and installed-harnesses
3. `grep "openspec" src/aishell/docker/volume.clj` shows registration in harness-keys and harness-npm-packages
4. `grep "openspec" src/aishell/state.clj` shows schema documentation
5. No `"openspec"` case in cli.clj dispatch — confirming it's not a harness subcommand
</verification>

<success_criteria>
- `--with-openspec` flag accepted by `aishell setup`
- `--with-openspec=1.2.3` pins version through validation and state persistence
- State map includes `:with-openspec` and `:openspec-version` keys
- Volume hash computation includes OpenSpec when enabled
- Volume population installs `@fission-ai/openspec` via npm when enabled
- `aishell update` displays OpenSpec version when enabled
- OpenSpec is NOT exposed as a CLI subcommand (no `aishell openspec`)
</success_criteria>

<output>
After completion, create `.planning/phases/63-core-openspec-integration/63-01-SUMMARY.md`
</output>
