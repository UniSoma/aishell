---
phase: 03-harness-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
autonomous: true

must_haves:
  truths:
    - "Claude Code binary is installed at /usr/local/bin/claude when WITH_CLAUDE=true"
    - "OpenCode binary is installed at /usr/local/bin/opencode when WITH_OPENCODE=true"
    - "Base image remains minimal when no harnesses requested"
  artifacts:
    - path: "Dockerfile"
      provides: "Conditional harness installation with build args"
      contains: "ARG WITH_CLAUDE"
  key_links:
    - from: "Dockerfile ARG WITH_CLAUDE"
      to: "curl claude.ai/install.sh"
      via: "conditional RUN"
      pattern: 'if \[ "\$WITH_CLAUDE" = "true" \]'
---

<objective>
Add conditional harness installation to Dockerfile using build args

Purpose: Enable building images with Claude Code and/or OpenCode pre-installed via --with-claude and --with-opencode flags, while keeping the base image minimal when harnesses are not requested.

Output: Modified Dockerfile with ARG-controlled harness installation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-harness-integration/03-RESEARCH.md
@.planning/phases/03-harness-integration/03-CONTEXT.md

# Current implementation
@Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add conditional harness installation to Dockerfile</name>
  <files>Dockerfile</files>
  <action>
Add build arguments and conditional installation for both harnesses:

1. Add build args after existing FROM:
   ```dockerfile
   ARG WITH_CLAUDE=false
   ARG WITH_OPENCODE=false
   ```

2. Add Claude Code installation (after gosu installation, before COPY entrypoint):
   ```dockerfile
   # Install Claude Code if requested (native binary)
   # Installs to /root/.claude/bin/claude, symlink to /usr/local/bin for PATH
   RUN if [ "$WITH_CLAUDE" = "true" ]; then \
         export DISABLE_AUTOUPDATER=1 && \
         curl -fsSL https://claude.ai/install.sh | bash && \
         ln -sf /root/.claude/bin/claude /usr/local/bin/claude; \
       fi
   ```

3. Add OpenCode installation (after Claude Code):
   ```dockerfile
   # Install OpenCode if requested (native binary)
   # Installs to /root/.opencode/bin/opencode, symlink to /usr/local/bin for PATH
   RUN if [ "$WITH_OPENCODE" = "true" ]; then \
         curl -fsSL https://opencode.ai/install | bash && \
         ln -sf /root/.opencode/bin/opencode /usr/local/bin/opencode; \
       fi
   ```

Key points:
- Use native installers (not npm for Claude Code - deprecated per RESEARCH.md)
- DISABLE_AUTOUPDATER=1 for Claude (containers are ephemeral)
- Symlink to /usr/local/bin so binaries are in PATH for all users
- Each harness in separate RUN for independent layer caching
  </action>
  <verify>
Verify Dockerfile syntax and build with different flag combinations:
```bash
cd /home/jonasrodrigues/projects/harness
# Verify syntax
docker build --check .
# Build without harnesses (should be fast, reuses cache)
docker build -t aishell-test-base .
# Confirm no harnesses in base
docker run --rm aishell-test-base which claude && echo "FAIL: claude found" || echo "OK: no claude"
docker run --rm aishell-test-base which opencode && echo "FAIL: opencode found" || echo "OK: no opencode"
```
  </verify>
  <done>
Dockerfile contains ARG WITH_CLAUDE and ARG WITH_OPENCODE with conditional installation blocks. Base image builds successfully without harnesses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build and verify harness installation</name>
  <files></files>
  <action>
Build images with harnesses enabled and verify installation:

1. Build with Claude Code:
   ```bash
   docker build --build-arg WITH_CLAUDE=true -t aishell-claude .
   ```

2. Verify Claude Code is installed:
   ```bash
   docker run --rm aishell-claude claude --version
   ```

3. Build with OpenCode:
   ```bash
   docker build --build-arg WITH_OPENCODE=true -t aishell-opencode .
   ```

4. Verify OpenCode is installed:
   ```bash
   docker run --rm aishell-opencode opencode --version
   ```

5. Build with both harnesses:
   ```bash
   docker build --build-arg WITH_CLAUDE=true --build-arg WITH_OPENCODE=true -t aishell-full .
   ```

6. Verify both installed:
   ```bash
   docker run --rm aishell-full claude --version
   docker run --rm aishell-full opencode --version
   ```

Note: This task produces no file changes - it validates the Dockerfile changes from Task 1.
  </action>
  <verify>
All three image variants build successfully:
- aishell-claude: `claude --version` works
- aishell-opencode: `opencode --version` works
- aishell-full: both commands work
  </verify>
  <done>
All harness installation configurations verified. Claude Code and OpenCode binaries are available at /usr/local/bin when their respective build args are true.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Base image remains minimal:
   ```bash
   docker run --rm aishell-test-base ls /usr/local/bin/ | grep -E 'claude|opencode' || echo "Clean: no harnesses"
   ```

2. Harness images have correct binaries:
   ```bash
   docker run --rm aishell-full which claude opencode
   ```

3. Binaries are functional:
   ```bash
   docker run --rm aishell-full claude --version
   docker run --rm aishell-full opencode --version
   ```
</verification>

<success_criteria>
- Dockerfile builds with WITH_CLAUDE=false WITH_OPENCODE=false (base, no harnesses)
- Dockerfile builds with WITH_CLAUDE=true (Claude Code installed)
- Dockerfile builds with WITH_OPENCODE=true (OpenCode installed)
- Dockerfile builds with both =true (both installed)
- Harness binaries available at /usr/local/bin/claude and /usr/local/bin/opencode
- Requirements HARNESS-06 and HARNESS-07 satisfied at image level
</success_criteria>

<output>
After completion, create `.planning/phases/03-harness-integration/03-01-SUMMARY.md`
</output>
