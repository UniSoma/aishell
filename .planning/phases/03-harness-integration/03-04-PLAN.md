# Plan: 03-04 Fix OpenCode XDG State Directory

## Overview
- **Phase**: 03-harness-integration
- **Type**: Gap closure (from UAT)
- **Gap**: OpenCode fails with EACCES when trying to create ~/.local/state

## Root Cause
entrypoint.sh creates `$HOME` but not XDG standard subdirectories. OpenCode expects to write to `~/.local/state` (XDG_STATE_HOME default) but it doesn't exist and the container user can't create parent directories.

## Goal
OpenCode can start without permission errors by ensuring XDG state directory exists.

## Tasks

### Task 1: Create XDG directories in entrypoint

**File:** `entrypoint.sh`

**Change:** After the home directory creation block (lines 35-37), add creation of XDG standard directories:

```bash
# Ensure home directory exists with correct ownership
mkdir -p "$HOME"
chown "$USER_ID:$GROUP_ID" "$HOME"

# Create XDG standard directories (apps expect these to be writable)
mkdir -p "$HOME/.local/state" "$HOME/.local/share" "$HOME/.local/bin"
chown -R "$USER_ID:$GROUP_ID" "$HOME/.local"
```

**Rationale:**
- `~/.local/state` - Required by OpenCode (XDG_STATE_HOME)
- `~/.local/share` - Common app data location
- `~/.local/bin` - User binaries (prevents Claude Code warning)

### Task 2: Rebuild and verify

**Commands:**
```bash
# Rebuild image
./aishell --with-opencode --with-claude

# Test OpenCode starts
./aishell opencode
```

**Success:** OpenCode starts without EACCES error.

## Verification

- [ ] `./aishell opencode` launches without permission errors
- [ ] OpenCode can connect to API and show interface
- [ ] Claude Code warning about ~/.local/bin disappears

## Commits

1. `fix(entrypoint): create XDG directories for harness compatibility`
