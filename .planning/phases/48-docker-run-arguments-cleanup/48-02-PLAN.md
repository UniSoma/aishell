---
phase: 48-docker-run-arguments-cleanup
plan: 02
type: execute
wave: 2
depends_on: ["48-01"]
files_modified:
  - src/aishell/docker/volume.clj
  - src/aishell/run.clj
autonomous: true

must_haves:
  truths:
    - "TPM and plugins are not installed in harness volume"
    - "Volume hash calculation excludes tmux state"
    - "inject-resurrect-plugin function no longer exists"
    - "build-tpm-install-command function no longer exists"
    - "Harness volume population only installs npm packages and OpenCode binary"
    - "ensure-harness-volume does not check :with-tmux"
    - "No resurrect references remain in docker runtime code paths (run.clj, docker/run.clj, docker/volume.clj)"
    - "Namespace loads without errors after all deletions"
  artifacts:
    - path: "src/aishell/docker/volume.clj"
      provides: "Volume management without tmux plugin installation"
      contains: "normalize-harness-config"
    - path: "src/aishell/run.clj"
      provides: "Launcher without :with-tmux volume check"
  key_links:
    - from: "src/aishell/run.clj"
      to: "src/aishell/docker/volume.clj"
      via: "compute-harness-hash and populate-volume calls"
      pattern: "vol/compute-harness-hash"
---

<objective>
Remove all tmux-related code from volume management (docker/volume.clj) and the harness volume check in the launcher (run.clj). This eliminates TPM installation, plugin management, resurrect plugin injection, and tmux state from volume hash calculation.

Purpose: Eliminates tmux plugin installation from harness volumes and removes tmux state from volume hash. Satisfies requirements TMUX-06 and TMUX-07.
Output: Clean volume.clj with no tmux references, simplified normalize-harness-config and populate-volume.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-docker-run-arguments-cleanup/48-RESEARCH.md
@.planning/phases/48-docker-run-arguments-cleanup/48-01-SUMMARY.md
@src/aishell/docker/volume.clj
@src/aishell/run.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete tmux functions and clean up volume hash and population in volume.clj</name>
  <files>src/aishell/docker/volume.clj</files>
  <action>
CRITICAL: Babashka/SCI resolves symbols at analysis time. Run `grep -rn "function-name" src/` for each function before deleting to confirm ALL callers are addressed.

**PREREQUISITE: Run these grep commands FIRST, before ANY edits, and verify the results match expectations. Do NOT proceed with edits if unexpected callers are found.**

```bash
cd /home/jonasrodrigues/projects/harness
grep -rn "inject-resurrect-plugin" src/
# Expected: lines 196-202 in docker/volume.clj ONLY (definition, no callers)
# Was called from config.clj but removed in Phase 47

grep -rn "build-tpm-install-command" src/
# Expected: lines 205, 336 in docker/volume.clj ONLY (definition + 1 caller in populate-volume)

grep -rn "tmux-plugins\|with-tmux\|tmux_plugins" src/aishell/docker/volume.clj
# Expected: matches in normalize-harness-config and populate-volume (being cleaned up)
# If ANY unexpected files appear, STOP and investigate before editing.
```

If all grep results match expectations, proceed with edits:

**Delete these 2 functions:**

1. `inject-resurrect-plugin` (lines 196-203) - auto-add resurrect to plugin list
   - Callers: NONE (grep confirms no callers -- was called from config.clj but removed in Phase 47)

2. `build-tpm-install-command` (lines 205-222) - builds TPM install command
   - Callers: line 336 in `populate-volume` (updated in same edit)

**Clean up `normalize-harness-config` (lines 43-55):**

Current code:
```clojure
(let [harness-pairs (->> harness-keys
                         (filter #(get state (keyword (str "with-" (name %)))))
                         (map (fn [harness-kw]
                                (let [version-key (keyword (str (name harness-kw) "-version"))
                                      version (get state version-key)]
                                  [harness-kw (or version "latest")])))
                         (sort-by first)
                         vec)
      tmux-state (when (:with-tmux state)
                   [:tmux {:plugins (vec (sort (or (:tmux-plugins state) [])))}])]
  (cond-> harness-pairs
    tmux-state (conj tmux-state)))
```

Replace with (remove let binding, tmux-state, and cond->):
```clojure
(->> harness-keys
     (filter #(get state (keyword (str "with-" (name %)))))
     (map (fn [harness-kw]
            (let [version-key (keyword (str (name harness-kw) "-version"))
                  version (get state version-key)]
              [harness-kw (or version "latest")])))
     (sort-by first)
     vec)
```

This simplification is safe because `:with-tmux` was removed from state in Phase 47, so `tmux-state` was always nil. The hash output does NOT change.

**Clean up `populate-volume` (lines 333-338):**

Current code:
```clojure
(let [install-commands (build-install-commands state)
      tmux-plugins (when (:with-tmux state)
                     (:tmux-plugins state))
      tmux-install (build-tpm-install-command tmux-plugins)
      full-commands (str install-commands
                        (when tmux-install (str " && " tmux-install)))
```

Replace with:
```clojure
(let [install-commands (build-install-commands state)
```
Then replace `full-commands` with `install-commands` on line 344 (the `"sh" "-c" full-commands` part).

Or even simpler, just use `install-commands` directly in the `cmd` vector below and remove `full-commands`:
```clojure
(let [install-commands (build-install-commands state)
```
Then replace `full-commands` with `install-commands` on line 344 (the `"sh" "-c" full-commands` part).

**Update docstrings:**
- `populate-volume` docstring (lines 306-331): Remove references to tmux plugin installation (lines 317-319 mentioning "Conditionally add tmux plugin installation" and `:config for tmux plugins`)
- Change `:config for tmux plugins` to just remove that part from opts description

**Verify after editing:** Run `bb -e "(require 'aishell.docker.volume)"` to confirm namespace loads.
  </action>
  <verify>
Run: `cd /home/jonasrodrigues/projects/harness && bb -e "(require 'aishell.docker.volume)"`
Expected: No error output, clean return.
Run: `grep -rn "tmux\|tpm\|resurrect" src/aishell/docker/volume.clj`
Expected: No matches (all tmux references removed from this file).
Run: `grep -rn "inject-resurrect-plugin\|build-tpm-install-command" src/`
Expected: No matches anywhere in src/.
  </verify>
  <done>
inject-resurrect-plugin and build-tpm-install-command deleted. normalize-harness-config simplified (tmux-state removed). populate-volume simplified (TPM installation removed). Volume hash output unchanged. Namespace loads cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove :with-tmux from ensure-harness-volume check in run.clj</name>
  <files>src/aishell/run.clj</files>
  <action>
In `src/aishell/run.clj` line 47, the `ensure-harness-volume` function checks whether any harness (including tmux) is enabled before computing volume hash:

Current code:
```clojure
(when (some #(get state %) [:with-claude :with-opencode :with-codex :with-gemini :with-tmux])
```

Remove `:with-tmux` from the vector:
```clojure
(when (some #(get state %) [:with-claude :with-opencode :with-codex :with-gemini])
```

This is correct because:
- `:with-tmux` was removed from state schema in Phase 47
- tmux is no longer a harness that needs volume population
- The check only needs to verify actual harness tools

**Verify:** Run `bb -e "(require 'aishell.run)"` and `grep -rn "with-tmux" src/aishell/run.clj` to confirm no remaining references.
  </action>
  <verify>
Run: `cd /home/jonasrodrigues/projects/harness && bb -e "(require 'aishell.run)"`
Expected: No error output, clean return.
Run: `grep -rn "with-tmux" src/aishell/run.clj`
Expected: No matches.
  </verify>
  <done>
:with-tmux removed from ensure-harness-volume check. run.clj no longer references tmux for volume decisions. Namespace loads cleanly.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Namespace verification:
   ```bash
   cd /home/jonasrodrigues/projects/harness
   bb -e "(require 'aishell.docker.volume)"
   bb -e "(require 'aishell.run)"
   bb -e "(require 'aishell.cli)"
   ```
   All must load without error.

2. No tmux references in volume.clj:
   ```bash
   grep -rn "tmux\|tpm\|resurrect" src/aishell/docker/volume.clj
   ```
   Expected: No matches.

3. No with-tmux in run.clj:
   ```bash
   grep -rn "with-tmux" src/aishell/run.clj
   ```
   Expected: No matches.

4. No deleted function references anywhere:
   ```bash
   grep -rn "inject-resurrect-plugin\|build-tpm-install-command" src/
   ```
   Expected: No matches.

5. Comprehensive resurrect runtime check (TMUX-09 verification):
   ```bash
   grep -rn "resurrect" src/aishell/docker/run.clj src/aishell/docker/volume.clj src/aishell/run.clj
   ```
   Expected: ZERO matches. All resurrect references removed from docker runtime code paths.
   ```bash
   grep -rn "resurrect" src/
   ```
   Expected: Only matches in templates.clj (entrypoint conditionals, Phase 49 scope) and migration.clj (migration message text, informational only -- not a runtime code path). No resurrect in run.clj, docker/run.clj, or docker/volume.clj.

6. Full tool test:
   ```bash
   cd /home/jonasrodrigues/projects/harness && bb -e "(require 'aishell.cli)" 2>&1
   ```
   Expected: Clean load, no errors.
</verification>

<success_criteria>
- inject-resurrect-plugin deleted from volume.clj
- build-tpm-install-command deleted from volume.clj
- normalize-harness-config simplified (no tmux-state in hash calculation)
- populate-volume simplified (no TPM installation)
- :with-tmux removed from ensure-harness-volume check in run.clj
- Volume hash output unchanged (tmux-state was already nil)
- No resurrect references in docker runtime code (run.clj, docker/run.clj, docker/volume.clj)
- All namespaces load cleanly in Babashka
</success_criteria>

<output>
After completion, create `.planning/phases/48-docker-run-arguments-cleanup/48-02-SUMMARY.md`
</output>
