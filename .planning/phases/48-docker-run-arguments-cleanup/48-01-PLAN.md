---
phase: 48-docker-run-arguments-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/run.clj
  - src/aishell/run.clj
autonomous: true

must_haves:
  truths:
    - "WITH_TMUX env var is never passed to containers"
    - "tmux config is never mounted into containers"
    - "Resurrect mounts are never added to docker run"
    - "Resurrect env args are never added to docker run"
    - "skip-tmux parameter is renamed to skip-interactive throughout"
    - "Namespace loads without errors after all deletions"
    - "Entrypoint handles missing WITH_TMUX gracefully (no crash)"
  artifacts:
    - path: "src/aishell/docker/run.clj"
      provides: "Docker run argument construction without tmux"
      contains: "skip-interactive"
    - path: "src/aishell/run.clj"
      provides: "Launcher using skip-interactive parameter"
      contains: "skip-interactive"
  key_links:
    - from: "src/aishell/run.clj"
      to: "src/aishell/docker/run.clj"
      via: "build-docker-args call with skip-interactive parameter"
      pattern: "skip-interactive"
    - from: "src/aishell/docker/run.clj"
      to: "src/aishell/docker/templates.clj"
      via: "WITH_TMUX env var removed; entrypoint conditionals safely skip when unset"
      pattern: "WITH_TMUX"
---

<objective>
Remove all tmux-related functions and conditional blocks from Docker run argument construction (docker/run.clj), and rename the overloaded `skip-tmux` parameter to `skip-interactive`.

Purpose: Eliminates tmux config mounts, resurrect mounts, WITH_TMUX env var, and resurrect env args from container runtime. Satisfies requirements TMUX-04, TMUX-05, TMUX-09.
Output: Clean docker/run.clj with no tmux references, skip-tmux renamed to skip-interactive.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-docker-run-arguments-cleanup/48-RESEARCH.md
@src/aishell/docker/run.clj
@src/aishell/run.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete tmux functions and cond-> blocks from docker/run.clj</name>
  <files>src/aishell/docker/run.clj</files>
  <action>
CRITICAL: Babashka/SCI resolves symbols at analysis time. ALL callers must be removed in the same edit as the function definition. Do NOT delete a function without also removing its callers.

**PREREQUISITE: Run these grep commands FIRST, before ANY edits, and verify the results match expectations. Do NOT proceed with edits if unexpected callers are found.**

```bash
cd /home/jonasrodrigues/projects/harness
grep -rn "user-mounted-tmux-config?" src/
# Expected: lines 192, 211 in docker/run.clj ONLY

grep -rn "build-tmux-config-mount" src/
# Expected: lines 201, 317 in docker/run.clj ONLY

grep -rn "build-resurrect-mount" src/
# Expected: lines 224, 322 in docker/run.clj ONLY

grep -rn "build-resurrect-env-args" src/
# Expected: lines 263, 332 in docker/run.clj ONLY

grep -rn "skip-tmux" src/
# Expected: lines 271, 315, 316, 320, 321, 325, 326, 330, 331, 335, 336, 382, 390, 420 in docker/run.clj
#           AND line 201 in run.clj
# If ANY unexpected files appear, STOP and investigate before editing.
```

If all grep results match expectations, proceed with edits:

**Delete these 4 functions (definitions only, callers handled separately):**

1. `user-mounted-tmux-config?` (lines 192-199) - helper for tmux config mount
   - Callers: line 211 inside `build-tmux-config-mount` (deleted together)

2. `build-tmux-config-mount` (lines 201-222) - builds tmux config mount args
   - Callers: line 317 in `build-docker-args-internal` (deleted together)

3. `build-resurrect-mount` (lines 224-227) - stub returning []
   - Callers: line 322 in `build-docker-args-internal` (deleted together)

4. `build-resurrect-env-args` (lines 263-266) - stub returning []
   - Callers: line 332 in `build-docker-args-internal` (deleted together)

**Delete these 4 cond-> blocks in `build-docker-args-internal`:**

1. Lines 314-317: tmux config mount block
   ```clojure
   ;; Tmux config mount (read-only, if enabled and file exists)
   ;; Skip when skip-tmux is true (non-interactive commands like exec/gitleaks)
   (cond-> (not skip-tmux)
     (into (build-tmux-config-mount state config)))
   ```

2. Lines 319-322: resurrect mount block
   ```clojure
   ;; Resurrect state directory mount (persistent tmux session state)
   ;; Skip when skip-tmux is true (non-interactive commands like exec/gitleaks)
   (cond-> (not skip-tmux)
     (into (build-resurrect-mount state config project-dir)))
   ```

3. Lines 324-327: WITH_TMUX env var block
   ```clojure
   ;; Pass WITH_TMUX flag to entrypoint for conditional tmux startup
   ;; Skip when skip-tmux is true (non-interactive commands like exec/gitleaks)
   (cond-> (and (get state :with-tmux) (not skip-tmux))
     (into ["-e" "WITH_TMUX=true"]))
   ```

4. Lines 329-332: resurrect env args block
   ```clojure
   ;; Pass resurrect config to entrypoint
   ;; Skip when skip-tmux is true (non-interactive commands like exec/gitleaks)
   (cond-> (not skip-tmux)
     (into (build-resurrect-env-args state config)))
   ```

**IMPORTANT: The harness aliases block at lines 334-337 is NOT deleted.** This block REMAINS but must be renamed from `skip-tmux` to `skip-interactive`. It controls whether harness aliases are added and is NOT tmux-specific:

```clojure
;; Harness aliases for interactive shell use
;; Skip for non-interactive commands (exec, gitleaks)
(cond-> (not skip-interactive)
  (into (build-harness-alias-env-args config state)))
```

Update both the comment (remove "skip-tmux" reference, clarify it's about non-interactive commands) and the condition `(not skip-tmux)` -> `(not skip-interactive)`.

**Rename `skip-tmux` to `skip-interactive` in these remaining locations within docker/run.clj:**

1. Line 271: `build-docker-args-internal` destructuring: `skip-tmux` -> `skip-interactive`
2. Line 382: `build-docker-args` destructuring: `skip-tmux` -> `skip-interactive`
3. Line 390: `build-docker-args` internal call: `:skip-tmux skip-tmux` -> `:skip-interactive skip-interactive`
4. Line 420: `build-docker-args-for-exec` internal call: `:skip-tmux true` -> `:skip-interactive true`

Also update the docstring for `build-docker-args-internal` (line 269-270) to remove "skip-tmux" reference. And update `build-docker-args` docstring (line 376) to not mention skip-tmux.

**Verify after editing:** Run `bb -e "(require 'aishell.docker.run)"` to confirm namespace loads.
  </action>
  <verify>
Run: `cd /home/jonasrodrigues/projects/harness && bb -e "(require 'aishell.docker.run)"`
Expected: No error output, clean return.
Run: `grep -rn "skip-tmux\|build-tmux-config-mount\|user-mounted-tmux-config\|build-resurrect-mount\|build-resurrect-env-args\|WITH_TMUX" src/aishell/docker/run.clj`
Expected: No matches (all tmux references removed from this file).
Run: `grep -n "skip-interactive" src/aishell/docker/run.clj`
Expected: 4-5 matches showing the renamed parameter.
  </verify>
  <done>
All 4 tmux-related functions deleted. All 4 tmux cond-> blocks deleted from build-docker-args-internal. Harness aliases block preserved with skip-interactive rename. skip-tmux renamed to skip-interactive. Namespace loads cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update skip-tmux to skip-interactive in caller (run.clj)</name>
  <files>src/aishell/run.clj</files>
  <action>
In `src/aishell/run.clj` line 201, rename the parameter passed to `build-docker-args`:

Change:
```clojure
:skip-tmux (= cmd "gitleaks")
```
To:
```clojure
:skip-interactive (= cmd "gitleaks")
```

This is the only caller of `build-docker-args` that passes the `skip-tmux` parameter (now `skip-interactive`).

**Verify:** Run `grep -rn "skip-tmux" src/` to confirm no remaining references to the old parameter name anywhere in the codebase.
  </action>
  <verify>
Run: `cd /home/jonasrodrigues/projects/harness && bb -e "(require 'aishell.run)"`
Expected: No error output, clean return.
Run: `grep -rn "skip-tmux" src/`
Expected: No matches anywhere in src/.
  </verify>
  <done>
skip-tmux renamed to skip-interactive in all files. `bb -e "(require 'aishell.run)"` loads without error. Zero grep matches for "skip-tmux" in src/.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Namespace verification:
   ```bash
   cd /home/jonasrodrigues/projects/harness
   bb -e "(require 'aishell.docker.run)"
   bb -e "(require 'aishell.run)"
   ```
   Both must load without error.

2. No tmux references in docker/run.clj:
   ```bash
   grep -rn "tmux\|WITH_TMUX" src/aishell/docker/run.clj
   ```
   Expected: No matches.

3. No skip-tmux anywhere:
   ```bash
   grep -rn "skip-tmux" src/
   ```
   Expected: No matches.

4. Entrypoint handles missing WITH_TMUX gracefully:
   ```bash
   grep -n 'WITH_TMUX' src/aishell/docker/templates.clj
   ```
   Verify all conditionals use `if [ "$WITH_TMUX" = "true" ]` pattern, which safely evaluates to false when WITH_TMUX is unset. This is Phase 49's cleanup scope (removing the conditionals entirely), but Phase 48 must confirm no crash when WITH_TMUX is absent. The entrypoint uses bash string comparison (`= "true"`) which returns false for unset variables -- no crash risk.

5. No resurrect references in docker runtime code paths:
   ```bash
   grep -rn "resurrect" src/aishell/docker/run.clj src/aishell/docker/volume.clj
   ```
   Expected: No matches in run.clj after Plan 01. Volume.clj matches are addressed by Plan 02.
   ```bash
   grep -rn "resurrect" src/aishell/docker/ src/aishell/run.clj
   ```
   Expected after Plan 02 completes: Only templates.clj has resurrect references (Phase 49 scope). No resurrect in run.clj, docker/run.clj, or docker/volume.clj.

6. Full tool test:
   ```bash
   cd /home/jonasrodrigues/projects/harness && bb -e "(require 'aishell.cli)" 2>&1
   ```
   Expected: Clean load, no errors.
</verification>

<success_criteria>
- 4 tmux functions deleted from docker/run.clj (user-mounted-tmux-config?, build-tmux-config-mount, build-resurrect-mount, build-resurrect-env-args)
- 4 tmux cond-> blocks deleted from build-docker-args-internal
- Harness aliases cond-> block preserved with skip-interactive rename
- WITH_TMUX env var no longer passed to containers
- Entrypoint verified to handle missing WITH_TMUX gracefully (bash `= "true"` comparison is false for unset)
- tmux config no longer mounted
- Resurrect mounts and env args no longer added
- skip-tmux renamed to skip-interactive in docker/run.clj and run.clj
- No resurrect references remain in docker/run.clj
- All namespaces load cleanly in Babashka
</success_criteria>

<output>
After completion, create `.planning/phases/48-docker-run-arguments-cleanup/48-01-SUMMARY.md`
</output>
