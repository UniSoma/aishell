# Plan 16-04: Fix config and CLI issues

## Goal

Fix two Phase 16 issues:
1. `build-env-args` to handle both array and map formats for env config
2. Allow pass-through arguments for claude/opencode commands

## Context

**Gap 1 - env format:**
- User provided: `env: [FOO=bar]` (array format)
- Code expects: `env: {FOO: bar}` (map format)
- Error: `java.lang.Character cannot be cast to clojure.lang.Named`
- Root cause: String destructuring as `[k v]` yields characters, not key/value pairs

**Gap 2 - pass-through args:**
- User ran: `./aishell.clj claude --version`
- Error: `Unknown option: :version`
- Root cause: Global `:restrict true` in cli/dispatch rejects unknown options for all commands

## Tasks

### Task 1: Update build-env-args to handle both formats

**File:** `src/aishell/docker/run.clj`

**Change:** Modify `build-env-args` to:
1. Detect if env is a map or sequential (array)
2. For map format (current): use existing logic
3. For array format: parse each string as `KEY=value` or `KEY` (passthrough)

**Implementation:**

```clojure
(defn- parse-env-string
  "Parse env string 'KEY=value' or 'KEY' (passthrough).
   Returns [key value] where value is nil for passthrough."
  [s]
  (let [s (str s)]
    (if-let [idx (str/index-of s "=")]
      [(subs s 0 idx) (subs s (inc idx))]
      [s nil])))

(defn- build-env-args
  "Build -e flags from env config.

   Supports two YAML formats:
   1. Map format:
      env:
        FOO: bar        # literal
        BAR:            # passthrough from host
   2. Array format:
      env:
        - FOO=bar       # literal
        - BAR           # passthrough from host

   Skips passthrough vars not set on host with warning."
  [env]
  (when (seq env)
    (let [entries (if (map? env)
                    ;; Map format: {:FOO "bar" :BAR nil}
                    (map (fn [[k v]] [(name k) v]) env)
                    ;; Array format: ["FOO=bar" "BAR"]
                    (map parse-env-string env))]
      (->> entries
           (mapcat
             (fn [[key-name value]]
               (if (nil? value)
                 ;; Passthrough: only add if set on host
                 (if-let [host-val (System/getenv key-name)]
                   ["-e" key-name]
                   (do
                     (output/warn (str "Skipping unset host variable: " key-name))
                     []))
                 ;; Literal value
                 ["-e" (str key-name "=" value)])))))))
```

**Verification:**
```bash
# Test array format
echo "env: [FOO=bar]" > /tmp/test-config.yaml
# Run and check $FOO=bar inside container

# Test map format still works
echo -e "env:\n  FOO: bar" > /tmp/test-config.yaml
# Run and check $FOO=bar inside container

# Test passthrough (array)
export TEST_VAR=hello
echo "env: [TEST_VAR]" > /tmp/test-config.yaml
# Run and check $TEST_VAR=hello inside container
```

### Task 2: Allow pass-through args for claude/opencode

**File:** `src/aishell/cli.clj`

**Change:** Add `:restrict false` to claude and opencode dispatch entries so unknown options are collected as args instead of rejected.

**Current (line 172-173):**
```clojure
{:cmds ["claude"] :fn #(handle-run % "claude") :spec {:help {:alias :h :coerce :boolean}}}
{:cmds ["opencode"] :fn #(handle-run % "opencode") :spec {:help {:alias :h :coerce :boolean}}}
```

**Fixed:**
```clojure
{:cmds ["claude"] :fn #(handle-run % "claude") :spec {:help {:alias :h :coerce :boolean}} :restrict false}
{:cmds ["opencode"] :fn #(handle-run % "opencode") :spec {:help {:alias :h :coerce :boolean}} :restrict false}
```

**Verification:**
```bash
# Should pass --version to claude, not reject it
./aishell.clj claude --version

# Should pass arbitrary args
./aishell.clj claude --model opus --help
```

## Commits

```
fix(16): support array format for env config and pass-through args

1. build-env-args now handles both map and array formats:
   - Map: env: {FOO: bar}
   - Array: env: [FOO=bar]

2. claude/opencode commands now pass-through all args to harness:
   - Added :restrict false to dispatch entries
```

## Success Criteria

- [ ] Array format `env: [FOO=bar]` works
- [ ] Map format `env: {FOO: bar}` still works
- [ ] Passthrough env (array): `env: [FOO]` passes $FOO from host
- [ ] Passthrough env (map): `env: {FOO:}` passes $FOO from host
- [ ] Missing passthrough vars show warning
- [ ] `./aishell.clj claude --version` passes --version to claude
- [ ] `./aishell.clj opencode --help` passes --help to opencode
