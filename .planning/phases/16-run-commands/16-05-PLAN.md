---
phase: 16-run-commands
plan: 05
type: gap_closure
source: 16-UAT.md
gaps_addressed: [9, 10]
---

# Phase 16 Plan 05: Fix pass-through args for harness commands

**Goal:** Make `./aishell.clj claude --help` and `./aishell.clj opencode --version` (and all other args) pass through to the harness instead of being parsed/dropped by babashka.cli.

## Root Cause

babashka.cli's dispatch mechanism:
1. Parses `--help` because it's in the spec, triggers aishell's help
2. With `:restrict false`, drops unknown options like `--version` instead of passing to args

## Fix Strategy

Handle claude/opencode commands BEFORE cli/dispatch so all args pass through verbatim to run-container.

## Tasks

### Task 1: Modify dispatch to handle pass-through commands first

**File:** `src/aishell/cli.clj`

**Change dispatch function from:**
```clojure
(defn dispatch [args]
  (cli/dispatch dispatch-table args {:error-fn handle-error
                                      :restrict true}))
```

**To:**
```clojure
(defn dispatch [args]
  ;; Handle pass-through commands before standard dispatch
  ;; This ensures all args (including --help, --version) go to the harness
  (case (first args)
    "claude" (run/run-container "claude" (vec (rest args)))
    "opencode" (run/run-container "opencode" (vec (rest args)))
    ;; Standard dispatch for other commands
    (cli/dispatch dispatch-table args {:error-fn handle-error
                                        :restrict true})))
```

**Rationale:** By checking for claude/opencode before cli/dispatch, we bypass babashka.cli's option parsing entirely and pass ALL remaining args directly to the harness.

### Task 2: Remove unused dispatch entries

**File:** `src/aishell/cli.clj`

**Change dispatch-table from:**
```clojure
(def dispatch-table
  [{:cmds ["build"] :fn handle-build :spec build-spec :restrict true}
   {:cmds ["claude"] :fn #(handle-run % "claude") :spec {:help {:alias :h :coerce :boolean}} :restrict false}
   {:cmds ["opencode"] :fn #(handle-run % "opencode") :spec {:help {:alias :h :coerce :boolean}} :restrict false}
   {:cmds [] :spec global-spec :fn handle-default}])
```

**To:**
```clojure
(def dispatch-table
  [{:cmds ["build"] :fn handle-build :spec build-spec :restrict true}
   {:cmds [] :spec global-spec :fn handle-default}])
```

**Rationale:** The claude/opencode entries are now handled before dispatch, so these entries are dead code.

### Task 3: Remove unused handle-run function

**File:** `src/aishell/cli.clj`

Delete the `handle-run` function (lines 128-150) as it's no longer used.

**Rationale:** With pass-through commands handled in dispatch, handle-run is dead code.

## Verification

```bash
# Test pass-through args
./aishell.clj claude --help     # Should show Claude's help, not aishell's
./aishell.clj claude --version  # Should show Claude's version
./aishell.clj opencode --help   # Should show OpenCode's help
./aishell.clj opencode --version # Should show OpenCode's version

# Test normal operation still works
./aishell.clj --help            # Should show aishell help
./aishell.clj build --help      # Should show build help
./aishell.clj                   # Should enter shell
./aishell.clj claude            # Should run Claude
```

## Commit Message

```
fix(16-05): pass all args through to harness commands

Handle claude/opencode commands before cli/dispatch to ensure
--help, --version, and all other args reach the harness instead
of being parsed/dropped by babashka.cli.

Closes gaps from UAT tests 9, 10.
```
