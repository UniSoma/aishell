---
phase: 01-core-container-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - aishell
autonomous: true
must_haves:
  truths:
    - "User can run aishell command from any directory"
    - "aishell builds image automatically if not present"
    - "aishell shows spinner during image build"
    - "aishell displays clear errors when Docker not running"
    - "aishell supports -v/--verbose, -h/--help, --version flags"
  artifacts:
    - path: "aishell"
      provides: "Main CLI entry point"
      contains: "docker run --rm -it"
      min_lines: 80
  key_links:
    - from: "aishell"
      to: "docker"
      via: "subprocess call"
      pattern: "docker (run|build|info)"
    - from: "aishell"
      to: "Dockerfile"
      via: "docker build context"
      pattern: 'docker build.*"\$script_dir"'
---

<objective>
Create the aishell CLI script: a Bash tool that builds and launches ephemeral Docker containers with the current directory mounted at the exact same path.

Purpose: This is the user-facing tool that orchestrates container creation with proper UID/GID mapping and volume mounts.

Output: Single executable Bash script `aishell` in project root.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-container-foundation/01-CONTEXT.md
@.planning/phases/01-core-container-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create aishell CLI script with Docker integration</name>
  <files>aishell</files>
  <action>
Create `aishell` executable Bash script in project root:

**Header and globals:**
- Shebang: `#!/bin/bash`
- `set -e` for exit on error
- VERSION="0.1.0"
- IMAGE_NAME="aishell"
- VERBOSE=false

**Color support detection (per research):**
```bash
supports_color() {
    [[ ! -t 1 ]] && return 1
    [[ -n "$NO_COLOR" ]] && return 1
    [[ -n "$FORCE_COLOR" ]] && return 0
    local colors
    colors=$(tput colors 2>/dev/null) || return 1
    [[ "$colors" -ge 8 ]]
}
```
Set RED, YELLOW, NC (no color) based on supports_color result.

**Output functions:**
- `error()` - Print red "Error:" prefix, message to stderr, exit 1
- `warn()` - Print yellow "Warning:" prefix, message to stderr
- `verbose()` - Print only if VERBOSE=true, to stderr

**Spinner functions (write to stderr, check TTY):**
- `start_spinner()` - Background process with spin chars `|/-\`
- `stop_spinner()` - Kill spinner process, clear line
- Use trap to stop spinner on EXIT

**Docker checks:**
- `check_docker()`:
  - Check `command -v docker` exists, error if not
  - Check `docker info >/dev/null 2>&1`, error if daemon not running
  - Error messages per CONTEXT.md: simple and clear

**Argument parsing:**
- `usage()` - Print help text
- `parse_args()` - Handle:
  - `-v|--verbose` - Set VERBOSE=true
  - `-h|--help` - Print usage, exit 0
  - `--version` - Print version, exit 0
  - Unknown options - error with message

**Image management:**
- `ensure_image()`:
  - Check if image exists: `docker image inspect "$IMAGE_NAME" >/dev/null 2>&1`
  - If not, build from Dockerfile in script's directory
  - Get script directory: `$(dirname "$(readlink -f "$0")")`
  - Show spinner during build
  - Error if build fails

**Main function:**
1. Call parse_args "$@"
2. Call check_docker
3. Call ensure_image
4. Get project_dir with `$(pwd)`
5. verbose log: project dir and UID/GID
6. exec docker run with:
   - `--rm` (ephemeral - CORE-02)
   - `-it` (interactive TTY)
   - `-v "$project_dir:$project_dir"` (same path mount - CORE-01)
   - `-w "$project_dir"` (working directory)
   - `-e "LOCAL_UID=$(id -u)"` (for entrypoint - CORE-03)
   - `-e "LOCAL_GID=$(id -g)"` (for entrypoint - CORE-03)
   - `-e "TERM=${TERM:-xterm-256color}"` (terminal type)
   - `"$IMAGE_NAME"` (image name)

**Make executable:** The script itself needs chmod +x
  </action>
  <verify>
Run: `chmod +x aishell && ./aishell --help`
Expected: Shows usage information

Run: `./aishell --version`
Expected: Shows "aishell 0.1.0"

Run: `./aishell` (with Docker running)
Expected: Enters container shell with [aishell] prompt
  </verify>
  <done>
- aishell script exists in project root and is executable
- `./aishell --help` shows usage
- `./aishell --version` shows version
- Script detects missing Docker and shows clear error
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify file ownership and path mounting</name>
  <files></files>
  <action>
Test the complete integration to verify requirements are met:

1. **Test same-path mounting (CORE-01):**
   - Run aishell from a test directory
   - Inside container, run `pwd`
   - Verify output matches the host directory path exactly

2. **Test file ownership (CORE-03):**
   - Inside container, create a test file: `touch test-ownership-file`
   - Exit container
   - On host, check ownership: `ls -la test-ownership-file`
   - Verify UID/GID matches host user
   - Clean up: `rm test-ownership-file`

3. **Test ephemeral behavior (CORE-02):**
   - Run aishell, note container ID or create a marker
   - Exit container
   - Verify container no longer exists: `docker ps -a | grep aishell`

4. **Test sudo access (CORE-04):**
   - Inside container, run `sudo whoami`
   - Verify output is "root"

5. **Test tools available (CORE-05):**
   - Inside container, verify each tool exists:
     - `git --version`
     - `curl --version`
     - `vim --version`
     - `jq --version`
     - `rg --version`
  </action>
  <verify>
All tests pass as described in action section.
  </verify>
  <done>
- Files created in container have correct host UID/GID ownership
- Project mounted at exact same path as host
- Container is ephemeral (removed on exit)
- sudo works inside container
- All required tools (git, curl, vim, jq, ripgrep) available
  </done>
</task>

</tasks>

<verification>
Complete end-to-end verification:

```bash
# 1. Test CLI flags
./aishell --help
./aishell --version

# 2. Test Docker detection (stop Docker first if safe to do so)
# systemctl stop docker && ./aishell  # Should show clear error
# systemctl start docker

# 3. Test same-path mounting
echo "Testing path mounting..."
./aishell -c 'echo "Container pwd: $(pwd)"'
echo "Host pwd: $(pwd)"
# Both should match

# 4. Test file ownership
./aishell -c 'touch /tmp/test-from-container'
# Won't work - /tmp is container-local

cd /tmp && mkdir -p aishell-test && cd aishell-test
# Then run aishell and create file to test ownership

# 5. Interactive test
./aishell
# Should see [aishell] prompt
# Run: pwd (should match host)
# Run: touch testfile && exit
# On host: ls -la testfile (should show your UID/GID)
# Cleanup: rm testfile
```
</verification>

<success_criteria>
- [ ] `./aishell --help` displays usage information
- [ ] `./aishell --version` displays "aishell 0.1.0"
- [ ] `./aishell` enters container with [aishell] prompt
- [ ] `pwd` inside container matches host working directory exactly
- [ ] Files created in container appear on host with host user's UID/GID
- [ ] Container is removed automatically on exit (`docker ps -a` shows nothing)
- [ ] `sudo whoami` inside container returns "root"
- [ ] git, curl, vim, jq, rg all available inside container
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-container-foundation/01-02-SUMMARY.md`
</output>
