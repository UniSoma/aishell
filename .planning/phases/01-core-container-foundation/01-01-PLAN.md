---
phase: 01-core-container-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - entrypoint.sh
  - bashrc.aishell
autonomous: true
must_haves:
  truths:
    - "Container image builds successfully with docker build"
    - "gosu is installed and functional in the image"
    - "Basic tools (git, curl, vim, jq, ripgrep, sudo) are available in image"
    - "Entrypoint can create dynamic user matching host UID/GID"
    - "Shell prompt clearly indicates user is inside aishell container"
  artifacts:
    - path: "Dockerfile"
      provides: "Base image definition with tools and gosu"
      contains: "FROM debian:bookworm-slim"
    - path: "entrypoint.sh"
      provides: "Dynamic user creation and gosu exec"
      contains: "exec gosu"
    - path: "bashrc.aishell"
      provides: "Custom PS1 prompt for container"
      contains: "[aishell]"
  key_links:
    - from: "Dockerfile"
      to: "entrypoint.sh"
      via: "COPY and ENTRYPOINT"
      pattern: "COPY entrypoint.sh"
    - from: "Dockerfile"
      to: "bashrc.aishell"
      via: "COPY to /etc"
      pattern: "COPY bashrc.aishell"
    - from: "entrypoint.sh"
      to: "gosu"
      via: "exec command"
      pattern: "exec gosu"
---

<objective>
Create the Docker image foundation for aishell: a Debian-based container with dynamic user creation, gosu for proper user switching, and basic development tools.

Purpose: This establishes the container infrastructure that the CLI will use to launch ephemeral development environments with correct file permissions.

Output: Three files (Dockerfile, entrypoint.sh, bashrc.aishell) that together define a buildable Docker image.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-container-foundation/01-CONTEXT.md
@.planning/phases/01-core-container-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile with base image and tools</name>
  <files>Dockerfile</files>
  <action>
Create Dockerfile in project root with:

1. Base image: `debian:bookworm-slim` (not Alpine - glibc compatibility per research)

2. Install packages in single layer (minimize image size):
   - bash, ca-certificates, curl (essentials)
   - git, vim, jq, ripgrep (CORE-05 tools)
   - sudo (CORE-04 - sudo access)
   - less (for paging)

3. Install gosu 1.19 for user switching:
   - Download from official GitHub release for correct architecture
   - Use `dpkg --print-architecture` to get arch (amd64, arm64)
   - Make executable and verify with `gosu --version` and `gosu nobody true`
   - Do NOT verify GPG signature (adds complexity, gosu repo recommends but optional)

4. Copy entrypoint.sh to /usr/local/bin/ and make executable

5. Copy bashrc.aishell to /etc/bash.aishell

6. Set ENTRYPOINT to entrypoint.sh, CMD to /bin/bash

Use `ENV DEBIAN_FRONTEND=noninteractive` to avoid apt prompts.
Clean apt cache with `rm -rf /var/lib/apt/lists/*` after install.
  </action>
  <verify>
Run: `docker build -t aishell:test .`
Expected: Build completes successfully, outputs image ID
  </verify>
  <done>
Dockerfile exists in project root and `docker build -t aishell:test .` succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Create entrypoint.sh and bashrc.aishell</name>
  <files>entrypoint.sh, bashrc.aishell</files>
  <action>
Create entrypoint.sh in project root:

1. Shebang: `#!/bin/bash` with `set -e`

2. Read LOCAL_UID and LOCAL_GID from environment (default to 1000 if not set)

3. Create group if GID doesn't exist:
   - Use `getent group "$GROUP_ID"` to check
   - Use `groupadd -g "$GROUP_ID" developer` if needed
   - Suppress errors with `2>/dev/null || true` (group might exist with different name)

4. Create user if UID doesn't exist:
   - Use `getent passwd "$USER_ID"` to check
   - Use `useradd --shell /bin/bash -u "$USER_ID" -g "$GROUP_ID" -o -c "Container User" -m developer`
   - The `-o` flag allows non-unique UID (in case UID exists with different name)
   - Suppress errors with `2>/dev/null || true`

5. Get actual username for the UID (might be different if user already existed):
   - `ACTUAL_USER=$(getent passwd "$USER_ID" | cut -d: -f1)`

6. Ensure home directory exists and has correct ownership:
   - `export HOME=$(getent passwd "$USER_ID" | cut -d: -f6)`
   - `mkdir -p "$HOME"`
   - `chown "$USER_ID:$GROUP_ID" "$HOME"`

7. Setup passwordless sudo:
   - `echo "$ACTUAL_USER ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/developer`
   - `chmod 0440 /etc/sudoers.d/developer`

8. Source custom bashrc if starting bash:
   - Check if `$1` is `/bin/bash` or `bash`
   - Append `source /etc/bash.aishell` to `$HOME/.bashrc`

9. Execute command as user via gosu:
   - `exec gosu "$USER_ID:$GROUP_ID" "$@"`

Create bashrc.aishell in project root:

1. Custom PS1 prompt: `\[\033[0;36m\][aishell]\[\033[0m\] \w \$ `
   - Cyan `[aishell]` prefix, then working directory, then `$`

2. Useful aliases:
   - `alias ll='ls -la'`
   - `alias la='ls -A'`
   - `alias ls='ls --color=auto'`
   - `alias grep='grep --color=auto'`

3. Editor settings:
   - `export EDITOR=vim`
   - `export VISUAL=vim`

4. History settings:
   - `export HISTSIZE=10000`
   - `export HISTFILESIZE=20000`
   - `export HISTCONTROL=ignoreboth:erasedups`
  </action>
  <verify>
Run: `docker build -t aishell:test . && docker run --rm -it -e LOCAL_UID=$(id -u) -e LOCAL_GID=$(id -g) aishell:test whoami`
Expected: Outputs a username (not "root")
Run: `docker run --rm -it -e LOCAL_UID=$(id -u) -e LOCAL_GID=$(id -g) aishell:test bash -c 'echo $PS1'`
Expected: Output contains "[aishell]"
  </verify>
  <done>
- entrypoint.sh exists and is executable in Dockerfile
- bashrc.aishell exists and sets custom prompt
- Container runs as non-root user matching host UID
- Shell prompt shows [aishell] prefix
  </done>
</task>

</tasks>

<verification>
Build and test the image:

```bash
# Build image
docker build -t aishell:test .

# Verify non-root user with matching UID
docker run --rm -e LOCAL_UID=$(id -u) -e LOCAL_GID=$(id -g) aishell:test id
# Expected: uid matches host uid, gid matches host gid

# Verify sudo works
docker run --rm -e LOCAL_UID=$(id -u) -e LOCAL_GID=$(id -g) aishell:test sudo whoami
# Expected: root

# Verify tools installed
docker run --rm -e LOCAL_UID=$(id -u) -e LOCAL_GID=$(id -g) aishell:test bash -c 'git --version && curl --version | head -1 && vim --version | head -1 && jq --version && rg --version'
# Expected: Version output for each tool

# Verify custom prompt (interactive)
docker run --rm -it -e LOCAL_UID=$(id -u) -e LOCAL_GID=$(id -g) aishell:test
# Expected: Prompt shows [aishell] prefix
```
</verification>

<success_criteria>
- [ ] Dockerfile builds successfully without errors
- [ ] Container runs as non-root user with UID/GID matching LOCAL_UID/LOCAL_GID env vars
- [ ] User has passwordless sudo access inside container
- [ ] All required tools available: git, curl, vim, jq, ripgrep, sudo
- [ ] Shell prompt displays [aishell] prefix in cyan
- [ ] gosu is installed and functional
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-container-foundation/01-01-SUMMARY.md`
</output>
