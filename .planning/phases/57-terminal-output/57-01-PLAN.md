---
phase: 57-terminal-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/output.clj
  - src/aishell/detection/formatters.clj
  - src/aishell/check.clj
autonomous: true

must_haves:
  truths:
    - "NO_COLOR=1 disables all ANSI color output across all modules"
    - "FORCE_COLOR=1 enables colors even when piped or redirected"
    - "Windows Terminal (WT_SESSION set) gets colored output"
    - "Legacy cmd.exe without WT_SESSION or COLORTERM gets plain text"
    - "Piped output (System/console nil) has no ANSI codes unless FORCE_COLOR set"
    - "All modules use the same centralized color detection logic"
  artifacts:
    - path: "src/aishell/output.clj"
      provides: "Standards-compliant colors-enabled? with NO_COLOR, FORCE_COLOR, WT_SESSION, ConEmuANSI detection"
      contains: "defn colors-enabled?"
    - path: "src/aishell/detection/formatters.clj"
      provides: "DIM color using centralized detection"
      contains: "output/colors-enabled?"
    - path: "src/aishell/check.clj"
      provides: "GREEN color using centralized detection"
      contains: "output/colors-enabled?"
  key_links:
    - from: "src/aishell/detection/formatters.clj"
      to: "src/aishell/output.clj"
      via: "output/colors-enabled? call for DIM definition"
      pattern: "output/colors-enabled?"
    - from: "src/aishell/check.clj"
      to: "src/aishell/output.clj"
      via: "output/colors-enabled? call for GREEN definition"
      pattern: "output/colors-enabled?"
---

<objective>
Enhance ANSI color detection to support Windows terminals and community standards (NO_COLOR/FORCE_COLOR), then centralize all color detection through a single public function.

Purpose: Windows terminals (Windows Terminal, ConEmu) support ANSI colors but are not detected by the current Unix-focused `colors-enabled?`. The NO_COLOR/FORCE_COLOR community standards (500+ CLI tools) are not properly implemented (empty string handling, priority ordering). Multiple modules use inconsistent inline `(System/console)` checks instead of the centralized function.

Output: All 3 files updated with consistent, standards-compliant color detection.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-terminal-output/57-RESEARCH.md
@src/aishell/output.clj
@src/aishell/detection/formatters.clj
@src/aishell/check.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance colors-enabled? with standards-compliant detection and Windows support</name>
  <files>src/aishell/output.clj</files>
  <action>
In `src/aishell/output.clj`:

1. Add `[babashka.fs :as fs]` to the namespace `:require` vector (alongside existing `[clojure.string :as str]`).

2. Replace the existing `colors-enabled?` function (currently `defn-`, lines 6-10) with a **public** `defn` version implementing this logic:

```clojure
(defn colors-enabled?
  "Detect if ANSI colors should be used in output.
   Priority: NO_COLOR (opt-out) > FORCE_COLOR (opt-in) > auto-detection.
   Auto-detection checks System/console, COLORTERM, WT_SESSION (Windows Terminal),
   ConEmuANSI (ConEmu), and TERM (Unix)."
  []
  (let [no-color (System/getenv "NO_COLOR")
        force-color (System/getenv "FORCE_COLOR")]
    (cond
      ;; User opt-out (highest priority, non-empty string per spec)
      (and no-color (not= "" no-color))
      false

      ;; User opt-in (overrides auto-detection)
      (and force-color (not= "" force-color))
      true

      ;; Auto-detection fallback
      :else
      (and
        ;; Must be interactive terminal (null when piped/redirected)
        (some? (System/console))
        ;; Terminal must support colors
        (or
          ;; Explicit color capability (modern terminals)
          (some? (System/getenv "COLORTERM"))
          ;; Windows Terminal (ANSI-capable)
          (and (fs/windows?)
               (some? (System/getenv "WT_SESSION")))
          ;; ConEmu with ANSI enabled
          (and (fs/windows?)
               (= "ON" (System/getenv "ConEmuANSI")))
          ;; Unix with standard TERM variable (not dumb)
          (and (not (fs/windows?))
               (let [term (System/getenv "TERM")]
                 (and term (not= "dumb" term)))))))))
```

Key changes from current implementation:
- `defn-` changed to `defn` (public for cross-module use)
- NO_COLOR checks for non-empty string (not just presence) per NO_COLOR spec
- FORCE_COLOR added as opt-in that overrides auto-detection (bypasses System/console check)
- Windows Terminal detection via `WT_SESSION` environment variable
- ConEmu detection via `ConEmuANSI=ON`
- Unix TERM check only applies on non-Windows (Windows doesn't set TERM)
- `babashka.fs/windows?` used for platform detection (established pattern from Phases 53-56)

The color `def` constants (RED, YELLOW, CYAN, BOLD, NC) on lines 12-16 remain unchanged — they already call `(colors-enabled?)`.
  </action>
  <verify>
Load the file in a Babashka REPL or use `bb -e "(load-file \"src/aishell/output.clj\")"` to verify it parses without errors. Confirm `colors-enabled?` is public by checking it resolves as `aishell.output/colors-enabled?`.
  </verify>
  <done>
`colors-enabled?` is public, uses `babashka.fs/windows?` for platform detection, implements NO_COLOR > FORCE_COLOR > auto-detection priority, and detects WT_SESSION and ConEmuANSI on Windows.
  </done>
</task>

<task type="auto">
  <name>Task 2: Centralize color detection in formatters.clj and check.clj</name>
  <files>src/aishell/detection/formatters.clj, src/aishell/check.clj</files>
  <action>
**In `src/aishell/detection/formatters.clj`** (line 8):

Replace the DIM definition that uses inline `(System/console)` check:
```clojure
;; BEFORE:
(def ^:private DIM (if (some? (System/console)) "\u001b[2m" ""))

;; AFTER:
(def ^:private DIM (if (output/colors-enabled?) "\u001b[2m" ""))
```

No namespace require changes needed — `aishell.output` is already required as `output`.

**In `src/aishell/check.clj`** (line 20):

Replace the GREEN definition that uses inline `(System/console)` check:
```clojure
;; BEFORE:
(def GREEN (if (some? (System/console)) "\u001b[0;32m" ""))

;; AFTER:
(def GREEN (if (output/colors-enabled?) "\u001b[0;32m" ""))
```

No namespace require changes needed — `aishell.output` is already required as `output`.

**Do NOT change `src/aishell/docker/spinner.clj`** — its `(System/console)` check is for TTY detection (spinner display), not color detection. Different concern.
  </action>
  <verify>
1. Load both files: `bb -e "(load-file \"src/aishell/detection/formatters.clj\")"` and `bb -e "(load-file \"src/aishell/check.clj\")"` — both must parse without errors.
2. Grep for remaining inline `(System/console)` color checks: `grep -rn "System/console" src/aishell/detection/formatters.clj src/aishell/check.clj` — should return zero matches (spinner.clj excluded from check).
3. Grep to confirm centralized detection: `grep -n "output/colors-enabled?" src/aishell/detection/formatters.clj src/aishell/check.clj` — should return matches in both files.
  </verify>
  <done>
Both `formatters.clj` and `check.clj` use `output/colors-enabled?` instead of inline `(System/console)` checks. All color detection in the codebase flows through the single centralized function in `output.clj`. Spinner.clj retains its separate TTY check (correct behavior).
  </done>
</task>

</tasks>

<verification>
1. **Syntax check:** `bb -e "(require 'aishell.output)" && bb -e "(require 'aishell.check)" && bb -e "(require 'aishell.detection.formatters)"` — all load without errors
2. **Public API:** `bb -e "(require 'aishell.output) (resolve 'aishell.output/colors-enabled?)"` — resolves (not nil)
3. **No inline color checks remain:** `grep -rn "(some? (System/console)).*\\\\u001b" src/aishell/` — zero matches for System/console used in color definitions (spinner.clj uses it for TTY, not color)
4. **Smoke test:** `bb -cp src -m aishell.core -- --help` — runs without crash
5. **NO_COLOR test:** `NO_COLOR=1 bb -cp src -m aishell.core -- --help` — output contains no ANSI escape codes
</verification>

<success_criteria>
- `colors-enabled?` is public and implements NO_COLOR > FORCE_COLOR > auto-detection priority
- Windows Terminal (WT_SESSION) and ConEmu (ConEmuANSI=ON) detected as ANSI-capable
- All ANSI color definitions across all 3 files use `output/colors-enabled?`
- No inline `(System/console)` checks for color decisions remain (spinner.clj excluded — different concern)
- `aishell --help` works without errors on current platform
</success_criteria>

<output>
After completion, create `.planning/phases/57-terminal-output/57-01-SUMMARY.md`
</output>
