---
phase: 39-state-schema-config-mounting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/cli.clj
  - src/aishell/state.clj
  - src/aishell/config.clj
autonomous: true

must_haves:
  truths:
    - "aishell build --with-tmux stores :with-tmux true in state.edn"
    - "aishell build without --with-tmux stores :with-tmux false in state.edn"
    - "tmux: section in config.yaml is accepted without unknown-key warning"
    - "tmux: section validates as map (warns if boolean or string)"
    - "tmux config merges as scalar replacement (project replaces global)"
  artifacts:
    - path: "src/aishell/cli.clj"
      provides: "--with-tmux flag parsing and state persistence"
      contains: ":with-tmux"
    - path: "src/aishell/state.clj"
      provides: "Updated state schema docs with :with-tmux"
      contains: ":with-tmux"
    - path: "src/aishell/config.clj"
      provides: "tmux config validation and merge strategy"
      contains: "validate-tmux-config"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/state.clj"
      via: "state/write-state with :with-tmux key"
      pattern: ":with-tmux"
    - from: "src/aishell/config.clj"
      to: "validate-tmux-config"
      via: "called from validate-config"
      pattern: "validate-tmux-config"
---

<objective>
Add --with-tmux CLI flag to build command and extend config schema for tmux section.

Purpose: Establishes the opt-in mechanism for tmux (TMUX-01, TMUX-02) and prepares the config schema for future plugin/resurrect settings (CONF-01 foundation). Without this, downstream phases cannot detect whether tmux is enabled.

Output: Modified cli.clj (flag parsing + state persistence), state.clj (schema docs), config.clj (tmux validation + merge)
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/39-state-schema-config-mounting/39-RESEARCH.md
@src/aishell/cli.clj
@src/aishell/state.clj
@src/aishell/config.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --with-tmux flag to CLI and persist in state</name>
  <files>src/aishell/cli.clj, src/aishell/state.clj</files>
  <action>
In cli.clj:

1. Add `:with-tmux` to `build-spec` (line ~67-75). Use same pattern as `--without-gitleaks` since tmux is a simple boolean toggle (not versioned like harnesses). Add it as:
   ```
   :with-tmux {:coerce :boolean :desc "Enable tmux multiplexer in container"}
   ```
   Note: Do NOT use parse-with-flag pattern (that's for versioned harnesses). This is a simple boolean like gitleaks.

2. In `handle-build` (line ~150), after the gitleaks flag parsing (line ~158):
   - Add: `with-tmux (boolean (:with-tmux opts))` -- default false when flag absent (requirements say "default behavior is no tmux")

3. In the `state-map` construction (line ~177-185), add:
   ```
   :with-tmux with-tmux
   ```

4. In `print-build-help` (line ~132-148), add an example:
   ```
   aishell build --with-claude --with-tmux    Include Claude + tmux
   ```

5. In `handle-update` (line ~268), the state is read from existing state.edn and written back. No change needed -- :with-tmux will round-trip naturally since it's already in state. But verify the "Show what we're updating" section (line ~282-289) by adding tmux status display:
   ```
   (when (:with-tmux state)
     (println "  tmux: enabled"))
   ```

In state.clj:

6. Update the write-state docstring schema (line ~25-40) to add:
   ```
   :with-tmux false             ; boolean (whether tmux enabled, default false)
   ```
   Place it after the `:with-gitleaks` line.

IMPORTANT: The default for :with-tmux is FALSE (not true). The requirements (TMUX-01) explicitly say "default behavior is no tmux". The research recommended true for backward compat, but the requirements override research. Follow requirements.
  </action>
  <verify>
Run `bb -cp src -e "(require '[aishell.cli :as cli]) (println (:with-tmux (:spec (first cli/dispatch-table))))"` -- should not error.

Grep for `:with-tmux` in cli.clj -- should appear in build-spec, handle-build state-map, and handle-update display.

Grep for `:with-tmux` in state.clj -- should appear in docstring.
  </verify>
  <done>
--with-tmux flag accepted by build command. :with-tmux boolean persisted to state.edn (false when omitted, true when flag present). Update command displays tmux status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend config schema with tmux section validation and merge</name>
  <files>src/aishell/config.clj</files>
  <action>
In config.clj:

1. Add `:tmux` to `known-keys` set (line 11):
   ```clojure
   #{:mounts :env :ports :docker_args :pre_start :extends :harness_args :gitleaks_freshness_check :detection :tmux}
   ```

2. Add `validate-tmux-config` function after `validate-detection-config` (after line 93). Follow the same validation pattern:
   ```clojure
   (defn validate-tmux-config
     "Validate tmux config structure. Warns on invalid format.
      Expected: map with optional keys like :plugins, :resurrect.
      Returns config unchanged."
     [tmux-config source-path]
     (when tmux-config
       (when-not (map? tmux-config)
         (output/warn (str "Invalid tmux section in " source-path
                          ": expected map, got " (type tmux-config)
                          "\nExample:\n  tmux:\n    plugins:\n      - tmux-plugins/tmux-sensible"))))
     tmux-config)
   ```

3. In `validate-config` (line ~95-109), add tmux validation after the detection validation call (after line 108):
   ```clojure
   (when-let [tmux (:tmux config)]
     (validate-tmux-config tmux source-path))
   ```

4. Also update the warning message in validate-config (line 104) to include "tmux" in the valid keys list string.

5. In `merge-configs` (line ~142-205), add `:tmux` to the `scalar-keys` set (line 154):
   ```clojure
   scalar-keys #{:pre_start :gitleaks_freshness_check :tmux}
   ```
   This ensures project tmux config fully replaces global tmux config (not concatenated).
  </action>
  <verify>
Run `bb -cp src -e "(require '[aishell.config :as config]) (println (config/validate-tmux-config {:plugins ['a']} 'test.yaml'))"` -- should return the config without warning.

Run `bb -cp src -e "(require '[aishell.config :as config]) (config/validate-tmux-config true 'test.yaml')"` -- should print a warning about expected map.

Grep for `:tmux` in config.clj -- should appear in known-keys, scalar-keys, validate-config, and validate-tmux-config.
  </verify>
  <done>
Config.yaml accepts tmux: section without unknown-key warning. Invalid tmux format (non-map) produces helpful warning. Project tmux config replaces global via scalar merge strategy.
  </done>
</task>

</tasks>

<verification>
1. `:with-tmux` appears in cli.clj build-spec
2. `:with-tmux` persisted to state-map in handle-build
3. `:tmux` in config.clj known-keys
4. `validate-tmux-config` callable and validates map type
5. `:tmux` in scalar-keys for merge-configs
6. State schema docstring updated
</verification>

<success_criteria>
- `aishell build --with-tmux --with-claude` would store {:with-tmux true, :with-claude true, ...} in state.edn
- `aishell build --with-claude` would store {:with-tmux false, :with-claude true, ...} in state.edn
- A config.yaml with `tmux: {plugins: [...]}` loads without warnings
- A config.yaml with `tmux: true` (scalar) produces a validation warning
- Project tmux config replaces (not merges with) global tmux config
</success_criteria>

<output>
After completion, create `.planning/phases/39-state-schema-config-mounting/39-01-SUMMARY.md`
</output>
