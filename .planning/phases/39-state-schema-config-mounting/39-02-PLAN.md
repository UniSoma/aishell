---
phase: 39-state-schema-config-mounting
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - src/aishell/docker/run.clj
  - src/aishell/run.clj
autonomous: true

must_haves:
  truths:
    - "User's ~/.tmux.conf is mounted read-only into container when :with-tmux is true in state"
    - "Missing ~/.tmux.conf on host does not cause error or warning"
    - "User who explicitly mounted .tmux.conf in config mounts does not get duplicate mount"
    - "Container runs without tmux mount when :with-tmux is false"
  artifacts:
    - path: "src/aishell/docker/run.clj"
      provides: "Conditional tmux config mount with collision detection"
      contains: "build-tmux-config-mount"
    - path: "src/aishell/run.clj"
      provides: "State passed to docker-run for tmux mount decision"
      contains: ":with-tmux"
  key_links:
    - from: "src/aishell/docker/run.clj"
      to: "state :with-tmux"
      via: "get state :with-tmux in build-tmux-config-mount"
      pattern: "get state :with-tmux"
    - from: "src/aishell/docker/run.clj"
      to: "fs/exists?"
      via: "check ~/.tmux.conf exists before mounting"
      pattern: "fs/exists\\?"
    - from: "src/aishell/run.clj"
      to: "src/aishell/docker/run.clj"
      via: "passes state to build-docker-args for tmux mount"
      pattern: "build-docker-args"
---

<objective>
Add conditional read-only mounting of ~/.tmux.conf into container when tmux is enabled.

Purpose: Implements CONF-01 (mount user tmux config) and CONF-02 (graceful handling of missing config). This is the runtime wiring that makes the opt-in flag from Plan 01 actually affect container behavior.

Output: Modified docker/run.clj (mount function + integration), run.clj (state threading)
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/39-state-schema-config-mounting/39-RESEARCH.md
@.planning/phases/39-state-schema-config-mounting/39-01-SUMMARY.md
@src/aishell/docker/run.clj
@src/aishell/run.clj
@src/aishell/config.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add conditional tmux config mount to docker/run.clj</name>
  <files>src/aishell/docker/run.clj</files>
  <action>
In docker/run.clj:

1. Add `clojure.string` alias if not already available (check requires -- it's already required as `str`).

2. Add a private helper function `user-mounted-tmux-config?` (after `build-harness-config-mounts`, around line 166):
   ```clojure
   (defn- user-mounted-tmux-config?
     "Check if user explicitly mounted .tmux.conf in their config mounts.
      Prevents duplicate mount when auto-mount would also add it."
     [config]
     (let [mounts (get config :mounts [])]
       (some #(str/includes? (str %) ".tmux.conf") mounts)))
   ```

3. Add `build-tmux-config-mount` function (after the helper above):
   ```clojure
   (defn- build-tmux-config-mount
     "Build mount args for ~/.tmux.conf if tmux is enabled and file exists.
      Mounts read-only to prevent container from modifying host config.
      Skips if user already mounted .tmux.conf explicitly in config.
      Returns vector of ['-v' 'path:path:ro'] or empty vector."
     [state config]
     (if (and (get state :with-tmux)
              (not (user-mounted-tmux-config? config)))
       (let [home (util/get-home)
             host-path (str home "/.tmux.conf")]
         (if (fs/exists? host-path)
           ["-v" (str host-path ":" host-path ":ro")]
           []))
       []))
   ```

   IMPORTANT: Use `(get state :with-tmux)` NOT `(get state :with-tmux true)`. Default is false (no tmux unless explicitly enabled). A nil/missing :with-tmux in old state files means tmux is disabled.

4. In `build-docker-args-internal` (line ~202), the function needs access to both `state` and `config`. Currently it receives config but not state. Add `:state` to the destructuring (line 205):
   ```clojure
   [{:keys [project-dir image-tag config state git-identity skip-pre-start detach container-name tty-flags harness-volume-name]}]
   ```

5. In the threading form inside `build-docker-args-internal` (around line 244-245, after harness volume mount), add the tmux config mount:
   ```clojure
   ;; Tmux config mount (read-only, if enabled and file exists)
   (into (build-tmux-config-mount state config))
   ```
   Place this BEFORE the config mounts section (before line 249) so user explicit mounts come after and can override.

6. Update `build-docker-args` (line ~277) to pass `:state` through:
   Add `:state state` to the map passed to `build-docker-args-internal`. This means the caller must provide it.

7. Update `build-docker-args-for-exec` (line ~303) similarly -- add `:state state` to the internal call map.
  </action>
  <verify>
Grep for `build-tmux-config-mount` in docker/run.clj -- should appear as defn and in build-docker-args-internal.

Grep for `:state` in the build-docker-args and build-docker-args-for-exec function signatures -- should be in destructuring.

Grep for `user-mounted-tmux-config?` -- should appear as defn and called from build-tmux-config-mount.
  </verify>
  <done>
build-tmux-config-mount exists and is called from build-docker-args-internal. Mounts ~/.tmux.conf:ro when :with-tmux true AND file exists AND not already user-mounted. Returns empty vector otherwise.
  </done>
</task>

<task type="auto">
  <name>Task 2: Thread state through callers for tmux mount</name>
  <files>src/aishell/run.clj</files>
  <action>
In run.clj, update the callers of `build-docker-args` and `build-docker-args-for-exec` to pass `:state`:

1. In `run-container` (line ~194-202), the call to `docker-run/build-docker-args` already has access to `state` (bound at line 104). Add `:state state` to the options map:
   ```clojure
   (docker-run/build-docker-args
     {:project-dir project-dir
      :image-tag image-tag
      :config cfg
      :git-identity git-id
      :skip-pre-start (:skip-pre-start opts)
      :detach (:detach opts)
      :container-name container-name-str
      :harness-volume-name harness-volume-name
      :state state})
   ```

2. In `run-exec` (line ~302-308), similarly add `:state state` to the call to `docker-run/build-docker-args-for-exec`:
   ```clojure
   (docker-run/build-docker-args-for-exec
     {:project-dir project-dir
      :image-tag image-tag
      :config cfg
      :git-identity git-id
      :tty? tty?
      :harness-volume-name harness-volume-name
      :state state})
   ```

Both functions already have `state` in scope from their let bindings, so this is just passing the existing value through.
  </action>
  <verify>
Grep for `:state state` in run.clj -- should appear in both run-container and run-exec function bodies.

Run `bb -cp src -e "(require '[aishell.docker.run])"` to verify the namespace loads without errors (syntax check).
  </verify>
  <done>
State is threaded from run.clj through to docker/run.clj. When :with-tmux is true in state and ~/.tmux.conf exists, it will be mounted read-only. When false or missing, no mount occurs. When user has explicit .tmux.conf mount in config, auto-mount is skipped.
  </done>
</task>

</tasks>

<verification>
1. `build-tmux-config-mount` function exists in docker/run.clj
2. `user-mounted-tmux-config?` collision detection works
3. State is passed through from run.clj -> docker/run.clj
4. `:ro` flag present on tmux config mount
5. `fs/exists?` check prevents mount of missing file
6. Missing :with-tmux in state defaults to falsy (no mount)
</verification>

<success_criteria>
- With :with-tmux true and ~/.tmux.conf exists: mount appears in docker args as "-v /home/user/.tmux.conf:/home/user/.tmux.conf:ro"
- With :with-tmux true and no ~/.tmux.conf: no mount, no error
- With :with-tmux false: no mount regardless of file existence
- With :with-tmux true but user has "~/.tmux.conf" in config mounts: auto-mount skipped (no duplicate)
- Old state.edn without :with-tmux key: no mount (falsy default)
</success_criteria>

<output>
After completion, create `.planning/phases/39-state-schema-config-mounting/39-02-SUMMARY.md`
</output>
