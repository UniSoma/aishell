---
phase: 56-process-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/attach.clj
  - src/aishell/run.clj
autonomous: true

must_haves:
  truths:
    - "aishell attach <name> transfers terminal control to container bash on Windows via p/process :inherit"
    - "aishell <harness> starts container and transfers terminal control on Windows via p/process :inherit"
    - "Exit codes propagate from Docker to parent shell on Windows via System/exit"
    - "Unix behavior unchanged — still uses p/exec for clean process replacement"
  artifacts:
    - path: "src/aishell/attach.clj"
      provides: "Cross-platform attach-to-container with p/process :inherit on Windows"
      contains: "p/process {:inherit true}"
    - path: "src/aishell/run.clj"
      provides: "Cross-platform run-container with p/process :inherit on Windows"
      contains: "p/process {:inherit true}"
  key_links:
    - from: "src/aishell/attach.clj"
      to: "babashka.process/process"
      via: "platform-conditional execution"
      pattern: "fs/windows\\?"
    - from: "src/aishell/run.clj"
      to: "babashka.process/process"
      via: "platform-conditional execution"
      pattern: "fs/windows\\?"
---

<objective>
Replace Windows platform guard exceptions in attach.clj and run.clj with working cross-platform process execution using `p/process {:inherit true}` + `System/exit` exit code propagation.

Purpose: Enable `aishell attach` and `aishell <harness>` commands to work on Windows by spawning Docker as a child process with inherited stdin/stdout/stderr, achieving identical UX to Unix's `p/exec` process replacement.

Output: Two modified files with cross-platform execution paths — `p/exec` on Unix (clean process tree), `p/process :inherit` on Windows (child process with exit code propagation).
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-process-execution/56-RESEARCH.md
@.planning/phases/53-platform-detection/53-01-SUMMARY.md
@src/aishell/attach.clj
@src/aishell/run.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace Windows guard in attach.clj with p/process :inherit</name>
  <files>src/aishell/attach.clj</files>
  <action>
In `src/aishell/attach.clj`, replace the Windows platform guard (lines 66-68) that throws an ex-info with a working `p/process {:inherit true}` execution path.

Current code (lines 66-68):
```clojure
(if (fs/windows?)
  (throw (ex-info "Process replacement (p/exec) not supported on Windows. See: Phase 56 (Process & Execution)"
                  {:platform :windows}))
  (p/exec "docker" "exec" "-it" ...))
```

Replace with:
```clojure
(if (fs/windows?)
  ;; Windows: spawn child process with inherited I/O, wait, propagate exit
  (let [result @(p/process {:inherit true}
                           "docker" "exec" "-it" "-u" "developer"
                           "-e" (str "TERM=" term)
                           "-e" (str "COLORTERM=" colorterm)
                           "-e" "LANG=C.UTF-8"
                           "-e" "LC_ALL=C.UTF-8"
                           container-name
                           "/bin/bash" "--login")]
    (System/exit (:exit result)))
  ;; Unix: replace process (cleaner process tree)
  (p/exec "docker" "exec" "-it" "-u" "developer"
          "-e" (str "TERM=" term)
          "-e" (str "COLORTERM=" colorterm)
          "-e" "LANG=C.UTF-8"
          "-e" "LC_ALL=C.UTF-8"
          container-name
          "/bin/bash" "--login"))
```

Also update the function docstring (lines 44-52) to reflect cross-platform behavior. Change "uses p/exec to replace current process" to mention both Unix (p/exec) and Windows (p/process :inherit) execution paths.

Keep the Unix `p/exec` path exactly as-is — do NOT change Unix behavior.
  </action>
  <verify>
1. `bb -e "(require '[aishell.attach])"` loads without errors (SCI analysis-time check)
2. `grep -n "p/process" src/aishell/attach.clj` shows the new Windows code path
3. `grep -n "p/exec" src/aishell/attach.clj` still shows the Unix code path preserved
4. `grep -n "throw" src/aishell/attach.clj` shows NO throw for Windows platform guard (the old ex-info is gone)
5. `grep -n "System/exit" src/aishell/attach.clj` shows exit code propagation
6. `bb aishell.clj --help` still works (no regression)
  </verify>
  <done>attach.clj has platform-conditional execution: Windows uses p/process :inherit with System/exit, Unix uses p/exec. No throw on Windows. File loads in Babashka without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Replace Windows guard in run.clj with p/process :inherit</name>
  <files>src/aishell/run.clj</files>
  <action>
In `src/aishell/run.clj`, replace the Windows platform guard (lines 244-246) that throws an ex-info with a working `p/process {:inherit true}` execution path.

Current code (lines 244-246):
```clojure
(if (fs/windows?)
  (throw (ex-info "Process replacement (p/exec) not supported on Windows. See: Phase 56 (Process & Execution)"
                  {:platform :windows}))
  (apply p/exec (concat docker-args container-cmd)))
```

Replace with:
```clojure
(if (fs/windows?)
  ;; Windows: spawn child process with inherited I/O, wait, propagate exit
  (let [result @(apply p/process {:inherit true}
                       (concat docker-args container-cmd))]
    (System/exit (:exit result)))
  ;; Unix: replace process (cleaner process tree)
  (apply p/exec (concat docker-args container-cmd)))
```

Key details:
- Use `apply` with `p/process` (same pattern as the existing `apply p/exec`) because `docker-args` and `container-cmd` are dynamic argument vectors
- The `{:inherit true}` options map is the first arg to `p/process`, followed by the splatted command args
- `@` derefs the process (blocks until Docker exits), then `System/exit` propagates the exit code
- The gitleaks branch (lines 229-239) and `run-exec` function (lines 300-305) already use `p/shell :inherit true` — do NOT touch them
- Keep the Unix `p/exec` path exactly as-is
  </action>
  <verify>
1. `bb -e "(require '[aishell.run])"` loads without errors (SCI analysis-time check)
2. `grep -n "p/process" src/aishell/run.clj` shows the new Windows code path
3. `grep -n "p/exec" src/aishell/run.clj` still shows the Unix code path preserved
4. `grep -n "throw" src/aishell/run.clj` shows NO throw for Windows platform guard (the old ex-info is gone)
5. `grep -n "System/exit" src/aishell/run.clj` shows exit code propagation in both gitleaks branch AND new Windows branch
6. `bb aishell.clj --help` still works (no regression)
  </verify>
  <done>run.clj has platform-conditional execution: Windows uses apply p/process :inherit with System/exit, Unix uses apply p/exec. No throw on Windows. File loads in Babashka without errors. Gitleaks and run-exec paths untouched.</done>
</task>

</tasks>

<verification>
1. Both files load in Babashka without SCI errors:
   - `bb -e "(require '[aishell.attach])"`
   - `bb -e "(require '[aishell.run])"`
2. CLI still works on Unix: `bb aishell.clj --help`
3. No remaining Windows platform guard exceptions:
   - `grep -rn "Phase 56" src/` returns zero matches (all Phase 56 guards resolved)
4. Windows code paths present:
   - `grep -rn "p/process.*:inherit" src/aishell/attach.clj` — 1 match
   - `grep -rn "p/process.*:inherit" src/aishell/run.clj` — 1 match
5. Unix code paths preserved:
   - `grep -rn "p/exec" src/aishell/attach.clj` — 1 match
   - `grep -rn "p/exec" src/aishell/run.clj` — 1 match
6. Exit code propagation:
   - `grep -rn "System/exit" src/aishell/attach.clj` — 1 match
   - `grep -rn "System/exit" src/aishell/run.clj` — 2+ matches (gitleaks + new Windows path)
</verification>

<success_criteria>
- attach.clj: Windows guard replaced with `p/process {:inherit true}` + `System/exit` pattern
- run.clj: Windows guard replaced with `apply p/process {:inherit true}` + `System/exit` pattern
- Zero remaining "Phase 56" error messages in source code
- Both files load in Babashka (SCI analysis passes)
- `bb aishell.clj --help` works without errors
- Unix behavior unchanged (p/exec paths preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/56-process-execution/56-01-SUMMARY.md`
</output>
