---
phase: 07-nodejs-and-clojure-tooling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - aishell
autonomous: false

must_haves:
  truths:
    - "User can run node --version and see Node.js 24.x"
    - "User can run npm --version and see npm version"
    - "User can run bb --version and see Babashka version"
    - "User can run bbin version and see bbin version"
    - "All tools work for non-root container user (after gosu switch)"
  artifacts:
    - path: "aishell"
      provides: "Dockerfile heredoc with Node.js, Babashka, bbin installations"
      contains: "FROM node:24-bookworm-slim AS node-source"
  key_links:
    - from: "aishell (write_dockerfile)"
      to: "node:24-bookworm-slim"
      via: "multi-stage COPY"
      pattern: "COPY --from=node-source"
    - from: "aishell (write_dockerfile)"
      to: "github.com/babashka/babashka"
      via: "curl binary download"
      pattern: "babashka.*linux-amd64-static"
    - from: "aishell (write_dockerfile)"
      to: "github.com/babashka/bbin"
      via: "curl script download"
      pattern: "bbin.*raw.githubusercontent"
---

<objective>
Add Node.js LTS, Babashka (bb), and bbin to the aishell base image for enhanced scripting capabilities.

Purpose: Users need Node.js for JavaScript/TypeScript tooling and Babashka for fast Clojure scripting within containers.
Output: Modified aishell with updated Dockerfile heredoc that installs all three tools via multi-stage build and direct downloads.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-nodejs-and-clojure-tooling/07-RESEARCH.md
@aishell
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Dockerfile heredoc with multi-stage build and tool installations</name>
  <files>aishell</files>
  <action>
Modify the `write_dockerfile()` function in aishell to:

1. **Convert to multi-stage build:**
   - Add first stage: `FROM node:24-bookworm-slim AS node-source`
   - Main stage continues: `FROM debian:bookworm-slim`

2. **Add Node.js installation (after apt-get, before gosu):**
   ```dockerfile
   # Install Node.js via multi-stage copy
   COPY --from=node-source /usr/local/bin/node /usr/local/bin/node
   COPY --from=node-source /usr/local/lib/node_modules /usr/local/lib/node_modules
   RUN ln -s /usr/local/lib/node_modules/npm/bin/npm-cli.js /usr/local/bin/npm \
       && ln -s /usr/local/lib/node_modules/npm/bin/npx-cli.js /usr/local/bin/npx \
       && node --version \
       && npm --version
   ```

3. **Add Babashka installation (after Node.js):**
   ```dockerfile
   # Install Babashka (static binary for container compatibility)
   ARG BABASHKA_VERSION=1.12.214
   RUN set -eux; \
       curl -fsSL "https://github.com/babashka/babashka/releases/download/v${BABASHKA_VERSION}/babashka-${BABASHKA_VERSION}-linux-amd64-static.tar.gz" \
       | tar -xz -C /usr/local/bin bb; \
       chmod +x /usr/local/bin/bb; \
       bb --version
   ```

4. **Add bbin installation (after Babashka, requires bb):**
   ```dockerfile
   # Install bbin (Babashka script installer)
   ARG BBIN_VERSION=0.2.5
   RUN curl -fsSL -o /usr/local/bin/bbin \
       "https://raw.githubusercontent.com/babashka/bbin/v${BBIN_VERSION}/bbin" \
       && chmod +x /usr/local/bin/bbin \
       && bbin version
   ```

**Order of layers in final Dockerfile:**
1. FROM node:24-bookworm-slim AS node-source
2. FROM debian:bookworm-slim
3. ARG declarations (WITH_CLAUDE, WITH_OPENCODE, versions, BABASHKA_VERSION, BBIN_VERSION)
4. ENV DEBIAN_FRONTEND=noninteractive
5. apt-get install (existing packages)
6. COPY --from=node-source (Node.js)
7. ln -s for npm/npx
8. curl + tar for Babashka
9. curl for bbin
10. gosu installation
11. Claude Code installation (conditional)
12. OpenCode installation (conditional)
13. COPY entrypoint.sh and bashrc.aishell
14. ENTRYPOINT and CMD

**Important:** Keep gosu AFTER the new tool installations to maintain existing layer caching behavior for the harness conditionals.
  </action>
  <verify>
Run `grep -A5 "FROM node" aishell` to confirm multi-stage build.
Run `grep "BABASHKA_VERSION" aishell` to confirm Babashka installation.
Run `grep "bbin" aishell` to confirm bbin installation.
  </verify>
  <done>
aishell contains updated Dockerfile heredoc with multi-stage Node.js copy, Babashka binary download, and bbin script download.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Modified aishell with updated Dockerfile heredoc that adds:
- Node.js 24 LTS via multi-stage copy from official image
- Babashka 1.12.214 static binary
- bbin 0.2.5 script installer
  </what-built>
  <how-to-verify>
1. **Build fresh image (force rebuild to test new Dockerfile):**
   ```bash
   ./aishell --rebuild
   ```

2. **Test Node.js in container:**
   ```bash
   # Inside container:
   node --version   # Should show v24.x.x
   npm --version    # Should show 10.x.x
   npx --version    # Should show 10.x.x
   ```

3. **Test Babashka in container:**
   ```bash
   # Inside container:
   bb --version     # Should show babashka v1.12.214
   bb -e '(println "Hello from Babashka!")'   # Should print greeting
   ```

4. **Test bbin in container:**
   ```bash
   # Inside container:
   bbin version     # Should show bbin 0.2.5
   ```

5. **Verify tools work as non-root user:**
   ```bash
   # Inside container:
   whoami           # Should show 'developer' (not root)
   which node       # Should show /usr/local/bin/node
   which bb         # Should show /usr/local/bin/bb
   which bbin       # Should show /usr/local/bin/bbin
   ```

All tools should be available and functional for the container user.
  </how-to-verify>
  <resume-signal>Type "approved" if all tools work correctly, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
- [ ] `./aishell --rebuild` completes without errors
- [ ] `node --version` shows v24.x.x in container
- [ ] `npm --version` shows version in container
- [ ] `bb --version` shows babashka v1.12.214 in container
- [ ] `bbin version` shows bbin 0.2.5 in container
- [ ] All tools accessible to non-root user (not just root)
</verification>

<success_criteria>
Phase 7 is complete when:
1. Node.js LTS (v24.x) is available in container
2. npm and npx are available in container
3. Babashka (bb) is available in container
4. bbin is available in container
5. All tools work for the dynamically created non-root user
</success_criteria>

<output>
After completion, create `.planning/phases/07-nodejs-and-clojure-tooling/07-01-SUMMARY.md`
</output>
