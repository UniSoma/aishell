---
phase: 40-plugin-installation-in-volume
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/volume.clj
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Declared plugins (e.g., tmux-sensible) installed into /tools/tmux/plugins/ during build"
  artifacts:
    - path: "src/aishell/docker/volume.clj"
      provides: "Fixed build-tpm-install-command that writes plugin declarations where TPM reads them"
      contains: "~/.tmux.conf"
  key_links:
    - from: "build-tpm-install-command printf"
      to: "TPM install_plugins AWK parser"
      via: "~/.tmux.conf file with set -g @plugin lines"
      pattern: "~/.tmux.conf"
---

<objective>
Fix TPM plugin installation by writing plugin declarations to ~/.tmux.conf instead of /tmp/plugins.conf.

Purpose: TPM's install_plugins script uses AWK to parse ~/.tmux.conf for "set -g @plugin" lines. The current code writes to /tmp/plugins.conf which install_plugins never reads, causing declared plugins to silently not install. Only TPM itself gets cloned, but no declared plugins are fetched.
Output: Working plugin installation where declared plugins appear in /tools/tmux/plugins/ after build.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-plugin-installation-in-volume/40-UAT.md
@.planning/debug/plugins-not-installing.md
@src/aishell/docker/volume.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix plugin declaration path in build-tpm-install-command</name>
  <files>src/aishell/docker/volume.clj</files>
  <action>
In `build-tpm-install-command` (line 196-211), change line 209 from writing to `/tmp/plugins.conf` to writing to `~/.tmux.conf`.

Change this line:
```
" && printf '%s\\n' \"" plugin-lines "\" > /tmp/plugins.conf"
```

To:
```
" && printf '%s\\n' \"" plugin-lines "\" > ~/.tmux.conf"
```

This is the ONLY change needed. The rest of the function is correct:
- TPM clone/pull logic is correct (lines 203-208)
- TMUX_PLUGIN_MANAGER_PATH=/tools/tmux/plugins is correct (line 210)
- chmod is correct (line 211)

Why ~/.tmux.conf: TPM's install_plugins script uses AWK to scan ~/.tmux.conf for lines matching `/^[ \t]*set(-option)? +-g +@plugin/`. Writing to any other path is invisible to TPM. The volume population runs in a temporary --rm container as root, so ~/.tmux.conf resolves to /root/.tmux.conf. This file is ephemeral to the build container and does not conflict with the user's tmux.conf which is mounted at runtime.

Do NOT use /root/.tmux.conf explicitly -- use ~/.tmux.conf so it works regardless of the container user. The build container runs as root, so ~ = /root.
  </action>
  <verify>
1. Verify code compiles: `bb -cp src -e "(require 'aishell.docker.volume)"`
2. Verify command string contains ~/.tmux.conf: `bb -cp src -e "(require 'aishell.docker.volume) (println (aishell.docker.volume/build-tpm-install-command [\"tmux-plugins/tmux-sensible\"]))"` -- output should contain `> ~/.tmux.conf` (NOT `/tmp/plugins.conf`)
3. Verify nil for empty: `bb -cp src -e "(require 'aishell.docker.volume) (println (aishell.docker.volume/build-tpm-install-command []))"` -- should print nil
4. End-to-end: Run `aishell build --with-tmux --with-claude --verbose` then check volume contents. The /tools/tmux/plugins/ directory should contain both `tpm/` AND `tmux-sensible/` (or whatever plugin is declared in .aishell/config.yaml).
  </verify>
  <done>
build-tpm-install-command writes plugin declarations to ~/.tmux.conf where TPM's install_plugins can find them. Declared plugins (e.g., tmux-sensible) are installed into /tools/tmux/plugins/ during build.
  </done>
</task>

</tasks>

<verification>
- `bb -cp src -e "(require 'aishell.docker.volume)"` compiles without error
- Generated command string contains `> ~/.tmux.conf` instead of `> /tmp/plugins.conf`
- `aishell build --with-tmux` installs declared plugins (not just TPM)
- /tools/tmux/plugins/tmux-sensible/ exists in volume after build (when tmux-sensible declared)
</verification>

<success_criteria>
- UAT Test 2 passes: declared plugins installed into /tools/tmux/plugins/ during build
- TPM clone still works (regression check)
- Empty plugins still returns nil (regression check)
</success_criteria>

<output>
After completion, create `.planning/phases/40-plugin-installation-in-volume/40-04-SUMMARY.md`
</output>
