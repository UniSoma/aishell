---
phase: 40-plugin-installation-in-volume
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/config.clj
autonomous: true

must_haves:
  truths:
    - "Invalid plugin format (e.g. 'invalid', '-bad/repo') triggers warning during config load"
    - "Valid plugin format (e.g. 'tmux-plugins/tmux-sensible') passes validation silently"
    - "Non-list tmux.plugins value triggers warning"
    - "Non-string plugin entries trigger warning"
  artifacts:
    - path: "src/aishell/config.clj"
      provides: "Plugin format validation in validate-tmux-config"
      contains: "plugin-format-pattern"
  key_links:
    - from: "src/aishell/config.clj validate-tmux-config"
      to: "validate-plugin-format"
      via: "called for each plugin in :plugins list"
      pattern: "validate-plugin-format"
---

<objective>
Add plugin format validation to config parsing so invalid owner/repo patterns are caught before build starts.

Purpose: PLUG-06 requires format validation at config parse time. This prevents wasted Docker operations from bad plugin declarations.
Output: Enhanced validate-tmux-config that validates tmux.plugins entries against owner/repo regex pattern.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-plugin-installation-in-volume/40-RESEARCH.md
@src/aishell/config.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add plugin format validation to config.clj</name>
  <files>src/aishell/config.clj</files>
  <action>
Add two new functions and extend validate-tmux-config:

1. Add `plugin-format-pattern` def - regex for GitHub owner/repo format:
   ```clojure
   (def plugin-format-pattern
     #"^[a-zA-Z0-9]([a-zA-Z0-9-]{0,37}[a-zA-Z0-9])?/[a-zA-Z0-9._-]{1,100}$")
   ```
   Place it near the top of the file, after `known-harnesses`.

2. Add `validate-plugin-format` function:
   ```clojure
   (defn validate-plugin-format
     "Validate single plugin string matches owner/repo format.
      Returns nil if valid, error message string if invalid."
     [plugin]
     (when-not (re-matches plugin-format-pattern plugin)
       (str "Invalid plugin format: '" plugin "' - expected 'owner/repo'")))
   ```

3. Extend existing `validate-tmux-config` to validate plugins list:
   - After the existing map? check, add validation for `:plugins` key
   - If `:plugins` exists but is not sequential?, warn
   - If `:plugins` is sequential, iterate each entry:
     - If entry is not a string, warn about type
     - If entry is a string, call validate-plugin-format and warn if error returned
   - Pattern follows existing validate-detection-config style (warn, don't error)

Important: Do NOT change the function signature or return value of validate-tmux-config. It still returns tmux-config unchanged. Validation is advisory (warnings only), matching the existing pattern used by validate-detection-config and validate-harness-names.

Add `clojure.string` alias if not already required (it is used but may be via full namespace - check before adding).
  </action>
  <verify>
Run `bb -cp src -e "(require 'aishell.config) (println (aishell.config/validate-plugin-format \"tmux-plugins/tmux-sensible\"))"` - should print nil.
Run `bb -cp src -e "(require 'aishell.config) (println (aishell.config/validate-plugin-format \"invalid\"))"` - should print error message.
Run `bb -cp src -e "(require 'aishell.config) (println (aishell.config/validate-plugin-format \"-bad/repo\"))"` - should print error message.
Verify config loads without error: `bb -cp src -e "(require 'aishell.config) (println (aishell.config/load-config \".\"))"` - should load .aishell/config.yaml (which has tmux-plugins/tmux-sensible) without warnings.
  </verify>
  <done>
Plugin format validation integrated into config parsing. Valid owner/repo patterns pass silently. Invalid patterns produce warnings. validate-tmux-config enhanced without breaking existing behavior.
  </done>
</task>

</tasks>

<verification>
- `bb -cp src -e "(require 'aishell.config) (println (aishell.config/validate-plugin-format \"tmux-plugins/tmux-sensible\"))"` prints `nil`
- `bb -cp src -e "(require 'aishell.config) (println (aishell.config/validate-plugin-format \"invalid\"))"` prints error string
- Loading project config with valid plugins produces no warnings
</verification>

<success_criteria>
- PLUG-06 satisfied: plugin format validated with owner/repo regex during config parsing
- Existing config validation behavior unchanged
- Warning-only approach consistent with rest of validation framework
</success_criteria>

<output>
After completion, create `.planning/phases/40-plugin-installation-in-volume/40-01-SUMMARY.md`
</output>
