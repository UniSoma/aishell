---
phase: 54-path-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/util.clj
autonomous: true

must_haves:
  truths:
    - "get-home returns USERPROFILE on Windows, HOME on Unix"
    - "expand-path handles Windows backslash paths and normalizes through fs/path"
    - "state-dir uses LOCALAPPDATA on Windows instead of XDG"
    - "config-dir still returns ~/.aishell on all platforms"
  artifacts:
    - path: "src/aishell/util.clj"
      provides: "Cross-platform get-home, expand-path, state-dir"
      contains: "USERPROFILE"
  key_links:
    - from: "src/aishell/util.clj"
      to: "babashka.fs"
      via: "fs/windows? for platform branching, fs/path for normalization"
      pattern: "fs/windows\\?"
---

<objective>
Update `util.clj` path utility functions for cross-platform Windows/Unix support.

Purpose: All downstream code (config, state, Docker mounts) depends on `get-home`, `expand-path`, and `state-dir` returning correct platform-appropriate paths. These foundational functions must work on Windows before Docker mount changes can build on them.

Output: Cross-platform `get-home`, `expand-path`, and `state-dir` in `util.clj`.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-path-handling/54-CONTEXT.md
@.planning/phases/54-path-handling/54-RESEARCH.md
@src/aishell/util.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update get-home, expand-path, and state-dir for cross-platform support</name>
  <files>src/aishell/util.clj</files>
  <action>
Modify three functions in `src/aishell/util.clj`:

**1. `get-home` (lines 5-10) — Add USERPROFILE priority on Windows:**

Replace the current implementation with platform-branching logic:
- On Windows (`fs/windows?`): priority order `USERPROFILE > HOME > fs/home`
- On Unix: keep current `HOME > fs/home`
- Silent fallback to `(str (fs/home))` in both cases (no warning, no error)
- Update docstring to document the priority order

```clojure
(defn get-home
  "Get user home directory (cross-platform).
   Windows: USERPROFILE > HOME > fs/home
   Unix: HOME > fs/home
   Silent fallback to fs/home ensures function always succeeds."
  []
  (if (fs/windows?)
    (or (System/getenv "USERPROFILE")
        (System/getenv "HOME")
        (str (fs/home)))
    (or (System/getenv "HOME")
        (str (fs/home)))))
```

**2. `expand-path` (lines 12-21) — Add backslash support and fs/path normalization:**

Update regex lookaheads to also match backslash (`\`) for Windows paths. Normalize output through `(str (fs/path ...))` to prevent mixed-separator paths. Update docstring.

```clojure
(defn expand-path
  "Expand ~ and $HOME in path string, normalize separators.
   Works on both Windows and Unix."
  [path]
  (when path
    (let [home (get-home)]
      (str (fs/path
             (-> path
                 (str/replace #"^~(?=[/\\]|$)" home)
                 (str/replace #"\$HOME(?=[/\\]|$)" home)
                 (str/replace #"\$\{HOME\}(?=[/\\]|$)" home)))))))
```

Key changes:
- Regex `(?=/|$)` becomes `(?=[/\\]|$)` to also match backslash separator
- Result wrapped in `(str (fs/path ...))` for OS-native separator normalization

**3. `state-dir` (lines 28-34) — Add LOCALAPPDATA on Windows:**

Replace with platform-branching logic:
- On Windows: use `LOCALAPPDATA` env var, fallback to XDG default (`~/.local/state`)
- On Unix: keep current XDG logic unchanged
- Update docstring

```clojure
(defn state-dir
  "Get platform-appropriate state directory for aishell.
   Windows: LOCALAPPDATA/aishell (fallback to XDG default)
   Unix: XDG_STATE_HOME/aishell or ~/.local/state/aishell"
  []
  (if (fs/windows?)
    (let [localappdata (System/getenv "LOCALAPPDATA")
          fallback (str (fs/path (get-home) ".local" "state"))]
      (str (fs/path (or localappdata fallback) "aishell")))
    (let [xdg-state (or (System/getenv "XDG_STATE_HOME")
                         (str (fs/path (get-home) ".local" "state")))]
      (str (fs/path xdg-state "aishell")))))
```

Do NOT modify `config-dir` — per user decision, config stays at `~/.aishell` on all platforms, and it already uses `fs/path`.
  </action>
  <verify>
Run these Babashka commands to verify:

```bash
# File loads without errors (SCI analysis-time check)
bb -e "(require '[aishell.util :as util])"

# get-home still works on Unix (HOME is set)
bb -e "(require '[aishell.util :as util]) (println (util/get-home))"

# expand-path still works with ~ and $HOME
bb -e "(require '[aishell.util :as util]) (println (util/expand-path \"~/.aishell\")) (println (util/expand-path \"\$HOME/.config\"))"

# state-dir still returns XDG path on Unix
bb -e "(require '[aishell.util :as util]) (println (util/state-dir))"

# config-dir unchanged
bb -e "(require '[aishell.util :as util]) (println (util/config-dir))"

# Verify fs/windows? is used (grep)
grep -n "fs/windows?" src/aishell/util.clj

# Verify USERPROFILE is referenced
grep -n "USERPROFILE" src/aishell/util.clj

# Verify LOCALAPPDATA is referenced
grep -n "LOCALAPPDATA" src/aishell/util.clj

# CLI still works
bb aishell.clj --help
```
  </verify>
  <done>
- `get-home` uses USERPROFILE > HOME > fs/home on Windows, HOME > fs/home on Unix
- `expand-path` regex matches both `/` and `\` in lookahead, output normalized through `fs/path`
- `state-dir` uses LOCALAPPDATA on Windows, XDG on Unix, with fallback
- `config-dir` unchanged (uses `fs/path` already, stays at `~/.aishell`)
- All callers (config.clj, state.clj, migration.clj, gitleaks/scan_state.clj, docker/run.clj, check.clj) continue working on Unix
- `bb aishell.clj --help` succeeds
  </done>
</task>

</tasks>

<verification>
1. `grep -c "fs/windows?" src/aishell/util.clj` returns 2 (get-home and state-dir)
2. `grep -c "USERPROFILE" src/aishell/util.clj` returns 1
3. `grep -c "LOCALAPPDATA" src/aishell/util.clj` returns 1
4. `bb -e "(require '[aishell.util])"` succeeds (no SCI errors)
5. `bb aishell.clj --help` succeeds (no regressions)
</verification>

<success_criteria>
- get-home checks USERPROFILE on Windows, keeps HOME on Unix
- expand-path handles backslash separators and normalizes via fs/path
- state-dir uses LOCALAPPDATA on Windows, XDG on Unix
- No functional regressions on Unix
</success_criteria>

<output>
After completion, create `.planning/phases/54-path-handling/54-01-SUMMARY.md`
</output>
