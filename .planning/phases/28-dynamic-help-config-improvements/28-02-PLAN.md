---
phase: 28-dynamic-help-config-improvements
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - src/aishell/cli.clj
  - docs/CONFIGURATION.md
autonomous: true

must_haves:
  truths:
    - "User runs aishell --help and sees only harnesses they have installed"
    - "User without state.edn sees all harness commands in help (discoverability)"
    - "User sees gitleaks command in help regardless of build flag"
    - "CONFIGURATION.md documents pre_start list format with examples"
    - "CONFIGURATION.md documents --without-gitleaks build flag"
  artifacts:
    - path: "src/aishell/cli.clj"
      provides: "Dynamic help with installed-harnesses function"
      contains: "installed-harnesses"
    - path: "docs/CONFIGURATION.md"
      provides: "Updated documentation for v2.5.0 features"
      contains: "without-gitleaks"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/state.clj"
      via: "state/read-state call in installed-harnesses"
      pattern: "state/read-state"
    - from: "print-help"
      to: "installed-harnesses"
      via: "conditional println based on set membership"
      pattern: "installed-harnesses"
---

<objective>
Implement dynamic help output that shows only installed harnesses, and update documentation for all Phase 28 features.

Purpose: Users see relevant commands in --help output, reducing confusion about what's available. Documentation enables users to discover and use new features.

Output: Updated cli.clj with dynamic help, comprehensive CONFIGURATION.md updates.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-dynamic-help-config-improvements/28-RESEARCH.md
@.planning/phases/28-dynamic-help-config-improvements/28-01-SUMMARY.md

@src/aishell/cli.clj
@src/aishell/state.clj
@docs/CONFIGURATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement dynamic help output based on build state</name>
  <files>src/aishell/cli.clj</files>
  <action>
Add installed-harnesses function before print-help:

```clojure
(defn installed-harnesses
  "Return set of installed harness names based on state.
   If no state file exists (no build yet), returns all harnesses
   to aid discoverability."
  []
  (if-let [state (state/read-state)]
    (cond-> #{}
      (:with-claude state) (conj "claude")
      (:with-opencode state) (conj "opencode")
      (:with-codex state) (conj "codex")
      (:with-gemini state) (conj "gemini"))
    ;; No state = no build yet, show all for discoverability
    #{"claude" "opencode" "codex" "gemini"}))
```

Update print-help function to conditionally show harness commands:

Replace the static harness command println statements (lines 79-82) with:

```clojure
;; Conditionally show harness commands based on installation
(let [installed (installed-harnesses)]
  (when (contains? installed "claude")
    (println (str "  " output/CYAN "claude" output/NC "     Run Claude Code")))
  (when (contains? installed "opencode")
    (println (str "  " output/CYAN "opencode" output/NC "   Run OpenCode")))
  (when (contains? installed "codex")
    (println (str "  " output/CYAN "codex" output/NC "      Run Codex CLI")))
  (when (contains? installed "gemini")
    (println (str "  " output/CYAN "gemini" output/NC "     Run Gemini CLI"))))
```

Keep gitleaks line static (always shown):
```clojure
(println (str "  " output/CYAN "gitleaks" output/NC "   Run Gitleaks secret scanner"))
```

Key considerations:
- Gitleaks always shown because: (a) may be installed on host, (b) command works even if not in container
- No state file = show all harnesses (helps new users discover options)
- State exists but no harnesses enabled = shows only build/update/gitleaks/(none)
- Reading state.edn is fast (<1ms) - no caching needed
  </action>
  <verify>
1. Build with only Claude: `aishell build --with-claude`
2. Run `aishell --help`
   - Should show: build, update, claude, gitleaks, (none)
   - Should NOT show: opencode, codex, gemini

3. Build with Claude and Codex: `aishell build --with-claude --with-codex`
4. Run `aishell --help`
   - Should show: build, update, claude, codex, gitleaks, (none)
   - Should NOT show: opencode, gemini

5. Remove state file: `rm ~/.aishell/state.edn`
6. Run `aishell --help`
   - Should show ALL harnesses (discoverability mode)
  </verify>
  <done>
- installed-harnesses function returns set of installed harness names
- print-help conditionally shows harness commands based on set membership
- gitleaks always shown regardless of build state
- No state file = all harnesses shown for discoverability
- Help output reflects actual build configuration
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CONFIGURATION.md documentation</name>
  <files>docs/CONFIGURATION.md</files>
  <action>
**Update version reference at top:**
Change `**Last updated:** v2.4.0` to `**Last updated:** v2.5.0`

**Update pre_start section (around line 488-525):**

Replace existing pre_start documentation with enhanced version that covers list format:

```markdown
### pre_start

**Purpose:** Run a background command before the shell/harness starts.

**Type:** String or List (v2.5+)

**Formats:**

**String format (original):**
```yaml
pre_start: "redis-server --daemonize yes"
```

**List format (v2.5+):**
```yaml
pre_start:
  - "echo 'Starting services...'"
  - "redis-server --daemonize yes"
  - "sleep 2"
  - "echo 'Services ready'"
```

**Behavior:**
- **String:** Executed as-is via `sh -c`
- **List:** Items joined with ` && ` separator, then executed via `sh -c`
- **Empty list:** No pre-start command runs
- **Empty items:** Filtered out automatically

**Example transformation:**
```yaml
# List input
pre_start:
  - "echo 'Step 1'"
  - "echo 'Step 2'"

# Becomes equivalent to
pre_start: "echo 'Step 1' && echo 'Step 2'"
```

**Notes:**
- Command runs in background (via `nohup ... &`)
- Output redirected to `/tmp/pre-start.log` (check if command fails)
- Runs as container user (not root)
- Use `&&` separator means if any command fails, execution stops
- Container doesn't wait for command completion (non-blocking)

**Merge behavior:** Project replaces global (only one pre_start runs).

**Common use cases:**

| Use Case | Example |
|----------|---------|
| Database | `["postgres -D /data/postgres &"]` |
| Redis | `["redis-server --daemonize yes"]` |
| Multiple services | `["redis-server --daemonize yes", "nginx -g 'daemon off;' &"]` |
| Wait for deps | `["redis-server --daemonize yes", "sleep 2", "echo 'Ready'"]` |
```

**Add new section after Common Patterns (before end of file):**

```markdown
---

## Build Options

### --without-gitleaks

**Purpose:** Skip Gitleaks installation during build to reduce image size.

**Usage:**
```bash
aishell build --with-claude --without-gitleaks
```

**Behavior:**
- By default, Gitleaks is installed in the container (~15MB)
- `--without-gitleaks` skips installation
- Build state records installation status in `~/.aishell/state.edn`
- `aishell --help` still shows `gitleaks` command (may work via host installation)

**State tracking:**
```bash
# Check what was installed
cat ~/.aishell/state.edn
# Shows :with-gitleaks true or false
```

**When to use:**
- **Minimal images:** Reduce container size when Gitleaks not needed
- **External Gitleaks:** Using Gitleaks installed on host instead
- **CI/CD:** Build environments where secret scanning handled elsewhere

**Image size impact:**
- With Gitleaks: ~280MB
- Without Gitleaks: ~265MB
- Savings: ~15MB

**Note:** The `aishell gitleaks` command may still work if Gitleaks is installed on your host system or mounted into the container.
```

**Update merge strategy table (around line 66-72):**

Add note about pre_start accepting lists:
```markdown
| **Scalars** | `pre_start`, `gitleaks_freshness_check` | Project replaces global | Global: `pre_start: "echo hi"`<br/>Project: `pre_start: ["echo", "bye"]`<br/>Result: `"echo && bye"` |
```
  </action>
  <verify>
1. Read updated CONFIGURATION.md
2. Verify pre_start section shows both string and list formats
3. Verify Build Options section exists with --without-gitleaks
4. Verify version updated to v2.5.0
5. Check no broken markdown formatting
  </verify>
  <done>
- CONFIGURATION.md version updated to v2.5.0
- pre_start section documents list format with examples
- pre_start section shows transformation example
- New "Build Options" section with --without-gitleaks
- Merge strategy table updated for list format note
- All markdown properly formatted
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Dynamic help verification:**
   - Build with subset of harnesses
   - `aishell --help` shows only installed harnesses + gitleaks
   - Remove state.edn, help shows all harnesses

2. **Documentation verification:**
   - Open docs/CONFIGURATION.md
   - Verify v2.5.0 version
   - Find pre_start list format documentation
   - Find --without-gitleaks documentation
   - Verify examples are correct and complete

3. **End-to-end Phase 28 verification:**
   - `aishell build --with-claude --without-gitleaks`
   - `aishell --help` shows only claude + gitleaks
   - Create config with list pre_start, verify execution
   - Check state.edn has all expected fields
</verification>

<success_criteria>
- [ ] installed-harnesses function exists and returns correct set
- [ ] print-help uses installed-harnesses to filter output
- [ ] gitleaks command always shown in help
- [ ] No state = all harnesses shown (discoverability)
- [ ] CONFIGURATION.md version is v2.5.0
- [ ] pre_start section documents list format
- [ ] pre_start section shows list-to-string transformation
- [ ] Build Options section documents --without-gitleaks
- [ ] All Phase 28 requirements covered in documentation
</success_criteria>

<output>
After completion, create `.planning/phases/28-dynamic-help-config-improvements/28-02-SUMMARY.md`
</output>
