---
phase: 15-build-command
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/cli.clj
  - src/aishell/docker/build.clj
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Version validation receives string, not Double"
    - "Docker build command executes correctly"
    - "Dangerous characters in version show user-friendly error"
  artifacts:
    - path: "src/aishell/cli.clj"
      provides: "String coercion in parse-with-flag"
      contains: "(str value)"
    - path: "src/aishell/docker/build.clj"
      provides: "Spread command vector with apply"
      contains: "apply p/process"
  key_links:
    - from: "parse-with-flag"
      to: "validate-version"
      via: "always passes string"
      pattern: "str value"
    - from: "run-build"
      to: "p/process and p/shell"
      via: "apply to spread vector"
      pattern: "apply p/(process|shell)"
---

<objective>
Fix two UAT-diagnosed bugs preventing build command from working.

Purpose: Close blocker (Docker command fails) and major (version type error) gaps from UAT testing.
Output: Working build command that handles dangerous input gracefully and executes Docker builds correctly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/15-build-command/15-UAT.md

@src/aishell/cli.clj
@src/aishell/docker/build.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix version type coercion in cli.clj</name>
  <files>src/aishell/cli.clj</files>
  <action>
In parse-with-flag function (line 33-45), the :else clause currently returns:
```clojure
:else {:enabled? true :version value}
```

babashka.cli auto-coerces numeric-looking values like "1.0" to Double (1.0).
When this Double reaches validate-version, re-find fails with "java.lang.Double cannot be cast to java.lang.CharSequence".

Fix by converting value to string in the :else clause:
```clojure
:else {:enabled? true :version (str value)}
```

This ensures validate-version always receives a string, whether babashka.cli coerced the input or not.
  </action>
  <verify>
Run: `./aishell.clj build --with-claude="1.0; rm -rf /"`
Should show: "Invalid Claude Code version: contains shell metacharacters"
NOT: "java.lang.Double cannot be cast to java.lang.CharSequence"
  </verify>
  <done>
Dangerous characters in version strings produce user-friendly error message instead of Java exception.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Docker command vector spreading in build.clj</name>
  <files>src/aishell/docker/build.clj</files>
  <action>
In run-build function (lines 70-93), the cmd vector is passed directly to p/process and p/shell.
This causes the error: Cannot run program "[docker"

The issue is on lines 79-82 (verbose mode):
```clojure
(let [{:keys [exit]} (p/process {:dir (str build-dir)
                                 :out :inherit
                                 :err :inherit}
                                cmd)]
```

And lines 85-89 (silent mode):
```clojure
(let [{:keys [exit out err]} (p/shell {:dir (str build-dir)
                                       :out :string
                                       :err :string
                                       :continue true}
                                      cmd)]
```

babashka.process expects command arguments as separate arguments, not as a single vector.
Fix by using apply to spread the vector:

For p/process (verbose mode):
```clojure
(let [{:keys [exit]} (apply p/process {:dir (str build-dir)
                                        :out :inherit
                                        :err :inherit}
                                       cmd)]
```

For p/shell (silent mode):
```clojure
(let [{:keys [exit out err]} (apply p/shell {:dir (str build-dir)
                                              :out :string
                                              :err :string
                                              :continue true}
                                             cmd)]
```

Note: apply with opts map as first arg works because p/process and p/shell accept opts as first positional arg followed by command parts.
  </action>
  <verify>
Run: `./aishell.clj build` (requires Docker daemon running)
Should show build progress/spinner, NOT: Cannot run program "[docker"
  </verify>
  <done>
Docker build command executes without "Cannot run program [docker" error.
  </done>
</task>

</tasks>

<verification>
1. Version coercion test:
   ```bash
   ./aishell.clj build --with-claude="1.0; rm -rf /"
   # Expected: Error message about shell metacharacters
   ```

2. Docker build test (requires Docker):
   ```bash
   ./aishell.clj build
   # Expected: Build starts, shows spinner or progress
   ```

3. Combined test with version pinning (requires Docker):
   ```bash
   ./aishell.clj build --with-claude=2.0.22
   # Expected: Build completes, shows "Claude Code: 2.0.22"
   ```
</verification>

<success_criteria>
- UAT Test 3 passes: Dangerous characters show clear error message
- UAT Test 4 passes: Build command executes Docker successfully
- UAT Tests 5-7 unblocked: Can proceed with version pinning and state persistence tests
</success_criteria>

<output>
After completion, create `.planning/phases/15-build-command/15-03-SUMMARY.md`
</output>
