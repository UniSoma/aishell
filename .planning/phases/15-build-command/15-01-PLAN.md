---
phase: 15-build-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/state.clj
autonomous: true

must_haves:
  truths:
    - "State can be written to ~/.aishell/state.edn"
    - "State can be read back with same values"
    - "State file is created when it doesn't exist"
    - "Missing state file returns nil (not error)"
  artifacts:
    - path: "src/aishell/state.clj"
      provides: "EDN state persistence"
      exports: ["state-file", "read-state", "write-state"]
  key_links:
    - from: "src/aishell/state.clj"
      to: "src/aishell/util.clj"
      via: "config-dir, ensure-dir"
      pattern: "util/config-dir|util/ensure-dir"
---

<objective>
Create the state persistence module for storing build configuration.

Purpose: Build flags need to persist between invocations so `aishell claude` knows what was built. This module provides the foundation for all state operations.

Output: `src/aishell/state.clj` with read/write functions for EDN state at `~/.aishell/state.edn`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-build-command/15-RESEARCH.md
@.planning/phases/15-build-command/15-CONTEXT.md
@src/aishell/util.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create state.clj module</name>
  <files>src/aishell/state.clj</files>
  <action>
Create `src/aishell/state.clj` with:

1. Namespace declaration requiring:
   - `babashka.fs` as `fs`
   - `clojure.edn` as `edn`
   - `aishell.util` as `util`

2. `state-file` function:
   - Returns path to `~/.aishell/state.edn`
   - Use `(str (fs/path (util/config-dir) "state.edn"))`

3. `read-state` function:
   - Check if file exists with `(fs/exists? path)`
   - If exists: `(edn/read-string (slurp path))`
   - If not exists: return `nil` (not an error)

4. `write-state` function:
   - Takes state map as argument
   - Ensure directory exists: `(util/ensure-dir (util/config-dir))`
   - Write with `(spit path (pr-str state))`

State schema (for documentation):
```clojure
{:with-claude true            ; boolean
 :with-opencode false         ; boolean
 :claude-version "2.0.22"     ; string or nil
 :opencode-version nil        ; string or nil
 :image-tag "aishell:base"    ; string
 :build-time #inst "..."}     ; instant
```

The module should be minimal - just read/write, no validation (validation happens in CLI layer).
  </action>
  <verify>
Test in bb REPL:
```bash
cd /home/jonasrodrigues/projects/harness
bb -e "(require '[aishell.state :as state]) (state/write-state {:test true}) (println (state/read-state))"
```
Should print `{:test true}` and create `~/.aishell/state.edn`
  </verify>
  <done>
- state.clj exists with state-file, read-state, write-state functions
- Writing state creates file at ~/.aishell/state.edn
- Reading non-existent state returns nil
- Reading written state returns same values
  </done>
</task>

</tasks>

<verification>
```bash
# Verify module loads
bb -e "(require '[aishell.state :as state]) (println 'OK)"

# Verify round-trip
bb -e "
(require '[aishell.state :as state])
(state/write-state {:with-claude true :claude-version \"1.0.0\"})
(let [s (state/read-state)]
  (assert (:with-claude s))
  (assert (= \"1.0.0\" (:claude-version s)))
  (println 'Round-trip OK))
"

# Verify file location
ls -la ~/.aishell/state.edn
```
</verification>

<success_criteria>
- src/aishell/state.clj exists and loads without errors
- write-state creates ~/.aishell/state.edn
- read-state returns nil for missing file
- read-state returns exact data that was written
</success_criteria>

<output>
After completion, create `.planning/phases/15-build-command/15-01-SUMMARY.md`
</output>
