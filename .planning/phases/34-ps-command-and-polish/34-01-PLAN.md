---
phase: 34-ps-command-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/cli.clj
autonomous: true

must_haves:
  truths:
    - "aishell ps lists all containers for the current project filtered by project hash"
    - "Output shows container short name, status, and creation time in a readable table"
    - "When no containers exist for project, shows helpful message with examples (not empty output)"
    - "Running from different directories shows different containers (project-scoped)"
  artifacts:
    - path: "src/aishell/cli.clj"
      provides: "PS command handler, short name extraction, table formatting, CLI dispatch and help integration"
      contains: "handle-ps"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/docker/naming.clj"
      via: "naming/list-project-containers call"
      pattern: "naming/list-project-containers"
    - from: "src/aishell/cli.clj"
      to: "clojure.pprint/print-table"
      via: "require and function call for table output"
      pattern: "pp/print-table"
---

<objective>
Implement the `aishell ps` command that lists project-scoped containers with readable table output.

Purpose: Complete the v2.6.0 multi-container workflow by providing visibility into running/stopped containers per project. Users can discover containers started with `--detach` and know what to attach to.

Output: Modified `src/aishell/cli.clj` with `handle-ps` function, short name extraction, and CLI dispatch integration. No new files needed — this is a thin presentation layer over Phase 30's existing `list-project-containers`.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-ps-command-and-polish/34-RESEARCH.md

@src/aishell/cli.clj
@src/aishell/docker/naming.clj
@src/aishell/output.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ps command handler and integrate into CLI</name>
  <files>src/aishell/cli.clj</files>
  <action>
Modify `src/aishell/cli.clj` to add the ps command. All changes are in this single file.

1. **Add require**: Add `[clojure.pprint :as pp]` to the ns `:require` vector.

2. **Add private helper** `extract-short-name` (use `defn-`):
   - Takes a full container name like `aishell-a1b2c3d4-claude`
   - Returns the user-friendly portion: `(last (str/split container-name #"-" 3))`
   - This handles names with hyphens (e.g., `aishell-hash-my-experiment` returns `my-experiment`)

3. **Add private helper** `format-container` (use `defn-`):
   - Takes a container map from `naming/list-project-containers` (has `:name`, `:status`, `:created`)
   - Returns a display map: `{:NAME (extract-short-name (:name c)) :STATUS (:status c) :CREATED (:created c)}`
   - Use uppercase keyword keys `:NAME`, `:STATUS`, `:CREATED` so `print-table` renders uppercase column headers

4. **Add `handle-ps` function** (public, takes no meaningful args — use `[_]`):
   - Get project dir: `(System/getProperty "user.dir")`
   - Call `(naming/list-project-containers project-dir)` to get containers
   - If empty: print helpful message:
     ```
     No containers found for this project.

     To start a container:
       aishell claude --detach
       aishell opencode --detach --name my-session

     Containers are project-specific (based on current directory).
     ```
   - If not empty: print header "Containers for this project:\n", then `(pp/print-table [:NAME :STATUS :CREATED] (map format-container containers))`, then a footer line: `"\nTo attach: aishell attach --name <name>"`

5. **Add "ps" to dispatch function**: In the `(case (first clean-args) ...)` block, add between "exec" and "attach":
   ```clojure
   "ps" (handle-ps nil)
   ```

6. **Add "ps" to print-help**: After the "exec" line and before "attach", add:
   ```clojure
   (println (str "  " output/CYAN "ps" output/NC "         List project containers"))
   ```

7. **Add "ps" to examples in print-help**: After the existing examples, add:
   ```clojure
   (println (str "  " output/CYAN "aishell ps" output/NC "                       List containers"))
   ```

Note: "ps" is already in the `known-commands` set in `output.clj` (line 19), so typo suggestions already work. No changes needed to output.clj.

IMPORTANT: Do NOT create a separate ps.clj file. The implementation is ~30 lines and belongs inline in cli.clj, following the same pattern as handle-build, handle-update, and handle-default.

IMPORTANT: Do NOT use `println` with multiple string args for the empty state message — `println` adds spaces between args. Use a single `(println "...")` call with `\n` for newlines.

IMPORTANT: Use Docker timestamps as-is from `list-project-containers`. Do NOT implement relative time formatting ("2 hours ago"). Keep it simple.
  </action>
  <verify>
Verify the CLI loads without errors:
```
bb -e "(require '[aishell.cli])" 2>&1
```
Should load without errors.

Verify handle-ps exists:
```
grep "defn handle-ps" src/aishell/cli.clj
```

Verify print-table is required:
```
grep "clojure.pprint" src/aishell/cli.clj
```

Verify ps is in dispatch:
```
grep '"ps"' src/aishell/cli.clj
```

Verify ps is in help text:
```
grep -c "ps" src/aishell/cli.clj
```
Should return 3+ (dispatch, help command list, help examples).

Test help output includes ps:
```
bb -cp src -m aishell.core -- --help 2>&1 | grep ps
```
Should show "ps" in command list.

Test ps command with no containers (from a temp directory):
```
cd /tmp && bb -cp /home/jonasrodrigues/projects/harness/src -m aishell.core -- ps 2>&1
```
Should show "No containers found" message (assuming no containers for /tmp).
  </verify>
  <done>
- `aishell ps` lists containers for current project using `naming/list-project-containers`
- Output table shows NAME, STATUS, CREATED columns via `clojure.pprint/print-table`
- Container names displayed as short names (e.g., "claude" not "aishell-hash-claude")
- Empty state shows helpful message with examples of starting containers
- "ps" appears in `aishell --help` command list and examples
- "ps" dispatches correctly in the case statement
- No new files created, no new dependencies
  </done>
</task>

</tasks>

<verification>
End-to-end verification (requires Docker and a running container):

1. Build if needed and start a detached container:
```
aishell claude --detach --name test-ps
```

2. Run ps from the project directory:
```
aishell ps
```
Should show table with "test-ps" (or "claude") container, status "Up...", and creation time.

3. Run ps from a different directory:
```
cd /tmp && aishell ps
```
Should show "No containers found" (different project hash).

4. Return to project and verify again:
```
cd /home/jonasrodrigues/projects/harness && aishell ps
```
Should show the container from step 1.

5. Stop the container and verify stopped status shows:
```
docker stop aishell-<hash>-test-ps
aishell ps
```
Should show container with "Exited..." status (list-project-containers uses docker ps -a).

6. Verify help:
```
aishell --help
```
Should include "ps" in command list.

7. Verify typo suggestion:
```
aishell pa 2>&1
```
Should suggest "ps" (already in known-commands).
</verification>

<success_criteria>
- `aishell ps` shows project-scoped containers in table format (NAME, STATUS, CREATED)
- Short names displayed (not full aishell-hash-name format)
- Empty project shows helpful message with examples
- Different directories show different containers (project hash isolation)
- `aishell --help` lists "ps" command
- No new files, no new dependencies, no Docker image changes
</success_criteria>

<output>
After completion, create `.planning/phases/34-ps-command-and-polish/34-01-SUMMARY.md`
</output>
