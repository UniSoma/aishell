---
phase: 46-foundation-image-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/templates.clj
autonomous: true

must_haves:
  truths:
    - "Foundation image builds successfully without tmux package"
    - "Foundation image size is reduced compared to pre-change"
    - "tmux command is unavailable inside containers built from foundation image"
  artifacts:
    - path: "src/aishell/docker/templates.clj"
      provides: "Foundation Dockerfile template without tmux installation"
      contains: "Install Node.js via multi-stage"
      not_contains: "TMUX_VERSION"
  key_links:
    - from: "src/aishell/docker/templates.clj"
      to: "docker build"
      via: "base-dockerfile string used as Dockerfile content"
      pattern: "def base-dockerfile"
---

<objective>
Remove tmux binary installation and global config from the foundation Docker image template.

Purpose: First step of v3.0.0 milestone -- tmux is being removed entirely from aishell. This phase removes the binary from the foundation image so containers no longer ship with tmux. Runtime logic (entrypoint WITH_TMUX conditionals) remains intact as dead code paths until Phase 49.

Output: Modified templates.clj with tmux installation block, ARG declaration, and /etc/tmux.conf creation removed from base-dockerfile string.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-foundation-image-cleanup/46-RESEARCH.md
@src/aishell/docker/templates.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove tmux installation from foundation Dockerfile template</name>
  <files>src/aishell/docker/templates.clj</files>
  <action>
Edit the `base-dockerfile` string in src/aishell/docker/templates.clj to remove all tmux-related lines:

1. **Remove ARG TMUX_VERSION declaration** (currently line 46 in the def string):
   ```
   ARG TMUX_VERSION=3.6a
   ```

2. **Remove the entire tmux static binary installation RUN block** (lines 44-57 in the def string), including its comment:
   ```
   # Install tmux static binary (Debian bookworm ships 3.3a)
   # Source: https://github.com/tmux/tmux-builds (official tmux org)
   ARG TMUX_VERSION=3.6a
   RUN set -eux; \
       dpkgArch="$(dpkg --print-architecture)"; \
       case "${dpkgArch}" in \
           amd64) tmuxArch='x86_64' ;; \
           arm64) tmuxArch='arm64' ;; \
           *) echo "unsupported architecture for tmux: $dpkgArch"; exit 1 ;; \
       esac; \
       curl -fsSL "https://github.com/tmux/tmux-builds/releases/download/v${TMUX_VERSION}/tmux-${TMUX_VERSION}-linux-${tmuxArch}.tar.gz" \
       | tar -xz -C /usr/local/bin tmux; \
       chmod +x /usr/local/bin/tmux; \
       tmux -V
   ```

3. **Remove the /etc/tmux.conf creation block** (around line 101-103 in the def string):
   ```
   # Enable tmux mouse mode for scroll support inside containers
   # Without this, scroll events are interpreted as arrow keys by the inner application
   RUN echo 'set -g mouse on' > /etc/tmux.conf
   ```

4. **Update the profile.d COPY comment** (around line 113): Change the comment from "Copy profile.d script for login shell environment (tmux new-window compatibility)" to "Copy profile.d script for login shell environment" -- remove the tmux reference since tmux is being removed.

IMPORTANT constraints:
- Do NOT modify the entrypoint-script string. It contains WITH_TMUX conditional logic that will be removed in Phase 49. Leaving it as dead code is intentional.
- Do NOT modify bashrc-content or profile-d-script strings.
- Do NOT remove the profile.d COPY line itself, only update its comment. The profile.d script is still needed for login shell PATH setup independent of tmux.
- Ensure no blank line artifacts (e.g., multiple consecutive blank lines where the removed blocks were). A single blank line between remaining sections is fine.
  </action>
  <verify>
Run `grep -n tmux src/aishell/docker/templates.clj` and confirm:
- No matches in the base-dockerfile string (the first ~117 lines of the file)
- tmux references may still exist in the entrypoint-script string (expected, Phase 49 scope)
- tmux reference in profile-d-script comment is acceptable (it says "tmux new-window" in context of explaining what profile.d does)

Specifically verify:
- `grep "TMUX_VERSION" src/aishell/docker/templates.clj` returns NO matches in base-dockerfile section
- `grep "tmux.conf" src/aishell/docker/templates.clj` returns NO matches in base-dockerfile section (but may match in entrypoint-script section -- that is expected)
- `grep "tmux-builds" src/aishell/docker/templates.clj` returns NO matches
  </verify>
  <done>
base-dockerfile string in templates.clj contains zero tmux-related lines: no ARG TMUX_VERSION, no tmux binary installation RUN block, no /etc/tmux.conf creation RUN. The entrypoint-script string is unchanged (still has WITH_TMUX conditionals as expected dead code for Phase 49).
  </done>
</task>

<task type="auto">
  <name>Task 2: Build foundation image and verify tmux removal</name>
  <files>src/aishell/docker/templates.clj</files>
  <action>
Build the foundation image to verify the template change produces a valid Docker image without tmux:

1. Run `bb -m aishell.cli build --force` from the project root to trigger a full foundation image rebuild (--force bypasses cache so the new template is used).

2. After successful build, verify tmux is absent:
   - Run `docker run --rm aishell:foundation which tmux` -- should exit non-zero (command not found)
   - Run `docker run --rm aishell:foundation test -f /etc/tmux.conf` -- should exit non-zero (file not found)
   - Run `docker run --rm aishell:foundation ls /usr/local/bin/tmux 2>/dev/null` -- should produce no output

3. Verify image still works for its core purpose:
   - Run `docker run --rm aishell:foundation node --version` -- should output Node.js version
   - Run `docker run --rm aishell:foundation git --version` -- should output git version
   - Run `docker run --rm aishell:foundation bb --version` -- should output Babashka version

4. Note the image size from build output. The build completion message already displays size (e.g., "Built aishell:foundation (Xs, XXX.XMB)"). This confirms the size reduction from tmux removal.

If the build fails, check the Dockerfile template for syntax issues (unclosed quotes, stray backslashes, missing blank lines between RUN instructions).
  </action>
  <verify>
All of the following must succeed:
- `bb -m aishell.cli build --force` exits 0 with "Built aishell:foundation" message
- `docker run --rm aishell:foundation which tmux; echo $?` prints exit code 1 (not found)
- `docker run --rm aishell:foundation test -f /etc/tmux.conf; echo $?` prints exit code 1
- `docker run --rm aishell:foundation node --version` prints a version string
- `docker run --rm aishell:foundation git --version` prints a version string
  </verify>
  <done>
Foundation image builds successfully without tmux. The tmux binary is not present in the image (/usr/local/bin/tmux absent). The /etc/tmux.conf file does not exist. Core tools (node, git, bb) remain functional. Image size is reduced compared to previous builds.
  </done>
</task>

</tasks>

<verification>
Phase 46 success verification checklist:
1. `grep -c "TMUX_VERSION" src/aishell/docker/templates.clj` in base-dockerfile section returns 0
2. `grep -c "tmux-builds" src/aishell/docker/templates.clj` returns 0
3. `grep -c "tmux.conf" src/aishell/docker/templates.clj` in base-dockerfile section returns 0
4. Foundation image builds successfully with `aishell build --force`
5. `docker run --rm aishell:foundation tmux -V` fails with "not found"
6. `docker run --rm aishell:foundation node --version` succeeds
7. Entrypoint script in templates.clj still contains WITH_TMUX logic (unchanged, Phase 49 scope)
</verification>

<success_criteria>
- Foundation image builds without errors after tmux removal
- tmux command unavailable inside foundation containers
- /etc/tmux.conf absent from foundation image
- Image size reduced (visible in build output)
- No TMUX_VERSION ARG in base-dockerfile template
- Core container tools (node, git, bb, gosu) still functional
- Entrypoint script unchanged (WITH_TMUX dead code paths preserved for Phase 49)
</success_criteria>

<output>
After completion, create `.planning/phases/46-foundation-image-cleanup/46-01-SUMMARY.md`
</output>
