---
phase: 18-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/core.clj
  - scripts/build-release.sh
autonomous: true

must_haves:
  truths:
    - "Build script creates single-file uberscript from source"
    - "Uberscript executes directly with shebang (./dist/aishell, not bb dist/aishell)"
    - "Version is injected at build time (not hardcoded in source)"
    - "Checksum file is generated alongside uberscript"
  artifacts:
    - path: "scripts/build-release.sh"
      provides: "Uberscript build automation"
      min_lines: 25
    - path: "src/aishell/core.clj"
      provides: "Version placeholder for injection"
      contains: "__VERSION__"
  key_links:
    - from: "scripts/build-release.sh"
      to: "src/aishell/core.clj"
      via: "bb uberscript command"
      pattern: "bb uberscript"
    - from: "scripts/build-release.sh"
      to: "dist/aishell"
      via: "sed version injection"
      pattern: "sed.*__VERSION__"
---

<objective>
Create the build script that packages aishell source into a single-file Babashka uberscript with version injection and checksum generation.

Purpose: Enable reproducible release builds that produce distributable artifacts for GitHub Releases.
Output: `scripts/build-release.sh` that generates `dist/aishell` and `dist/aishell.sha256`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-distribution/18-CONTEXT.md
@.planning/phases/18-distribution/18-RESEARCH.md

@src/aishell/core.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update core.clj with version placeholder</name>
  <files>src/aishell/core.clj</files>
  <action>
    Modify the version definition in core.clj:
    - Change `(def version "2.0.0")` to `(def version "__VERSION__")`
    - This placeholder will be replaced by sed during the build process
    - The dev entry script (aishell.clj) will show "__VERSION__" during development, which is fine

    Keep all other code unchanged.
  </action>
  <verify>grep -q '__VERSION__' src/aishell/core.clj</verify>
  <done>core.clj contains version placeholder "__VERSION__" ready for build-time injection</done>
</task>

<task type="auto">
  <name>Task 2: Create build-release.sh script</name>
  <files>scripts/build-release.sh</files>
  <action>
    Create `scripts/build-release.sh` that:

    1. Accept VERSION as first argument (required, e.g., "2.0.0")
    2. Create dist/ directory
    3. Run `bb uberscript dist/aishell -m aishell.core`
    4. Add shebang `#!/usr/bin/env bb` as first line using sed
    5. Inject version using sed: replace `__VERSION__` with actual version
    6. Make executable with chmod +x
    7. Generate checksum file dist/aishell.sha256
       - Use sha256sum on Linux, shasum -a 256 on macOS
       - Format: `{hash}  aishell` (two spaces, relative filename)
    8. Print success message with version and checksum

    Script requirements:
    - Use `set -euo pipefail` for safety
    - Validate VERSION argument is provided
    - Support both Linux (sha256sum) and macOS (shasum -a 256)
    - Use sed -i on Linux, sed -i '' on macOS (detect platform)

    Reference RESEARCH.md Pattern 1 and Pattern 2 for implementation.
  </action>
  <verify>
    Run: VERSION=2.0.0 ./scripts/build-release.sh 2.0.0
    Then: ./dist/aishell --version (should show "aishell 2.0.0")
    Then: file dist/aishell (should show "ASCII text executable")
    Then: cat dist/aishell.sha256 (should show hash)
  </verify>
  <done>
    Build script exists at scripts/build-release.sh, runs successfully, produces:
    - dist/aishell (executable uberscript with correct version)
    - dist/aishell.sha256 (checksum file)
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify uberscript execution</name>
  <files>dist/aishell</files>
  <action>
    Test the generated uberscript thoroughly:

    1. Run `./dist/aishell --version` - should show "aishell 2.0.0"
    2. Run `./dist/aishell --help` - should show help text
    3. Run `./dist/aishell build --help` - should show build help
    4. Verify shebang is present: `head -1 dist/aishell` should show `#!/usr/bin/env bb`
    5. Verify checksum matches:
       - Calculate: sha256sum dist/aishell | awk '{print $1}'
       - Compare with: awk '{print $1}' dist/aishell.sha256
       - Must match

    If any test fails, debug the build script and rebuild.

    Note: Commands that require Docker (build, shell, claude) will fail without Docker - that's expected. We're verifying the uberscript loads and executes correctly.
  </action>
  <verify>
    ./dist/aishell --version outputs "aishell 2.0.0"
    ./dist/aishell --help outputs help text without errors
    Checksum verification passes
  </verify>
  <done>
    Uberscript executes correctly:
    - --version shows correct version
    - --help works
    - Checksum file is accurate
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. scripts/build-release.sh exists and is executable
2. Running build-release.sh produces dist/aishell and dist/aishell.sha256
3. dist/aishell is directly executable (./dist/aishell, not bb dist/aishell)
4. Version is correctly injected (not "__VERSION__")
5. Checksum file matches actual file hash
</verification>

<success_criteria>
- Build script creates reproducible uberscript artifacts
- Uberscript executes all CLI commands without classpath issues
- Version injection works correctly at build time
- Checksum verification works on both Linux and macOS
</success_criteria>

<output>
After completion, create `.planning/phases/18-distribution/18-01-SUMMARY.md`
</output>
