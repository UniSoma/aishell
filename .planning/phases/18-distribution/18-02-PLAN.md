---
phase: 18-distribution
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - install.sh
autonomous: true

must_haves:
  truths:
    - "Installer downloads aishell from GitHub Releases"
    - "Installer verifies SHA256 checksum before installation"
    - "Installer fails with clear error if Babashka not installed"
    - "Installer shows PATH warning if ~/.local/bin not in PATH"
    - "Installer shows quick start instructions after success"
  artifacts:
    - path: "install.sh"
      provides: "curl|bash installer for v2.0"
      min_lines: 80
      contains: "install_aishell"
  key_links:
    - from: "install.sh"
      to: "GitHub Releases"
      via: "curl download"
      pattern: "github.com.*releases"
    - from: "install.sh"
      to: "~/.local/bin/aishell"
      via: "file copy and chmod"
      pattern: "chmod.*aishell"
---

<objective>
Create the curl|bash installer script that downloads and installs aishell from GitHub Releases with checksum verification.

Purpose: Enable one-liner installation: `curl -fsSL ... | bash`
Output: `install.sh` with partial download protection, checksum verification, and user guidance
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-distribution/18-CONTEXT.md
@.planning/phases/18-distribution/18-RESEARCH.md
@.planning/phases/18-distribution/18-01-SUMMARY.md

@install.sh (existing legacy installer for reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create v2.0 installer script</name>
  <files>install.sh</files>
  <action>
    Replace the existing install.sh with a new v2.0 installer that:

    **Structure (from RESEARCH.md Pattern 3):**
    - Wrap entire installer in `install_aishell()` function
    - Call function on last line: `install_aishell "$@"`
    - This protects against partial download execution

    **Dependency checks (from RESEARCH.md Pattern 4):**
    - Check for Babashka (bb command)
      - If missing: "Error: Babashka required. Install: https://babashka.org" and exit 1
    - Check for curl or wget (need one)
      - If neither: "Error: Either 'curl' or 'wget' required" and exit 1

    **Configuration:**
    - REPO_URL="https://github.com/UniSoma/aishell"
    - VERSION="${VERSION:-latest}" (env var override for pinning)
    - INSTALL_DIR="${INSTALL_DIR:-${HOME}/.local/bin}" (env var override)

    **Download logic:**
    - Create install directory with mkdir -p (silently)
    - Determine download URL:
      - latest: ${REPO_URL}/releases/latest/download/aishell
      - specific: ${REPO_URL}/releases/download/v${VERSION}/aishell
    - Download aishell to ${INSTALL_DIR}/aishell
    - Download checksum to /tmp/aishell.sha256
    - Use curl with --retry 3 or wget with --tries=3

    **Checksum verification (from RESEARCH.md Pitfall 5):**
    - Extract expected hash from downloaded .sha256 file
    - Calculate actual hash (sha256sum on Linux, shasum -a 256 on macOS)
    - Compare hashes
    - If mismatch: print error with both hashes, delete downloaded file, exit 1

    **Post-install:**
    - chmod +x the installed file
    - Clean up /tmp/aishell.sha256
    - Print success message
    - Check PATH (from RESEARCH.md Pattern 5):
      - If ~/.local/bin not in PATH: print instructions to add it
      - If in PATH: print quick start instructions (aishell build, aishell shell)

    **Progress messages (from CONTEXT.md):**
    - "Downloading aishell..."
    - "Verifying checksum..."
    - "Installing..."
    - "Done!"

    **Error messages (from CONTEXT.md):**
    - Missing Babashka: "Error: Babashka required. Install: https://babashka.org"
    - Checksum failure: "Error: Checksum verification failed" with expected/actual hashes
    - Permission denied: Catch and report "Cannot write to ~/.local/bin. Check permissions."

    Use `set -euo pipefail` at the top.
    Keep color support similar to existing install.sh for nice output.
  </action>
  <verify>
    Syntax check: bash -n install.sh
    Structure check: grep -q 'install_aishell()' install.sh
    Function call check: tail -3 install.sh | grep -q 'install_aishell'
  </verify>
  <done>
    install.sh exists with:
    - Function wrapper for partial download protection
    - Babashka dependency check
    - curl/wget support with retry
    - SHA256 checksum verification
    - PATH detection and advisory
    - Quick start instructions
  </done>
</task>

<task type="auto">
  <name>Task 2: Test installer end-to-end with local HTTP server</name>
  <files>install.sh</files>
  <action>
    Test the full curl|bash installation flow using a local HTTP server (Babashka):

    1. Create test release artifacts:
       ```bash
       mkdir -p /tmp/test-release
       cp dist/aishell /tmp/test-release/aishell
       cp dist/aishell.sha256 /tmp/test-release/aishell.sha256
       ```

    2. Start a local HTTP server using Babashka http-server (in background):
       ```bash
       bb -Sdeps '{:deps {org.babashka/http-server {:mvn/version "0.1.14"}}}' \
          -e '(require (quote [babashka.http-server :as server])) (server/exec {:port 8888 :dir "/tmp/test-release"})' &
       SERVER_PID=$!
       sleep 1  # Give server time to start
       ```

    3. Create a modified install.sh for local testing (test-install.sh):
       - Copy install.sh to /tmp/test-release/install.sh
       - Replace GitHub URL with http://localhost:8888
       - Set INSTALL_DIR to /tmp/test-bin

    4. Test the full curl|bash flow:
       ```bash
       mkdir -p /tmp/test-bin
       curl -fsSL http://localhost:8888/install.sh | INSTALL_DIR=/tmp/test-bin bash
       ```

    5. Verify installation worked:
       - /tmp/test-bin/aishell exists and is executable
       - /tmp/test-bin/aishell --version shows correct version

    6. Test error cases:
       - Corrupt the checksum file and verify checksum error
       - Test with bb temporarily unavailable (rename or use PATH manipulation)

    7. Cleanup:
       ```bash
       kill $SERVER_PID 2>/dev/null
       rm -rf /tmp/test-release /tmp/test-bin
       ```

    This validates the actual curl|bash pattern, not just script logic.
  </action>
  <verify>
    - Local HTTP server serves test artifacts
    - curl|bash downloads and installs successfully
    - Installed binary executes correctly (--version)
    - Checksum verification works (fails on corrupt)
    - Babashka check produces correct error message
  </verify>
  <done>
    Full curl|bash installation flow validated:
    - Installer downloads from HTTP URL
    - Checksum verification works correctly
    - Binary installs to target directory
    - Installed binary executes successfully
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. install.sh is a valid bash script
2. Installer is wrapped in function (partial download protection)
3. Babashka check fails gracefully with helpful message
4. Checksum verification logic is correct
5. PATH detection provides correct guidance
</verification>

<success_criteria>
- Installer can be run via curl|bash pattern
- Missing Babashka produces clear error with install URL
- Checksum verification prevents corrupted installs
- Users get clear guidance on PATH and next steps
</success_criteria>

<output>
After completion, create `.planning/phases/18-distribution/18-02-SUMMARY.md`
</output>
