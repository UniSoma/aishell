---
phase: 18-distribution
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - install.sh
autonomous: true

must_haves:
  truths:
    - "Installer downloads aishell from GitHub Releases"
    - "Installer verifies SHA256 checksum before installation"
    - "Installer fails with clear error if Babashka not installed"
    - "Installer shows PATH warning if ~/.local/bin not in PATH"
    - "Installer shows quick start instructions after success"
  artifacts:
    - path: "install.sh"
      provides: "curl|bash installer for v2.0"
      min_lines: 80
      contains: "install_aishell"
  key_links:
    - from: "install.sh"
      to: "GitHub Releases"
      via: "curl download"
      pattern: "github.com.*releases"
    - from: "install.sh"
      to: "~/.local/bin/aishell"
      via: "file copy and chmod"
      pattern: "chmod.*aishell"
---

<objective>
Create the curl|bash installer script that downloads and installs aishell from GitHub Releases with checksum verification.

Purpose: Enable one-liner installation: `curl -fsSL ... | bash`
Output: `install.sh` with partial download protection, checksum verification, and user guidance
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-distribution/18-CONTEXT.md
@.planning/phases/18-distribution/18-RESEARCH.md
@.planning/phases/18-distribution/18-01-SUMMARY.md

@install.sh (existing legacy installer for reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create v2.0 installer script</name>
  <files>install.sh</files>
  <action>
    Replace the existing install.sh with a new v2.0 installer that:

    **Structure (from RESEARCH.md Pattern 3):**
    - Wrap entire installer in `install_aishell()` function
    - Call function on last line: `install_aishell "$@"`
    - This protects against partial download execution

    **Dependency checks (from RESEARCH.md Pattern 4):**
    - Check for Babashka (bb command)
      - If missing: "Error: Babashka required. Install: https://babashka.org" and exit 1
    - Check for curl or wget (need one)
      - If neither: "Error: Either 'curl' or 'wget' required" and exit 1

    **Configuration:**
    - REPO_URL="https://github.com/UniSoma/aishell"
    - VERSION="${VERSION:-latest}" (env var override for pinning)
    - INSTALL_DIR="${INSTALL_DIR:-${HOME}/.local/bin}" (env var override)

    **Download logic:**
    - Create install directory with mkdir -p (silently)
    - Determine download URL:
      - latest: ${REPO_URL}/releases/latest/download/aishell
      - specific: ${REPO_URL}/releases/download/v${VERSION}/aishell
    - Download aishell to ${INSTALL_DIR}/aishell
    - Download checksum to /tmp/aishell.sha256
    - Use curl with --retry 3 or wget with --tries=3

    **Checksum verification (from RESEARCH.md Pitfall 5):**
    - Extract expected hash from downloaded .sha256 file
    - Calculate actual hash (sha256sum on Linux, shasum -a 256 on macOS)
    - Compare hashes
    - If mismatch: print error with both hashes, delete downloaded file, exit 1

    **Post-install:**
    - chmod +x the installed file
    - Clean up /tmp/aishell.sha256
    - Print success message
    - Check PATH (from RESEARCH.md Pattern 5):
      - If ~/.local/bin not in PATH: print instructions to add it
      - If in PATH: print quick start instructions (aishell build, aishell shell)

    **Progress messages (from CONTEXT.md):**
    - "Downloading aishell..."
    - "Verifying checksum..."
    - "Installing..."
    - "Done!"

    **Error messages (from CONTEXT.md):**
    - Missing Babashka: "Error: Babashka required. Install: https://babashka.org"
    - Checksum failure: "Error: Checksum verification failed" with expected/actual hashes
    - Permission denied: Catch and report "Cannot write to ~/.local/bin. Check permissions."

    Use `set -euo pipefail` at the top.
    Keep color support similar to existing install.sh for nice output.
  </action>
  <verify>
    Syntax check: bash -n install.sh
    Structure check: grep -q 'install_aishell()' install.sh
    Function call check: tail -3 install.sh | grep -q 'install_aishell'
  </verify>
  <done>
    install.sh exists with:
    - Function wrapper for partial download protection
    - Babashka dependency check
    - curl/wget support with retry
    - SHA256 checksum verification
    - PATH detection and advisory
    - Quick start instructions
  </done>
</task>

<task type="auto">
  <name>Task 2: Test installer locally</name>
  <files>install.sh</files>
  <action>
    Test the installer script locally (without actually downloading from GitHub):

    1. Create a mock test environment:
       - Copy dist/aishell to /tmp/test-release/aishell
       - Copy dist/aishell.sha256 to /tmp/test-release/aishell.sha256

    2. Test dependency checks:
       - Temporarily rename bb to test missing Babashka error (or use Docker)
       - Verify error message is correct

    3. Test checksum verification:
       - Modify the mock aishell file to corrupt it
       - Run installer pointing to mock release
       - Verify checksum error is shown

    4. Test successful install flow:
       - Set INSTALL_DIR=/tmp/test-install
       - Point installer at local mock release (modify script temporarily or use local server)
       - Verify file is installed and executable

    5. Test PATH detection:
       - Verify PATH warning appears when ~/.local/bin not in PATH
       - Or verify quick start appears when it is in PATH

    Note: Full integration test will happen after GitHub Release is created. This task validates the logic works.
  </action>
  <verify>
    - Installer syntax is valid
    - Dependency check logic works
    - Checksum verification logic works
    - PATH detection works
  </verify>
  <done>
    Installer script logic validated locally:
    - Dependency checks work correctly
    - Checksum verification catches corruption
    - PATH detection provides appropriate guidance
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. install.sh is a valid bash script
2. Installer is wrapped in function (partial download protection)
3. Babashka check fails gracefully with helpful message
4. Checksum verification logic is correct
5. PATH detection provides correct guidance
</verification>

<success_criteria>
- Installer can be run via curl|bash pattern
- Missing Babashka produces clear error with install URL
- Checksum verification prevents corrupted installs
- Users get clear guidance on PATH and next steps
</success_criteria>

<output>
After completion, create `.planning/phases/18-distribution/18-02-SUMMARY.md`
</output>
