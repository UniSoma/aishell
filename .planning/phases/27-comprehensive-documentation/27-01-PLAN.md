---
phase: 27-comprehensive-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/ARCHITECTURE.md
  - docs/CONFIGURATION.md
autonomous: true

must_haves:
  truths:
    - "docs/ARCHITECTURE.md explains the Host -> Container -> Harness data flow"
    - "docs/ARCHITECTURE.md documents namespace responsibilities"
    - "docs/CONFIGURATION.md provides a full annotated config.yaml example"
    - "docs/CONFIGURATION.md explains the merge strategy for extends: global"
  artifacts:
    - path: "docs/ARCHITECTURE.md"
      provides: "System architecture documentation with Mermaid diagrams"
      min_lines: 100
    - path: "docs/CONFIGURATION.md"
      provides: "Complete configuration reference with examples"
      min_lines: 150
  key_links:
    - from: "docs/ARCHITECTURE.md"
      to: "src/aishell/"
      via: "namespace references"
      pattern: "aishell\\.(cli|config|run|docker)"
    - from: "docs/CONFIGURATION.md"
      to: ".aishell/config.yaml"
      via: "example reference"
      pattern: "\\.aishell/config\\.yaml"
---

<objective>
Create the foundational documentation for aishell architecture and configuration.

Purpose: Enable users to understand how aishell works (Host -> Container -> Harness flow) and reference all available configuration options.

Output:
- docs/ARCHITECTURE.md with Mermaid diagrams and namespace explanations
- docs/CONFIGURATION.md with full annotated config.yaml and merge strategy
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-comprehensive-documentation/27-CONTEXT.md
@.planning/phases/27-comprehensive-documentation/27-RESEARCH.md
@src/aishell/cli.clj
@src/aishell/config.clj
@src/aishell/run.clj
@src/aishell/docker/build.clj
@src/aishell/docker/templates.clj
@.aishell/config.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create docs/ARCHITECTURE.md</name>
  <files>docs/ARCHITECTURE.md</files>
  <action>
Create the Architecture documentation with:

1. **Header section:**
   - Title: "aishell Architecture"
   - Brief intro explaining the document scope
   - "Last updated: v2.4.0"

2. **System Overview with Mermaid diagram:**
   - Host Machine (CLI, Project, Config)
   - Docker Container (Entrypoint, Harness, Tools)
   - Data flow arrows showing mounts and execution
   - Use Mermaid.js graph TB format (GitHub renders natively)

3. **Data Flow section:**
   - Build phase: CLI -> Dockerfile template -> Docker build
   - Run phase: CLI -> Docker run -> Entrypoint -> Harness
   - Config merge: Global config -> Project config -> Runtime

4. **Namespace Responsibilities table:**
   Document key namespaces from src/aishell/:
   - aishell.cli: Command parsing, dispatch, help
   - aishell.config: YAML loading, merging, validation
   - aishell.run: Container execution, harness routing
   - aishell.docker.build: Image building, state management
   - aishell.docker.templates: Dockerfile/entrypoint generation
   - aishell.docker.run: Docker command construction
   - aishell.detection.core: Sensitive file detection
   - aishell.gitleaks: Gitleaks integration

5. **Key Files section:**
   Brief descriptions of:
   - ~/.aishell/state.edn (build state)
   - .aishell/config.yaml (project config)
   - .aishell/Dockerfile (project extension)

Keep tone: technical but approachable. Use tables for namespace reference.
  </action>
  <verify>File exists at docs/ARCHITECTURE.md with valid Mermaid diagram syntax (```mermaid block)</verify>
  <done>Architecture document explains Host -> Container -> Harness flow with Mermaid diagram and namespace table</done>
</task>

<task type="auto">
  <name>Task 2: Create docs/CONFIGURATION.md</name>
  <files>docs/CONFIGURATION.md</files>
  <action>
Create the Configuration documentation with:

1. **Header section:**
   - Title: "aishell Configuration Reference"
   - Explain the two config files: global (~/.aishell/config.yaml) and project (.aishell/config.yaml)
   - "Last updated: v2.4.0"

2. **Config Inheritance (extends):**
   - Default: `extends: global` (merge with global config)
   - Override: `extends: none` (project config only)
   - Merge strategy table:
     | Type | Behavior | Example |
     |------|----------|---------|
     | Lists (mounts, ports) | Concatenate | global + project |
     | Maps (env, harness_args) | Shallow merge | project overrides global |
     | Scalars (pre_start) | Replace | project wins |

3. **Full Annotated Example:**
   Include a complete config.yaml with ALL options, commented.
   Reference the existing .aishell/config.yaml as source of truth.

4. **Configuration Reference sections:**
   For each config option:
   - extends
   - mounts (both formats: string and source/target)
   - env (both formats: map and array)
   - ports (including IP binding)
   - docker_args (string and array)
   - pre_start
   - harness_args (per-harness defaults)
   - detection (enabled, custom_patterns, allowlist)
   - gitleaks_freshness_check

   Each option needs:
   - Purpose
   - Syntax/formats
   - Example
   - Notes/caveats

5. **Common Patterns section:**
   - Database credentials mounting
   - Port exposure for web servers
   - Custom Docker resource limits
   - Per-harness model configuration

Keep tone: reference-focused but with practical examples.
  </action>
  <verify>File exists at docs/CONFIGURATION.md with extends/merge strategy documented and full config example</verify>
  <done>Configuration document covers all config.yaml options with annotated examples and merge strategy explanation</done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Check docs/ directory exists with both files:
   ```bash
   ls -la docs/
   ```

2. Verify Mermaid syntax in ARCHITECTURE.md:
   ```bash
   grep -A 20 '```mermaid' docs/ARCHITECTURE.md
   ```

3. Verify merge strategy is documented in CONFIGURATION.md:
   ```bash
   grep -i 'merge\|extends' docs/CONFIGURATION.md
   ```

4. Verify namespace table in ARCHITECTURE.md:
   ```bash
   grep -E 'aishell\.(cli|config|run|docker)' docs/ARCHITECTURE.md
   ```
</verification>

<success_criteria>
- docs/ARCHITECTURE.md exists with 100+ lines
- docs/ARCHITECTURE.md contains Mermaid diagram
- docs/ARCHITECTURE.md documents namespace responsibilities
- docs/CONFIGURATION.md exists with 150+ lines
- docs/CONFIGURATION.md explains merge strategy for extends
- docs/CONFIGURATION.md provides full annotated config example
- Both files follow consistent formatting
</success_criteria>

<output>
After completion, create `.planning/phases/27-comprehensive-documentation/27-01-SUMMARY.md`
</output>
