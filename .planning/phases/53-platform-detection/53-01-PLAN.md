---
phase: 53-platform-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/run.clj
  - src/aishell/run.clj
  - src/aishell/attach.clj
autonomous: true

must_haves:
  truths:
    - "get-uid and get-gid throw informative ex-info on Windows instead of crashing on missing `id` command"
    - "p/exec calls in run.clj and attach.clj throw informative ex-info on Windows instead of UnsupportedOperationException"
    - "All existing Unix behavior is unchanged — guards only activate when (fs/windows?) returns true"
    - "No container paths (/bin/bash, /usr/local/bin) are guarded — only host-side Unix assumptions"
  artifacts:
    - path: "src/aishell/docker/run.clj"
      provides: "Platform-guarded UID/GID extraction"
      contains: "fs/windows?"
    - path: "src/aishell/run.clj"
      provides: "Platform-guarded process replacement"
      contains: "fs/windows?"
    - path: "src/aishell/attach.clj"
      provides: "Platform-guarded attach exec"
      contains: "fs/windows?"
  key_links:
    - from: "src/aishell/docker/run.clj"
      to: "build-docker-args-internal"
      via: "get-uid and get-gid called at line 230-231"
      pattern: "fs/windows\\?"
    - from: "src/aishell/run.clj"
      to: "p/exec"
      via: "apply p/exec at line 243"
      pattern: "fs/windows\\?"
    - from: "src/aishell/attach.clj"
      to: "p/exec"
      via: "p/exec docker exec at line 65"
      pattern: "fs/windows\\?"
---

<objective>
Add platform detection guards to all Unix-specific host-side code paths using `babashka.fs/windows?`.

Purpose: Prevent runtime crashes when aishell runs on Windows by guarding `id -u`/`id -g` commands and `p/exec` calls with platform checks that throw informative errors pointing to the later phases that will implement Windows alternatives.

Output: 3 modified source files with platform guards; no new files created.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53-platform-detection/53-RESEARCH.md
@src/aishell/docker/run.clj
@src/aishell/run.clj
@src/aishell/attach.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Guard UID/GID extraction in docker/run.clj</name>
  <files>src/aishell/docker/run.clj</files>
  <action>
Guard `get-uid` and `get-gid` functions with `(fs/windows?)` platform checks.

**`get-uid` (line 28-29):** Wrap in `if (fs/windows?)` — on Windows, throw `(ex-info "UID detection not supported on Windows. See: github.com/... Phase 55 (Host Identity)" {:platform :windows})`. On Unix, keep existing `(-> (p/shell {:out :string} "id" "-u") :out str/trim)`.

**`get-gid` (line 30-31):** Same pattern as get-uid — throw ex-info on Windows, keep existing shell call on Unix.

`babashka.fs` is ALREADY required as `fs` in this file's ns declaration (line 5). No require changes needed.

**Do NOT:**
- Guard container paths like `/bin/bash`, `/usr/local/bin`, `/etc/passwd`, `/tmp/pre-start.log` — these run inside Linux containers on all platforms
- Implement Windows UID/GID defaults (1000/1000) — that is Phase 55 scope
- Touch any other functions in this file
  </action>
  <verify>
Run `bb -e "(require '[aishell.docker.run])"` from project root to confirm the file loads without errors (SCI analysis-time symbol resolution). Then grep for `fs/windows?` in the file to confirm guards are present.
  </verify>
  <done>
`get-uid` and `get-gid` each contain an `(if (fs/windows?) (throw ...) ...)` guard. File loads successfully in Babashka. Existing Unix behavior unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Guard p/exec calls in run.clj and attach.clj</name>
  <files>src/aishell/run.clj, src/aishell/attach.clj</files>
  <action>
Guard `p/exec` usage in both files with `(fs/windows?)` platform checks.

**src/aishell/run.clj (line 243):**
1. Add `[babashka.fs :as fs]` to the `:require` vector in the ns declaration (currently NOT imported in this file).
2. Wrap the `(apply p/exec ...)` call at line 243 in a platform check: `(if (fs/windows?) (throw (ex-info "Process replacement (p/exec) not supported on Windows. See: Phase 56 (Process & Execution)" {:platform :windows})) (apply p/exec (concat docker-args container-cmd)))`.

**src/aishell/attach.clj (line 65):**
1. Add `[babashka.fs :as fs]` to the `:require` vector in the ns declaration (currently NOT imported in this file).
2. Wrap the `(p/exec "docker" "exec" ...)` call at line 65 in a platform check: `(if (fs/windows?) (throw (ex-info "Process replacement (p/exec) not supported on Windows. See: Phase 56 (Process & Execution)" {:platform :windows})) (p/exec "docker" "exec" ...existing args...))`.

**Important formatting:** Keep the existing code structure. The `if` wraps the final expression in each function — the existing `p/exec` call becomes the else branch.

**Do NOT:**
- Change the gitleaks branch in run.clj (line 228-238) — it uses `p/shell`, not `p/exec`, so it already works cross-platform
- Guard the `p/shell` call in `run-exec` (line 298) — `p/shell` works on Windows
- Implement Windows process alternatives (p/process + :inherit) — that is Phase 56 scope
  </action>
  <verify>
Run `bb -e "(require '[aishell.run])"` and `bb -e "(require '[aishell.attach])"` from project root to confirm both files load without errors. Then grep for `fs/windows?` in both files to confirm guards are present.
  </verify>
  <done>
Both `run.clj` and `attach.clj` have `babashka.fs` imported and `p/exec` calls guarded with `(if (fs/windows?) (throw ...) ...)`. Both files load successfully in Babashka. Existing Unix behavior unchanged.
  </done>
</task>

</tasks>

<verification>
1. All 3 source files load in Babashka without errors:
   ```bash
   bb -e "(require '[aishell.docker.run])" && echo "docker/run OK"
   bb -e "(require '[aishell.run])" && echo "run OK"
   bb -e "(require '[aishell.attach])" && echo "attach OK"
   ```
2. Grep confirms 4 `fs/windows?` guards across 3 files:
   ```bash
   grep -rn "fs/windows?" src/aishell/docker/run.clj src/aishell/run.clj src/aishell/attach.clj
   ```
   Expected: 2 hits in docker/run.clj (get-uid, get-gid), 1 hit in run.clj, 1 hit in attach.clj
3. Run `bb aishell.clj --help` to verify the full CLI still works on Unix (no behavior change).
4. No container paths are guarded — grep for `fs/windows?` should NOT appear near `/bin/bash`, `/usr/local/bin`, `/etc/passwd`, or `/tmp/`.
</verification>

<success_criteria>
- 4 platform guards added (2 in docker/run.clj, 1 in run.clj, 1 in attach.clj)
- All guards use `(fs/windows?)` from `babashka.fs`
- All guards throw `ex-info` with informative message and phase reference
- Existing Unix behavior completely unchanged (guards only activate on Windows)
- All files load in Babashka without SCI errors
- Full CLI still works (`aishell --help`)
</success_criteria>

<output>
After completion, create `.planning/phases/53-platform-detection/53-01-SUMMARY.md`
</output>
