---
phase: 51-cli-semantics-update
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/cli.clj
  - src/aishell/run.clj
  - src/aishell/docker/run.clj
  - src/aishell/attach.clj
autonomous: true

must_haves:
  truths:
    - "`aishell` (no args) creates container named `shell`"
    - "`aishell claude` creates container named `claude`"
    - "`aishell --name foo` creates container named `foo` running bash"
    - "`aishell claude --name bar` creates container named `bar` running Claude Code"
    - "Creation commands error if named container already running"
    - "`--detach`/`-d` flag is rejected by CLI (no detached mode)"
    - "Help text contains no references to --detach"
  artifacts:
    - path: "src/aishell/cli.clj"
      provides: "CLI dispatch without detach extraction, --name extraction for all run modes"
      contains: "should-extract-name?"
    - path: "src/aishell/run.clj"
      provides: "Container execution with foreground-only mode"
    - path: "src/aishell/docker/run.clj"
      provides: "Docker args without detach flag support"
    - path: "src/aishell/attach.clj"
      provides: "Attach error messages without --detach references"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/run.clj"
      via: "run/run-container opts map no longer includes :detach key"
      pattern: "run/run-container"
    - from: "src/aishell/run.clj"
      to: "src/aishell/docker/run.clj"
      via: "build-docker-args no longer receives :detach key"
      pattern: "build-docker-args"
---

<objective>
Remove the `--detach`/`-d` flag from the CLI and extend `--name` extraction to work in shell mode, completing the always-attached container model for v3.0.0.

Purpose: With tmux removed from containers (Phases 46-50), detached mode has no purpose. Containers are always foreground-attached. The `--name` flag needs to work in shell mode to satisfy CLI-03.

Output: All 4 source files updated, no detach code paths remain, `--name` works for all run modes.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-cli-semantics-update/51-RESEARCH.md
@src/aishell/cli.clj
@src/aishell/run.clj
@src/aishell/docker/run.clj
@src/aishell/attach.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove detach flag and extend --name extraction</name>
  <files>
    src/aishell/cli.clj
    src/aishell/run.clj
    src/aishell/docker/run.clj
  </files>
  <action>
**cli.clj changes:**

1. Delete detach extraction (lines 484-486): Remove the 3 lines that extract `--detach`/`-d` flag and clean args.

2. Extend `--name` extraction to cover shell mode. Currently `should-extract-name?` (line 491) only triggers for harness commands. Change the logic so `--name` is extracted for ALL run-mode commands (harness commands AND when no command is given). The cleanest approach: remove the `harness-commands` guard entirely and extract `--name` unconditionally (before the `case` dispatch). Commands that don't use it (setup, update, check, etc.) won't see it because they go through `cli/dispatch` which has its own spec. The `--name` extraction must also handle the case where `--name` appears but the first arg is NOT a harness command and NOT absent (e.g., `aishell setup --name foo` should NOT extract --name since setup goes through babashka.cli dispatch).

   Revised approach: Extract `--name` when the first arg is either:
   - A harness command (claude, opencode, codex, gemini, gitleaks), OR
   - NOT a known subcommand (setup, update, check, exec, ps, volumes, attach) — meaning it's shell mode or will go to handle-default

   Replace line 490-491:
   ```clojure
   known-subcommands #{"setup" "update" "check" "exec" "ps" "volumes" "attach"}
   should-extract-name? (not (contains? known-subcommands (first clean-args)))
   ```

3. Remove `:detach detach?` from ALL `run/run-container` calls (lines 536, 538, 540, 542, 544, 548). Each opts map should no longer include `:detach`.

4. **CRITICAL: Wire --name to shell mode dispatch.** The current conditional at lines 546-551:
   ```clojure
   (if unsafe?
     (run/run-container nil [] {:unsafe true :container-name container-name-override :detach detach?})
     (cli/dispatch dispatch-table args {:error-fn handle-error :restrict true}))
   ```
   has a bug: when `aishell --name foo` is run (no --unsafe), `container-name-override` is "foo" but the code falls through to `cli/dispatch` which discards it. Replace with:
   ```clojure
   (if (or unsafe? container-name-override)
     (run/run-container nil [] {:unsafe (boolean unsafe?) :container-name container-name-override})
     (cli/dispatch dispatch-table args {:error-fn handle-error :restrict true}))
   ```
   This ensures `aishell --name foo` creates a container named "foo" running bash (shell mode), matching CLI-03.

5. Update `handle-ps` empty message (line 452): Replace the text that says "aishell claude --detach" and "aishell opencode --detach --name my-session" with guidance that doesn't reference --detach. New text:
   ```
   "No containers found for this project.\n\nTo start a container:\n  aishell claude\n  aishell opencode --name my-session\n\nContainers are project-specific (based on current directory)."
   ```

6. Update attach help notes (line 528): Remove the line that says "The container must be running (started with 'aishell <harness> --detach')." Replace with "The container must be running. Start one in another terminal: aishell <harness>".

**run.clj changes:**

1. Remove `:detach (:detach opts)` from the `build-docker-args` call (line 202).

2. Delete the entire detached mode branch (lines 240-258). Currently there's:
   ```clojure
   ;; For detached mode, use p/shell to capture container ID and print feedback
   ;; For foreground mode, use p/exec (replaces process)
   (if (:detach opts)
     ;; Detached mode: use p/shell so we can print feedback
     (let [result ...]
       ...)
     ;; Foreground mode: set window title, then exec (replaces process)
     (let [project-name ...]
       ...))
   ```
   Replace the entire `if (:detach opts)` with just the foreground branch (no if wrapper):
   ```clojure
   ;; Foreground mode: set window title, then exec (replaces process)
   (let [project-name (.getName (java.io.File. project-dir))]
     (print (str "\033]2;[aishell] " project-name "\007"))
     (flush)
     (apply p/exec (concat docker-args container-cmd)))
   ```

**docker/run.clj changes:**

1. Remove `detach` from the destructuring in `build-docker-args-internal` (line 229): Remove `detach` from the keys vector.

2. Remove the `(cond-> detach (conj "--detach"))` line (line 236).

3. Remove `detach` from the destructuring in `build-docker-args` (line 321): Remove `detach` from the keys vector.

4. Remove `:detach detach` from the map passed to `build-docker-args-internal` (line 330).
  </action>
  <verify>
    Run: `grep -rn "detach" src/` — should return ZERO results.
    Run: `grep -rn "should-extract-name" src/aishell/cli.clj` — should show the updated logic with `known-subcommands`.
    Run: `bb -cp src -e "(require '[aishell.cli]) :ok"` — should load without errors (SCI analysis check).
  </verify>
  <done>
    - No `detach` references in any source file under src/
    - `--name` extraction works for both harness commands and shell mode (not just harness commands)
    - `aishell --name foo` dispatches to run/run-container (not cli/dispatch), creating container "foo" in shell mode
    - All run/run-container calls pass opts without :detach
    - build-docker-args no longer accepts or uses :detach
    - Help text (ps empty, attach notes) contains no --detach references
  </done>
</task>

<task type="auto">
  <name>Task 2: Update attach.clj error messages</name>
  <files>
    src/aishell/attach.clj
  </files>
  <action>
Update `validate-container-state!` in attach.clj to remove `--detach` references from error messages.

1. Line 36: Change `"To start: aishell " short-name " --detach"` to `"To start: aishell " short-name` (remove " --detach" suffix).

2. Line 40: Change `"To start: aishell " short-name " --detach\n"` to `"To start: aishell " short-name "\n"` (remove " --detach" and keep the \n).
  </action>
  <verify>
    Run: `grep -n "detach" src/aishell/attach.clj` — should return ZERO results.
    Run: `grep -n "To start:" src/aishell/attach.clj` — should show messages without --detach.
  </verify>
  <done>
    - attach.clj error messages guide users to start containers without --detach flag
    - No "detach" string appears anywhere in attach.clj
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "detach" src/` — ZERO results (complete removal)
2. `grep -rn "\-d\b" src/aishell/cli.clj` — no -d flag extraction (only legitimate -d uses like unrelated flags)
3. `bb -cp src -e "(require '[aishell.cli]) :ok"` — loads without SCI errors
4. `grep -n "should-extract-name" src/aishell/cli.clj` — shows updated extraction logic
5. `grep -n "known-subcommands" src/aishell/cli.clj` — confirms new guard set
6. `grep -n "or unsafe? container-name-override" src/aishell/cli.clj` — confirms --name wired to shell mode dispatch
</verification>

<success_criteria>
- CLI-01: `aishell` (no args) → container named "shell" (already works, unchanged)
- CLI-02: `aishell claude` → container named "claude" (already works, unchanged)
- CLI-03: `aishell --name foo` → container named "foo" (FIXED: --name now extracted in shell mode)
- CLI-04: `aishell claude --name bar` → container named "bar" (already works, unchanged)
- CLI-05: error if container running (already works via ensure-name-available!)
- CLI-06: --detach/-d fully removed from codebase (REMOVED)
- No "detach" string in any source file under src/
- SCI analysis passes (bb loads without error)
</success_criteria>

<output>
After completion, create `.planning/phases/51-cli-semantics-update/51-01-SUMMARY.md`
</output>
