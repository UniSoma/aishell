---
phase: 49-entrypoint-simplification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/templates.clj
  - src/aishell/docker/build.clj
autonomous: true

must_haves:
  truths:
    - "Entrypoint script has single code path with no WITH_TMUX conditional"
    - "Container commands execute directly via exec gosu (no tmux wrapper)"
    - "No tmux plugin setup, config injection, or resurrect configuration in entrypoint"
    - "TERM validation and UTF-8 locale setup preserved (comments updated)"
    - "Babashka namespace loads without error"
  artifacts:
    - path: "src/aishell/docker/templates.clj"
      provides: "Simplified entrypoint-script and updated profile-d-script"
      contains: "exec gosu"
  key_links:
    - from: "src/aishell/docker/build.clj"
      to: "templates/entrypoint-script"
      via: "spit to entrypoint.sh during build"
      pattern: "templates/entrypoint-script"
---

<objective>
Remove all dead tmux conditional logic from the entrypoint script embedded in templates.clj

Purpose: Phase 48 removed WITH_TMUX from docker run, making all tmux conditionals in the entrypoint dead code. This phase deletes ~100 lines of dead code (plugin path bridging, config injection, resurrect configuration, conditional startup wrapper), leaving a single direct `exec gosu` execution path. Also updates tmux-referencing comments in profile-d-script.

Output: Simplified entrypoint-script (~95 lines, down from 197) and cleaned profile-d-script comments in templates.clj
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-entrypoint-simplification/49-RESEARCH.md
@src/aishell/docker/templates.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete tmux blocks from entrypoint-script and update comments</name>
  <files>src/aishell/docker/templates.clj</files>
  <action>
Edit the `entrypoint-script` def string in templates.clj. The entrypoint bash script currently spans lines 100-298 of the file. Perform these exact edits within the string:

**DELETE Block 1 (lines 218-225):** Plugin path bridging
Remove the entire block starting with "# Plugin path bridging" through the closing "fi", plus the blank line before it. This is the `if [ "$WITH_TMUX" = "true" ] && [ -d "/tools/tmux/plugins" ]` block.

**DELETE Block 2 (lines 227-264):** Config injection
Remove the entire block starting with "# Config injection: build runtime tmux config" through the closing "fi", plus the blank line before it. This is the `if [ "$WITH_TMUX" = "true" ]` block that builds RUNTIME_TMUX_CONF.

**DELETE Block 3 (lines 266-283):** Resurrect configuration
Remove the entire block starting with "# Resurrect configuration" through the closing "fi", plus the blank line before it. This is the `if [ "$WITH_TMUX" = "true" ] && [ "$RESURRECT_ENABLED" = "true" ]` block.

**DELETE Block 4 (lines 285-298):** Conditional startup wrapper
Remove the 4-line comment ("# Conditional startup: tmux session or direct shell" etc.), the entire `if [ "$WITH_TMUX" = "true" ]` block (lines 289-294), the `else` keyword (line 295), and the closing `fi` (line 297). Keep ONLY the exec gosu line (line 296) but remove its 4-space indentation so it becomes a standalone top-level statement.

**ADD:** Before the now-standalone `exec gosu` line, add a comment:
```
# Execute command as developer user
```

**UPDATE comment (line 208):** Change the TERM validation comment from:
```
# Validate TERM has terminfo entry; fallback to xterm-256color if missing
# Prevents tmux failure with custom terminals (e.g., xterm-ghostty from Ghostty)
```
to:
```
# Validate TERM has terminfo entry; fallback to xterm-256color if missing
```
(Delete the second comment line that mentions tmux)

**UPDATE comment (lines 213-214):** Change the UTF-8 locale comment from:
```
# Set UTF-8 locale before tmux starts so tmux enables Unicode mode
# Without this, tmux defaults to ASCII and Unicode characters render as dashes
```
to:
```
# Set UTF-8 locale for proper Unicode rendering
```
(Replace both lines with a single generic comment)

The resulting entrypoint-script should be approximately 95 lines, ending with:
```
# Execute command as developer user
exec gosu \"$USER_ID:$GROUP_ID\" \"$@\"
")
```

CRITICAL: Ensure the Clojure string remains valid - opening quote on def line matches the closing `")` at the end. All bash double-quotes within the string must remain escaped as `\"`.
  </action>
  <verify>
Run `bb -e "(require 'aishell.docker.templates)"` from the project root to verify the namespace loads without SCI errors. Then run `bb -e "(require 'aishell.docker.templates) (println (count (clojure.string/split-lines aishell.docker.templates/entrypoint-script)))"` to verify line count is approximately 95 (between 90 and 100).
  </verify>
  <done>entrypoint-script contains no WITH_TMUX, RESURRECT_ENABLED, RUNTIME_TMUX_CONF, or tmux references. Single exec gosu code path. Namespace loads cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Update profile-d-script comments to remove tmux references</name>
  <files>src/aishell/docker/templates.clj</files>
  <action>
Edit the `profile-d-script` def string in templates.clj. Update comments that reference tmux:

**Line 340 (comment):** Change from:
```
# Sourced by /etc/profile on login shell startup (new tmux windows, ssh, etc.)
```
to:
```
# Sourced by /etc/profile on login shell startup (new shell sessions, ssh, etc.)
```

**Line 341 (comment):** Change from:
```
# Ensures harness tools and shell customizations persist across tmux windows.
```
to:
```
# Ensures harness tools and shell customizations persist across shell sessions.
```

**Line 358 (comment):** Change from:
```
# Source harness aliases for login shells (tmux new-window)
```
to:
```
# Source harness aliases for login shells
```

Also update the `build.clj` comment on line 97 if it references tmux in the foundation image description. Change:
```
Foundation image contains only system dependencies (Debian, Node.js, babashka, gosu, gitleaks, tmux).
```
to:
```
Foundation image contains only system dependencies (Debian, Node.js, babashka, gosu, gitleaks).
```
(tmux was already removed from the foundation image in Phase 46)
  </action>
  <verify>
Run `grep -n "tmux" src/aishell/docker/templates.clj` to confirm zero tmux references remain in the file. Run `grep -n "tmux" src/aishell/docker/build.clj` to confirm the foundation image comment is updated. Then run `bb -e "(require 'aishell.docker.templates) (require 'aishell.docker.build)"` to verify both namespaces load.
  </verify>
  <done>Zero tmux references in templates.clj. build.clj foundation comment updated. Both namespaces load without error.</done>
</task>

</tasks>

<verification>
1. `bb -e "(require 'aishell.docker.templates)"` - namespace loads without error
2. `bb -e "(require 'aishell.docker.build)"` - namespace loads without error
3. `grep -rn "tmux" src/aishell/docker/templates.clj` - returns zero matches
4. `grep -c "WITH_TMUX" src/aishell/docker/templates.clj` - returns 0
5. `grep -c "RESURRECT" src/aishell/docker/templates.clj` - returns 0
6. `grep -c "exec gosu" src/aishell/docker/templates.clj` - returns exactly 1
7. Entrypoint script line count between 90-100 lines
</verification>

<success_criteria>
- Entrypoint script has single code path (no WITH_TMUX conditional)
- All tmux plugin setup, config injection, and resurrect code deleted
- TERM validation and UTF-8 locale setup preserved with updated comments
- exec gosu is standalone (not inside if/else)
- Zero tmux references in templates.clj
- Both templates and build namespaces load in Babashka
</success_criteria>

<output>
After completion, create `.planning/phases/49-entrypoint-simplification/49-01-SUMMARY.md`
</output>
