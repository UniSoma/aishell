---
phase: 58-bat-wrapper
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/build-release.clj
  - scripts/create-release.clj
  - .github/workflows/release.yml
autonomous: true

must_haves:
  truths:
    - "Running build-release.clj produces dist/aishell.bat alongside dist/aishell and dist/aishell.sha256"
    - "dist/aishell.bat contains 4-line neil-pattern wrapper with CRLF line endings"
    - "aishell.bat invokes bb -f with script path resolved via %~dp0"
    - "GitHub Release includes aishell.bat as a release asset"
    - "chmod +x is skipped on Windows (guarded by fs/windows?)"
  artifacts:
    - path: "scripts/build-release.clj"
      provides: "Build script with .bat wrapper generation"
      contains: "create-bat-wrapper"
    - path: "scripts/create-release.clj"
      provides: "Release script uploading .bat to GitHub"
      contains: "dist/aishell.bat"
    - path: ".github/workflows/release.yml"
      provides: "CI verification of .bat artifact"
      contains: "aishell.bat"
  key_links:
    - from: "scripts/build-release.clj"
      to: "dist/aishell.bat"
      via: "create-bat-wrapper function"
      pattern: "create-bat-wrapper"
    - from: "scripts/create-release.clj"
      to: "dist/aishell.bat"
      via: "gh release create asset list"
      pattern: "dist-bat"
---

<objective>
Generate a Windows .bat wrapper during the build process and include it in GitHub Releases, enabling Windows users to run `aishell` from PATH without the `bb` prefix.

Purpose: Complete the distribution story for Windows — users download aishell + aishell.bat, place both in PATH, and run `aishell <command>` natively in cmd.exe or PowerShell.
Output: Updated build pipeline that produces dist/aishell.bat and uploads it as a release asset.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-bat-wrapper/58-RESEARCH.md
@scripts/build-release.clj
@scripts/create-release.clj
@.github/workflows/release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add .bat wrapper generation to build-release.clj</name>
  <files>scripts/build-release.clj</files>
  <action>
Modify `scripts/build-release.clj` with these changes:

1. **Add `bat-file` def** after the existing `output-file` def:
   ```clojure
   (def bat-file (str output-file ".bat"))
   ```

2. **Add `create-bat-wrapper` function** after `compute-sha256`:
   ```clojure
   (defn create-bat-wrapper
     "Generate Windows .bat wrapper following neil pattern.
      Uses explicit CRLF line endings for Windows CMD compatibility."
     [script-name]
     (spit bat-file (str "@echo off\r\n"
                         "set ARGS=%*\r\n"
                         "set SCRIPT=%~dp0" script-name "\r\n"
                         "bb -f %SCRIPT% %ARGS%\r\n")))
   ```

3. **Delete existing .bat on rebuild** — add after the existing `fs/delete-if-exists` for output-file:
   ```clojure
   (fs/delete-if-exists bat-file)
   ```

4. **Guard `chmod` with platform check** — replace the bare `(p/shell "chmod" "+x" output-file)` with:
   ```clojure
   (when-not (fs/windows?)
     (p/shell "chmod" "+x" output-file))
   ```

5. **Call `create-bat-wrapper`** — add after the chmod guard, before checksum generation:
   ```clojure
   ;; Generate Windows .bat wrapper
   (create-bat-wrapper "aishell")
   ```

6. **Update completion message** — add wrapper line after "Binary:" line:
   ```clojure
   (println (str "  Wrapper:  " bat-file))
   ```

7. **Update the file header comment** to mention aishell.bat in the "Produces:" section.

Do NOT add bb.exe detection (`where bb`) logic — keep the 4-line minimal pattern per research recommendation. Do NOT add checksum for .bat (4-line file, easily auditable).
  </action>
  <verify>
Run `bb scripts/build-release.clj` from project root. Confirm:
1. dist/aishell.bat exists
2. dist/aishell.bat content is exactly 4 lines with CRLF endings: `xxd dist/aishell.bat | head -20` should show `\r\n` (0d 0a) at line ends
3. dist/aishell.bat references `%~dp0aishell` (no double backslash)
4. Build completion message includes "Wrapper:" line
5. dist/aishell and dist/aishell.sha256 still generated correctly
  </verify>
  <done>build-release.clj generates dist/aishell.bat with correct 4-line neil-pattern content and CRLF line endings alongside existing uberscript and checksum artifacts</done>
</task>

<task type="auto">
  <name>Task 2: Include .bat wrapper in GitHub Release pipeline</name>
  <files>scripts/create-release.clj, .github/workflows/release.yml</files>
  <action>
**In `scripts/create-release.clj`:**

1. **Add `dist-bat` def** after existing `dist-checksum` def:
   ```clojure
   (def dist-bat "dist/aishell.bat")
   ```

2. **Add .bat existence check** in `check-files-exist` — add after the checksum check:
   ```clojure
   (when-not (.exists (java.io.File. dist-bat))
     (exit 1 (str "Error: " dist-bat " not found. Run ./scripts/build-release.clj first.")))
   ```

3. **Add .bat to release assets** — update the `create-release` function's `p/shell` call to include `dist-bat` as an additional asset alongside `dist-binary` and `dist-checksum`:
   ```clojure
   (p/shell "gh" "release" "create" tag
            dist-binary
            dist-bat
            dist-checksum
            "--title" tag
            "--generate-notes")
   ```

4. **Update the file header comment** to mention aishell.bat in the Prerequisites section.

**In `.github/workflows/release.yml`:**

5. **Add .bat verification** to the "Verify build artifacts" step — add after the checksum test:
   ```yaml
   test -f dist/aishell.bat || { echo "Build failed: dist/aishell.bat not found"; exit 1; }
   ```

This ensures the CI pipeline validates that .bat generation works before attempting release creation.
  </action>
  <verify>
1. Read `scripts/create-release.clj` and confirm `dist-bat` is defined, checked in `check-files-exist`, and included in `gh release create` arguments
2. Read `.github/workflows/release.yml` and confirm `dist/aishell.bat` verification line exists in the "Verify build artifacts" step
3. Run `bb scripts/build-release.clj` to ensure all 3 artifacts exist, then verify `create-release.clj` parses without error: `bb -e '(load-file "scripts/create-release.clj")'` (will fail at runtime without gh auth, but should parse cleanly)
  </verify>
  <done>create-release.clj uploads aishell.bat as a GitHub Release asset, and release.yml CI validates its existence before release creation</done>
</task>

</tasks>

<verification>
1. `bb scripts/build-release.clj` produces dist/aishell, dist/aishell.bat, and dist/aishell.sha256
2. `xxd dist/aishell.bat | grep "0d 0a"` confirms CRLF line endings
3. `cat dist/aishell.bat` shows exactly 4 lines matching neil pattern
4. `grep -c "dist-bat\|aishell.bat" scripts/create-release.clj` returns >= 3 (def, check, release)
5. `grep "aishell.bat" .github/workflows/release.yml` shows verification step
</verification>

<success_criteria>
- build-release.clj generates dist/aishell.bat with 4-line neil-pattern content and CRLF line endings
- chmod +x is guarded by (when-not (fs/windows?)) for Windows compatibility
- create-release.clj includes aishell.bat in GitHub Release assets
- release.yml CI verifies aishell.bat exists before creating release
- Existing build artifacts (dist/aishell, dist/aishell.sha256) unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/58-bat-wrapper/58-01-SUMMARY.md`
</output>
