---
phase: 08-explicit-build-update-commands
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - aishell
autonomous: true

must_haves:
  truths:
    - "State directory is created at XDG_STATE_HOME/aishell/builds"
    - "State files can be written atomically without corruption"
    - "State files can be read safely with validation"
    - "Project path is converted to unique 12-character hash"
  artifacts:
    - path: "aishell"
      provides: "State management functions"
      contains: "setup_state_dir"
  key_links:
    - from: "aishell"
      to: "~/.local/state/aishell/builds"
      via: "setup_state_dir function"
      pattern: "XDG_STATE_HOME.*aishell"
---

<objective>
Add state management infrastructure to aishell for persisting build configuration per-project.

Purpose: Enable the `update` command to rebuild with saved flags, and allow run commands to verify prerequisites
Output: State file read/write/validate functions in aishell
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-explicit-build-update-commands/08-CONTEXT.md
@.planning/phases/08-explicit-build-update-commands/08-RESEARCH.md
@aishell
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add state directory and project hash functions</name>
  <files>aishell</files>
  <action>
Add the following functions to aishell after the existing helper functions section:

1. `get_project_hash()` - Convert project path to unique 12-char hash
   - Accept project_dir as parameter
   - Use realpath to canonicalize path (handles symlinks)
   - Hash with sha256sum, truncate to 12 characters
   - Pattern already exists in codebase for extended images

2. `setup_state_dir()` - Create and return state directory path
   - Use XDG_STATE_HOME with fallback: `${XDG_STATE_HOME:-$HOME/.local/state}`
   - Create `$state_base/aishell/builds` directory with mkdir -p
   - Return the builds directory path
   - This is idempotent (safe to call multiple times)

Place these functions in a new section: `# --- State Management ---`
  </action>
  <verify>
Run: `bash -n aishell` to verify no syntax errors.
Verify functions exist: `grep -E "^(get_project_hash|setup_state_dir)\(\)" aishell`
  </verify>
  <done>
Both functions defined in aishell, no syntax errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add state file read/write functions</name>
  <files>aishell</files>
  <action>
Add state file management functions in the `# --- State Management ---` section:

1. `write_state_file()` - Atomically write build state
   Parameters: state_file, project_path, with_claude, with_opencode, claude_version, opencode_version, image_tag

   Implementation:
   - Create temp file with mktemp
   - Write header comment with project path and timestamp (date -Iseconds)
   - Write BUILD_WITH_CLAUDE=true/false
   - Write BUILD_WITH_OPENCODE=true/false
   - Write BUILD_CLAUDE_VERSION="value" (quoted for empty handling)
   - Write BUILD_OPENCODE_VERSION="value" (quoted)
   - Write BUILD_IMAGE_TAG="value"
   - Write BUILD_TIMESTAMP="value"
   - Atomic mv from temp to final location
   - Reference RESEARCH.md for exact format

2. `read_state_file()` - Safely read and validate state file
   Parameters: state_file

   Implementation:
   - Initialize BUILD_* variables to defaults (false, "", etc.)
   - Return 1 if file doesn't exist
   - Validate file with grep: only allow comments (#), empty lines, and BUILD_*=value patterns
   - If validation fails, warn and return 1
   - Source the file if valid
   - Return 0 on success

   Security: Only accept lines matching `^(#.*|BUILD_[A-Z_]+="?[^"]*"?|[[:space:]]*)$`

3. `get_state_file()` - Get state file path for current project
   Parameters: project_dir

   Implementation:
   - Call setup_state_dir to get builds directory
   - Call get_project_hash to get project hash
   - Return "$state_dir/$hash.state"
  </action>
  <verify>
Run: `bash -n aishell` to verify no syntax errors.
Verify functions exist: `grep -E "^(write_state_file|read_state_file|get_state_file)\(\)" aishell`
  </verify>
  <done>
All three state file functions defined in aishell, no syntax errors, security validation pattern included
  </done>
</task>

<task type="auto">
  <name>Task 3: Add build preview function</name>
  <files>aishell</files>
  <action>
Add build preview function in the `# --- State Management ---` section:

`show_build_preview()` - Display what will be built
Parameters: with_claude, with_opencode, claude_version, opencode_version, is_update

Implementation:
- Print action line: "Building image with:" or "Updating image with:" based on is_update
- If with_claude=true: print "  - Claude Code v{version}" or "  - Claude Code (latest)"
- If with_opencode=true: print "  - OpenCode v{version}" or "  - OpenCode (latest)"
- If neither harness: print "  - Base image only (shell access)"
- Print empty line after list

This function provides user feedback before long-running builds start.
Reference RESEARCH.md show_build_preview() for exact format.
  </action>
  <verify>
Run: `bash -n aishell` to verify no syntax errors.
Verify function exists: `grep "^show_build_preview()" aishell`
  </verify>
  <done>
show_build_preview function defined, provides build feedback to user
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `bash -n aishell` - No syntax errors
2. All 6 new functions present: get_project_hash, setup_state_dir, write_state_file, read_state_file, get_state_file, show_build_preview
3. XDG_STATE_HOME fallback pattern present
4. Security validation regex present in read_state_file
5. Atomic write pattern (mktemp + mv) present in write_state_file
</verification>

<success_criteria>
- State management section added to aishell with 6 functions
- Functions follow patterns from RESEARCH.md
- No syntax errors in aishell
- Security validation prevents code injection in state files
- Atomic writes prevent corruption
</success_criteria>

<output>
After completion, create `.planning/phases/08-explicit-build-update-commands/08-01-SUMMARY.md`
</output>
