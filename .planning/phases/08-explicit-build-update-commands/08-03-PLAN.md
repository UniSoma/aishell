---
phase: 08-explicit-build-update-commands
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - aishell
autonomous: false

must_haves:
  truths:
    - "aishell claude fails with helpful error when Claude not in build"
    - "aishell opencode fails with helpful error when OpenCode not in build"
    - "Error messages include exact command to fix the issue"
    - "All success criteria from roadmap verified working"
  artifacts:
    - path: "aishell"
      provides: "harness requirement checks"
      contains: "error_missing_harness"
  key_links:
    - from: "aishell run_harness"
      to: "read_state_file"
      via: "verify harness was built"
      pattern: "BUILD_WITH_CLAUDE.*true"
---

<objective>
Add requirement checks before running harnesses and verify all phase success criteria.

Purpose: Clear errors when prerequisites not met, validate complete implementation
Output: Fully working build/update/run flow with human verification
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-explicit-build-update-commands/08-CONTEXT.md
@.planning/phases/08-explicit-build-update-commands/08-RESEARCH.md
@aishell
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add harness requirement checks</name>
  <files>aishell</files>
  <action>
Add harness availability checks before running claude/opencode:

1. Create `error_missing_harness()` function:
   Parameters: harness_name (claude or opencode)

   Implementation:
   - Print colored error: "Error: {harness_name} was not included in the build."
   - Print empty line
   - Print: "Current build does not include {harness_name}."
   - Print empty line
   - Print: "To add {harness_name} to the build:"
   - Print: "    aishell update --with-{harness_name}"
   - Print empty line
   - Print: "Or rebuild with {harness_name}:"
   - Print: "    aishell build --with-{harness_name}"
   - Exit with code 1

2. Create `verify_harness_available()` function:
   Parameters: harness_name, required_flag_value

   Implementation:
   - If required_flag_value != "true", call error_missing_harness and exit
   - Return 0 if harness is available

3. Update claude command dispatch:
   - Before running claude, load state file
   - Call verify_harness_available "claude" "$BUILD_WITH_CLAUDE"
   - Only proceed to docker run if check passes

4. Update opencode command dispatch:
   - Before running opencode, load state file
   - Call verify_harness_available "opencode" "$BUILD_WITH_OPENCODE"
   - Only proceed to docker run if check passes

5. Shell command (no args) - only requires build exists:
   - Already handled by verify_build_exists from Plan 02
   - No harness-specific check needed (base image is fine)

Key behaviors:
- `aishell claude` without --with-claude in build = specific error
- `aishell opencode` without --with-opencode in build = specific error
- Error messages tell user exactly what command to run
  </action>
  <verify>
Run: `bash -n aishell` to verify no syntax errors.
Verify error function exists: `grep "error_missing_harness" aishell`
Verify harness check in claude dispatch: `grep -A5 "claude)" aishell | grep -E "(verify_harness|BUILD_WITH)"`
  </verify>
  <done>
Harness-specific requirement checks added, clear error messages with corrective commands
  </done>
</task>

<task type="auto">
  <name>Task 2: Update help text and polish</name>
  <files>aishell</files>
  <action>
Final polish on CLI interface:

1. Update usage() with complete command documentation:
   ```
   Usage: aishell [OPTIONS] COMMAND [ARGS...]

   Build and run ephemeral containers for AI harnesses.

   Commands:
       build       Build the container image
       update      Rebuild with latest versions (uses saved configuration)
       claude      Run Claude Code (requires: aishell build --with-claude)
       opencode    Run OpenCode (requires: aishell build --with-opencode)
       (none)      Enter interactive shell (requires: aishell build)

   Build Options:
       --with-claude           Include Claude Code in image
       --with-opencode         Include OpenCode in image
       --claude-version=X.Y.Z  Install specific Claude Code version
       --opencode-version=X.Y.Z Install specific OpenCode version
       --no-cache              Force fresh build (no Docker cache)

   Global Options:
       --build-arg KEY=VAL     Pass build argument to Dockerfile
       -v, --verbose           Show detailed output
       -h, --help              Show this help message
       --version               Show version

   Project Extensions:
       Place a Dockerfile at .aishell/Dockerfile to extend the base image.

   Examples:
       aishell build --with-claude     # Build with Claude Code
       aishell build                   # Build base image only
       aishell claude                  # Run Claude Code
       aishell                         # Enter shell
       aishell update                  # Rebuild with latest versions
       aishell update --with-opencode  # Add OpenCode to existing build

   Environment Variables:
       AISHELL_SKIP_PERMISSIONS   Set to 'false' for permission prompts in Claude
   ```

2. Remove deprecated --with-claude/--with-opencode from global options:
   - These are now build-time only options
   - Remove from main argument parsing (only parse in do_build)
   - Keep --rebuild as alias for `build --no-cache` for backwards compat? (optional)

3. Ensure color support in all error messages:
   - error_no_build uses RED
   - error_missing_harness uses RED
   - All errors go to stderr

4. Verify VERSION constant is updated if needed
  </action>
  <verify>
Run: `./aishell --help` - shows updated usage text
Run: `./aishell --version` - shows version
Run: `bash -n aishell` - no syntax errors
  </verify>
  <done>
Help text reflects new command structure, deprecated options removed or aliased
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete explicit build/update command system:
- `aishell build` with flag persistence
- `aishell update` with state merging
- Requirement checks for harnesses
- Clear error messages with corrective commands
  </what-built>
  <how-to-verify>
Test all success criteria from roadmap:

1. Build with harnesses:
   ```bash
   cd /home/jonasrodrigues/projects/harness
   ./aishell build --with-claude --with-opencode
   ```
   Expected: Image builds, state file created

2. Verify state file:
   ```bash
   cat ~/.local/state/aishell/builds/*.state
   ```
   Expected: Contains BUILD_WITH_CLAUDE=true, BUILD_WITH_OPENCODE=true

3. Enter shell (requires prior build):
   ```bash
   ./aishell
   ```
   Expected: Shell opens (type `exit` to leave)

4. Run Claude Code:
   ```bash
   ./aishell claude --version
   ```
   Expected: Claude version shown (proves harness works)

5. Run OpenCode:
   ```bash
   ./aishell opencode --version
   ```
   Expected: OpenCode version shown

6. Test update command:
   ```bash
   ./aishell update
   ```
   Expected: Rebuilds with --no-cache, shows "Updating image with: Claude Code, OpenCode"

7. Test error when build missing (use different project):
   ```bash
   cd /tmp
   /home/jonasrodrigues/projects/harness/aishell claude
   ```
   Expected: Error message with "aishell build --with-claude" suggestion

8. Test error when harness missing:
   ```bash
   cd /home/jonasrodrigues/projects/harness
   # First build without Claude
   ./aishell build
   ./aishell claude
   ```
   Expected: Error "Claude was not included in the build" with update suggestion
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any failures</resume-signal>
</task>

</tasks>

<verification>
Phase 8 Success Criteria (from roadmap):
1. [x] `./aishell build --with-claude --with-opencode` builds image
2. [x] `./aishell` enters shell (requires prior build)
3. [x] `./aishell claude` runs Claude Code (requires build with --with-claude)
4. [x] `./aishell opencode` runs OpenCode (requires build with --with-opencode)
5. [x] `./aishell update` rebuilds with same flags as last build
6. [x] Build flags persisted to state file
7. [x] Clear error messages when running without required build
</verification>

<success_criteria>
- All 7 roadmap success criteria verified by human
- Error messages include exact corrective commands
- Help text reflects new command structure
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/08-explicit-build-update-commands/08-03-SUMMARY.md`
</output>
