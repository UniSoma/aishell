---
phase: 60-pi-build-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/templates.clj
  - src/aishell/docker/volume.clj
autonomous: true
requirements:
  - FOUND-01
  - FOUND-02
  - HARNESS-05

must_haves:
  truths:
    - "fd command is available inside the container after foundation image rebuild"
    - "Pi coding agent npm package is installed in harness volume when :with-pi is true"
    - "Volume hash changes when pi harness is added or pi version changes"
  artifacts:
    - path: "src/aishell/docker/templates.clj"
      provides: "fd-find package installation with fd symlink in foundation Dockerfile"
      contains: "fd-find"
    - path: "src/aishell/docker/volume.clj"
      provides: "Pi harness key and npm package mapping for volume population"
      contains: "@mariozechner/pi-coding-agent"
  key_links:
    - from: "src/aishell/docker/volume.clj"
      to: "harness volume"
      via: "build-install-commands generates npm install for pi"
      pattern: "pi-coding-agent"
    - from: "src/aishell/docker/volume.clj"
      to: "compute-harness-hash"
      via: "harness-keys includes :pi for hash computation"
      pattern: ":pi"
---

<objective>
Add fd-find to the foundation Docker image and register pi coding agent as an npm harness in the volume infrastructure.

Purpose: Foundation image must include fd (pi's file-finding dependency) and volume population must know how to install @mariozechner/pi-coding-agent via npm.
Output: Updated templates.clj with fd-find, updated volume.clj with pi harness registration.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/aishell/docker/templates.clj
@src/aishell/docker/volume.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fd-find to foundation image and register pi in volume infrastructure</name>
  <files>src/aishell/docker/templates.clj, src/aishell/docker/volume.clj</files>
  <action>
  In `src/aishell/docker/templates.clj`:
  1. In `base-dockerfile`, add `fd-find` to the apt-get install list (after `file`, alphabetical order)
  2. After the apt-get install RUN block (after `&& rm -rf /var/lib/apt/lists/*`), add a RUN command to create the `fd` symlink:
     `RUN ln -s /usr/bin/fdfind /usr/bin/fd`
     This is needed because Debian packages fd-find as `fdfind` but pi expects `fd`.

  In `src/aishell/docker/volume.clj`:
  1. Add `:pi` to the `harness-keys` vector (alphabetical: after `:opencode`):
     `[:claude :codex :gemini :opencode :pi]`
  2. Add `:pi` to the `harness-npm-packages` map:
     `{:claude "@anthropic-ai/claude-code"
      :codex "@openai/codex"
      :gemini "@google/gemini-cli"
      :pi "@mariozechner/pi-coding-agent"}`

  No changes needed to `normalize-harness-config`, `compute-harness-hash`, or `build-install-commands` — they already iterate over `harness-keys` and `harness-npm-packages` dynamically.
  </action>
  <verify>
  1. Grep for `fd-find` in templates.clj to confirm it's in the apt-get list
  2. Grep for `fdfind` in templates.clj to confirm the symlink RUN command exists
  3. Grep for `:pi` in volume.clj to confirm it appears in harness-keys
  4. Grep for `pi-coding-agent` in volume.clj to confirm the npm package is registered
  5. Start a bb REPL and verify: `(require '[aishell.docker.volume :as vol]) (vol/normalize-harness-config {:with-pi true :pi-version "1.0.0"})` returns `[[:pi "1.0.0"]]`
  6. Verify `(vol/build-install-commands {:with-pi true})` includes `@mariozechner/pi-coding-agent@latest`
  7. Verify foundation rebuild is triggered by template change: run `bb -e '(require (quote [aishell.docker.templates :as t])) (require (quote [aishell.docker.build :as b])) (println (b/check-dockerfile-stale (t/base-dockerfile)))'` — since the template string has changed (fd-find added), its hash will differ from the previously built image label, causing `check-dockerfile-stale` to return true. This is how `aishell update --force` detects that a foundation rebuild is needed (FOUND-02).
  </verify>
  <done>
  fd-find is in the foundation Dockerfile apt-get install list with a /usr/bin/fd symlink.
  Pi is registered in volume.clj harness-keys and harness-npm-packages.
  build-install-commands correctly generates npm install for pi.
  Volume hash computation includes pi when enabled.
  </done>
</task>

</tasks>

<verification>
1. `grep "fd-find" src/aishell/docker/templates.clj` shows fd-find in apt-get install
2. `grep "fdfind" src/aishell/docker/templates.clj` shows symlink command
3. `grep ":pi" src/aishell/docker/volume.clj` shows :pi in harness-keys and harness-npm-packages
4. `bb -e '(require (quote [aishell.docker.volume :as vol])) (println (vol/build-install-commands {:with-pi true :with-claude true :claude-version "2.0.22"}))'` includes both claude and pi packages
</verification>

<success_criteria>
- fd-find package and fd symlink are in the foundation Dockerfile template
- Pi npm package @mariozechner/pi-coding-agent is registered in volume.clj
- Volume hash changes when :with-pi is toggled (verified via normalize-harness-config)
- build-install-commands generates correct npm install for pi with version pinning
</success_criteria>

<output>
After completion, create `.planning/phases/60-pi-build-infrastructure/60-01-SUMMARY.md`
</output>
