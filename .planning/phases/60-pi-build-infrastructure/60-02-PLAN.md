---
phase: 60-pi-build-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["60-01"]
files_modified:
  - src/aishell/cli.clj
  - src/aishell/docker/run.clj
  - src/aishell/run.clj
  - src/aishell/check.clj
  - src/aishell/state.clj
autonomous: true
requirements:
  - HARNESS-01
  - HARNESS-03
  - ENV-01
  - ENV-02

must_haves:
  truths:
    - "aishell setup --with-pi builds with pi enabled and persists :with-pi true in state"
    - "aishell setup --with-pi=1.0.0 pins version and persists :pi-version in state"
    - "PI_CODING_AGENT_DIR and PI_SKIP_VERSION_CHECK env vars from host are passed through to container"
    - "Pi volume is populated during setup when --with-pi is specified"
    - "aishell update shows pi version when pi is installed"
  artifacts:
    - path: "src/aishell/cli.clj"
      provides: "--with-pi flag in setup spec, pi in installed-harnesses, pi in handle-setup state-map, pi in update display"
      contains: "with-pi"
    - path: "src/aishell/docker/run.clj"
      provides: "PI_CODING_AGENT_DIR and PI_SKIP_VERSION_CHECK env var passthrough, pi config mount, pi alias env"
      contains: "PI_CODING_AGENT_DIR"
    - path: "src/aishell/run.clj"
      provides: "Pi harness verification and ensure-harness-volume pi check"
      contains: ":with-pi"
    - path: "src/aishell/check.clj"
      provides: "Pi in harness status display"
      contains: "Pi"
    - path: "src/aishell/state.clj"
      provides: "Pi fields in state schema documentation"
      contains: ":with-pi"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/state.clj"
      via: "handle-setup persists :with-pi and :pi-version to state"
      pattern: ":with-pi"
    - from: "src/aishell/cli.clj"
      to: "src/aishell/docker/volume.clj"
      via: "handle-setup includes :with-pi in state-map for volume hash computation"
      pattern: "with-pi"
    - from: "src/aishell/docker/run.clj"
      to: "container environment"
      via: "PI_* env vars passed through to container via -e flags"
      pattern: "PI_CODING_AGENT_DIR"
    - from: "src/aishell/run.clj"
      to: "src/aishell/docker/volume.clj"
      via: "ensure-harness-volume checks :with-pi for volume population trigger"
      pattern: ":with-pi"
---

<objective>
Add --with-pi build flag to CLI, integrate pi into state persistence, env var passthrough, harness check display, and volume population triggers.

Purpose: Users can build with `aishell setup --with-pi` (or `--with-pi=VERSION`) and have pi installed in the harness volume. PI_* env vars pass through from host to container.
Output: Updated cli.clj, docker/run.clj, run.clj, check.clj, and state.clj with full pi build integration.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/60-pi-build-infrastructure/60-01-SUMMARY.md
@src/aishell/cli.clj
@src/aishell/docker/run.clj
@src/aishell/run.clj
@src/aishell/check.clj
@src/aishell/state.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --with-pi CLI flag and state integration</name>
  <files>src/aishell/cli.clj, src/aishell/state.clj</files>
  <action>
  In `src/aishell/cli.clj`:

  1. **setup-spec**: Add `:with-pi` entry (same pattern as :with-codex):
     ```
     :with-pi     {:desc "Include Pi coding agent (optional: =VERSION)"}
     ```
     Place after `:with-gemini` in the setup-spec map.

  2. **installed-harnesses**: Add pi to the cond-> block:
     ```
     (:with-pi state) (conj "pi")
     ```
     Add after the `:with-gemini` line, before the `:with-gitleaks` line.

  3. **handle-setup**: Add pi parsing and wiring:
     - After `gemini-config`: `pi-config (parse-with-flag (:with-pi opts))`
     - After gemini validation: `_ (validate-version (:version pi-config) "Pi")`
     - In state-map: Add `:with-pi (:enabled? pi-config)` and `:pi-version (:version pi-config)`
     - In the `(some #(get state-map %) ...)` vector: Add `:with-pi`
     - In harness-list keep function: Add `:pi (:with-pi state-map)`

  4. **print-help**: Add pi to conditional harness commands display:
     ```
     (when (contains? installed "pi")
       (println (str "  " output/CYAN "pi" output/NC "         Run Pi coding agent")))
     ```
     Place after gemini, before gitleaks.

  5. **print-setup-help**: Add `--with-pi` to the order vector and examples:
     - In format-opts order: add `:with-pi` after `:with-gemini`
     - Add example line: `aishell setup --with-pi` (Include Pi coding agent)

  6. **handle-update**: Add pi display line:
     ```
     (when (:with-pi state)
       (println (str "  Pi: " (or (:pi-version state) "latest"))))
     ```
     After the gemini display block. Also add `:with-pi` to harnesses-enabled? check:
     ```
     (some #(get state %) [:with-claude :with-opencode :with-codex :with-gemini :with-pi])
     ```
     And add `:pi (:with-pi state)` to the harness-list keep function.

  In `src/aishell/state.clj`:
  1. Update the `write-state` docstring schema to include pi fields:
     ```
     :with-pi false              ; boolean
     :pi-version nil             ; string or nil
     ```
     Add after `:with-gemini` and `:gemini-version` respectively.
  </action>
  <verify>
  1. `grep "with-pi" src/aishell/cli.clj` shows multiple hits (setup-spec, handle-setup, installed-harnesses, update)
  2. `grep "with-pi" src/aishell/state.clj` shows pi in state schema docstring
  3. `grep ":with-pi" src/aishell/cli.clj | wc -l` shows at least 6 occurrences
  4. Verify `installed-harnesses` includes "pi" by checking code path
  </verify>
  <done>
  --with-pi flag exists in setup-spec.
  handle-setup parses, validates, and persists :with-pi and :pi-version to state.
  Pi appears in help when installed.
  aishell update shows Pi version.
  State schema docs include pi fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Pi env var passthrough, config mounts, and runtime wiring</name>
  <files>src/aishell/docker/run.clj, src/aishell/run.clj, src/aishell/check.clj</files>
  <action>
  In `src/aishell/docker/run.clj`:

  1. **api-key-vars**: Add Pi-specific env vars to the passthrough list:
     ```
     "PI_CODING_AGENT_DIR"
     "PI_SKIP_VERSION_CHECK"
     ```
     Add at the end of the api-key-vars vector (these are passthrough vars, passed only when set on host).

  2. **build-harness-config-mounts**: Add pi config directory to `config-entries`:
     ```
     [".pi"]
     ```
     Add after `[".gemini"]` in the config-entries vector. This mounts `~/.pi/` from host into container when it exists.

  3. **build-harness-alias-env-args**: Add pi to the `known` vector:
     ```
     ["pi"       :with-pi     false]
     ```
     Add after the gemini entry. The `false` means aliases are only generated when harness_args are configured (same as codex/gemini).

  In `src/aishell/run.clj`:

  1. **ensure-harness-volume**: Add `:with-pi` to the `some` check:
     ```
     (some #(get state %) [:with-claude :with-opencode :with-codex :with-gemini :with-pi])
     ```

  2. **run-container** verify-harness case: Add pi entry:
     ```
     "pi" (verify-harness-available "pi" :with-pi state)
     ```
     Add after the "gemini" case. Note: `verify-harness-available` needs a display name mapping. Add `"pi" "Pi coding agent"` to the case expression inside that function.

  3. **run-container** container-cmd case: Add pi entry:
     ```
     "pi"
     (into ["pi"] merged-args)
     ```
     Add after the "gemini" container-cmd case.

  In `src/aishell/check.clj`:

  1. **check-harnesses**: Add pi to the harnesses vector:
     ```
     ["Pi" :with-pi :pi-version]
     ```
     Add after the Gemini entry, before the Gitleaks entry.
  </action>
  <verify>
  1. `grep "PI_CODING_AGENT_DIR" src/aishell/docker/run.clj` confirms env var passthrough
  2. `grep "PI_SKIP_VERSION_CHECK" src/aishell/docker/run.clj` confirms env var passthrough
  3. `grep '".pi"' src/aishell/docker/run.clj` confirms config mount
  4. `grep ":with-pi" src/aishell/run.clj` shows pi in volume check and verify-harness
  5. `grep '"pi"' src/aishell/run.clj` shows pi in container-cmd case
  6. `grep "Pi" src/aishell/check.clj` shows Pi in harness check display
  7. `grep ":with-pi" src/aishell/check.clj` confirms state key check
  </verify>
  <done>
  PI_CODING_AGENT_DIR and PI_SKIP_VERSION_CHECK pass through from host to container when set.
  Pi config directory (~/.pi/) is mounted from host when it exists.
  Pi harness alias is generated in container when pi is installed with harness_args.
  ensure-harness-volume triggers volume population when :with-pi is true.
  run-container verifies pi installation and dispatches pi command.
  aishell check displays Pi installation status and version.
  </done>
</task>

</tasks>

<verification>
1. `grep -c "with-pi" src/aishell/cli.clj` should be >= 6 (setup-spec, handle-setup, installed-harnesses, print-help, handle-update)
2. `grep "PI_CODING_AGENT_DIR" src/aishell/docker/run.clj` shows env var
3. `grep "PI_SKIP_VERSION_CHECK" src/aishell/docker/run.clj` shows env var
4. `grep ":with-pi" src/aishell/run.clj` shows at least 2 hits (ensure-harness-volume, verify-harness)
5. `grep "Pi" src/aishell/check.clj` shows Pi in harness list
6. `bb -e '(require (quote [aishell.cli :as cli]))'` loads without errors (namespace compiles)
</verification>

<success_criteria>
- `--with-pi` flag accepted by aishell setup with optional version pinning
- State persists :with-pi and :pi-version after setup
- PI_CODING_AGENT_DIR and PI_SKIP_VERSION_CHECK pass through to container
- Pi config directory mounted from host
- aishell check shows Pi installation status
- help shows pi command when installed
- aishell update shows Pi version when installed
- Volume population triggered when pi is enabled
</success_criteria>

<output>
After completion, create `.planning/phases/60-pi-build-infrastructure/60-02-SUMMARY.md`
</output>
