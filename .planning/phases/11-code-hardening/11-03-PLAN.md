---
phase: 11-code-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [aishell]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Unknown options to do_build() cause immediate error exit"
    - "Unknown options to do_update() cause immediate error exit"
    - "Malformed version flags like '--version X' are caught as unknown options"
  artifacts:
    - path: "aishell"
      provides: "Default case in do_build() and do_update() case statements"
      contains: "*) error"
  key_links:
    - from: "do_build() case statement"
      to: "error()"
      via: "default case pattern"
      pattern: '^\s+\*\)\s+error'
    - from: "do_update() case statement"
      to: "error()"
      via: "default case pattern"
      pattern: '^\s+\*\)\s+error'
---

<objective>
Close UAT gap: Add default case handlers to do_build() and do_update() case statements.

Purpose: Prevent silent ignoring of unknown/malformed options which bypasses validate_version().
Output: Modified aishell script that rejects unknown options with clear error messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@aishell (lines 836-874 for do_build, lines 1347-1383 for do_update)

Root cause from UAT diagnosis:
- `--version "1.0.0"` (space-separated) is parsed as two arguments
- First arg `--version` doesn't match any case pattern
- Without default case, it's silently ignored
- Second arg `1.0.0` also silently ignored
- validate_version() never called because version variables stay empty
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add default case to do_build() case statement</name>
  <files>aishell</files>
  <action>
In do_build() function, locate the case statement at lines 837-873.
Add a default case BEFORE the closing `esac`:

```bash
            *)
                error "Unknown option: $arg"
                ;;
```

This should be added after the `-h|--help)` case block and before `esac`.
The error() function (line 185) prints to stderr and exits with code 1.
  </action>
  <verify>
Run: `grep -A3 '^\s*\*)' aishell | head -10`
Verify default case exists in do_build() region.

Test: `./aishell build --version "1.0.0"` should error with "Unknown option: --version"
  </verify>
  <done>do_build() rejects unknown options with error message and exit 1</done>
</task>

<task type="auto">
  <name>Task 2: Add default case to do_update() case statement</name>
  <files>aishell</files>
  <action>
In do_update() function, locate the case statement at lines 1348-1382.
Add a default case BEFORE the closing `esac`:

```bash
            *)
                error "Unknown option: $arg"
                ;;
```

This should be added after the `-h|--help)` case block and before `esac`.
  </action>
  <verify>
Run: `grep -n '^\s*\*)' aishell`
Verify two default cases exist (one in do_build region ~line 873, one in do_update region ~line 1383).

Test: `./aishell update --version "1.0.0"` should error with "Unknown option: --version"
  </verify>
  <done>do_update() rejects unknown options with error message and exit 1</done>
</task>

</tasks>

<verification>
1. Syntax check: `bash -n aishell` exits 0
2. Build unknown option: `./aishell build --foo 2>&1 | grep -q "Unknown option: --foo"`
3. Update unknown option: `./aishell update --bar 2>&1 | grep -q "Unknown option: --bar"`
4. Injection attempt blocked: `./aishell build --version "1.0.0; echo pwned" 2>&1 | grep -q "Unknown option"`
5. Valid options still work: `./aishell build --help` shows usage (no error)
</verification>

<success_criteria>
- Unknown options to `build` and `update` commands produce error and exit 1
- Malformed version flags (`--version X` instead of `--version=X`) are rejected
- Valid options (`--with-claude`, `--claude-version=1.0.0`, etc.) still work
- Shell injection via space-separated arguments is blocked
</success_criteria>

<output>
After completion, create `.planning/phases/11-code-hardening/11-03-SUMMARY.md`
</output>
