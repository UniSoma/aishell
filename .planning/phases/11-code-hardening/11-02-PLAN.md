---
phase: 11-code-hardening
plan: 02
type: execute
wave: 2
depends_on:
  - "11-01"
files_modified:
  - aishell
autonomous: true

must_haves:
  truths:
    - "Port mapping 127.0.0.1:8080:80 is accepted and passed to docker run"
    - "Invalid version string '1.0;rm -rf /' is rejected before reaching npm/curl"
    - "Script handles missing HOME with fallback behavior"
    - "Container runs with --init flag for zombie process reaping"
    - "DOCKER_ARGS with --privileged prints warning to stderr"
  artifacts:
    - path: "aishell"
      provides: "Input validation and security warnings"
      contains: "validate_version"
  key_links:
    - from: "parse_args()"
      to: "validate_version()"
      via: "validation call for --claude-version"
      pattern: "validate_version.*claude"
    - from: "main()"
      to: "warn_dangerous_docker_args()"
      via: "security check after run.conf parse"
      pattern: "warn_dangerous_docker_args"
    - from: "docker_args"
      to: "--init"
      via: "array element"
      pattern: "--init"
---

<objective>
Add input validation for versions and ports, HOME fallback handling, --init flag, and dangerous DOCKER_ARGS warnings.

Purpose: Complete Phase 11 hardening by validating all external inputs before shell interpolation, adding zombie process reaping via --init, and warning users about potentially dangerous Docker arguments.

Output: Hardened aishell script with VALID-01 (port IP binding), VALID-02 (version validation), VALID-03 (HOME fallback), ROBUST-03 (--init flag), and SEC-01 (dangerous args warning) requirements satisfied.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-code-hardening/11-RESEARCH.md
@.planning/phases/11-code-hardening/11-01-SUMMARY.md

Reference code examples from research: VALID-01 (port regex), VALID-02 (version validation), VALID-03 (HOME fallback), ROBUST-03 (--init), SEC-01 (dangerous args warning).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation functions</name>
  <files>aishell</files>
  <action>
Add validation functions after the cleanup infrastructure section (after register_cleanup/track_pid), before the spinner functions:

1. Add version validation function (VALID-02):
   ```bash
   # --- Input Validation ---
   # Semver-like pattern (major.minor.patch with optional pre-release/build metadata)
   readonly VERSION_REGEX='^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$'
   # Shell metacharacter blocklist (defense in depth)
   readonly DANGEROUS_CHARS_REGEX='[;&|`$(){}[\]<>!\\]'

   validate_version() {
       local version="$1"
       local name="$2"  # "Claude Code" or "OpenCode"

       # Empty is OK (means "latest")
       [[ -z "$version" ]] && return 0

       # Block dangerous characters first (defense in depth)
       if [[ "$version" =~ $DANGEROUS_CHARS_REGEX ]]; then
           error "Invalid $name version: contains shell metacharacters"
       fi

       # Validate semver-like format
       if [[ ! "$version" =~ $VERSION_REGEX ]]; then
           error "Invalid $name version format: $version
   Expected: X.Y.Z or X.Y.Z-prerelease (e.g., 2.0.22, 1.0.0-beta.1)"
       fi
   }
   ```

2. Add HOME validation function (VALID-03):
   ```bash
   validate_home() {
       if [[ -z "${HOME:-}" ]]; then
           # Try to determine from passwd entry
           HOME=$(getent passwd "$(id -u)" | cut -d: -f6) || true

           # Final fallback
           if [[ -z "$HOME" ]]; then
               HOME="/tmp/aishell-$$"
               warn "HOME not set, using fallback: $HOME"
               mkdir -p "$HOME"
           fi
           export HOME
       fi

       # Ensure HOME directory exists
       if [[ ! -d "$HOME" ]]; then
           warn "HOME directory does not exist: $HOME"
           mkdir -p "$HOME" 2>/dev/null || error "Cannot create HOME directory"
       fi
   }
   ```

3. Update build_port_args() function (VALID-01) - modify the regex at line ~576:
   - CHANGE FROM: `if [[ "$port_spec" =~ ^[0-9]+:[0-9]+(/[a-z]+)?$ ]]; then`
   - CHANGE TO: `if [[ "$port_spec" =~ ^(([0-9]{1,3}\.){3}[0-9]{1,3}:)?[0-9]+:[0-9]+(/[a-z]+)?$ ]]; then`
   - UPDATE error message to include IP binding format:
     ```
     error "Invalid port mapping: $port_spec
   Expected format: HOST_PORT:CONTAINER_PORT or IP:HOST_PORT:CONTAINER_PORT
   Examples: 8080:80, 127.0.0.1:8080:80, 8080:80/udp"
     ```

4. Add dangerous DOCKER_ARGS warning function (SEC-01):
   ```bash
   # --- Security Warnings ---
   warn_dangerous_docker_args() {
       local docker_args="$1"
       local warned=false

       # Check for dangerous patterns
       if [[ "$docker_args" == *"--privileged"* ]]; then
           [[ "$warned" == false ]] && { echo "" >&2; warn "Security notice: Potentially dangerous Docker options detected"; warned=true; }
           echo "  - --privileged: Container has full host access" >&2
       fi

       if [[ "$docker_args" == *"docker.sock"* ]]; then
           [[ "$warned" == false ]] && { echo "" >&2; warn "Security notice: Potentially dangerous Docker options detected"; warned=true; }
           echo "  - docker.sock mount: Container can control Docker daemon" >&2
       fi

       if [[ "$docker_args" == *"--cap-add=SYS_ADMIN"* ]] || [[ "$docker_args" == *"--cap-add=ALL"* ]]; then
           [[ "$warned" == false ]] && { echo "" >&2; warn "Security notice: Potentially dangerous Docker options detected"; warned=true; }
           echo "  - Elevated capabilities: Increases container escape risk" >&2
       fi

       if [[ "$docker_args" == *"apparmor=unconfined"* ]] || [[ "$docker_args" == *"seccomp=unconfined"* ]]; then
           [[ "$warned" == false ]] && { echo "" >&2; warn "Security notice: Potentially dangerous Docker options detected"; warned=true; }
           echo "  - Disabled security profiles: Reduces container isolation" >&2
       fi

       if [[ "$warned" == true ]]; then
           echo "" >&2
           echo "These options reduce container isolation. Use only if necessary." >&2
           echo "" >&2
       fi
   }
   ```
  </action>
  <verify>
Run: `grep -c "validate_version" aishell` - should show 2+ occurrences (definition + usage later)
Run: `grep -c "validate_home" aishell` - should show 2+ occurrences
Run: `grep "127.0.0.1" aishell` - should show the IP pattern in port regex
Run: `bash -n aishell` - syntax check passes
  </verify>
  <done>
All four validation/warning functions exist: validate_version(), validate_home(), updated build_port_args() regex, warn_dangerous_docker_args().
Script passes syntax check.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply validation and add --init flag</name>
  <files>aishell</files>
  <action>
Wire up the validation functions and add the remaining hardening features:

1. Call validate_home() early in main() function (around line 1297):
   - Add as first line inside main(): `validate_home`
   - This ensures HOME is valid before any other operations

2. Call validate_version() in parse_args() for version flags (around lines 915-922):
   - After `--claude-version=*)` case, after extracting version, add:
     `validate_version "$CLAUDE_VERSION" "Claude Code"`
   - After `--opencode-version=*)` case, after extracting version, add:
     `validate_version "$OPENCODE_VERSION" "OpenCode"`

3. Call validate_version() in do_build() for version flags (around lines 682-686):
   - After `--claude-version=*)` case: `validate_version "$claude_version" "Claude Code"`
   - After `--opencode-version=*)` case: `validate_version "$opencode_version" "OpenCode"`

4. Call validate_version() in do_update() for version flags (around lines 1187-1190):
   - After `--claude-version=*)` case: `validate_version "$new_claude_version" "Claude Code"`
   - After `--opencode-version=*)` case: `validate_version "$new_opencode_version" "OpenCode"`

5. Add --init flag to docker_args in main() (around line 1357):
   - Modify the docker_args array initialization to include --init:
     ```bash
     local -a docker_args=(
         --rm -it
         --init
         -v "$project_dir:$project_dir"
         ...
     )
     ```

6. Call warn_dangerous_docker_args() after loading CONF_DOCKER_ARGS (around line 1427-1431):
   - After the line `docker_args+=($CONF_DOCKER_ARGS)`, add:
     ```bash
     # Check for dangerous patterns
     warn_dangerous_docker_args "$CONF_DOCKER_ARGS"
     ```
  </action>
  <verify>
Run: `grep -c "validate_version" aishell` - should show 7+ occurrences (1 def + 6 calls)
Run: `grep -c "validate_home" aishell` - should show 2 occurrences (1 def + 1 call)
Run: `grep "\\-\\-init" aishell` - should show --init in docker_args
Run: `grep -c "warn_dangerous_docker_args" aishell` - should show 2 occurrences (1 def + 1 call)
Run: `bash -n aishell` - syntax check passes
  </verify>
  <done>
All validation functions are called at appropriate points.
--init flag is added to docker run arguments.
Dangerous DOCKER_ARGS trigger security warnings.
Script passes syntax check.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Syntax check: `bash -n aishell`
2. Test port validation: Create test with `PORTS="127.0.0.1:8080:80"` in run.conf - should work
3. Test version validation: Run `aishell build --claude-version='1.0;rm'` - should error before build
4. Verify --init: `grep "\\-\\-init" aishell` shows it in docker_args
5. Test security warning: Run with `DOCKER_ARGS="--privileged"` in run.conf - should show warning

Functional tests (manual):
- `echo 'PORTS="127.0.0.1:3000:3000"' > .aishell/run.conf && aishell --verbose 2>&1 | grep "\-p 127.0.0.1"`
- `aishell build --claude-version="1.0.0;whoami"` should error with "contains shell metacharacters"
</verification>

<success_criteria>
- [ ] VALID-01: Port mapping with IP binding (127.0.0.1:8080:80) accepted
- [ ] VALID-02: Invalid version strings rejected before npm/curl
- [ ] VALID-03: Missing HOME handled with fallback
- [ ] ROBUST-03: --init flag added to docker run
- [ ] SEC-01: Dangerous DOCKER_ARGS patterns trigger warning
- [ ] Script passes `bash -n` syntax check
- [ ] All validation functions called at appropriate entry points
</success_criteria>

<output>
After completion, create `.planning/phases/11-code-hardening/11-02-SUMMARY.md`
</output>
