---
phase: 11-code-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - aishell
autonomous: true

must_haves:
  truths:
    - "Ctrl+C during build exits cleanly without orphaned processes"
    - "Temp files and directories are removed on any exit path"
    - "Spinner process is terminated on script exit"
    - "Only one trap statement exists for EXIT signal"
  artifacts:
    - path: "aishell"
      provides: "Consolidated cleanup infrastructure"
      contains: "trap cleanup EXIT"
  key_links:
    - from: "do_build()"
      to: "register_cleanup()"
      via: "function call for temp dir"
      pattern: "register_cleanup.*build_dir"
    - from: "start_spinner()"
      to: "CLEANUP_PIDS"
      via: "track_pid() call"
      pattern: "track_pid.*spinner_pid"
---

<objective>
Consolidate multiple trap statements into a single cleanup handler to eliminate trap override bugs.

Purpose: The current aishell script has trap statements at lines 102, 731, 755, 1047, 1255, 1278 that override each other, causing cleanup bugs when Ctrl+C is pressed during builds. This plan implements the consolidated trap handler pattern from the research.

Output: Single cleanup() function registered once at script start, with register_cleanup() and track_pid() helpers used throughout the codebase.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-code-hardening/11-RESEARCH.md

Reference the "Consolidated Trap Handler Pattern" and "ROBUST-01" code examples from research.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create consolidated cleanup infrastructure</name>
  <files>aishell</files>
  <action>
Add consolidated cleanup infrastructure after the color support section (around line 60), before the spinner functions:

1. Add global cleanup state arrays:
   ```bash
   # --- Cleanup Infrastructure ---
   declare -a CLEANUP_FILES=()
   declare -a CLEANUP_PIDS=()
   ```

2. Create the consolidated cleanup() function (based on research ROBUST-01 example):
   - Save exit code at start: `local exit_code=$?`
   - Stop spinner if running (check spinner_pid, kill, clear line)
   - Loop through CLEANUP_FILES and rm -rf each
   - Loop through CLEANUP_PIDS and kill each
   - Exit with saved exit code

3. Create register_cleanup() helper:
   ```bash
   register_cleanup() {
       CLEANUP_FILES+=("$1")
   }
   ```

4. Create track_pid() helper:
   ```bash
   track_pid() {
       CLEANUP_PIDS+=("$1")
   }
   ```

5. Register the single trap at infrastructure section:
   ```bash
   trap cleanup EXIT
   ```

6. REMOVE the existing trap at line 102 (`trap 'stop_spinner' EXIT`)

7. Modify start_spinner() to call track_pid() after spawning background process:
   - After `spinner_pid=$!`, add `track_pid "$spinner_pid"`

8. Modify stop_spinner() to handle the case where spinner_pid is tracked:
   - Keep existing logic but ensure it sets spinner_pid="" after kill
   - The cleanup() function will also try to stop spinner, so make both idempotent
  </action>
  <verify>
Run: `grep -n "^trap" aishell` - should show only ONE trap statement (trap cleanup EXIT)
Run: `grep -c "CLEANUP_FILES" aishell` - should show multiple occurrences (declaration + usage)
  </verify>
  <done>
Global cleanup infrastructure exists with register_cleanup() and track_pid() helpers.
Only one trap statement for EXIT signal in the entire script.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update build functions to use cleanup infrastructure</name>
  <files>aishell</files>
  <action>
Update all build functions to use register_cleanup() instead of trap RETURN:

1. In do_build() function (around line 728-765):
   - REMOVE: `trap "rm -rf '$build_dir'" RETURN` (line ~731)
   - REMOVE: `trap "rm -rf '$build_dir' '$build_log'" RETURN` (line ~755)
   - ADD after `build_dir=$(mktemp -d)`: `register_cleanup "$build_dir"`
   - ADD after `build_log=$(mktemp)`: `register_cleanup "$build_log"`

2. In do_update() function (around line 1251-1278):
   - REMOVE: `trap "rm -rf '$build_dir'" RETURN` (line ~1255)
   - REMOVE: `trap "rm -rf '$build_dir' '$build_log'" RETURN` (line ~1278)
   - ADD after `build_dir=$(mktemp -d)`: `register_cleanup "$build_dir"`
   - ADD after `build_log=$(mktemp)`: `register_cleanup "$build_log"`

3. In build_extended_image() function (around line 1044-1047):
   - REMOVE: `trap "rm -f '$build_log'" RETURN` (line ~1047)
   - ADD after `build_log=$(mktemp)`: `register_cleanup "$build_log"`

After changes, verify no trap statements remain except the single `trap cleanup EXIT`.
  </action>
  <verify>
Run: `grep -n "trap.*RETURN" aishell` - should return nothing (no trap RETURN statements)
Run: `grep -c "register_cleanup" aishell` - should show 5+ occurrences
Run: `bash -n aishell` - syntax check passes
  </verify>
  <done>
All build functions use register_cleanup() for temp files.
No trap RETURN statements remain in the codebase.
Script passes syntax check.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Syntax check: `bash -n aishell`
2. Count traps: `grep -c "^trap" aishell` should return 1
3. Verify cleanup pattern: `grep -A5 "cleanup()" aishell` shows proper cleanup logic
4. Manual test (optional): Run `aishell build --with-claude`, press Ctrl+C during build, verify no temp files remain in /tmp
</verification>

<success_criteria>
- [ ] Only ONE trap statement exists in aishell (trap cleanup EXIT)
- [ ] All trap RETURN statements removed from build functions
- [ ] register_cleanup() and track_pid() helpers exist and are used
- [ ] Script passes `bash -n` syntax check
- [ ] ROBUST-01 requirement satisfied: consolidated cleanup handler
- [ ] ROBUST-02 requirement satisfied: signal handling during build propagates cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/11-code-hardening/11-01-SUMMARY.md`
</output>
