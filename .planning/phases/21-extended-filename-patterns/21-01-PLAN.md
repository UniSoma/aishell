---
phase: 21-extended-filename-patterns
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/detection/patterns.clj
  - src/aishell/detection/core.clj
autonomous: true

must_haves:
  truths:
    - "User sees high warning when application_default_credentials.json exists"
    - "User sees high warning when terraform.tfstate or terraform.tfstate.backup exist"
    - "User sees medium warning when kubeconfig or .kube/config patterns detected"
  artifacts:
    - path: "src/aishell/detection/patterns.clj"
      provides: "detect-gcp-credentials, detect-terraform-state, detect-kubeconfig functions"
      contains: ["detect-gcp-credentials" , "detect-terraform-state", "detect-kubeconfig"]
    - path: "src/aishell/detection/core.clj"
      provides: "scan-project calling cloud credential detectors"
      contains: ["detect-gcp-credentials", "detect-terraform-state", "detect-kubeconfig"]
  key_links:
    - from: "src/aishell/detection/core.clj"
      to: "src/aishell/detection/patterns.clj"
      via: "patterns/ namespace require and function calls"
      pattern: "patterns/detect-gcp-credentials"
---

<objective>
Add cloud credential file detection to the sensitive file scanning framework.

Purpose: Warn users about GCP application default credentials, Terraform state files, and Kubernetes configuration files before AI agents access the project directory.

Output: Three new detection functions in patterns.clj integrated into scan-project, detecting CLOD-02, CLOD-03, and CLOD-04 requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-extended-filename-patterns/21-RESEARCH.md

# Source files to modify
@src/aishell/detection/patterns.clj
@src/aishell/detection/core.clj

# Prior phase patterns
@.planning/phases/20-filename-detection/20-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cloud credential detection functions to patterns.clj</name>
  <files>src/aishell/detection/patterns.clj</files>
  <action>
Add three detection functions to patterns.clj following the established Phase 20 template:

1. **detect-gcp-credentials** (high severity)
   - Match exact filename "application_default_credentials.json" (case-insensitive)
   - Use fs/glob with "**" and {:hidden true}, filter excluded-dirs, then filter by basename
   - Return findings with :type :gcp-credentials, :severity :high
   - Reason: "GCP application default credentials file"

2. **detect-terraform-state** (high severity)
   - Use fs/glob with pattern "**/terraform.tfstate*" to match terraform.tfstate and terraform.tfstate.backup
   - Apply case-insensitive post-filtering via str/lower-case on filename
   - Filter excluded-dirs
   - Return findings with :type :terraform-state, :severity :high
   - Reason: "Terraform state file (may contain plaintext secrets)"

3. **detect-kubeconfig** (medium severity)
   - Match exact filename "kubeconfig" (case-insensitive via str/lower-case basename)
   - Also match files where path contains ".kube/config" (str/includes? check)
   - Use distinct to avoid duplicates if same file matches both patterns
   - Return findings with :type :kubeconfig, :severity :medium
   - Reason: "Kubernetes cluster configuration file"

Follow the existing function signature: `[project-dir excluded-dirs]`

Place new functions after detect-pem-key-files and before group-findings.
  </action>
  <verify>
```bash
bb -e "(require '[aishell.detection.patterns :as p]) (println 'loaded)"
```
Should print "loaded" without errors.
  </verify>
  <done>
Three new detection functions (detect-gcp-credentials, detect-terraform-state, detect-kubeconfig) exist in patterns.clj and load without syntax errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate cloud credential detectors into scan-project</name>
  <files>src/aishell/detection/core.clj</files>
  <action>
Update scan-project function in core.clj to call the three new detection functions.

Add to the concat chain after existing detectors:
```clojure
(patterns/detect-gcp-credentials project-dir excluded-dirs)
(patterns/detect-terraform-state project-dir excluded-dirs)
(patterns/detect-kubeconfig project-dir excluded-dirs)
```

The scan-project function should now call:
1. patterns/detect-env-files (Phase 20)
2. patterns/detect-ssh-keys (Phase 20)
3. patterns/detect-key-containers (Phase 20)
4. patterns/detect-pem-key-files (Phase 20)
5. patterns/detect-gcp-credentials (NEW)
6. patterns/detect-terraform-state (NEW)
7. patterns/detect-kubeconfig (NEW)
  </action>
  <verify>
```bash
bb -e "(require '[aishell.detection.core :as c]) (println 'loaded)"
```
Should print "loaded" without errors.
  </verify>
  <done>
scan-project calls all three new cloud credential detection functions.
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-end verification with test files</name>
  <files></files>
  <action>
Create temporary test directory with cloud credential files and verify detection:

```bash
# Create test directory
mkdir -p /tmp/aishell-test-21-01
mkdir -p /tmp/aishell-test-21-01/.kube

# Cloud credentials (high)
touch /tmp/aishell-test-21-01/application_default_credentials.json
touch /tmp/aishell-test-21-01/terraform.tfstate
touch /tmp/aishell-test-21-01/terraform.tfstate.backup

# Kubeconfig variants (medium)
touch /tmp/aishell-test-21-01/kubeconfig
touch /tmp/aishell-test-21-01/.kube/config

# Run detection
cd /home/jonasrodrigues/projects/harness
bb -e "
(require '[aishell.detection.core :as core])
(let [findings (core/scan-project \"/tmp/aishell-test-21-01\")]
  (println \"Total findings:\" (count findings))
  (doseq [f findings]
    (println (:severity f) (:type f) (:path f) (:reason f)))
  (core/display-warnings findings))
"

# Clean up
rm -rf /tmp/aishell-test-21-01
```

Expected results:
- application_default_credentials.json: high, :gcp-credentials
- terraform.tfstate: high, :terraform-state
- terraform.tfstate.backup: high, :terraform-state
- kubeconfig: medium, :kubeconfig
- .kube/config: medium, :kubeconfig
  </action>
  <verify>
Detection output shows all 5 test files detected with correct severities:
- 3 high-severity findings (1 GCP, 2 terraform)
- 2 medium-severity findings (2 kubeconfig)
  </verify>
  <done>
All cloud credential files detected correctly with appropriate severity levels. GCP ADC and terraform state show high severity, kubeconfig shows medium severity.
  </done>
</task>

</tasks>

<verification>
1. `bb -e "(require '[aishell.detection.patterns :as p] '[aishell.detection.core :as c]) (println 'ok)"` loads without errors
2. Test directory detection shows all 5 cloud credential files with correct types and severities
3. High-severity findings (GCP, terraform) trigger confirmation prompt in interactive mode
</verification>

<success_criteria>
- application_default_credentials.json detected with high severity
- terraform.tfstate and terraform.tfstate.backup detected with high severity
- kubeconfig and .kube/config detected with medium severity
- All detectors integrated into scan-project
- No regression in existing Phase 20 detectors
</success_criteria>

<output>
After completion, create `.planning/phases/21-extended-filename-patterns/21-01-SUMMARY.md`
</output>
