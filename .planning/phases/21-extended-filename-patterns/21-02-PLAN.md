---
phase: 21-extended-filename-patterns
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/aishell/detection/patterns.clj
  - src/aishell/detection/core.clj
autonomous: true

must_haves:
  truths:
    - "User sees high warning when .pypirc or .netrc exist"
    - "User sees medium warning when .npmrc, .yarnrc.yml, .docker/config.json, .terraformrc, or credentials.tfrc.json exist"
    - "User sees high warning when Rails master.key or credentials*.yml.enc exist"
    - "User sees medium warning when secret.*, secrets.*, vault.*, token.*, apikey.*, or private.* files exist"
    - "User sees medium warning when .pgpass, .my.cnf, or database.yml exist"
  artifacts:
    - path: "src/aishell/detection/patterns.clj"
      provides: "detect-package-manager-credentials, detect-tool-configs, detect-rails-secrets, detect-secret-pattern-files, detect-database-credentials functions"
      contains: ["detect-package-manager-credentials", "detect-tool-configs", "detect-rails-secrets", "detect-secret-pattern-files", "detect-database-credentials"]
    - path: "src/aishell/detection/core.clj"
      provides: "scan-project calling all Phase 21 detectors"
      contains: ["detect-package-manager-credentials", "detect-rails-secrets", "detect-secret-pattern-files"]
  key_links:
    - from: "src/aishell/detection/core.clj"
      to: "src/aishell/detection/patterns.clj"
      via: "patterns/ namespace require and function calls"
      pattern: "patterns/detect-package-manager-credentials"
---

<objective>
Add package manager, application secret, and database credential file detection to the sensitive file scanning framework.

Purpose: Warn users about PyPI/npm/Docker credentials, Rails secrets, generic secret-named files, and database credential files before AI agents access the project directory.

Output: Five new detection functions in patterns.clj integrated into scan-project, completing Phase 21 requirements (PKGM-02/03/04, ASEC-01/02/03).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-extended-filename-patterns/21-RESEARCH.md

# Source files to modify
@src/aishell/detection/patterns.clj
@src/aishell/detection/core.clj

# Prior plan in this phase
@.planning/phases/21-extended-filename-patterns/21-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add package manager and application secret detection functions to patterns.clj</name>
  <files>src/aishell/detection/patterns.clj</files>
  <action>
Add five detection functions to patterns.clj following the established template. Place after the Phase 21-01 functions (detect-kubeconfig) and before group-findings.

1. **detect-package-manager-credentials** (high severity)
   - Match exact filenames ".pypirc" and ".netrc" (case-insensitive via str/lower-case basename)
   - Use fs/glob "**" with {:hidden true}, filter excluded-dirs
   - Return findings with :type :package-manager-creds, :severity :high
   - Reason: "Package manager credentials file"

2. **detect-tool-configs** (medium severity)
   - Match exact filenames: ".npmrc", ".yarnrc.yml", ".terraformrc", "credentials.tfrc.json" (case-insensitive)
   - Also match .docker/config.json: files where path contains ".docker/" AND filename is "config.json"
   - Use distinct to combine results
   - Return findings with :type :tool-config, :severity :medium
   - Reason: "Tool configuration file (may contain credentials)"

3. **detect-rails-secrets** (high severity)
   - Match exact filename "master.key" (case-insensitive via str/lower-case basename)
   - Also match pattern "**/credentials*.yml.enc" via fs/glob (catches credentials.yml.enc, credentials.production.yml.enc)
   - Use concat for both match types, distinct to avoid duplicates
   - Return findings with :type :rails-secret, :severity :high
   - Reason for master.key: "Rails master key (decrypts all application secrets)"
   - Reason for *.yml.enc: "Rails encrypted credentials file"

4. **detect-secret-pattern-files** (medium severity)
   - Use multiple glob patterns: "**/secret.*", "**/secrets.*", "**/vault.*", "**/token.*", "**/apikey.*", "**/private.*"
   - Collect all matches with mapcat, filter excluded-dirs, apply distinct
   - Return findings with :type :secret-pattern-file, :severity :medium
   - Reason: "File with secret-like naming pattern"

5. **detect-database-credentials** (medium severity)
   - Match exact filenames: ".pgpass", ".my.cnf", "database.yml" (case-insensitive via str/lower-case basename)
   - Use fs/glob "**" with {:hidden true}, filter excluded-dirs
   - Return findings with :type :database-credentials, :severity :medium
   - Reason: "Database credentials file"

Follow the existing function signature: `[project-dir excluded-dirs]`
  </action>
  <verify>
```bash
bb -e "(require '[aishell.detection.patterns :as p]) (println 'loaded)"
```
Should print "loaded" without errors.
  </verify>
  <done>
Five new detection functions exist in patterns.clj and load without syntax errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate all remaining detectors into scan-project</name>
  <files>src/aishell/detection/core.clj</files>
  <action>
Update scan-project function in core.clj to call the five new detection functions.

Add to the concat chain after the Phase 21-01 detectors:
```clojure
(patterns/detect-package-manager-credentials project-dir excluded-dirs)
(patterns/detect-tool-configs project-dir excluded-dirs)
(patterns/detect-rails-secrets project-dir excluded-dirs)
(patterns/detect-secret-pattern-files project-dir excluded-dirs)
(patterns/detect-database-credentials project-dir excluded-dirs)
```

The complete scan-project function should now call all 12 detectors:
1-4: Phase 20 detectors (env, ssh, key-containers, pem-key)
5-7: Phase 21-01 detectors (gcp, terraform, kubeconfig)
8-12: Phase 21-02 detectors (package-manager, tool-configs, rails, secret-pattern, database)
  </action>
  <verify>
```bash
bb -e "(require '[aishell.detection.core :as c]) (println 'loaded)"
```
Should print "loaded" without errors.
  </verify>
  <done>
scan-project calls all five new detection functions, completing Phase 21 integration.
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-end verification with comprehensive test files</name>
  <files></files>
  <action>
Create temporary test directory with all Phase 21-02 file types and verify detection:

```bash
# Create test directory
mkdir -p /tmp/aishell-test-21-02
mkdir -p /tmp/aishell-test-21-02/.docker
mkdir -p /tmp/aishell-test-21-02/config

# Package manager credentials (high)
touch /tmp/aishell-test-21-02/.pypirc
touch /tmp/aishell-test-21-02/.netrc

# Tool configs (medium)
touch /tmp/aishell-test-21-02/.npmrc
touch /tmp/aishell-test-21-02/.yarnrc.yml
touch /tmp/aishell-test-21-02/.docker/config.json
touch /tmp/aishell-test-21-02/.terraformrc
touch /tmp/aishell-test-21-02/credentials.tfrc.json

# Rails secrets (high)
touch /tmp/aishell-test-21-02/master.key
touch /tmp/aishell-test-21-02/credentials.yml.enc
touch /tmp/aishell-test-21-02/credentials.production.yml.enc

# Secret pattern files (medium)
touch /tmp/aishell-test-21-02/secret.yaml
touch /tmp/aishell-test-21-02/secrets.json
touch /tmp/aishell-test-21-02/vault.txt
touch /tmp/aishell-test-21-02/token.env
touch /tmp/aishell-test-21-02/apikey.config
touch /tmp/aishell-test-21-02/private.pem

# Database credentials (medium)
touch /tmp/aishell-test-21-02/.pgpass
touch /tmp/aishell-test-21-02/.my.cnf
touch /tmp/aishell-test-21-02/config/database.yml

# Run detection
cd /home/jonasrodrigues/projects/harness
bb -e "
(require '[aishell.detection.core :as core])
(let [findings (core/scan-project \"/tmp/aishell-test-21-02\")]
  (println \"\\nTotal findings:\" (count findings))
  (println \"\\nBy severity:\")
  (println \"  High:\" (count (filter #(= :high (:severity %)) findings)))
  (println \"  Medium:\" (count (filter #(= :medium (:severity %)) findings)))
  (println \"\\nDetailed findings:\")
  (doseq [f (sort-by (juxt :severity :type) findings)]
    (println (:severity f) (:type f) (or (:path f) (str \"[summary: \" (:reason f) \"]\"))))
  (println)
  (core/display-warnings findings))
"

# Clean up
rm -rf /tmp/aishell-test-21-02
```

Expected results by type:
- :package-manager-creds (high): .pypirc, .netrc (2 files)
- :rails-secret (high): master.key, credentials.yml.enc, credentials.production.yml.enc (3 files)
- :tool-config (medium): .npmrc, .yarnrc.yml, .docker/config.json, .terraformrc, credentials.tfrc.json (5 files, may summarize)
- :secret-pattern-file (medium): secret.yaml, secrets.json, vault.txt, token.env, apikey.config, private.pem (6 files, will summarize)
- :database-credentials (medium): .pgpass, .my.cnf, database.yml (3 files)

Note: private.pem may also match :pem-key from Phase 20 - this is expected (overlapping patterns).
  </action>
  <verify>
Detection output shows:
- High-severity count: 5 (2 package-manager-creds + 3 rails-secret)
- Medium-severity: 14+ files across tool-config, secret-pattern-file, database-credentials, and possible pem-key overlap
- Threshold-of-3 summarization applied to groups with >3 files (secret-pattern-file, tool-config)
  </verify>
  <done>
All Phase 21-02 files detected with correct types and severities. Package manager credentials and Rails secrets show high severity. Tool configs, secret patterns, and database credentials show medium severity. Grouping/summarization works correctly.
  </done>
</task>

</tasks>

<verification>
1. `bb -e "(require '[aishell.detection.patterns :as p] '[aishell.detection.core :as c]) (println 'ok)"` loads without errors
2. Test directory detection shows all file types with correct severities
3. High-severity findings (.pypirc, .netrc, master.key, credentials*.yml.enc) trigger confirmation prompt
4. Threshold-of-3 summarization applied when >3 files of same type
5. No regression in Phase 20 or Phase 21-01 detectors
</verification>

<success_criteria>
- .pypirc and .netrc detected with high severity
- .npmrc, .yarnrc.yml, .docker/config.json, .terraformrc, credentials.tfrc.json detected with medium severity
- master.key and credentials*.yml.enc detected with high severity
- secret.*, secrets.*, vault.*, token.*, apikey.*, private.* detected with medium severity
- .pgpass, .my.cnf, database.yml detected with medium severity
- All 12 detectors integrated into scan-project
- Phase 21 complete: All extended filename pattern requirements met
</success_criteria>

<output>
After completion, create `.planning/phases/21-extended-filename-patterns/21-02-SUMMARY.md`
</output>
