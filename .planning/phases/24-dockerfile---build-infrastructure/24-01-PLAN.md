---
phase: 24-dockerfile---build-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/templates.clj
  - src/aishell/cli.clj
autonomous: true

must_haves:
  truths:
    - "Dockerfile template includes ARG WITH_CODEX and ARG WITH_GEMINI"
    - "Dockerfile template includes conditional npm install for @openai/codex"
    - "Dockerfile template includes conditional npm install for @google/gemini-cli"
    - "CLI build-spec includes :with-codex and :with-gemini flags"
    - "CLI help shows --with-codex and --with-gemini options"
  artifacts:
    - path: "src/aishell/docker/templates.clj"
      provides: "Dockerfile with Codex/Gemini install blocks"
      contains: "WITH_CODEX"
    - path: "src/aishell/cli.clj"
      provides: "Build command flags for new harnesses"
      contains: ":with-codex"
  key_links:
    - from: "templates.clj"
      to: "build.clj"
      via: "ARG names must match build-arg values"
      pattern: "WITH_CODEX|WITH_GEMINI|CODEX_VERSION|GEMINI_VERSION"
---

<objective>
Add Dockerfile installation blocks and CLI flags for Codex and Gemini harnesses.

Purpose: Enable users to specify --with-codex and --with-gemini during aishell build
Output: Extended Dockerfile template and CLI build-spec with new harness options
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-dockerfile---build-infrastructure/24-RESEARCH.md

@src/aishell/docker/templates.clj
@src/aishell/cli.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Codex and Gemini installation blocks to Dockerfile template</name>
  <files>src/aishell/docker/templates.clj</files>
  <action>
Extend the base-dockerfile string in templates.clj to add installation blocks for Codex and Gemini CLI.

Add after the existing ARGs (WITH_CLAUDE, WITH_OPENCODE):
```dockerfile
ARG WITH_CODEX=false
ARG WITH_GEMINI=false
ARG CODEX_VERSION=""
ARG GEMINI_VERSION=""
```

Add after the OpenCode installation RUN block:
```dockerfile
# Install Codex CLI if requested (npm global)
# npm global installs to /usr/local/bin/codex
RUN if [ "$WITH_CODEX" = "true" ]; then \
        if [ -n "$CODEX_VERSION" ]; then \
            npm install -g @openai/codex@"$CODEX_VERSION"; \
        else \
            npm install -g @openai/codex; \
        fi \
    fi

# Install Gemini CLI if requested (npm global)
# npm global installs to /usr/local/bin/gemini
RUN if [ "$WITH_GEMINI" = "true" ]; then \
        if [ -n "$GEMINI_VERSION" ]; then \
            npm install -g @google/gemini-cli@"$GEMINI_VERSION"; \
        else \
            npm install -g @google/gemini-cli; \
        fi \
    fi
```

Follow the existing pattern exactly - use same structure as Claude installation block.
  </action>
  <verify>
Run: `grep -E "WITH_CODEX|WITH_GEMINI|@openai/codex|@google/gemini-cli" src/aishell/docker/templates.clj`
Should show all 4 ARGs and both npm install commands.
  </verify>
  <done>
Dockerfile template contains ARG WITH_CODEX, ARG WITH_GEMINI, ARG CODEX_VERSION, ARG GEMINI_VERSION and conditional npm install blocks for both @openai/codex and @google/gemini-cli packages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add --with-codex and --with-gemini to CLI build spec</name>
  <files>src/aishell/cli.clj</files>
  <action>
Extend the CLI to support new harness flags.

1. In build-spec map, add after :with-opencode:
```clojure
:with-codex    {:desc "Include Codex CLI (optional: =VERSION)"}
:with-gemini   {:desc "Include Gemini CLI (optional: =VERSION)"}
```

2. In print-build-help, update the format-opts :order vector to include new flags:
```clojure
:order [:with-claude :with-opencode :with-codex :with-gemini :force :verbose :help]
```

3. In print-build-help examples section, add example:
```clojure
(println (str "  " output/CYAN "aishell build --with-codex --with-gemini" output/NC " Include Codex and Gemini"))
```

4. In handle-build, parse the new flags (after opencode-config):
```clojure
codex-config (parse-with-flag (:with-codex opts))
gemini-config (parse-with-flag (:with-gemini opts))
```

5. Add version validation for new harnesses (after OpenCode validation):
```clojure
_ (validate-version (:version codex-config) "Codex")
_ (validate-version (:version gemini-config) "Gemini")
```

6. Pass new flags to build/build-base-image:
```clojure
:with-codex (:enabled? codex-config)
:with-gemini (:enabled? gemini-config)
:codex-version (:version codex-config)
:gemini-version (:version gemini-config)
```

7. Add new harness state to state/write-state call:
```clojure
:with-codex (:enabled? codex-config)
:with-gemini (:enabled? gemini-config)
:codex-version (:version codex-config)
:gemini-version (:version gemini-config)
```

8. In handle-update, show new harnesses in update output (after OpenCode):
```clojure
(when (:with-codex state)
  (println (str "  Codex: " (or (:codex-version state) "latest"))))
(when (:with-gemini state)
  (println (str "  Gemini: " (or (:gemini-version state) "latest"))))
```

9. In handle-update, pass new harness state to build:
```clojure
:with-codex (:with-codex state)
:with-gemini (:with-gemini state)
:codex-version (:codex-version state)
:gemini-version (:gemini-version state)
```
  </action>
  <verify>
Run: `bb -cp src -e "(require '[aishell.cli]) (println (:with-codex aishell.cli/build-spec))"`
Should print: `{:desc Include Codex CLI (optional: =VERSION)}`
  </verify>
  <done>
CLI accepts --with-codex and --with-gemini flags, validates versions, and passes them to build function and state persistence.
  </done>
</task>

</tasks>

<verification>
1. `grep -c "with-codex\|with-gemini" src/aishell/cli.clj` returns count >= 8
2. `grep -c "WITH_CODEX\|WITH_GEMINI" src/aishell/docker/templates.clj` returns count >= 4
3. `bb -cp src -e "(require '[aishell.cli]) (keys aishell.cli/build-spec)"` includes :with-codex and :with-gemini
</verification>

<success_criteria>
- Dockerfile template has ARGs and RUN blocks for Codex and Gemini
- CLI build-spec includes :with-codex and :with-gemini
- Version validation works for new harnesses
- Help text shows new options
- State persistence includes new harness fields
</success_criteria>

<output>
After completion, create `.planning/phases/24-dockerfile---build-infrastructure/24-01-SUMMARY.md`
</output>
