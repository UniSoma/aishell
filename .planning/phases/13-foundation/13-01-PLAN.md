---
phase: 13-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bb.edn
  - src/aishell/core.clj
  - src/aishell/cli.clj
  - src/aishell/output.clj
autonomous: true

must_haves:
  truths:
    - "User can run ./bb.edn script and see version output"
    - "User can run -h or --help and see command descriptions"
    - "User sees colored output when terminal supports it"
  artifacts:
    - path: "bb.edn"
      provides: "Babashka project configuration"
      contains: ":paths"
    - path: "src/aishell/core.clj"
      provides: "Version constant and -main entry point"
      exports: ["version", "-main"]
    - path: "src/aishell/cli.clj"
      provides: "CLI dispatch table and help generation"
      exports: ["dispatch", "print-help"]
    - path: "src/aishell/output.clj"
      provides: "Colored output functions"
      exports: ["error", "warn"]
  key_links:
    - from: "src/aishell/core.clj"
      to: "src/aishell/cli.clj"
      via: "require and call dispatch"
      pattern: "cli/dispatch"
    - from: "src/aishell/cli.clj"
      to: "src/aishell/output.clj"
      via: "require and call error"
      pattern: "output/error"
---

<objective>
Create project structure and core CLI with version, help, and colored output.

Purpose: Establish the Babashka project foundation that all subsequent phases build on.
Output: Working CLI that responds to --version, --help, and unknown commands with appropriate output.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-foundation/13-CONTEXT.md
@.planning/phases/13-foundation/13-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Babashka project structure</name>
  <files>bb.edn, src/aishell/core.clj, src/aishell/output.clj</files>
  <action>
Create the Babashka project configuration and core modules:

1. Create `bb.edn` with:
   - `:paths ["src"]` to include source directory
   - No external dependencies (all built-in)

2. Create `src/aishell/output.clj` with:
   - Namespace `aishell.output`
   - `colors-enabled?` function checking `System/console`, `NO_COLOR`, `TERM`
   - Color constants: RED, YELLOW, CYAN, BOLD, NC (empty strings if colors disabled)
   - `error` function: prints red "Error:" prefix to stderr, calls `System/exit 1`
   - `warn` function: prints yellow "Warning:" prefix to stderr
   - `verbose` function: prints to stderr if `*verbose*` dynamic var is true
   - `error-unknown-command` function: prints error with suggestion to try --help

3. Create `src/aishell/core.clj` with:
   - Namespace `aishell.core`
   - `version` constant: "2.0.0"
   - `print-version` function: prints "aishell 2.0.0"
   - `print-version-json` function: prints `{"name":"aishell","version":"2.0.0"}`
   - `-main` function: calls `cli/dispatch` with args, wraps in try/catch for errors
   - Entry point guard: `(when (= *file* (System/getProperty "babashka.file")) (apply -main *command-line-args*))`

Reference: 13-RESEARCH.md Code Examples section for exact patterns.
  </action>
  <verify>
  - `ls bb.edn src/aishell/core.clj src/aishell/output.clj` shows all files exist
  - `bb -e "(require 'aishell.output) (println aishell.output/RED)"` runs without error
  </verify>
  <done>Project structure exists with output utilities ready for CLI</done>
</task>

<task type="auto">
  <name>Task 2: Implement CLI dispatch with version and help</name>
  <files>src/aishell/cli.clj</files>
  <action>
Create `src/aishell/cli.clj` implementing the CLI dispatch:

1. Namespace requires:
   - `[babashka.cli :as cli]`
   - `[aishell.core :as core]`
   - `[aishell.output :as output]`

2. Define `global-spec`:
   ```clojure
   {:help    {:alias :h :coerce :boolean :desc "Show help"}
    :version {:alias :v :coerce :boolean :desc "Show version"}
    :json    {:coerce :boolean :desc "Output in JSON format"}}
   ```

3. Implement `print-help` function with:
   - Usage line: "Usage: aishell [OPTIONS] COMMAND [ARGS...]"
   - Description: "Build and run ephemeral containers for AI harnesses."
   - Commands section listing: build, update, claude, opencode, (none) = shell
   - Global Options section using `cli/format-opts`
   - Examples section with 3 practical examples (from CONTEXT.md: colored, inline)
   - Use CYAN color for command names, BOLD for section headers if colors enabled

4. Implement `handle-default` function:
   - If `:version` in opts: call `core/print-version` (or json variant if `:json`)
   - If `:help` in opts: call `print-help`
   - If args not empty: call `output/error-unknown-command` with first arg
   - Else: call `output/error` with "No image built. Run: aishell build --with-claude"

5. Define `dispatch-table`:
   ```clojure
   [{:cmds [] :spec global-spec :fn handle-default}]
   ```
   Note: Specific commands (build, claude, etc.) added in later phases.

6. Implement `dispatch` function:
   ```clojure
   (defn dispatch [args]
     (cli/dispatch dispatch-table args))
   ```

Reference: 13-RESEARCH.md Pattern 1-5 and Code Examples section.
  </action>
  <verify>
  - `bb -m aishell.core --version` prints "aishell 2.0.0"
  - `bb -m aishell.core --version --json` prints JSON with name and version
  - `bb -m aishell.core -v` prints "aishell 2.0.0" (short alias works)
  - `bb -m aishell.core --help` prints help with commands and examples
  - `bb -m aishell.core -h` prints help (short alias works)
  - `bb -m aishell.core foo` prints error about unknown command and suggests --help
  - `bb -m aishell.core` prints error about no image built
  </verify>
  <done>CLI responds correctly to --version, --help, -v, -h, and unknown commands</done>
</task>

<task type="auto">
  <name>Task 3: Create entry point script</name>
  <files>aishell.clj</files>
  <action>
Create `aishell.clj` as the entry point script (separate from v1.x `aishell` Bash script):

1. Add shebang: `#!/usr/bin/env bb`

2. Load the source path and require main:
   ```clojure
   (require '[babashka.fs :as fs])

   ;; Add src to classpath dynamically
   (let [script-dir (fs/parent (fs/absolutize *file*))]
     (babashka.classpath/add-classpath (str (fs/path script-dir "src"))))

   (require '[aishell.core :as core])
   (apply core/-main *command-line-args*)
   ```

3. Make executable: The Write tool creates the file, then use chmod.

This allows running `./aishell.clj --help` directly during development.
In Phase 18, this will become an uberscript combining all sources.
  </action>
  <verify>
  - `chmod +x aishell.clj && ./aishell.clj --version` prints "aishell 2.0.0"
  - `./aishell.clj --help` prints formatted help
  - `./aishell.clj foo` prints unknown command error
  </verify>
  <done>Entry point script works for direct execution</done>
</task>

</tasks>

<verification>
Run full verification suite:
```bash
# Version checks
bb -m aishell.core --version
bb -m aishell.core -v
bb -m aishell.core --version --json

# Help checks
bb -m aishell.core --help
bb -m aishell.core -h

# Error handling
bb -m aishell.core unknowncommand  # Should error with suggestion
bb -m aishell.core  # Should error about no image

# Entry point
./aishell.clj --version
./aishell.clj --help
```
</verification>

<success_criteria>
- bb.edn exists and configures source paths
- All source files in src/aishell/ namespace
- `--version` and `-v` print version
- `--version --json` prints JSON format
- `--help` and `-h` print formatted help with colors (when terminal supports)
- Unknown command prints error with suggestion
- Default (no args) prints meaningful error
- Entry point script is executable
</success_criteria>

<output>
After completion, create `.planning/phases/13-foundation/13-01-SUMMARY.md`
</output>
