---
phase: 04-project-customization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - aishell
autonomous: false

must_haves:
  truths:
    - "CLI detects .aishell/Dockerfile and builds extended image"
    - "Extended image includes project-specific dependencies"
    - "Subsequent runs use cached image unless Dockerfile or base changes"
    - "--rebuild flag forces fresh build"
    - "--build-arg passes arguments to extended Dockerfile"
  artifacts:
    - path: "aishell"
      provides: "Extension detection, building, and caching logic"
      contains: "extension_dockerfile"
  key_links:
    - from: "aishell"
      to: "docker build"
      via: "build_extended_image function"
      pattern: "docker build.*-f.*\\.aishell/Dockerfile"
    - from: "aishell"
      to: "docker inspect"
      via: "base image ID tracking"
      pattern: "docker inspect.*aishell.base.id"
---

<objective>
Add project extension support to aishell CLI.

Purpose: Allow projects to extend the base aishell image with their own dependencies (Node.js, Python, Rust, etc.) using a standard Dockerfile in `.aishell/Dockerfile`. This enables project-specific tooling without modifying the core aishell image.

Output: Updated aishell script that detects `.aishell/Dockerfile`, builds extended images with proper caching, and supports `--rebuild` and `--build-arg` flags.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-project-customization/04-CONTEXT.md
@.planning/phases/04-project-customization/04-RESEARCH.md
@aishell
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add project extension support to aishell</name>
  <files>aishell</files>
  <action>
Modify the aishell script to support project extensions. Add the following:

**New global variables (near existing globals):**
```bash
FORCE_REBUILD=false
BUILD_ARGS=()
IMAGE_TO_RUN=""
```

**New functions (before ensure_image):**

1. `extension_dockerfile()` - Check for `.aishell/Dockerfile` in project directory:
   - Takes project_dir as argument
   - Returns 0 and echoes path if file exists, returns 1 otherwise

2. `get_base_image_id()` - Get current base image ID:
   - Uses `docker inspect --format='{{.Id}}' aishell:base`
   - Returns empty if image doesn't exist

3. `needs_extended_rebuild()` - Check if extended image needs rebuild:
   - Takes extended_tag and current_base_id as arguments
   - Returns 0 (needs rebuild) if:
     - Extended image doesn't exist
     - Stored base ID (from label) differs from current base ID
   - Returns 1 (use cache) otherwise
   - Use label `aishell.base.id` for tracking

4. `build_extended_image()` - Build extended image:
   - Takes dockerfile, project_dir, image_tag, base_id, force_rebuild as arguments
   - Build with `-f "$dockerfile"` and context as `"$project_dir"`
   - Add `--label "aishell.base.id=$base_id"`
   - Add `--no-cache` if force_rebuild is true
   - Pass through BUILD_ARGS array as `--build-arg` flags
   - Show spinner unless VERBOSE (then use `--progress=plain`)
   - On failure: show error output and exit non-zero

5. `ensure_image_with_extension()` - Main entry point for image selection:
   - First call `ensure_image` to ensure base exists
   - Check for `.aishell/Dockerfile` using `extension_dockerfile`
   - If no extension: set `IMAGE_TO_RUN="aishell:base"` and return
   - If extension exists:
     - Calculate extended tag: `aishell:ext-{hash}` where hash is first 12 chars of sha256 of project path
     - Get current base image ID
     - Check if rebuild needed (or FORCE_REBUILD is true)
     - Build extended image (Docker cache handles efficiency)
     - Set `IMAGE_TO_RUN` to extended tag

**Argument parsing updates (in parse_args):**
- Add `--rebuild` flag: sets `FORCE_REBUILD=true`
- Add `--build-arg` handling: append value to BUILD_ARGS array (format: `--build-arg KEY=VALUE`)

**Usage/help updates:**
- Add `--rebuild` to Options: "Force rebuild of images (ignore cache)"
- Add `--build-arg` to Options: "Pass build argument to Dockerfile (can repeat)"
- Update Examples to show: `aishell --build-arg NODE_VERSION=20`

**Main function updates:**
- After `ensure_image`, call `ensure_image_with_extension "$project_dir"` instead
- In docker run commands, use `"$IMAGE_TO_RUN"` instead of `"$IMAGE_NAME"`
- Move `ensure_image` call to AFTER project_dir is set (it's needed for extension check)

**Rename `IMAGE_NAME` to `BASE_IMAGE_NAME`** for clarity, update references accordingly.

**Error handling:**
- If `.aishell/Dockerfile` exists but build fails, show error and exit (no fallback)
- Capture build output to temp file, show on failure

**Important implementation notes:**
- Use hash-based tag: `echo -n "$project_dir" | sha256sum | cut -c1-12`
- Build context must be project directory (for COPY to work)
- Always run `docker build` for extended images - Docker handles caching
- Only pass `--no-cache` when force_rebuild or base image changed
  </action>
  <verify>
Run `./aishell --help` and confirm new flags (--rebuild, --build-arg) appear in output.
Run `./aishell --version` to confirm script syntax is valid.
  </verify>
  <done>
aishell script contains extension detection, building, and caching logic. New --rebuild and --build-arg flags work. Script runs without syntax errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify project extension workflow</name>
  <what-built>
Project extension support in aishell CLI. Projects with `.aishell/Dockerfile` will have an extended image built automatically with project-specific dependencies.
  </what-built>
  <how-to-verify>
**Test 1: Extension detection and build**
1. Create test extension in current project:
   ```bash
   mkdir -p .aishell
   cat > .aishell/Dockerfile << 'EOF'
   FROM aishell:base
   RUN apt-get update && apt-get install -y cowsay
   ENV PATH="/usr/games:$PATH"
   EOF
   ```
2. Run: `./aishell`
3. Expect: Spinner shows "Building project image..." then shell opens
4. Inside container, run: `cowsay "It works!"`
5. Expect: ASCII cow with message (proves extended image has cowsay)
6. Exit container

**Test 2: Cache efficiency**
1. Run: `./aishell` again
2. Expect: No rebuild message, container starts quickly (Docker cache hit)
3. Exit container

**Test 3: Force rebuild**
1. Run: `./aishell --rebuild`
2. Expect: Spinner shows "Building project image..." (forced rebuild)
3. Exit container

**Test 4: Build arg passthrough**
1. Update test Dockerfile:
   ```bash
   cat > .aishell/Dockerfile << 'EOF'
   FROM aishell:base
   ARG TEST_VALUE=default
   RUN echo "TEST_VALUE=$TEST_VALUE" > /tmp/build-arg-test
   EOF
   ```
2. Run: `./aishell --rebuild --build-arg TEST_VALUE=custom`
3. Inside container, run: `cat /tmp/build-arg-test`
4. Expect: Output shows `TEST_VALUE=custom`
5. Exit container

**Test 5: Base image change detection**
1. Rebuild base with different harness: `./aishell --with-claude --rebuild`
2. Run: `./aishell` (should auto-rebuild extended because base changed)
3. Expect: "Building project image..." spinner (base image ID changed)
4. Exit container

**Test 6: Cleanup test files**
1. Remove test extension: `rm -rf .aishell`
2. Run: `./aishell`
3. Expect: Container starts using base image (no extension to build)

**Test 7: Verbose mode**
1. Recreate test extension (step 1 from Test 1)
2. Run: `./aishell --verbose --rebuild`
3. Expect: Docker build output streams to terminal (not spinner)
4. Exit and cleanup: `rm -rf .aishell`
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe which test failed and how.</resume-signal>
</task>

</tasks>

<verification>
All CORE-06 requirement criteria verified:
- CLI detects `.aishell/Dockerfile` and builds extended image
- Extended image includes project-specific dependencies
- Builds are cached (Docker layer cache + base image ID tracking)
- `--rebuild` forces fresh build
- `--build-arg` passes through to extended Dockerfile
</verification>

<success_criteria>
- `./aishell --help` shows --rebuild and --build-arg options
- Project with `.aishell/Dockerfile` triggers extended image build
- Extended image contains dependencies from project Dockerfile
- Second run uses cached image (no rebuild spinner)
- `--rebuild` forces rebuild regardless of cache
- Base image change triggers extended image rebuild
</success_criteria>

<output>
After completion, create `.planning/phases/04-project-customization/04-01-SUMMARY.md`
</output>
