---
phase: 44-flip-gitleaks-default
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/aishell/run.clj]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Gitleaks staleness warning only displays when :with-gitleaks is true in state"
    - "Users who build without --with-gitleaks never see gitleaks-related warnings"
    - "Users who build with --with-gitleaks still see staleness warning when appropriate"
  artifacts:
    - path: "src/aishell/run.clj"
      provides: "Conditional gitleaks freshness warning gated on :with-gitleaks state"
      contains: ":with-gitleaks state"
  key_links:
    - from: "src/aishell/run.clj"
      to: "state map (:with-gitleaks key)"
      via: "state already bound at line 104"
      pattern: "with-gitleaks state.*display-freshness-warning"
---

<objective>
Fix PIPE-01 gap: Make gitleaks staleness warning conditional on :with-gitleaks state.

Purpose: Users who build without --with-gitleaks should never see "Gitleaks scan is missing" warnings, since they cannot run the gitleaks command.

Output: Updated src/aishell/run.clj with conditional warning display.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-flip-gitleaks-default/44-01-SUMMARY.md
@.planning/phases/44-flip-gitleaks-default/44-VERIFICATION.md
@src/aishell/run.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gate gitleaks freshness warning on :with-gitleaks state</name>
  <files>src/aishell/run.clj</files>
  <action>
    In src/aishell/run.clj, change lines 189-191 from:

    ```clojure
    ;; Display gitleaks freshness warning (for shell/claude/opencode, not gitleaks itself)
    _ (when-not (= cmd "gitleaks")
        (gitleaks-warnings/display-freshness-warning project-dir cfg))
    ```

    To:

    ```clojure
    ;; Display gitleaks freshness warning only if gitleaks is installed
    _ (when (and (:with-gitleaks state) (not= cmd "gitleaks"))
        (gitleaks-warnings/display-freshness-warning project-dir cfg))
    ```

    This adds a check for `:with-gitleaks` in the state map (already bound at line 104 via `state/read-state`) so the warning only fires when gitleaks was actually installed during setup.

    The logic is:
    - (:with-gitleaks state) is truthy: gitleaks is installed, show warning (unless running gitleaks command itself)
    - (:with-gitleaks state) is falsy or nil: gitleaks not installed, skip warning entirely

    Do NOT change anything else in the file. This is a surgical one-line fix.
  </action>
  <verify>
    1. grep -n "with-gitleaks state" src/aishell/run.clj shows the new condition on the freshness warning line
    2. grep -n "when-not.*gitleaks" src/aishell/run.clj returns NO matches (old pattern removed)
    3. grep -n "display-freshness-warning" src/aishell/run.clj shows exactly one match, inside the new conditional
  </verify>
  <done>
    The gitleaks freshness warning is gated on (:with-gitleaks state) — it only displays when gitleaks was installed via --with-gitleaks during setup. Users who build without gitleaks never see the warning.
  </done>
</task>

</tasks>

<verification>
1. `grep -n "with-gitleaks state" src/aishell/run.clj` — confirms state check is present
2. `grep -c "when-not.*gitleaks" src/aishell/run.clj` — returns 0 (old unconditional pattern gone)
3. `grep -A2 "with-gitleaks state" src/aishell/run.clj` — shows display-freshness-warning is inside the conditional
4. The file still compiles (no syntax errors introduced)
</verification>

<success_criteria>
- PIPE-01 requirement satisfied: staleness warning skipped when gitleaks not installed
- No regression: warning still shows for users who have gitleaks installed (when :with-gitleaks is true)
- Phase 44 verification score moves from 4/5 to 5/5
</success_criteria>

<output>
After completion, create `.planning/phases/44-flip-gitleaks-default/44-02-SUMMARY.md`
</output>
