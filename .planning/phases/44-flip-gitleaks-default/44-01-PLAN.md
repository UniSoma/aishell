---
phase: 44-flip-gitleaks-default
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/cli.clj
  - src/aishell/docker/templates.clj
  - src/aishell/docker/build.clj
  - src/aishell/state.clj
autonomous: true

must_haves:
  truths:
    - "Building without flags produces image without Gitleaks installed (ARG WITH_GITLEAKS defaults to false)"
    - "Building with --with-gitleaks produces image with Gitleaks installed"
    - "aishell --help shows gitleaks command only when state has :with-gitleaks true"
    - "aishell setup --help shows --with-gitleaks flag (not --without-gitleaks)"
    - "Pipeline runs without Gitleaks staleness warning when Gitleaks not installed (unchanged behavior)"
    - "Filename-based secret detection still blocks suspicious files independent of Gitleaks (unchanged behavior)"
  artifacts:
    - path: "src/aishell/cli.clj"
      provides: "--with-gitleaks flag in setup-spec, boolean default logic, updated help examples"
      contains: ":with-gitleaks {:coerce :boolean"
    - path: "src/aishell/docker/templates.clj"
      provides: "ARG WITH_GITLEAKS=false default in Dockerfile template"
      contains: "ARG WITH_GITLEAKS=false"
    - path: "src/aishell/docker/build.clj"
      provides: "Updated docstring for opt-in semantics"
    - path: "src/aishell/state.clj"
      provides: "Updated docstring for opt-in semantics"
  key_links:
    - from: "src/aishell/cli.clj (handle-setup)"
      to: "src/aishell/docker/build.clj (build-foundation-image)"
      via: ":with-gitleaks boolean in opts map"
      pattern: "with-gitleaks.*boolean.*:with-gitleaks opts"
    - from: "src/aishell/cli.clj (installed-harnesses)"
      to: "state.edn"
      via: ":with-gitleaks state default"
      pattern: ":with-gitleaks state"
---

<objective>
Flip Gitleaks from opt-out (--without-gitleaks) to opt-in (--with-gitleaks) to establish a consistent --with-* flag pattern across all build options.

Purpose: Gitleaks becomes opt-in, matching the pattern already used by all harnesses (--with-claude, --with-opencode, etc.) and tmux (--with-tmux). This eliminates the inconsistent negative flag and simplifies the mental model.

Output: Modified CLI flag, Dockerfile ARG default, help text, and docstrings. All downstream consumers (help visibility, warnings, filename detection) work without modification because they already read the positive `:with-gitleaks` state field.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-flip-gitleaks-default/44-RESEARCH.md
@src/aishell/cli.clj
@src/aishell/docker/templates.clj
@src/aishell/docker/build.clj
@src/aishell/state.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Flip Dockerfile ARG default and update build docstring</name>
  <files>src/aishell/docker/templates.clj, src/aishell/docker/build.clj</files>
  <action>
  In `src/aishell/docker/templates.clj`:
  1. Change `ARG WITH_GITLEAKS=true` to `ARG WITH_GITLEAKS=false` in the `base-dockerfile` string
  2. Update the comment on that line from `(conditional)` to `(conditional, opt-in)` for clarity

  In `src/aishell/docker/build.clj`:
  3. Change docstring line `:with-gitleaks - Include Gitleaks (default true)` to `:with-gitleaks - Include Gitleaks (default false, opt-in)`

  Do NOT change anything else in these files. The RUN conditional and the build-arg passing logic are already correct.
  </action>
  <verify>
  Run: `grep -n "WITH_GITLEAKS" src/aishell/docker/templates.clj` -- should show `ARG WITH_GITLEAKS=false`
  Run: `grep -n "with-gitleaks" src/aishell/docker/build.clj` -- should show `default false, opt-in`
  </verify>
  <done>
  Dockerfile template defaults to WITH_GITLEAKS=false. Build docstring reflects opt-in semantics.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace --without-gitleaks with --with-gitleaks in CLI and update state docstring</name>
  <files>src/aishell/cli.clj, src/aishell/state.clj</files>
  <action>
  In `src/aishell/cli.clj`, make exactly these changes:

  1. **setup-spec** (line 74): Replace `:without-gitleaks {:coerce :boolean :desc "Skip Gitleaks installation"}` with `:with-gitleaks {:coerce :boolean :desc "Include Gitleaks secret scanner"}`

  2. **print-setup-help :order vector** (line 142): Replace `:without-gitleaks` with `:with-gitleaks` in the :order list

  3. **print-setup-help example** (line 151): Replace the `--without-gitleaks` example line with:
     `(println (str "  " output/CYAN "aishell setup --with-gitleaks" output/NC "      Include Gitleaks scanner"))`
     Note the extra spaces after `--with-gitleaks"` for column alignment.

  4. **handle-setup let binding** (line 164): Replace `with-gitleaks (not (:without-gitleaks opts))` with `with-gitleaks (boolean (:with-gitleaks opts))` and update comment to `; opt-in: nil -> false, true -> true`

  5. **installed-harnesses default** (line 91): Change `(:with-gitleaks state true)` to `(:with-gitleaks state false)` -- when state file has no `:with-gitleaks` key, default to false (not installed, matching opt-in model)

  6. **handle-update default** (line 319): Change `(:with-gitleaks state true)` to `(:with-gitleaks state false)` -- same rationale as above

  In `src/aishell/state.clj`:

  7. **write-state docstring** (line 30): Change `:with-gitleaks true` to `:with-gitleaks false` and update comment to `; boolean (whether Gitleaks installed, default false, opt-in)`

  Do NOT change:
  - The `installed-harnesses` fallback when no state file exists (line 93): The `#{"claude" "opencode" "codex" "gemini" "gitleaks"}` set should remain -- this is the discoverability behavior when no build has been done yet.
  - Any code in run.clj, detection files, or gitleaks/ namespace -- these are downstream consumers that already check `:with-gitleaks` positively.
  </action>
  <verify>
  Run: `grep -n "without-gitleaks" src/aishell/cli.clj` -- should return NO results (zero occurrences)
  Run: `grep -n "without.gitleaks" src/aishell/cli.clj` -- should return NO results
  Run: `grep -n "with-gitleaks" src/aishell/cli.clj` -- should show positive flag in setup-spec, order, handle-setup, installed-harnesses, handle-update
  Run: `grep -c "with-gitleaks" src/aishell/cli.clj` -- should show 7 occurrences (spec, order, example, handle-setup let, state-map x2, handle-update)
  Wait, let me recount: spec(1), order(1), example(1), handle-setup let(1), state-map :with-gitleaks(1), state-map usage(1), installed-harnesses(1), handle-update(1) = 8. But two of those are `:with-gitleaks with-gitleaks` bindings. Let's just verify no "without-gitleaks" remains.
  Run: `grep -rn "without-gitleaks" src/` -- should return NO results in any source file
  </verify>
  <done>
  CLI uses --with-gitleaks (positive flag). Default value is false when flag absent. No occurrences of "without-gitleaks" remain in src/. State docstring reflects opt-in default.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **No remnants of old flag in source code:**
   `grep -rn "without-gitleaks" src/` -- must return empty (zero results)

2. **Dockerfile template defaults to false:**
   `grep "ARG WITH_GITLEAKS" src/aishell/docker/templates.clj` -- must show `=false`

3. **CLI spec uses positive flag:**
   `grep ":with-gitleaks" src/aishell/cli.clj | head -1` -- must show `:with-gitleaks {:coerce :boolean`

4. **Default value logic is correct:**
   `grep "boolean (:with-gitleaks" src/aishell/cli.clj` -- must show `(boolean (:with-gitleaks opts))`

5. **Help order uses new flag:**
   `grep ":order" src/aishell/cli.clj | head -2` -- must show `:with-gitleaks` (not `:without-gitleaks`)

6. **State defaults changed:**
   `grep "with-gitleaks state" src/aishell/cli.clj` -- both occurrences must show `state false)` not `state true)`

7. **Filename detection unchanged (PIPE-02):**
   No files in src/aishell/detection/ should be modified. Verify with:
   `git diff --name-only src/aishell/detection/` -- must be empty

8. **Run pipeline unchanged (PIPE-01):**
   No files in src/aishell/run.clj should be modified. Verify with:
   `git diff --name-only src/aishell/run.clj` -- must be empty
</verification>

<success_criteria>
- BUILD-01: `--with-gitleaks` flag enables Gitleaks installation -- setup-spec has `:with-gitleaks {:coerce :boolean}` and handle-setup reads it with `(boolean (:with-gitleaks opts))`
- BUILD-02: Gitleaks NOT installed by default -- ARG WITH_GITLEAKS=false in Dockerfile template, `(boolean nil)` returns false
- HELP-01: `aishell gitleaks` hidden from --help when not installed -- installed-harnesses defaults to false when key absent from state
- PIPE-01: Gitleaks staleness warning skipped when not installed -- no changes to run.clj needed (already conditional on gitleaks command dispatch)
- PIPE-02: Filename-based detection continues to work -- no changes to detection/ namespace (verified by git diff)
</success_criteria>

<output>
After completion, create `.planning/phases/44-flip-gitleaks-default/44-01-SUMMARY.md`
</output>
