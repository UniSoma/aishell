---
phase: 02-git-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [aishell, entrypoint.sh]
autonomous: true

must_haves:
  truths:
    - "User can run git config user.name in container and see their host identity"
    - "User can run git config user.email in container and see their host email"
    - "User can run git status without dubious ownership errors"
    - "Git commits made in container have correct author name and email"
  artifacts:
    - path: "aishell"
      provides: "Git identity reading and environment variable passing"
      contains: "GIT_AUTHOR_NAME"
    - path: "entrypoint.sh"
      provides: "Git safe.directory configuration"
      contains: "safe.directory"
  key_links:
    - from: "aishell"
      to: "docker run"
      via: "GIT_AUTHOR_* and GIT_COMMITTER_* environment variables"
      pattern: "GIT_AUTHOR_NAME.*GIT_AUTHOR_EMAIL.*GIT_COMMITTER_NAME.*GIT_COMMITTER_EMAIL"
    - from: "entrypoint.sh"
      to: "git config --global"
      via: "safe.directory configuration"
      pattern: "git config --global.*safe\\.directory"
---

<objective>
Add git identity propagation and safe directory configuration so users can make commits inside the container with their host identity and without ownership warnings.

Purpose: Complete GIT-01 and GIT-02 requirements, enabling seamless git workflows inside the container.
Output: Modified aishell and entrypoint.sh with git integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-git-integration/02-RESEARCH.md
@.planning/phases/02-git-integration/02-CONTEXT.md
@.planning/phases/01-core-container-foundation/01-02-SUMMARY.md
@aishell
@entrypoint.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add git identity reading and environment variable passing to aishell</name>
  <files>aishell</files>
  <action>
Modify aishell to read git identity from the host and pass it to the container as environment variables.

Add a function `read_git_identity()` that:
1. Checks if git is installed on host (`command -v git`)
2. If git exists, reads effective config from project directory using `git -C "$project_dir" config user.name` and `git -C "$project_dir" config user.email` (this respects local .git/config overrides)
3. Returns empty strings if git not installed or values not set

In `main()`, after setting `project_dir`:
1. Call `read_git_identity` to get name and email
2. If either name or email is empty, call `warn "Git identity not found on host"` (per CONTEXT.md: simple warning, shows in normal mode)
3. If BOTH name and email are set (non-empty), add these environment variables to the docker run command:
   - `-e "GIT_AUTHOR_NAME=$git_name"`
   - `-e "GIT_AUTHOR_EMAIL=$git_email"`
   - `-e "GIT_COMMITTER_NAME=$git_name"`
   - `-e "GIT_COMMITTER_EMAIL=$git_email"`

IMPORTANT: Only pass the environment variables if BOTH values are non-empty. Empty env vars would override git config with empty strings (Pitfall 5 from RESEARCH.md).

Add verbose output showing the git identity being used.

The docker run command should use a bash array for clean argument building (already established pattern).
  </action>
  <verify>
Run `./aishell -v` and verify verbose output shows git identity.
Run `./aishell` and inside container run `echo $GIT_AUTHOR_NAME $GIT_AUTHOR_EMAIL` - should show host values.
Run `git config user.name` and `git config user.email` inside container - should return host values.
  </verify>
  <done>
Git identity environment variables passed to container when host has git configured.
Warning shown when git identity not found on host.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add safe.directory configuration to entrypoint.sh</name>
  <files>entrypoint.sh</files>
  <action>
Modify entrypoint.sh to configure git safe.directory for the mounted project path.

After the home directory creation block (after `chown "$USER_ID:$GROUP_ID" "$HOME"`), add:

```bash
# Configure git safe.directory to trust the mounted project path (GIT-02)
# PWD is set by docker run -w flag
if [ -n "$PWD" ]; then
    git config --global --add safe.directory "$PWD"
fi
```

This MUST be:
1. After home directory exists (git config --global needs $HOME/.gitconfig writable)
2. Before exec gosu (runs as root, can write to the gitconfig that will be owned by user)

The home directory is already created with correct ownership before this point, so git config will write to the correct location.
  </action>
  <verify>
Run `./aishell` and inside container:
1. `git status` - should work without "dubious ownership" error
2. `cat ~/.gitconfig` - should contain `safe.directory = /path/to/project`
  </verify>
  <done>
Git recognizes mounted project directory as safe.
No "dubious ownership" errors when running git commands.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full git integration</name>
  <files></files>
  <action>
Verify the complete git integration works end-to-end:

1. Exit any existing container
2. Run `./aishell` from a git repository on the host
3. Inside the container, verify:
   - `git config user.name` returns the host user's name
   - `git config user.email` returns the host user's email
   - `git status` works without errors
   - Create a test commit (if safe to do so in the project):
     ```bash
     echo "test" > /tmp/test-file
     git add /tmp/test-file 2>/dev/null || echo "Not in worktree (expected)"
     ```
   - Verify commit authorship would be correct by checking:
     ```bash
     git log --format="%an <%ae>" -1 HEAD
     ```
     The format should match what `git config user.name` and `git config user.email` return.

The test does NOT need to actually make a commit to the repository - just verify the configuration is correct.
  </action>
  <verify>
All three success criteria from roadmap are met:
1. `git config user.name` and `git config user.email` return host values
2. `git status` shows no "dubious ownership" errors
3. Git commit authorship would be correct (config matches host)
  </verify>
  <done>
GIT-01 and GIT-02 requirements complete.
Phase 2 success criteria verified.
  </done>
</task>

</tasks>

<verification>
## Phase Verification

After all tasks complete:

```bash
# Outside container
./aishell -v  # Should show git identity in verbose output

# Inside container
git config user.name    # Should return host value
git config user.email   # Should return host value
git status              # Should work without errors
cat ~/.gitconfig        # Should contain safe.directory entry
echo "$GIT_AUTHOR_NAME <$GIT_AUTHOR_EMAIL>"  # Should show correct identity
```
</verification>

<success_criteria>
1. Running `git config user.name` and `git config user.email` in container returns host values
2. Running `git status` in mounted project shows no "dubious ownership" errors
3. Git commits made in container would have correct author name and email (verified via config)
</success_criteria>

<output>
After completion, create `.planning/phases/02-git-integration/02-01-SUMMARY.md`

Include in summary:
- Confirmation that GIT-01 and GIT-02 requirements are complete
- Any edge cases discovered (git not installed, no identity configured)
- Files modified with line count changes
</output>
