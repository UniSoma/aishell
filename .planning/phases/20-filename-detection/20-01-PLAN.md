---
phase: 20-filename-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/detection/patterns.clj
  - src/aishell/detection/core.clj
  - src/aishell/detection/formatters.clj
autonomous: true

must_haves:
  truths:
    - "User sees medium warning when .env file exists in project"
    - "User sees medium warning when .env.local, .env.production, or .envrc exist"
    - "User sees low-severity info when .env.example or .env.sample exist"
    - "When >3 env files match, output shows summary with count instead of individual files"
  artifacts:
    - path: "src/aishell/detection/patterns.clj"
      provides: "Pattern detection functions and grouping logic"
      exports: ["detect-env-files", "group-findings"]
    - path: "src/aishell/detection/core.clj"
      provides: "scan-project calling pattern detectors"
      contains: "patterns/detect-env-files"
    - path: "src/aishell/detection/formatters.clj"
      provides: "Summary format support for grouped findings"
      contains: "summary?"
  key_links:
    - from: "src/aishell/detection/core.clj"
      to: "src/aishell/detection/patterns.clj"
      via: "require and function calls in scan-project"
      pattern: "patterns/detect-env-files"
---

<objective>
Implement environment file detection (.env variants) with threshold-based grouping

Purpose: Users are warned about .env files that may contain secrets before AI agents access them
Output: Working env file detection integrated into scan-project with <=3 individual / >3 summary display
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-filename-detection/20-CONTEXT.md
@.planning/phases/20-filename-detection/20-RESEARCH.md
@.planning/phases/19-core-detection-framework/19-01-SUMMARY.md
@src/aishell/detection/core.clj
@src/aishell/detection/formatters.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create patterns.clj with env file detection and grouping</name>
  <files>src/aishell/detection/patterns.clj</files>
  <action>
Create new patterns.clj namespace with:

1. Helper functions:
   - `in-excluded-dir?` - reuse logic from core.clj (check path against excluded-dirs)
   - `case-insensitive-basename-match?` - compare fs/file-name lowercased to pattern

2. `detect-env-files` function:
   - Takes project-dir and excluded-dirs as args
   - Uses fs/glob with "**" pattern and {:hidden true}
   - Filters out excluded directories
   - Matches files where name is ".env" OR starts with ".env." OR equals ".envrc" (case-insensitive)
   - Classifies as :env-template (low severity) if name contains "example" or "sample"
   - Otherwise classifies as :env-file (medium severity)
   - Returns vector of findings: {:path :type :severity :reason}

3. `group-findings` function (threshold-of-3):
   - Groups findings by :type
   - If count <= 3, returns findings as-is
   - If count > 3, returns single summary finding with:
     - :summary? true
     - :sample-paths (first 2 paths)
     - :reason like "15 files detected"
     - Same :type and :severity as group

Use require:
```clojure
(:require [babashka.fs :as fs]
          [clojure.string :as str])
```

Reason strings:
- :env-file -> "Environment configuration file"
- :env-template -> "Environment template file"
  </action>
  <verify>
```bash
cd /home/jonasrodrigues/projects/harness && bb -e "(require '[aishell.detection.patterns :as p]) (println (p/detect-env-files \".\" #{\"node_modules\" \".git\"}))"
```
Should load without error and return a vector (empty or with findings depending on project state).
  </verify>
  <done>
patterns.clj exists with detect-env-files and group-findings functions that correctly identify .env variants and apply threshold-of-3 grouping.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update formatters.clj for summary display and integrate patterns into core.clj</name>
  <files>src/aishell/detection/formatters.clj, src/aishell/detection/core.clj</files>
  <action>
**formatters.clj changes:**

Update the default format-finding method to handle summary findings:
- Check for :summary? key
- If summary: format as "  SEVERITY N files detected (e.g., .env, .env.local)"
  - Use (fs/file-name) to extract just filename from sample-paths
  - Only show sample-paths if present
- If not summary: keep existing individual format "  SEVERITY path - reason"

Add require for babashka.fs if needed for file-name extraction.

**core.clj changes:**

1. Add require for patterns namespace:
   ```clojure
   [aishell.detection.patterns :as patterns]
   ```

2. Replace placeholder scan-project with actual implementation:
   ```clojure
   (defn scan-project
     "Scan project directory for sensitive files.
      Returns vector of findings: [{:path :type :severity :reason}]"
     [project-dir]
     (let [env-findings (patterns/detect-env-files project-dir excluded-dirs)]
       (patterns/group-findings env-findings)))
   ```

3. Keep excluded-dirs and all other existing functions unchanged.
  </action>
  <verify>
```bash
cd /home/jonasrodrigues/projects/harness && bb -e "
(require '[aishell.detection.core :as core])
(require '[aishell.detection.formatters :as fmt])

;; Test scan returns findings (or empty if no .env files)
(let [findings (core/scan-project \".\")]
  (println \"Findings:\" (count findings))
  (doseq [f findings]
    (println (fmt/format-finding f))))
"
```
Should display any .env files found with proper formatting (individual or summary).
  </verify>
  <done>
scan-project calls detect-env-files and applies grouping. Formatter handles both individual and summary findings correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test end-to-end with mock .env files</name>
  <files>None (verification only)</files>
  <action>
Create temporary test scenario and verify detection works:

1. Create test directory with various .env files:
   ```bash
   mkdir -p /tmp/aishell-test-20
   touch /tmp/aishell-test-20/.env
   touch /tmp/aishell-test-20/.env.local
   touch /tmp/aishell-test-20/.env.production
   touch /tmp/aishell-test-20/.env.example
   touch /tmp/aishell-test-20/.envrc
   ```

2. Run detection and verify output:
   - .env, .env.local, .env.production, .envrc -> medium severity
   - .env.example -> low severity
   - With 5 files, some should be grouped if same type

3. Test threshold-of-3 by adding more files:
   ```bash
   touch /tmp/aishell-test-20/.env.staging
   touch /tmp/aishell-test-20/.env.test
   ```
   Now 6 env-file type files -> should show summary "6 files detected"

4. Clean up:
   ```bash
   rm -rf /tmp/aishell-test-20
   ```

5. Verify display-warnings output format looks correct with grouped findings.
  </action>
  <verify>
Full end-to-end test with bb script showing:
- Individual files when <= 3
- Summary with count when > 3
- Correct severity colors (medium=yellow, low=dim)
- Proper path display
  </verify>
  <done>
Detection correctly identifies all .env variants, applies threshold-of-3 grouping, and displays with appropriate severity formatting.
  </done>
</task>

</tasks>

<verification>
Requirements covered by this plan:
- ENVF-01: .env files detected with medium severity
- ENVF-02: .env.local, .env.production, .envrc detected with medium severity
- ENVF-03: .env.example, .env.sample detected with low severity

CONTEXT.md decisions implemented:
- Threshold-of-3 grouping (individual if <=3, summary if >3)
- Case-insensitive matching
- Hidden files included
- Excluded directories honored (node_modules, .git, etc.)
</verification>

<success_criteria>
1. `bb -e "(require '[aishell.detection.core]) (aishell.detection.core/scan-project \"/tmp/aishell-test-20\")"` returns findings for .env files
2. Medium severity for actual env files, low severity for template files
3. When >3 files of same type, output shows summary instead of individual lines
4. All namespaces load without error
</success_criteria>

<output>
After completion, create `.planning/phases/20-filename-detection/20-01-SUMMARY.md`
</output>
