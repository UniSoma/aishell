---
phase: 20-filename-detection
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/aishell/detection/patterns.clj
  - src/aishell/detection/core.clj
autonomous: true

must_haves:
  truths:
    - "User sees high warning when id_rsa, id_dsa, id_ed25519, id_ecdsa, or *.ppk files exist"
    - "User sees high warning when *.p12, *.pfx, *.jks, *.keystore files exist"
    - "User sees medium warning when *.pem or *.key files exist"
    - "All pattern types apply threshold-of-3 grouping consistently"
  artifacts:
    - path: "src/aishell/detection/patterns.clj"
      provides: "SSH key, key container, and PEM/key file detectors"
      exports: ["detect-ssh-keys", "detect-key-containers", "detect-pem-key-files"]
    - path: "src/aishell/detection/core.clj"
      provides: "scan-project calling all pattern detectors"
      contains: "patterns/detect-ssh-keys"
  key_links:
    - from: "src/aishell/detection/core.clj"
      to: "src/aishell/detection/patterns.clj"
      via: "concat of all detection results in scan-project"
      pattern: "(concat.*detect-env-files.*detect-ssh-keys.*detect-key-containers.*detect-pem-key-files)"
---

<objective>
Add SSH key, key container, and PEM/key file detection to complete Phase 20

Purpose: Users are warned about cryptographic key files before AI agents can access them
Output: Complete filename-based detection covering all Phase 20 requirements (PKEY-02, PKEY-03, PKEY-04)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-filename-detection/20-CONTEXT.md
@.planning/phases/20-filename-detection/20-RESEARCH.md
@.planning/phases/20-filename-detection/20-01-SUMMARY.md
@src/aishell/detection/patterns.clj
@src/aishell/detection/core.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SSH key and key container detection to patterns.clj</name>
  <files>src/aishell/detection/patterns.clj</files>
  <action>
Add three new detection functions to patterns.clj:

1. `detect-ssh-keys` function:
   - Takes project-dir and excluded-dirs
   - Uses fs/glob with "**" and {:hidden true}
   - Filters excluded directories
   - Matches exact filenames (case-insensitive): id_rsa, id_dsa, id_ed25519, id_ecdsa
   - Also matches *.ppk files (PuTTY keys) - use separate glob for "**/*.ppk"
   - Returns findings with :type :ssh-key, :severity :high
   - Reason: "SSH private key file"

2. `detect-key-containers` function:
   - Takes project-dir and excluded-dirs
   - Uses multiple globs for extensions: "**/*.p12", "**/*.pfx", "**/*.jks", "**/*.keystore"
   - Case-insensitive: also check uppercase variants or use post-filter
   - Filters excluded directories
   - Returns findings with :type :key-container, :severity :high
   - Reason: "Key container file (PKCS12/JKS)"

3. `detect-pem-key-files` function:
   - Takes project-dir and excluded-dirs
   - Uses globs: "**/*.pem", "**/*.key"
   - Filters excluded directories
   - Returns findings with :type :pem-key, :severity :medium
   - Reason: "PEM/key file (may contain private key or certificate)"

Note: For glob patterns with extensions (*.ppk, *.p12), case-sensitivity matters less because extensions are usually lowercase. But for safety, could post-filter with lower-case comparison.
  </action>
  <verify>
```bash
cd /home/jonasrodrigues/projects/harness && bb -e "
(require '[aishell.detection.patterns :as p])
;; Verify functions exist and are callable
(println \"detect-ssh-keys:\" (fn? p/detect-ssh-keys))
(println \"detect-key-containers:\" (fn? p/detect-key-containers))
(println \"detect-pem-key-files:\" (fn? p/detect-pem-key-files))
"
```
All three functions should exist and be callable.
  </verify>
  <done>
patterns.clj has detect-ssh-keys, detect-key-containers, and detect-pem-key-files functions that return correctly typed findings with appropriate severity.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update scan-project to call all detectors</name>
  <files>src/aishell/detection/core.clj</files>
  <action>
Update scan-project in core.clj to call all four detectors:

```clojure
(defn scan-project
  "Scan project directory for sensitive files.
   Returns vector of findings: [{:path :type :severity :reason}]"
  [project-dir]
  (let [all-findings (concat
                       (patterns/detect-env-files project-dir excluded-dirs)
                       (patterns/detect-ssh-keys project-dir excluded-dirs)
                       (patterns/detect-key-containers project-dir excluded-dirs)
                       (patterns/detect-pem-key-files project-dir excluded-dirs))]
    (patterns/group-findings all-findings)))
```

This:
1. Collects findings from all four detectors
2. Applies threshold-of-3 grouping per type
3. Returns grouped/individual findings for display
  </action>
  <verify>
```bash
cd /home/jonasrodrigues/projects/harness && bb -e "
(require '[aishell.detection.core :as core])
(let [findings (core/scan-project \".\")]
  (println \"Total findings (grouped):\" (count findings))
  (doseq [f findings]
    (println \"  -\" (:type f) (:severity f))))
"
```
Should show any findings from the project directory with correct types and severities.
  </verify>
  <done>
scan-project calls all four pattern detectors and returns combined, grouped findings.
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-end verification with test files</name>
  <files>None (verification only)</files>
  <action>
Create comprehensive test scenario:

1. Create test directory with all file types:
   ```bash
   mkdir -p /tmp/aishell-test-20-02

   # Env files (from Plan 01 - still works)
   touch /tmp/aishell-test-20-02/.env
   touch /tmp/aishell-test-20-02/.env.local

   # SSH keys (high severity)
   touch /tmp/aishell-test-20-02/id_rsa
   touch /tmp/aishell-test-20-02/id_ed25519
   touch /tmp/aishell-test-20-02/backup.ppk

   # Key containers (high severity)
   touch /tmp/aishell-test-20-02/cert.p12
   touch /tmp/aishell-test-20-02/keystore.jks

   # PEM/key files (medium severity)
   touch /tmp/aishell-test-20-02/server.pem
   touch /tmp/aishell-test-20-02/private.key
   ```

2. Run full detection:
   ```bash
   bb -e "
   (require '[aishell.detection.core :as core])
   (require '[aishell.detection.formatters :as fmt])
   (let [findings (core/scan-project \"/tmp/aishell-test-20-02\")]
     (core/display-warnings findings))
   "
   ```

3. Verify output shows:
   - High severity (red): SSH keys, key containers
   - Medium severity (yellow): env files, PEM/key files
   - Proper grouping if >3 of same type

4. Clean up:
   ```bash
   rm -rf /tmp/aishell-test-20-02
   ```
  </action>
  <verify>
End-to-end output shows:
- "Sensitive files detected in project directory" header
- HIGH labels for id_rsa, id_ed25519, backup.ppk, cert.p12, keystore.jks
- MEDIUM labels for .env, .env.local, server.pem, private.key
- Correct reason text for each type
- Grouping applied if >3 of same type
  </verify>
  <done>
Phase 20 complete: All filename patterns detected with correct severity, grouping works across all types, display output is clear and properly formatted.
  </done>
</task>

</tasks>

<verification>
Requirements covered by this plan:
- PKEY-02: SSH key files (id_rsa, id_dsa, id_ed25519, id_ecdsa, *.ppk) - high severity
- PKEY-03: Key container files (*.p12, *.pfx, *.jks, *.keystore) - high severity
- PKEY-04: PEM/key files (*.pem, *.key) - medium severity

Combined with Plan 01, Phase 20 covers:
- ENVF-01, ENVF-02, ENVF-03 (env files)
- PKEY-02, PKEY-03, PKEY-04 (key files by filename)

All Phase 20 Success Criteria from ROADMAP.md:
1. User sees medium warning when .env file exists in project - Plan 01
2. User sees medium warning when .env.local, .env.production, or .envrc exist - Plan 01
3. User sees low-severity info when .env.example or .env.sample exist - Plan 01
4. User sees high warning when id_rsa, id_dsa, id_ed25519, id_ecdsa, or *.ppk files exist - THIS PLAN
5. User sees high warning when *.p12, *.pfx, *.jks, *.keystore files exist - THIS PLAN
</verification>

<success_criteria>
1. `aishell claude` in project with id_rsa shows HIGH warning before container
2. `aishell claude` in project with server.p12 shows HIGH warning before container
3. `aishell claude` in project with cert.pem shows MEDIUM warning before container
4. All detection happens before Docker command runs
5. Threshold-of-3 grouping works consistently for all file types
</success_criteria>

<output>
After completion, create `.planning/phases/20-filename-detection/20-02-SUMMARY.md`
</output>
