---
phase: 47-state-config-schema-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/cli.clj
  - src/aishell/state.clj
  - src/aishell/config.clj
autonomous: true

must_haves:
  truths:
    - "--with-tmux flag is not recognized by aishell setup (triggers Unknown option error)"
    - "aishell setup --help output contains zero tmux references"
    - "State schema docstring documents v3.0.0 with no :with-tmux or :tmux-plugins keys"
    - "Config validation treats tmux: as unknown key (triggers warning)"
    - "parse-resurrect-config and validate-tmux-config functions are deleted"
    - "handle-setup builds state-map without :with-tmux, :tmux-plugins, or :resurrect-config"
    - "handle-update does not display tmux status or check :with-tmux for harnesses-enabled?"
  artifacts:
    - path: "src/aishell/cli.clj"
      provides: "CLI without tmux flag, help, handler logic"
      contains: "setup-spec without :with-tmux"
    - path: "src/aishell/state.clj"
      provides: "State schema docstring for v3.0.0"
      contains: "State schema (v3.0.0)"
    - path: "src/aishell/config.clj"
      provides: "Config validation without tmux"
      contains: "known-keys without :tmux"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/config.clj"
      via: "handle-setup no longer calls config/parse-resurrect-config"
      pattern: "parse-resurrect-config should NOT appear in cli.clj"
    - from: "src/aishell/config.clj"
      to: "validate-config"
      via: "validate-config no longer calls validate-tmux-config"
      pattern: "validate-tmux-config should NOT appear in validate-config"
---

<objective>
Remove all tmux-related flags, state keys, and config schema from aishell's CLI, state persistence, and configuration validation. This is the second phase of v3.0.0 (Docker-native attach), cleaning up the configuration surface after Phase 46 removed the tmux binary from the foundation image.

Purpose: Make the CLI, state, and config schemas reflect reality -- tmux is gone from the container, so all references to it in the configuration surface must be removed. Satisfies requirements TMUX-02 (--with-tmux flag), TMUX-03 (:with-tmux/:tmux-plugins state keys), and TMUX-08 (tmux: config section).

Output: Three modified Clojure source files with all tmux references removed from CLI spec, help text, handler logic, state schema docstring, and config validation/merge logic.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-state-config-schema-cleanup/47-RESEARCH.md
@src/aishell/cli.clj
@src/aishell/state.clj
@src/aishell/config.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove tmux from CLI spec, help text, and handler logic</name>
  <files>src/aishell/cli.clj</files>
  <action>
Remove all tmux references from src/aishell/cli.clj. This is pure deletion -- no new code needed.

1. **setup-spec** (line 75): Remove the `:with-tmux` entry entirely:
   ```
   :with-tmux     {:coerce :boolean :desc "Enable tmux multiplexer in container"}
   ```

2. **print-setup-help** (line 142): Remove `:with-tmux` from the `:order` vector in `cli/format-opts`:
   ```
   ;; BEFORE: :order [:with-claude :with-opencode :with-codex :with-gemini :with-tmux :with-gitleaks :force :verbose :help]
   ;; AFTER:  :order [:with-claude :with-opencode :with-codex :with-gemini :with-gitleaks :force :verbose :help]
   ```

3. **print-setup-help** (line 150): Remove the manual tmux example line entirely:
   ```
   (println (str "  " output/CYAN "aishell setup --with-claude --with-tmux" output/NC "  Include Claude + tmux"))
   ```

4. **handle-setup** (line 165): Remove `with-tmux` binding:
   ```
   with-tmux (boolean (:with-tmux opts))
   ```

5. **handle-setup state-map** (lines 191-206): Remove three keys from state-map:
   - `:with-tmux with-tmux`
   - `:tmux-plugins (when with-tmux ...)` (the entire block with plugins, resurrect-val, resurrect-cfg, etc.)
   - `:resurrect-config (when with-tmux ...)`

6. **handle-setup harness-enabled?** (line 212): Remove `:with-tmux` from the `some` check:
   ```
   ;; BEFORE: (some #(get state-map %) [:with-claude :with-opencode :with-codex :with-gemini :with-tmux])
   ;; AFTER:  (some #(get state-map %) [:with-claude :with-opencode :with-codex :with-gemini])
   ```

7. **handle-update** (lines 311-312): Remove the tmux status display:
   ```
   (when (:with-tmux state)
     (println "  tmux: enabled"))
   ```

8. **handle-update harnesses-enabled?** (line 329): Remove `:with-tmux` from the `some` check:
   ```
   ;; BEFORE: (some #(get state %) [:with-claude :with-opencode :with-codex :with-gemini :with-tmux])
   ;; AFTER:  (some #(get state %) [:with-claude :with-opencode :with-codex :with-gemini])
   ```

IMPORTANT: Do NOT modify attach command help text or dispatch logic in this phase -- Phase 50 will rewrite attach.clj comprehensively.
  </action>
  <verify>
Run these checks:
1. `grep -n "with-tmux\|with_tmux\|tmux-plugins\|tmux_plugins\|resurrect-config\|parse-resurrect-config" src/aishell/cli.clj` -- should return NO matches
2. `grep -n ":with-tmux" src/aishell/cli.clj` -- should return NO matches
3. `grep -c "tmux" src/aishell/cli.clj` -- count remaining tmux references (should only be in attach help text which is Phase 50 scope)
  </verify>
  <done>
setup-spec has no :with-tmux key. print-setup-help :order has no :with-tmux. No tmux example in help. handle-setup does not parse with-tmux opt, does not build :with-tmux/:tmux-plugins/:resurrect-config in state-map, does not check :with-tmux in harness-enabled?. handle-update does not display tmux status or check :with-tmux in harnesses-enabled?. Only remaining "tmux" in cli.clj is attach command help text (Phase 50 scope).
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove tmux from state schema and config validation</name>
  <files>src/aishell/state.clj, src/aishell/config.clj</files>
  <action>
Remove all tmux references from state.clj and config.clj. Pure deletion.

**In src/aishell/state.clj:**

1. **write-state docstring** (line 25): Change version from `v2.8.0` to `v3.0.0`
2. **write-state docstring** (line 31): Remove the `:with-tmux false` line entirely:
   ```
   :with-tmux false             ; boolean (whether tmux enabled, default false)
   ```
3. Also remove the DEPRECATED `:dockerfile-hash` line from the docstring (it was kept for v2.7.0 compat but we're in v3.0.0 now -- the key is still written in code for backward compat, just remove from docstring as it's deprecated).

**In src/aishell/config.clj:**

1. **known-keys** (line 11): Remove `:tmux` from the set:
   ```
   ;; BEFORE: #{:mounts :env :ports :docker_args :pre_start :extends :harness_args :gitleaks_freshness_check :detection :tmux}
   ;; AFTER:  #{:mounts :env :ports :docker_args :pre_start :extends :harness_args :gitleaks_freshness_check :detection}
   ```

2. **validate-config warning message** (line 180): Remove "tmux" from the valid keys string:
   ```
   ;; BEFORE: "\nValid keys: mounts, env, ports, docker_args, pre_start, extends, harness_args, detection, tmux"
   ;; AFTER:  "\nValid keys: mounts, env, ports, docker_args, pre_start, extends, harness_args, detection"
   ```

3. **validate-config body** (lines 185-186): Remove the tmux validation call:
   ```
   (when-let [tmux (:tmux config)]
     (validate-tmux-config tmux source-path))
   ```

4. **Delete parse-resurrect-config function** (lines 108-136): Remove the entire function. It is ONLY called from cli.clj handle-setup (which Task 1 already removed) and from validate-tmux-config (which we're also deleting).

5. **Delete validate-tmux-config function** (lines 138-169): Remove the entire function. It is ONLY called from validate-config (which we're removing the call from above).

6. **merge-configs scalar-keys** (line 232): Remove `:tmux` from scalar-keys set:
   ```
   ;; BEFORE: scalar-keys #{:pre_start :gitleaks_freshness_check :tmux}
   ;; AFTER:  scalar-keys #{:pre_start :gitleaks_freshness_check}
   ```

7. **Delete plugin-format-pattern** (lines 17-21): This regex is ONLY used by validate-plugin-format which is ONLY called by validate-tmux-config. With validate-tmux-config deleted, both become dead code. Remove the def and the validate-plugin-format function (lines 74-79).

NOTE: The validate-plugin-format function (lines 74-79) is called ONLY from validate-tmux-config. With validate-tmux-config removed, validate-plugin-format becomes dead code. Delete it along with plugin-format-pattern.
  </action>
  <verify>
Run these checks:
1. `grep -n "tmux\|resurrect\|plugin-format-pattern\|validate-plugin-format" src/aishell/config.clj` -- should return NO matches
2. `grep -n "with-tmux\|tmux" src/aishell/state.clj` -- should return NO matches
3. `grep -n "v3.0.0" src/aishell/state.clj` -- should show the version bump in docstring
4. Verify no orphaned references: `grep -rn "parse-resurrect-config\|validate-tmux-config\|validate-plugin-format\|plugin-format-pattern" src/aishell/` -- should only match attach.clj or run.clj if at all (not cli.clj, config.clj, or state.clj)
  </verify>
  <done>
state.clj docstring shows v3.0.0 schema with no :with-tmux line. config.clj known-keys has no :tmux. validate-tmux-config and parse-resurrect-config functions are deleted. validate-plugin-format and plugin-format-pattern are deleted. validate-config does not call validate-tmux-config. merge-configs scalar-keys has no :tmux. Valid keys warning message does not include tmux.
  </done>
</task>

</tasks>

<verification>
After both tasks, verify the complete cleanup:

1. **Grep all source files for tmux schema references:**
   ```bash
   grep -rn "with-tmux\|tmux-plugins\|resurrect-config\|parse-resurrect-config\|validate-tmux-config" src/aishell/cli.clj src/aishell/state.clj src/aishell/config.clj
   ```
   Expected: NO matches in any of these three files.

2. **Verify config.clj compiles (no orphaned references):**
   ```bash
   grep -n "validate-plugin-format\|plugin-format-pattern" src/aishell/config.clj
   ```
   Expected: NO matches.

3. **Count remaining tmux references in entire codebase:**
   ```bash
   grep -rn "tmux" src/aishell/ --include="*.clj"
   ```
   Expected: Only matches in attach.clj, run.clj, and docker/ files (Phase 48-50 scope). Zero matches in cli.clj setup/update handlers, state.clj, or config.clj.

4. **Verify phase success criteria from ROADMAP.md:**
   - `--with-tmux` flag removed from build command: Confirmed by absence from setup-spec
   - `:with-tmux` and `:tmux-plugins` absent from state schema: Confirmed by state.clj docstring
   - `tmux:` section absent from config.yaml schema: Confirmed by config.clj known-keys
   - Build command help output shows no tmux options: Confirmed by print-setup-help cleanup
</verification>

<success_criteria>
- src/aishell/cli.clj: setup-spec has no :with-tmux, help has no tmux, handlers have no tmux logic
- src/aishell/state.clj: docstring says v3.0.0, no :with-tmux line
- src/aishell/config.clj: no :tmux in known-keys, no validate-tmux-config, no parse-resurrect-config, no validate-plugin-format, no plugin-format-pattern
- grep for tmux in these 3 files returns only attach-related help text in cli.clj (Phase 50 scope)
- Requirements TMUX-02, TMUX-03, TMUX-08 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/47-state-config-schema-cleanup/47-01-SUMMARY.md`
</output>
