---
phase: 23-context-config
plan: 03
title: Fix UAT gaps - custom pattern severity and allowlist filtering
type: gap_closure
source: 23-UAT.md
---

# Plan 23-03: Fix UAT Gaps

**Goal:** Fix 2 bugs found during UAT verification

## Gap 1: Custom pattern severity ignored

**Root cause:** `detect-custom-patterns` in patterns.clj assumes `opts` is always a map, but shorthand YAML syntax `"*.frubas": high` passes a string.

**Fix:** Check if `opts` is a map before extracting `:severity`; if string/keyword, use it directly.

**File:** `src/aishell/detection/patterns.clj`
**Location:** Line ~281 in `detect-custom-patterns`

**Current:**
```clojure
severity (keyword (or (:severity opts) "medium"))
```

**Fixed:**
```clojure
severity (keyword (cond
                    (map? opts) (or (:severity opts) "medium")
                    (keyword? opts) (name opts)
                    :else (str opts)))
```

## Gap 2: Allowlist silences all warnings

**Root cause:** `file-allowlisted?` doesn't guard against nil file paths. Summary findings have `:path nil`, which causes incorrect match.

**Fix:** Add early return when `file-path` is nil.

**File:** `src/aishell/detection/core.clj`
**Location:** `file-allowlisted?` function

**Add at start of function:**
```clojure
(when (nil? file-path)
  (return false))  ;; Summary findings should never be allowlisted
```

Or use if-let pattern to guard the whole function.

## Tasks

1. **Fix custom pattern severity extraction** - Handle shorthand YAML syntax in detect-custom-patterns
2. **Fix allowlist nil path handling** - Guard file-allowlisted? against nil paths

## Verification

After fixes, user should be able to:
1. Configure `"*.frubas": high` and see HIGH severity in output
2. Allowlist `.env` without affecting other file warnings
