---
phase: 23-context-config
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/aishell/config.clj
  - src/aishell/detection/core.clj
  - src/aishell/detection/patterns.clj
  - src/aishell/run.clj
autonomous: true

must_haves:
  truths:
    - "User can add custom_patterns in detection config and see warnings for matches"
    - "Custom patterns extend defaults (don't replace)"
    - "User can add allowlist entries to suppress specific file warnings"
    - "Allowlisted files are hidden from output entirely (not shown as 'allowed')"
    - "Global kill switch detection.enabled: false disables all filename detection"
    - "Invalid severity values in custom patterns are skipped with warning"
  artifacts:
    - path: "src/aishell/config.clj"
      provides: "Detection config parsing with merge strategy"
      contains: ":detection"
    - path: "src/aishell/detection/core.clj"
      provides: "Allowlist filtering and detection enabled check"
      contains: "allowlist"
    - path: "src/aishell/detection/patterns.clj"
      provides: "Custom pattern detection function"
      contains: "detect-custom-patterns"
    - path: "src/aishell/run.clj"
      provides: "Wiring: loads config, passes detection settings, applies filtering"
      contains: "filter-allowlisted"
  key_links:
    - from: "src/aishell/detection/core.clj"
      to: "config.clj"
      via: "load-config for detection settings"
      pattern: "config/load-config"
    - from: "src/aishell/detection/core.clj"
      to: "patterns.clj"
      via: "detect-custom-patterns call"
      pattern: "patterns/detect-custom-patterns"
    - from: "src/aishell/run.clj"
      to: "src/aishell/detection/core.clj"
      via: "scan-project and filter-allowlisted calls"
      pattern: "filter-allowlisted"
---

<objective>
Add configuration support for custom sensitive file patterns and allowlist entries, enabling users to extend detection and suppress false positives.

Purpose: Different projects have different security needs. Custom patterns let users detect project-specific sensitive files. Allowlists prevent warning fatigue from known-safe files.

Output: Extended config.clj with :detection key and merge strategy, patterns.clj with custom pattern detection, core.clj with allowlist filtering, run.clj with full integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-context-config/23-CONTEXT.md
@.planning/phases/23-context-config/23-RESEARCH.md
@.planning/phases/23-context-config/23-01-SUMMARY.md

@src/aishell/config.clj
@src/aishell/detection/core.clj
@src/aishell/detection/patterns.clj
@src/aishell/run.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add :detection config key with merge strategy</name>
  <files>src/aishell/config.clj</files>
  <action>
Extend config.clj to support the :detection key:

1. Add `:detection` to `known-keys` set

2. Create `merge-detection` function for detection-specific merging:
```clojure
(defn merge-detection
  "Custom merge for detection config.
   - enabled: project wins (scalar, use contains? for false values)
   - custom_patterns: map merge (project overrides global per-pattern)
   - allowlist: concatenate (both apply, list merge)"
  [global-detection project-detection]
  (let [enabled (cond
                  (contains? project-detection :enabled) (:enabled project-detection)
                  (contains? global-detection :enabled) (:enabled global-detection)
                  :else nil)
        patterns (merge (:custom_patterns global-detection)
                        (:custom_patterns project-detection))
        allowlist (vec (concat (:allowlist global-detection [])
                              (:allowlist project-detection [])))]
    (cond-> {}
      (some? enabled) (assoc :enabled enabled)
      (seq patterns) (assoc :custom_patterns patterns)
      (seq allowlist) (assoc :allowlist allowlist))))
```

3. In `merge-configs`, add special handling for `:detection`:
   - Before the reduce, extract detection from both configs
   - After reduce, merge detection using `merge-detection`
   - Add merged detection to result

4. Add validation for detection config:
   - Create `validate-detection-config` function
   - Warn if custom_patterns contains invalid severity (not high/medium/low)
   - Warn if allowlist entries are missing :reason field
   - Call from `validate-config`

Config structure per RESEARCH.md:
```yaml
detection:
  enabled: true  # false to disable all detection
  custom_patterns:
    "*.api-key":
      severity: high
      description: "API key files"  # optional
  allowlist:
    - path: "config/secrets.example.json"
      reason: "Example file with fake credentials"  # required
```
  </action>
  <verify>
Test in REPL:
```clojure
(require '[aishell.config :as config] :reload)

;; Create test configs
(spit "/tmp/global-test/config.yaml"
  "detection:\n  enabled: true\n  custom_patterns:\n    '*.global-key':\n      severity: high\n  allowlist:\n    - path: global.txt\n      reason: global allow")

(spit "/tmp/project-test/.aishell/config.yaml"
  "detection:\n  custom_patterns:\n    '*.project-key':\n      severity: medium\n  allowlist:\n    - path: project.txt\n      reason: project allow")

;; Verify merge produces combined patterns and allowlist
```
  </verify>
  <done>:detection key recognized, merge-detection combines patterns and allowlists correctly</done>
</task>

<task type="auto">
  <name>Task 2: Add custom pattern detection and allowlist filtering</name>
  <files>src/aishell/detection/patterns.clj, src/aishell/detection/core.clj</files>
  <action>
**In patterns.clj:**

1. Add `detect-custom-patterns` function:
```clojure
(defn detect-custom-patterns
  "Detect files matching custom glob patterns from config.
   Returns vector of findings with :custom? true marker."
  [project-dir excluded-dirs custom-patterns-map]
  (when (seq custom-patterns-map)
    (for [[pattern-str opts] custom-patterns-map
          :let [severity (keyword (or (:severity opts) "medium"))
                description (or (:description opts) "Custom pattern match")]
          :when (#{:high :medium :low} severity)  ;; Skip invalid severities
          path (fs/glob project-dir pattern-str {:hidden true})
          :when (not (in-excluded-dir? path excluded-dirs))]
      {:path (str path)
       :type :custom-pattern
       :severity severity
       :reason description
       :pattern pattern-str
       :custom? true})))
```

**In core.clj:**

2. Add require for `[aishell.config :as config]` (if not already present)

3. Modify `scan-project` to:
   - Accept optional `detection-config` parameter (or load from config)
   - Check `(:enabled detection-config true)` - if false, return []
   - Get custom_patterns from detection-config
   - Add `(patterns/detect-custom-patterns project-dir excluded-dirs custom-patterns)` to all-findings

4. Add `filter-allowlisted` function:
```clojure
(defn- file-allowlisted?
  "Check if file path matches any allowlist entry.
   Supports exact paths and glob patterns."
  [file-path allowlist project-dir]
  (when (seq allowlist)
    (let [rel-path (str (fs/relativize project-dir (fs/absolutize file-path)))]
      (some (fn [{:keys [path]}]
              (or (= path rel-path)
                  (= path (fs/file-name file-path))  ;; Allow filename-only matching
                  (fs/match rel-path (str "glob:" path))))
            allowlist))))

(defn filter-allowlisted
  "Remove findings that match allowlist entries.
   Allowlisted files are completely hidden (no 'allowed' status)."
  [findings allowlist project-dir]
  (if (seq allowlist)
    (remove #(file-allowlisted? (:path %) allowlist project-dir) findings)
    findings))
```

5. Update scan-project signature:
```clojure
(defn scan-project
  "Scan project directory for sensitive files.
   Returns vector of findings, filtered by allowlist."
  [project-dir & [detection-config]]
  ...)
```
  </action>
  <verify>
Test in REPL:
```clojure
(require '[aishell.detection.patterns :as p] '[aishell.detection.core :as core] :reload)

;; Test custom pattern detection
(p/detect-custom-patterns "." #{".git"} {"*.test-pattern" {:severity "high" :description "Test"}})

;; Test allowlist filtering
(def findings [{:path "test.txt" :severity :high :reason "test"}])
(core/filter-allowlisted findings [{:path "test.txt" :reason "allowed"}] ".")
;; Should return empty vector
```
  </verify>
  <done>Custom patterns detected with :custom? marker, filter-allowlisted removes matching files</done>
</task>

<task type="auto">
  <name>Task 3: Wire detection config into run.clj execution flow</name>
  <files>src/aishell/run.clj</files>
  <action>
In run.clj, wire the full detection config flow:

1. At the top of the shell/run flow (where project scanning happens):
   - Load config using `(config/load-config project-dir)` if not already loaded
   - Extract detection config: `(get config :detection {})`

2. Pass detection config to scan-project:
   - Find the call to `(core/scan-project project-dir ...)`
   - Change to `(core/scan-project project-dir detection-config)`
   - This enables:
     - `enabled: false` check inside scan-project
     - Custom patterns passed to detect-custom-patterns

3. Apply allowlist filtering AFTER scan-project returns:
   - Get allowlist: `(:allowlist detection-config [])`
   - Filter findings: `(core/filter-allowlisted findings allowlist project-dir)`
   - This must happen BEFORE display-warnings is called

4. The flow should be:
```clojure
(let [config (config/load-config project-dir)
      detection-config (get config :detection {})
      allowlist (:allowlist detection-config [])
      ;; scan-project checks :enabled and uses :custom_patterns
      findings (core/scan-project project-dir detection-config)
      ;; filter out allowlisted files
      filtered-findings (core/filter-allowlisted findings allowlist project-dir)]
  ;; display-warnings already gets project-dir from 23-01
  (core/display-warnings project-dir filtered-findings)
  ...)
```

5. Ensure the detection-config is accessible where needed:
   - If scan-project is called from multiple places, thread detection-config through
   - Or use a consistent pattern of loading config at entry point
  </action>
  <verify>
End-to-end test:

1. Create test config with custom pattern:
```yaml
# .aishell/config.yaml
detection:
  custom_patterns:
    "*.custom-secret":
      severity: high
      description: "Custom secret file"
```

2. Create matching file:
```bash
touch test.custom-secret
```

3. Run `aishell shell` - should show HIGH warning for test.custom-secret

4. Add to allowlist:
```yaml
detection:
  custom_patterns:
    "*.custom-secret":
      severity: high
  allowlist:
    - path: test.custom-secret
      reason: Test file for verification
```

5. Run again - test.custom-secret should NOT appear in warnings

6. Test enabled: false disables all detection:
```yaml
detection:
  enabled: false
```

7. Run - should show no sensitive file warnings at all

8. Clean up test files
  </verify>
  <done>run.clj loads detection config, passes to scan-project, applies filter-allowlisted to results before display</done>
</task>

</tasks>

<verification>
1. All namespaces load: `(require '[aishell.config :as c] '[aishell.detection.core :as d] '[aishell.detection.patterns :as p])`
2. `:detection` in config.clj known-keys
3. Global + project detection configs merge correctly (patterns merge, allowlists concat)
4. Custom patterns are detected and shown with configured severity
5. Allowlisted files completely hidden from output
6. `detection.enabled: false` disables all filename detection
7. Invalid severity in custom patterns skipped (with warning if possible)
8. Missing reason in allowlist triggers warning
9. run.clj correctly wires config -> scan-project -> filter-allowlisted -> display-warnings
</verification>

<success_criteria>
- [ ] :detection added to config.clj known-keys
- [ ] merge-detection function handles enabled/custom_patterns/allowlist merge
- [ ] validate-config warns on invalid severity and missing reason
- [ ] detect-custom-patterns function in patterns.clj
- [ ] Custom patterns produce findings with :custom? true
- [ ] filter-allowlisted removes matching files entirely
- [ ] scan-project respects detection.enabled flag
- [ ] run.clj loads config and extracts detection settings
- [ ] run.clj passes detection-config to scan-project
- [ ] run.clj calls filter-allowlisted on results before display
- [ ] All namespaces load without error
- [ ] End-to-end test: custom pattern -> warning -> allowlist -> hidden
</success_criteria>

<output>
After completion, create `.planning/phases/23-context-config/23-02-SUMMARY.md`
</output>
