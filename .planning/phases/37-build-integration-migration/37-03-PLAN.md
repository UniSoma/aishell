---
phase: 37-build-integration-migration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/extension.clj
  - src/aishell/docker/build.clj
  - src/aishell/run.clj
autonomous: true

must_haves:
  truths:
    - "Extension cache invalidation checks aishell.foundation.id label instead of aishell.base.id"
    - "Extensions with old aishell.base.id label (pre-upgrade) trigger rebuild because new label is nil"
    - "New extension builds label with aishell.foundation.id"
    - "build.clj exports foundation-image-id-label constant for consistent reference"
  artifacts:
    - path: "src/aishell/docker/extension.clj"
      provides: "Foundation-aware extension cache invalidation"
      contains: "foundation-image-id-label"
    - path: "src/aishell/docker/build.clj"
      provides: "Foundation image ID label constant"
      contains: "foundation-image-id-label"
  key_links:
    - from: "src/aishell/docker/extension.clj"
      to: "src/aishell/docker/build.clj"
      via: "foundation-image-id-label constant reference"
      pattern: "foundation-image-id-label"
    - from: "src/aishell/run.clj"
      to: "src/aishell/docker/extension.clj"
      via: "build-extended-image call with :foundation-tag parameter"
      pattern: ":foundation-tag"
---

<objective>
Update extension cache invalidation to reference foundation image ID instead of base image ID. Existing extensions auto-rebuild after upgrade because new label is absent.

Purpose: CACHE-01 requires extension tracking references foundation image ID. MIGR-02 requires existing extensions auto-rebuild on first build after upgrade (because foundation ID changed and old extensions have no aishell.foundation.id label).

Output: Updated extension.clj and build.clj with foundation-aware cache invalidation
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/aishell/docker/extension.clj
@src/aishell/docker/build.clj
@.planning/phases/37-build-integration-migration/37-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update label constants and cache invalidation logic</name>
  <files>src/aishell/docker/extension.clj, src/aishell/docker/build.clj</files>
  <action>
**In src/aishell/docker/build.clj:**

1. Rename `base-image-id-label` to `foundation-image-id-label`:
   - Change line 17: `(def base-image-id-label "aishell.base.id")` to `(def foundation-image-id-label "aishell.foundation.id")`
   - Keep the old name as a backward-compat alias: `(def base-image-id-label foundation-image-id-label)`

**In src/aishell/docker/extension.clj:**

1. Change label constant on line 15:
   - From: `(def base-image-id-label "aishell.base.id")`
   - To: `(def foundation-image-id-label "aishell.foundation.id")`

2. Update `needs-extended-rebuild?` (lines 92-130):
   - Change `stored-base-id` to read from `foundation-image-id-label` instead of `base-image-id-label`
   - The key migration behavior: when stored label is nil (old extension without aishell.foundation.id), `(not= nil current-id)` evaluates to true, triggering rebuild. This satisfies MIGR-02 naturally.
   - Replace references to `base-image-id-label` with `foundation-image-id-label`

3. Update `build-extended-image` (lines 132-174):
   - Change the `--label=` arg from `base-image-id-label` to `foundation-image-id-label`
   - Change variable name `base-id` to `foundation-id` for clarity
   - Change `:base-tag` parameter name to `:foundation-tag` in the destructuring AND the docstring
   - Keep the function otherwise identical

4. Update `get-base-image-id` function name to `get-foundation-image-id`:
   - Rename the function (line 55)
   - Update all callers within extension.clj (needs-extended-rebuild? and build-extended-image)
   - Update the docstring to say "foundation image" instead of "a given image"

5. Update the ns docstring to say "foundation image" instead of "base image" where appropriate.

**In src/aishell/run.clj:**

Update run.clj line 53 where `build-extended-image` is called with `:base-tag` to use `:foundation-tag` instead. This call is at lines 51-56 in the `resolve-effective-image` function.

Do NOT remove backward compatibility entirely -- keep `base-image-id-label` as an alias in build.clj so any other code referencing it still works.
  </action>
  <verify>
Run `bb -e '(require (quote [aishell.docker.extension]))' ` to verify namespace loads.
Run `bb -e '(require (quote [aishell.docker.build]))' ` to verify namespace loads.
Run `bb -e '(require (quote [aishell.run]))' ` to verify run.clj loads (catches parameter rename issues).

Grep for "aishell.foundation.id" in extension.clj to confirm new label.
Grep for "aishell.base.id" in extension.clj to confirm old label is gone (should find zero matches).
Grep for "foundation-image-id-label" in extension.clj to confirm new constant name used.
  </verify>
  <done>
Extension cache invalidation uses aishell.foundation.id label. Old extensions (with aishell.base.id) auto-rebuild because nil != current foundation ID (MIGR-02). New extensions label with aishell.foundation.id. build.clj exports foundation-image-id-label with backward-compat alias.
  </done>
</task>

</tasks>

<verification>
- `bb -e '(require (quote [aishell.docker.extension]))'` loads without error
- `bb -e '(require (quote [aishell.run]))'` loads without error
- extension.clj uses `foundation-image-id-label` ("aishell.foundation.id") everywhere
- extension.clj no longer has hardcoded "aishell.base.id" string
- build.clj defines `foundation-image-id-label` and `base-image-id-label` alias
- build-extended-image labels with foundation-image-id-label
- needs-extended-rebuild? checks foundation-image-id-label (nil triggers rebuild)
</verification>

<success_criteria>
Extension cache invalidation references foundation image ID (CACHE-01). Existing extensions auto-rebuild after upgrade because aishell.foundation.id label is absent, so nil != current-id triggers rebuild (MIGR-02). New extensions properly labeled with foundation ID for future cache checks.
</success_criteria>

<output>
After completion, create `.planning/phases/37-build-integration-migration/37-03-SUMMARY.md`
</output>
