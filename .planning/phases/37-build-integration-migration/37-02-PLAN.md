---
phase: 37-build-integration-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/run.clj
autonomous: true

must_haves:
  truths:
    - "Container run auto-populates harness volume if volume is missing"
    - "Container run auto-repopulates harness volume if stored hash differs from current config hash"
    - "Container run passes harness-volume-name to build-docker-args for mounting"
    - "run-exec also passes harness-volume-name for one-off command execution"
    - "v2.7.0 state files (without :harness-volume-name) work correctly by computing volume name on the fly"
  artifacts:
    - path: "src/aishell/run.clj"
      provides: "Lazy volume population pre-flight check and harness-volume-name wiring"
      contains: "ensure-harness-volume"
  key_links:
    - from: "src/aishell/run.clj"
      to: "src/aishell/docker/volume.clj"
      via: "ensure-harness-volume calls vol/compute-harness-hash, vol/volume-exists?, vol/create-volume, vol/populate-volume"
      pattern: "vol/compute-harness-hash"
    - from: "src/aishell/run.clj"
      to: "src/aishell/docker/run.clj"
      via: "harness-volume-name parameter in build-docker-args"
      pattern: ":harness-volume-name"
---

<objective>
Add lazy harness volume population to run.clj so containers auto-populate volumes on first run or when stale.

Purpose: HVOL-04 requires lazy volume population on first container run. HVOL-05 requires stale volume detection. This ensures users never need to manually manage volumes -- they auto-populate transparently.

Output: Updated run.clj with ensure-harness-volume function and harness-volume-name wiring into build-docker-args
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/aishell/run.clj
@src/aishell/docker/volume.clj
@src/aishell/docker/run.clj
@.planning/phases/37-build-integration-migration/37-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ensure-harness-volume function and wire into run-container</name>
  <files>src/aishell/run.clj</files>
  <action>
1. Add `[aishell.docker.volume :as vol]` to the ns require vector in run.clj.

2. Add a private function `ensure-harness-volume` after the `check-dockerfile-stale` function:

```clojure
(defn- ensure-harness-volume
  "Ensure harness volume exists and is up-to-date.
   Populates lazily if missing or stale (hash mismatch).
   Returns volume name for docker run mounting, or nil if no harnesses enabled."
  [state]
  (when (some #(get state %) [:with-claude :with-opencode :with-codex :with-gemini])
    (let [expected-hash (vol/compute-harness-hash state)
          volume-name (or (:harness-volume-name state)
                          (vol/volume-name expected-hash))]
      (cond
        ;; Volume missing - create and populate
        (not (vol/volume-exists? volume-name))
        (do
          (vol/create-volume volume-name {"aishell.harness.hash" expected-hash
                                          "aishell.harness.version" "2.8.0"})
          (vol/populate-volume volume-name state))

        ;; Volume exists but stale (hash mismatch or missing label)
        (not= (vol/get-volume-label volume-name "aishell.harness.hash")
              expected-hash)
        (vol/populate-volume volume-name state))
      ;; Return volume name regardless
      volume-name)))
```

Key design decisions:
- Returns nil if NO harnesses enabled (no volume needed)
- Uses `:harness-volume-name` from state if available, computes on the fly if nil (v2.7.0 compat)
- Treats missing label as stale (triggers repopulation) -- conservative approach
- Does NOT store/update state after population (build command handles that)

3. In `run-container`, add the ensure-harness-volume call and pass result to build-docker-args:

After the line `_ (output/verbose (str "Container name: " container-name-str))` and before the base image existence check, add:
```clojure
;; Ensure harness volume ready (lazy population)
harness-volume-name (ensure-harness-volume state)
```

Then update the `build-docker-args` call (around line 160) to include `:harness-volume-name harness-volume-name`.

4. In `run-exec`, add the same pattern:

After `base-tag` binding, add:
```clojure
harness-volume-name (ensure-harness-volume state)
```

Then update `build-docker-args-for-exec` call to include `:harness-volume-name harness-volume-name`.

IMPORTANT: The `check-dockerfile-stale` function currently checks `:dockerfile-hash`. Leave it unchanged for now -- it still works for backward compatibility. The foundation-hash comparison will be handled when cli.clj writes both fields (Plan 37-04).
  </action>
  <verify>
Run `bb -e '(require (quote [aishell.run]))' ` to verify the namespace loads without errors (confirms require of volume.clj works).

Grep for `ensure-harness-volume` in run.clj to confirm it exists.
Grep for `:harness-volume-name` in run.clj to confirm it's passed to build-docker-args in both run-container and run-exec.
  </verify>
  <done>
run-container and run-exec both call ensure-harness-volume before docker run. Volume auto-populates if missing or stale. harness-volume-name passed to build-docker-args for volume mounting. v2.7.0 state files handled gracefully (nil :harness-volume-name triggers on-the-fly computation).
  </done>
</task>

</tasks>

<verification>
- `bb -e '(require (quote [aishell.run]))'` loads without error
- ensure-harness-volume function exists in run.clj
- run-container passes :harness-volume-name to build-docker-args
- run-exec passes :harness-volume-name to build-docker-args-for-exec
- ensure-harness-volume returns nil when no harnesses enabled
- ensure-harness-volume calls vol/populate-volume when volume missing or stale
</verification>

<success_criteria>
Lazy volume population implemented in run.clj. Containers auto-populate harness volumes on first run (HVOL-04) with staleness detection (HVOL-05). Both run-container and run-exec pass harness-volume-name for Docker volume mounting.
</success_criteria>

<output>
After completion, create `.planning/phases/37-build-integration-migration/37-02-SUMMARY.md`
</output>
