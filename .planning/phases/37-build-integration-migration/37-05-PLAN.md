---
phase: 37-build-integration-migration
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/volume.clj
  - src/aishell/docker/templates.clj
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "OpenCode binary is installed into /tools/bin/ during volume population when --with-opencode is enabled"
    - "PATH includes /tools/bin when the directory exists, making opencode command available"
  artifacts:
    - path: "src/aishell/docker/volume.clj"
      provides: "OpenCode Go binary download in build-install-commands"
      contains: "opencode"
    - path: "src/aishell/docker/templates.clj"
      provides: "/tools/bin in PATH conditional"
      contains: "/tools/bin"
  key_links:
    - from: "src/aishell/docker/volume.clj"
      to: "/tools/bin/opencode"
      via: "curl download in build-install-commands"
      pattern: "curl.*opencode"
    - from: "src/aishell/docker/templates.clj"
      to: "PATH"
      via: "directory existence check for /tools/bin"
      pattern: "/tools/bin"
---

<objective>
Add OpenCode binary installation to harness volume population and wire /tools/bin into PATH.

Purpose: GAP-01 fix — OpenCode is a Go binary excluded from npm installation. The foundation image no longer installs harness tools, so OpenCode has zero installation path in v2.8.0. This plan adds binary download to volume population and ensures the binary is on PATH.

Output: OpenCode available in container when configured with --with-opencode.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-build-integration-migration/37-UAT.md
@src/aishell/docker/volume.clj
@src/aishell/docker/templates.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OpenCode binary download to volume population</name>
  <files>src/aishell/docker/volume.clj</files>
  <action>
  Update `build-install-commands` in volume.clj to handle OpenCode binary installation alongside npm packages.

  Specific changes:

  1. Add a `build-opencode-install-command` helper function (or inline logic) that:
     - Checks if `:with-opencode` is truthy in state
     - Gets version from `:opencode-version` (or "latest")
     - Builds a curl command to download the OpenCode binary into `/tools/bin/`
     - The download URL pattern for OpenCode releases is: `https://github.com/opencodeco/opencode/releases/download/v{VERSION}/opencode_linux_amd64.tar.gz` (for latest, use `https://github.com/opencodeco/opencode/releases/latest/download/opencode_linux_amd64.tar.gz`)
     - Command should: `mkdir -p /tools/bin && curl -fsSL {URL} | tar -xz -C /tools/bin opencode`
     - NOTE: Verify the actual OpenCode release artifact structure first. If the binary name or archive layout differs, adjust accordingly. The executor should check the GitHub releases page to confirm the download URL pattern and binary name inside the archive.

  2. Update `build-install-commands` to concatenate the OpenCode binary install command (if applicable) with the existing npm install commands using `&&`.

  The final command string should look like:
  ```
  export NPM_CONFIG_PREFIX=/tools/npm && npm install -g @anthropic-ai/claude-code@2.0.22 && mkdir -p /tools/bin && curl -fsSL {URL} | tar -xz -C /tools/bin opencode && chmod -R a+rX /tools
  ```

  Keep `chmod -R a+rX /tools` as the LAST step so it covers both /tools/npm and /tools/bin.
  </action>
  <verify>
  Read volume.clj and confirm:
  - `build-install-commands` returns a command string that includes `mkdir -p /tools/bin` and `curl` when `:with-opencode` is true in state
  - When `:with-opencode` is false, no opencode commands appear
  - The `chmod -R a+rX /tools` remains the final command
  </verify>
  <done>
  `build-install-commands` generates OpenCode binary download commands when `:with-opencode` is enabled, alongside npm package installs for other harnesses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add /tools/bin to PATH in entrypoint</name>
  <files>src/aishell/docker/templates.clj</files>
  <action>
  Update `entrypoint-script` in templates.clj to add `/tools/bin` to PATH when the directory exists.

  Find the existing block:
  ```
  if [ -d "/tools/npm/bin" ]; then
    export PATH="/tools/npm/bin:$PATH"
    export NODE_PATH="/tools/npm/lib/node_modules"
  fi
  ```

  Add a similar block immediately after for `/tools/bin`:
  ```
  if [ -d "/tools/bin" ]; then
    export PATH="/tools/bin:$PATH"
  fi
  ```

  This follows the same pattern (directory existence check) used for npm tools, keeping the approach consistent.
  </action>
  <verify>
  Read templates.clj and confirm `entrypoint-script` contains the `/tools/bin` PATH conditional block after the `/tools/npm/bin` block.
  </verify>
  <done>
  Entrypoint script adds `/tools/bin` to PATH when the directory exists, making OpenCode binary accessible in the container.
  </done>
</task>

</tasks>

<verification>
1. Read volume.clj — `build-install-commands` handles OpenCode when enabled
2. Read templates.clj — entrypoint adds /tools/bin to PATH
3. Grep for "opencode" in volume.clj — confirms binary download logic exists
4. Grep for "/tools/bin" in templates.clj — confirms PATH wiring
</verification>

<success_criteria>
- OpenCode binary installation is part of volume population when --with-opencode is configured
- /tools/bin is added to PATH in entrypoint when directory exists
- Existing npm-based harness installation is unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/37-build-integration-migration/37-05-SUMMARY.md`
</output>
