---
phase: 37-build-integration-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/state.clj
autonomous: true

must_haves:
  truths:
    - "State file from v2.7.0 (without new fields) reads without error and returns nil for missing fields"
    - "State file from v2.8.0 (with new fields) reads and returns all fields correctly"
    - "write-state docstring documents the v2.8.0 schema including foundation-hash, harness-volume-hash, and harness-volume-name"
  artifacts:
    - path: "src/aishell/state.clj"
      provides: "Updated state schema documentation with v2.8.0 fields"
      contains: "foundation-hash"
  key_links: []
---

<objective>
Update state.clj schema documentation to include v2.8.0 fields: :foundation-hash, :harness-volume-hash, and :harness-volume-name. Mark :dockerfile-hash as deprecated in favor of :foundation-hash.

Purpose: CACHE-02 requires state schema tracks foundation-hash and harness-volume-hash as separate fields. MIGR-01 requires backward-compatible migration. Since EDN maps return nil for missing keys, the actual read/write code needs no changes -- only the schema documentation in write-state's docstring needs updating.

Output: Updated state.clj with v2.8.0 schema documentation
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/aishell/state.clj
@.planning/phases/37-build-integration-migration/37-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update state schema documentation</name>
  <files>src/aishell/state.clj</files>
  <action>
Update the write-state docstring in src/aishell/state.clj to document the v2.8.0 schema:

1. Change `:image-tag "aishell:base"` to `:image-tag "aishell:foundation"` in the docstring example
2. Add comment next to `:dockerfile-hash` marking it as `; DEPRECATED: Use :foundation-hash`
3. Add three new fields to the schema docstring:
   - `:foundation-hash "abc123def456"  ; 12-char SHA-256 of foundation Dockerfile template`
   - `:harness-volume-hash "def789ghi012" ; 12-char SHA-256 of enabled harnesses+versions`
   - `:harness-volume-name "aishell-harness-def789ghi012" ; Docker volume name for runtime mounting`

The actual read-state and write-state function bodies remain UNCHANGED. EDN's flexible schema handles this naturally -- old state files return nil for new keys, new state files include them.

Do NOT add any migration logic, version tracking, or schema validation. The additive approach (new fields default to nil) is the migration strategy.
  </action>
  <verify>
Run `bb -e '(require (quote [aishell.state :as s])) (println (s/read-state))'` from project root to confirm state.clj still loads and reads existing state file without error.

Visually confirm the docstring contains all three new fields (:foundation-hash, :harness-volume-hash, :harness-volume-name) and the deprecated marker on :dockerfile-hash.
  </verify>
  <done>
write-state docstring documents v2.8.0 schema with :foundation-hash, :harness-volume-hash, :harness-volume-name fields. :dockerfile-hash marked as deprecated. read-state and write-state function bodies unchanged. Existing state files continue to read correctly.
  </done>
</task>

</tasks>

<verification>
- `bb -e '(require (quote [aishell.state :as s])) (println (s/read-state))'` succeeds (backward compat)
- state.clj docstring contains `:foundation-hash`, `:harness-volume-hash`, `:harness-volume-name`
- state.clj docstring contains `DEPRECATED` marker on `:dockerfile-hash`
- No functional code changes in state.clj (only docstring update)
</verification>

<success_criteria>
State schema documentation updated for v2.8.0. Backward compatibility preserved (no code changes needed -- EDN handles nil for missing keys naturally). Requirements CACHE-02 (schema tracking) and MIGR-01 (backward-compatible migration) addressed at the schema documentation level.
</success_criteria>

<output>
After completion, create `.planning/phases/37-build-integration-migration/37-01-SUMMARY.md`
</output>
