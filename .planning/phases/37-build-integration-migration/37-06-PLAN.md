---
phase: 37-build-integration-migration
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/templates.clj
  - src/aishell/docker/build.clj
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "New tmux windows have the cyan [aishell] prompt, aliases, and locale settings"
    - "New tmux windows have /tools/npm/bin and /tools/bin in PATH (harness tools accessible)"
    - "New tmux windows have NODE_PATH set for module resolution"
  artifacts:
    - path: "src/aishell/docker/templates.clj"
      provides: "/etc/profile.d/aishell.sh content and Dockerfile COPY instruction"
      contains: "profile.d"
  key_links:
    - from: "src/aishell/docker/templates.clj"
      to: "base-dockerfile"
      via: "COPY profile.d script into image"
      pattern: "profile.d/aishell.sh"
    - from: "/etc/profile.d/aishell.sh"
      to: "/etc/bash.aishell"
      via: "source command for prompt/aliases"
      pattern: "source /etc/bash.aishell"
---

<objective>
Fix tmux new-window environment loss by creating /etc/profile.d/aishell.sh for login shell compatibility.

Purpose: GAP-02 fix — tmux spawns new windows as login shells (bash -l). Login shells source /etc/profile (which resets PATH) and /etc/profile.d/*.sh, but NOT ~/.bashrc. The entrypoint sets PATH/NODE_PATH via export before exec, and bashrc sourcing is only in ~/.bashrc. New tmux windows lose both PATH (harness tools) and shell customizations (prompt, aliases).

Output: New tmux windows inherit full aishell environment (PATH, NODE_PATH, prompt, aliases, locale).
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-build-integration-migration/37-UAT.md
@src/aishell/docker/templates.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profile.d script content and wire into Dockerfile</name>
  <files>src/aishell/docker/templates.clj</files>
  <action>
  Make three changes to templates.clj:

  **1. Add a new def for the profile.d script content:**

  Add a new `def` called `profile-d-script` with this content:

  ```bash
  # /etc/profile.d/aishell.sh - Login shell environment for aishell containers
  # Sourced by /etc/profile on login shell startup (new tmux windows, ssh, etc.)
  # Ensures harness tools and shell customizations persist across tmux windows.

  # Volume-mounted harness tools PATH configuration
  if [ -d "/tools/npm/bin" ]; then
    export PATH="/tools/npm/bin:$PATH"
    export NODE_PATH="/tools/npm/lib/node_modules"
  fi

  if [ -d "/tools/bin" ]; then
    export PATH="/tools/bin:$PATH"
  fi

  # Source shell customizations (prompt, aliases, locale)
  if [ -f "/etc/bash.aishell" ]; then
    . /etc/bash.aishell
  fi
  ```

  **2. Update base-dockerfile to COPY the profile.d script:**

  After the existing line `COPY bashrc.aishell /etc/bash.aishell`, add:

  ```dockerfile
  COPY profile.d-aishell.sh /etc/profile.d/aishell.sh
  ```

  This places the script where login shells will automatically source it. The file name `profile.d-aishell.sh` is the build-context filename; it gets copied to `/etc/profile.d/aishell.sh` in the image.

  **3. Update the build context in build.clj (if needed):**

  Check how build.clj writes build-context files. It likely writes `entrypoint.sh` and `bashrc.aishell` from template defs. Add a similar write for `profile.d-aishell.sh` using the new `profile-d-script` def.

  To find where build context files are written, look for references to `entrypoint-script` or `bashrc-content` in the codebase (likely in `src/aishell/docker/build.clj`). Add a parallel entry for the new file.

  IMPORTANT: The profile.d script uses `. /etc/bash.aishell` (dot-source) not `source`, because /etc/profile.d scripts may run under sh, not bash. Using dot-source is POSIX-compatible.
  </action>
  <verify>
  1. Read templates.clj — confirm `profile-d-script` def exists with PATH, NODE_PATH, and bash.aishell sourcing
  2. Read templates.clj — confirm `base-dockerfile` contains `COPY profile.d-aishell.sh /etc/profile.d/aishell.sh`
  3. Grep for "profile.d-aishell" or "profile-d-script" in build.clj — confirm the new file is written to build context
  </verify>
  <done>
  - profile.d script defined in templates.clj with PATH/NODE_PATH/bash.aishell sourcing
  - Dockerfile copies it to /etc/profile.d/aishell.sh
  - Build context writes the file alongside entrypoint.sh and bashrc.aishell
  - Login shells (new tmux windows) will source it automatically
  </done>
</task>

</tasks>

<verification>
1. Read templates.clj — `profile-d-script` def exists
2. Read templates.clj — `base-dockerfile` includes COPY for profile.d script
3. Grep for "profile-d-script" in build.clj — build context includes the file
4. Verify /etc/profile.d/aishell.sh content handles: PATH with /tools/npm/bin, PATH with /tools/bin, NODE_PATH, and sources /etc/bash.aishell
</verification>

<success_criteria>
- /etc/profile.d/aishell.sh is created in the Docker image during build
- Login shells source it automatically (Debian /etc/profile sources /etc/profile.d/*.sh)
- New tmux windows get correct PATH (harness tools), NODE_PATH, prompt, aliases, and locale
- Existing interactive shell behavior unchanged (entrypoint + bashrc path still works)
</success_criteria>

<output>
After completion, create `.planning/phases/37-build-integration-migration/37-06-SUMMARY.md`
</output>
