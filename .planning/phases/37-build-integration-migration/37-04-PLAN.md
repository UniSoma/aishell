---
phase: 37-build-integration-migration
plan: 04
type: execute
wave: 2
depends_on: ["37-01"]
files_modified:
  - src/aishell/cli.clj
autonomous: true

must_haves:
  truths:
    - "aishell build --with-claude builds foundation image AND populates harness volume in one command"
    - "State file after build contains :foundation-hash, :harness-volume-hash, and :harness-volume-name fields"
    - "State file after build still contains :dockerfile-hash for backward compatibility"
    - "Volume is only populated if missing or hash mismatch (not on every build)"
    - "Build output shows volume population progress when volume is created/updated"
  artifacts:
    - path: "src/aishell/cli.clj"
      provides: "Unified build command handling foundation image + harness volume"
      contains: "harness-volume-hash"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/docker/volume.clj"
      via: "vol/compute-harness-hash, vol/volume-name, vol/volume-exists?, vol/create-volume, vol/populate-volume"
      pattern: "vol/compute-harness-hash"
    - from: "src/aishell/cli.clj"
      to: "src/aishell/state.clj"
      via: "state/write-state with new schema fields"
      pattern: ":harness-volume-hash"
---

<objective>
Wire foundation build and harness volume population into unified build command flow. `aishell build` transparently handles both operations and writes complete v2.8.0 state.

Purpose: BUILD-01 requires `aishell build` handles both foundation image and harness volume transparently. This is the integration point where all Phase 36 primitives (hash computation, volume creation, volume population) are called from the build command.

Output: Updated cli.clj handle-build with volume population step and v2.8.0 state writing
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/aishell/cli.clj
@src/aishell/docker/volume.clj
@src/aishell/state.clj
@.planning/phases/37-build-integration-migration/37-RESEARCH.md
@.planning/phases/37-build-integration-migration/37-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add volume population to handle-build and update state writing</name>
  <files>src/aishell/cli.clj</files>
  <action>
1. Add `[aishell.docker.volume :as vol]` to the ns require vector in cli.clj (if not already present).

2. In `handle-build` function (starting at line 148), after the foundation image build result (around line 172), add volume population steps:

After the existing `result` binding, add these new bindings in the same `let` block:

```clojure
;; Step 2: Compute harness volume hash
state-map {:with-claude (:enabled? claude-config)
           :with-opencode (:enabled? opencode-config)
           :with-codex (:enabled? codex-config)
           :with-gemini (:enabled? gemini-config)
           :with-gitleaks with-gitleaks
           :claude-version (:version claude-config)
           :opencode-version (:version opencode-config)
           :codex-version (:version codex-config)
           :gemini-version (:version gemini-config)}

harness-hash (vol/compute-harness-hash state-map)
volume-name (vol/volume-name harness-hash)

;; Step 3: Populate volume if needed (only if missing or stale)
_ (when (some #(get state-map %) [:with-claude :with-opencode :with-codex :with-gemini])
    (when (or (not (vol/volume-exists? volume-name))
              (not= (vol/get-volume-label volume-name "aishell.harness.hash")
                    harness-hash))
      (when-not (vol/volume-exists? volume-name)
        (vol/create-volume volume-name {"aishell.harness.hash" harness-hash
                                        "aishell.harness.version" "2.8.0"}))
      (vol/populate-volume volume-name state-map {:verbose (:verbose opts)})))
```

3. Update the `state/write-state` call to include new v2.8.0 fields:

```clojure
(state/write-state
  (assoc state-map
         :image-tag (:image result)
         :build-time (str (java.time.Instant/now))
         :dockerfile-hash (hash/compute-hash templates/base-dockerfile)  ; Kept for v2.7.0 compat
         :foundation-hash (hash/compute-hash templates/base-dockerfile)  ; NEW: same as dockerfile-hash for now
         :harness-volume-hash harness-hash                               ; NEW
         :harness-volume-name volume-name))                              ; NEW
```

This replaces the existing write-state call (lines 175-187) which currently writes the state-map inline. The new version uses `assoc` on `state-map` to avoid duplicating the harness flags.

4. Also update `handle-update` function to write new fields. handle-update reads existing state and force-rebuilds. After the foundation build, it should also check/populate volume and write the new state fields. Read the handle-update function to see its current structure, then add similar volume population and state writing with new fields.

IMPORTANT design decisions:
- Volume population only happens when at least one harness is enabled (`some` check)
- Volume is only populated if missing OR hash mismatch (lazy, not every build)
- Both :dockerfile-hash (deprecated) and :foundation-hash (new) are written for backward compat
- :harness-volume-name is stored so run.clj can use it without recomputing
  </action>
  <verify>
Run `bb -e '(require (quote [aishell.cli]))' ` to verify namespace loads without error (confirms vol require and all references resolve).

Grep for `:harness-volume-hash` in cli.clj to confirm new state field is written.
Grep for `:foundation-hash` in cli.clj to confirm new state field is written.
Grep for `vol/compute-harness-hash` in cli.clj to confirm volume hash computation.
Grep for `vol/populate-volume` in cli.clj to confirm volume population step.
  </verify>
  <done>
`aishell build` transparently handles foundation image build + harness volume population (BUILD-01). State file written with :foundation-hash, :harness-volume-hash, :harness-volume-name (CACHE-02). Volume only populated when needed (lazy). handle-update also updated with new fields.
  </done>
</task>

</tasks>

<verification>
- `bb -e '(require (quote [aishell.cli]))'` loads without error
- cli.clj handle-build calls vol/compute-harness-hash and vol/populate-volume
- cli.clj handle-build writes :foundation-hash, :harness-volume-hash, :harness-volume-name to state
- cli.clj handle-build still writes :dockerfile-hash for backward compat
- Volume population conditional on harness being enabled AND volume being missing/stale
- handle-update also writes new state fields
</verification>

<success_criteria>
`aishell build` handles both foundation image and harness volume transparently (BUILD-01). State written with full v2.8.0 schema (CACHE-02). Volume population is lazy -- only when needed. handle-update preserves new field behavior.
</success_criteria>

<output>
After completion, create `.planning/phases/37-build-integration-migration/37-04-SUMMARY.md`
</output>
