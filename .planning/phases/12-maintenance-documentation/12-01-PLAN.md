---
phase: 12-maintenance-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - aishell
  - README.md
autonomous: true

must_haves:
  truths:
    - "Running aishell after Dockerfile change shows warning about version mismatch"
    - "README explains run.conf format limitations with examples"
    - "README explains safe.directory behavior and host gitconfig impact"
  artifacts:
    - path: "aishell"
      provides: "Dockerfile hash detection functions"
      contains: "get_dockerfile_hash"
    - path: "aishell"
      provides: "Dockerfile hash label in build"
      contains: "aishell.dockerfile.hash"
    - path: "README.md"
      provides: "run.conf limitations section"
      contains: "run.conf Limitations"
    - path: "README.md"
      provides: "safe.directory documentation"
      contains: "safe.directory"
  key_links:
    - from: "do_build"
      to: "docker build --label"
      via: "aishell.dockerfile.hash label"
      pattern: '--label "aishell.dockerfile.hash'
    - from: "main"
      to: "check_dockerfile_changed"
      via: "runtime check before container launch"
      pattern: "check_dockerfile_changed"
---

<objective>
Add Dockerfile change detection and document known limitations for run.conf and safe.directory.

Purpose: Help users understand when to rebuild (MAINT-01) and avoid confusion about parsing limits (DOC-01, DOC-02).
Output: Updated aishell with hash detection, updated README with limitation sections.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-maintenance-documentation/12-RESEARCH.md
@aishell
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Dockerfile hash detection to aishell</name>
  <files>aishell</files>
  <action>
Add Dockerfile change detection per MAINT-01. Three additions needed:

1. Add `get_dockerfile_hash()` function after `write_bashrc()` (around line 450):
```bash
# --- Dockerfile Hash Detection (MAINT-01) ---
# Compute hash of embedded Dockerfile content for update detection
get_dockerfile_hash() {
    local temp_dir
    temp_dir=$(mktemp -d)
    write_dockerfile "$temp_dir"
    local hash
    hash=$(sha256sum "${temp_dir}/Dockerfile" | cut -c1-12)
    rm -rf "$temp_dir"
    echo "$hash"
}

# Read hash label from built image
get_image_dockerfile_hash() {
    local image="$1"
    docker inspect --format='{{index .Config.Labels "aishell.dockerfile.hash"}}' "$image" 2>/dev/null || true
}

# Warn if Dockerfile has changed since build
check_dockerfile_changed() {
    local image="$1"

    local built_hash
    built_hash=$(get_image_dockerfile_hash "$image")

    # Skip check for old images without hash label
    [[ -z "$built_hash" ]] && return 0

    local current_hash
    current_hash=$(get_dockerfile_hash)

    if [[ "$built_hash" != "$current_hash" ]]; then
        warn "Image was built with a different Dockerfile version"
        echo "  Built with:  $built_hash" >&2
        echo "  Current:     $current_hash" >&2
        echo "  Run 'aishell update' to rebuild with the current version." >&2
        echo "" >&2
    fi
}
```

2. In `do_build()` function, add the Dockerfile hash label. Find where `build_args` array is built (around line 862-867) and add BEFORE the docker build call:
```bash
    # Compute Dockerfile hash for update detection (MAINT-01)
    local dockerfile_hash
    dockerfile_hash=$(get_dockerfile_hash)
    build_args+=(--label "aishell.dockerfile.hash=$dockerfile_hash")
```

3. In `do_update()` function, add the same label. Find the build_args array (around line 1387-1391) and add BEFORE the docker build call:
```bash
    # Compute Dockerfile hash for update detection (MAINT-01)
    local dockerfile_hash
    dockerfile_hash=$(get_dockerfile_hash)
    build_args+=(--label "aishell.dockerfile.hash=$dockerfile_hash")
```

4. In `main()` function, add the check AFTER `handle_extension "$project_dir"` (around line 1462):
```bash
    # Check for Dockerfile updates (MAINT-01)
    check_dockerfile_changed "$IMAGE_TO_RUN"
```

Note: The hash is computed from the heredoc output, not the script source. This ensures the hash is stable and only changes when the Dockerfile content actually changes. Use 12-char truncation (same as project hash pattern at line 460).
  </action>
  <verify>
1. Build an image: `aishell build --with-claude`
2. Verify the label exists: `docker inspect --format='{{index .Config.Labels "aishell.dockerfile.hash"}}' aishell:claude-*` should return a 12-char hash
3. Run aishell - should NOT warn (hash matches)
4. Manually change the label to test warning: `docker tag aishell:claude-* test:changed && docker rmi aishell:claude-* && docker tag test:changed aishell:claude-*` (this resets labels, so running aishell after build should NOT warn because image still matches)
  </verify>
  <done>
- `get_dockerfile_hash()` function exists and returns 12-char hash
- `do_build()` and `do_update()` add `aishell.dockerfile.hash` label
- `main()` calls `check_dockerfile_changed()` before container launch
- Old images without label don't trigger errors (graceful skip)
  </done>
</task>

<task type="auto">
  <name>Task 2: Document run.conf and safe.directory limitations</name>
  <files>README.md</files>
  <action>
Add two documentation sections to README.md after the "Runtime configuration" section (around line 106).

1. Add run.conf Limitations section (DOC-01):
```markdown
### run.conf Limitations

The `.aishell/run.conf` file uses a simplified parsing format:

**Supported syntax:**
- `VAR=value` - Unquoted value (no spaces allowed)
- `VAR="value with spaces"` - Double-quoted value
- `VAR='value with spaces'` - Single-quoted value
- `# comment` - Comments on their own line

**Not supported:**
- Escaped quotes: `VAR="value with \"quotes\""` will fail
- Multi-line values: Each assignment must be on one line
- Shell expansion: `$VAR` and `$(command)` are not expanded
- Continuation lines: No backslash line continuation

**Workaround for complex values:**
Use `DOCKER_ARGS` to pass environment variables that need special characters:
```bash
DOCKER_ARGS="-e COMPLEX_VAR=value-with-special-chars"
```
```

2. Add safe.directory section (DOC-02):
```markdown
### Git safe.directory

When you run a container, aishell configures git to trust the mounted project directory by adding it to `safe.directory` in the container's gitconfig.

**What happens:**
1. The entrypoint runs `git config --global --add safe.directory /your/project/path`
2. This writes to `~/.gitconfig` inside the container

**Host gitconfig impact:**
If you mount your host's `~/.gitconfig` or `~/.config/git/config` into the container (via `MOUNTS` in run.conf), the safe.directory entry will be added to your **host's** gitconfig file.

**Why this happens:**
- Git requires safe.directory for directories owned by different users
- Inside the container, the mounted project appears owned by a different user
- This is a security feature (CVE-2022-24765), not a bug

**To avoid modifying host gitconfig:**
Don't mount your host gitconfig into the container. The container creates its own gitconfig that is discarded when the container exits.
```

Place these sections BEFORE the "## Environment Variables" section.
  </action>
  <verify>
1. Read README.md and confirm both sections exist
2. Sections are placed logically after runtime config, before environment variables
3. Code blocks render correctly (no syntax errors in markdown)
  </verify>
  <done>
- README has "run.conf Limitations" section explaining format restrictions
- README has "Git safe.directory" section explaining host gitconfig impact
- Both sections include clear examples and workarounds
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **MAINT-01 verification:**
   - Build image: `cd /tmp && mkdir test-proj && cd test-proj && aishell build --with-claude`
   - Check label: `docker inspect aishell:claude-* | grep dockerfile.hash`
   - Run: `aishell` (should NOT warn, hash matches)

2. **DOC-01 verification:**
   - `grep -A20 "run.conf Limitations" README.md` shows the section

3. **DOC-02 verification:**
   - `grep -A15 "safe.directory" README.md` shows the section

All requirements (MAINT-01, DOC-01, DOC-02) addressed.
</verification>

<success_criteria>
- [ ] aishell has Dockerfile hash detection functions
- [ ] `do_build()` and `do_update()` add hash label to image
- [ ] `main()` checks hash and warns on mismatch
- [ ] README documents run.conf parsing limitations
- [ ] README documents safe.directory behavior
- [ ] All verification commands pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-maintenance-documentation/12-01-SUMMARY.md`
</output>
