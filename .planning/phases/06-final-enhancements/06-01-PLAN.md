---
phase: 06-final-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - aishell
autonomous: true

must_haves:
  truths:
    - "User can specify --claude-version=X.Y.Z to install specific Claude version"
    - "User can specify --opencode-version=X.Y.Z to install specific OpenCode version"
    - "Without version flags, latest version is installed"
    - "Versioned images have distinct tags for caching"
  artifacts:
    - path: "aishell"
      provides: "Version flag parsing and image tagging"
      contains: "--claude-version"
  key_links:
    - from: "parse_args"
      to: "write_dockerfile"
      via: "CLAUDE_VERSION and OPENCODE_VERSION variables"
      pattern: "CLAUDE_VERSION|OPENCODE_VERSION"
    - from: "ensure_image"
      to: "docker build"
      via: "build-arg with version"
      pattern: "--build-arg.*VERSION"
---

<objective>
Add version pinning support to aishell for reproducible builds

Purpose: Allow users to pin specific harness versions for reproducible environments
Output: aishell with --claude-version and --opencode-version flags, version-aware image tags
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-final-enhancements/06-RESEARCH.md
@aishell
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add version CLI flags and parsing</name>
  <files>aishell</files>
  <action>
Add two new global variables after existing WITH_* variables:

```bash
CLAUDE_VERSION=""
OPENCODE_VERSION=""
```

Update usage() to document new options:

```
    --claude-version=X.Y.Z  Install specific Claude Code version (e.g., 2.0.22)
    --opencode-version=X.Y.Z Install specific OpenCode version (e.g., 1.1.25)
```

Add parsing in parse_args() case statement:

```bash
--claude-version=*)
    CLAUDE_VERSION="${1#--claude-version=}"
    shift
    ;;
--opencode-version=*)
    OPENCODE_VERSION="${1#--opencode-version=}"
    shift
    ;;
```

Note: Version numbers have NO "v" prefix (e.g., "2.0.22" not "v2.0.22") per RESEARCH.md.
  </action>
  <verify>Run `./aishell --help` and confirm --claude-version and --opencode-version appear in help text</verify>
  <done>CLI accepts --claude-version=X.Y.Z and --opencode-version=X.Y.Z flags, stored in global variables</done>
</task>

<task type="auto">
  <name>Task 2: Modify Dockerfile heredoc for version installation</name>
  <files>aishell</files>
  <action>
Update write_dockerfile() to accept version build args. Modify the embedded Dockerfile:

Add new ARG declarations after existing WITH_* args:

```dockerfile
ARG CLAUDE_VERSION=""
ARG OPENCODE_VERSION=""
```

Modify Claude Code installation RUN block:

```dockerfile
RUN if [ "$WITH_CLAUDE" = "true" ]; then \
        export DISABLE_AUTOUPDATER=1 && \
        if [ -n "$CLAUDE_VERSION" ]; then \
            curl -fsSL https://claude.ai/install.sh | bash -s "$CLAUDE_VERSION"; \
        else \
            curl -fsSL https://claude.ai/install.sh | bash; \
        fi && \
        cp /root/.local/bin/claude /usr/local/bin/claude && \
        chmod +x /usr/local/bin/claude; \
    fi
```

Modify OpenCode installation RUN block:

```dockerfile
RUN if [ "$WITH_OPENCODE" = "true" ]; then \
        if [ -n "$OPENCODE_VERSION" ]; then \
            VERSION="$OPENCODE_VERSION" curl -fsSL https://opencode.ai/install | bash; \
        else \
            curl -fsSL https://opencode.ai/install | bash; \
        fi && \
        cp /root/.opencode/bin/opencode /usr/local/bin/opencode && \
        chmod +x /usr/local/bin/opencode; \
    fi
```

Key patterns from RESEARCH.md:
- Claude: `bash -s <version>` (no v prefix)
- OpenCode: `VERSION=<version>` env var (no v prefix)
  </action>
  <verify>Run `grep -A5 'CLAUDE_VERSION' aishell` and confirm the version conditional logic appears in Dockerfile heredoc</verify>
  <done>Embedded Dockerfile supports CLAUDE_VERSION and OPENCODE_VERSION build args with conditional installation</done>
</task>

<task type="auto">
  <name>Task 3: Update image tagging to include version</name>
  <files>aishell</files>
  <action>
Create a new function to compute versioned image tag. Add after BASE_IMAGE_NAME="aishell:base":

```bash
compute_image_tag() {
    local tag="aishell"
    local suffix=""

    # Build suffix from versions
    if [[ -n "$CLAUDE_VERSION" ]]; then
        suffix="${suffix:+$suffix-}claude-$CLAUDE_VERSION"
    fi
    if [[ -n "$OPENCODE_VERSION" ]]; then
        suffix="${suffix:+$suffix-}opencode-$OPENCODE_VERSION"
    fi

    # Return tagged name or base
    if [[ -n "$suffix" ]]; then
        echo "aishell:$suffix"
    else
        echo "$BASE_IMAGE_NAME"
    fi
}
```

Modify ensure_image() to:
1. Compute tag using compute_image_tag()
2. Check if that specific tagged image exists
3. Pass version as build-args to docker build

Replace the image existence check and build logic:

```bash
ensure_image() {
    local needs_build=false
    local -a build_args=()

    # Compute tag based on versions
    local target_tag
    target_tag=$(compute_image_tag)

    # Check if image exists
    if ! docker image inspect "$target_tag" >/dev/null 2>&1; then
        needs_build=true
    fi

    # Check if build flags request harnesses not in current image
    if [[ "$WITH_CLAUDE" == true ]] || [[ "$WITH_OPENCODE" == true ]]; then
        needs_build=true
    fi

    # Also rebuild if version specified (may differ from existing)
    if [[ -n "$CLAUDE_VERSION" ]] || [[ -n "$OPENCODE_VERSION" ]]; then
        needs_build=true
    fi

    if [[ "$needs_build" == true ]]; then
        # ... existing build logic ...

        # Add version build args
        [[ -n "$CLAUDE_VERSION" ]] && build_args+=(--build-arg "CLAUDE_VERSION=$CLAUDE_VERSION")
        [[ -n "$OPENCODE_VERSION" ]] && build_args+=(--build-arg "OPENCODE_VERSION=$OPENCODE_VERSION")

        # Build with target tag instead of BASE_IMAGE_NAME
        if ! docker build "${build_args[@]}" -t "$target_tag" "$build_dir" >/dev/null 2>&1; then
            # ...
        fi
    fi

    # Update BASE_IMAGE_NAME to point to built tag for extension builds
    BASE_IMAGE_NAME="$target_tag"
}
```

Also update ensure_image_with_extension() to use the computed tag (it already uses BASE_IMAGE_NAME which we update).

Update do_update() similarly to support versions in update command.
  </action>
  <verify>
Run: `./aishell --with-claude --claude-version=2.0.22 --version` (this exercises parsing)
Then check: `docker images | grep aishell` to see if versioned tag pattern would work
  </verify>
  <done>Images tagged with version info (e.g., aishell:claude-2.0.22) for cache discrimination</done>
</task>

</tasks>

<verification>
1. `./aishell --help` shows --claude-version and --opencode-version options
2. Dockerfile heredoc contains CLAUDE_VERSION and OPENCODE_VERSION ARG declarations
3. compute_image_tag function exists and returns versioned tags
4. Build with version creates appropriately tagged image
</verification>

<success_criteria>
- VERSION-01: `--claude-version=X.Y.Z` flag accepted and used in build
- VERSION-02: `--opencode-version=X.Y.Z` flag accepted and used in build
- VERSION-03: Without flags, latest version installed (default empty string triggers curl|bash without version arg)
- VERSION-04: Versioned builds use distinct image tags (aishell:claude-X.Y.Z)
</success_criteria>

<output>
After completion, create `.planning/phases/06-final-enhancements/06-01-SUMMARY.md`
</output>
