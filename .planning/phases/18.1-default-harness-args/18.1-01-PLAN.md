---
phase: 18.1-default-harness-args
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/config.clj
  - src/aishell/run.clj
autonomous: true

must_haves:
  truths:
    - "User can add harness_args key to config.yaml mapping harness names to argument lists"
    - "Default arguments are prepended to CLI-provided arguments"
    - "Per-harness granularity works (claude and opencode have independent defaults)"
    - "Global and project harness_args merge correctly (global first, then project)"
  artifacts:
    - path: "src/aishell/config.clj"
      provides: "harness_args parsing, validation, and merge logic"
      contains: ":harness_args"
    - path: "src/aishell/run.clj"
      provides: "Default argument injection at invocation"
      contains: "harness_args"
  key_links:
    - from: "src/aishell/config.clj"
      to: "src/aishell/run.clj"
      via: "load-config returns map with :harness_args"
      pattern: ":harness_args"
    - from: "config.yaml"
      to: "src/aishell/config.clj"
      via: "YAML parsing normalizes harness_args structure"
      pattern: "harness_args"
---

<objective>
Implement per-harness default arguments in config.yaml that are automatically prepended to CLI arguments on every invocation.

Purpose: Allow users to define common harness arguments once in config rather than typing them on every command. This reduces repetition for frequently-used flags like --plugin or --model.

Output: Modified config.clj (parsing, validation, merge) and run.clj (argument injection) that support the harness_args config key.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18.1-default-harness-args/18.1-CONTEXT.md
@.planning/phases/18.1-default-harness-args/18.1-RESEARCH.md

@src/aishell/config.clj
@src/aishell/run.clj
@src/aishell/output.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add harness_args config parsing and validation</name>
  <files>src/aishell/config.clj</files>
  <action>
Extend config.clj to support harness_args:

1. Add :harness_args to known-keys set (line 9-11)

2. Add known-harnesses set for validation:
   ```clojure
   (def known-harnesses
     "Valid harness names for harness_args validation."
     #{"claude" "opencode"})
   ```

3. Add normalize-harness-arg function (DX convenience):
   ```clojure
   (defn normalize-harness-arg
     "Convert string to single-element list, pass lists through."
     [arg-val]
     (cond
       (nil? arg-val) []
       (string? arg-val) [arg-val]
       (sequential? arg-val) (vec arg-val)
       :else []))
   ```

4. Add normalize-harness-args function:
   ```clojure
   (defn normalize-harness-args
     "Normalize harness_args map: convert string values to single-element lists."
     [harness-args-map]
     (when harness-args-map
       (into {}
             (map (fn [[k v]] [k (normalize-harness-arg v)])
                  harness-args-map))))
   ```

5. Add validate-harness-names function:
   ```clojure
   (defn validate-harness-names
     "Warn if harness_args contains unknown harness names."
     [harness-args-map source-path]
     (when harness-args-map
       (let [config-harnesses (set (map name (keys harness-args-map)))
             unknown (clojure.set/difference config-harnesses known-harnesses)]
         (when (seq unknown)
           (output/warn (str "Unknown harness names in " source-path
                            " harness_args: "
                            (clojure.string/join ", " unknown)))))))
   ```

6. Update validate-config to also validate harness names:
   - After existing unknown-keys check, add:
   ```clojure
   (when-let [harness-args (:harness_args config)]
     (validate-harness-names harness-args source-path))
   ```

7. Add merge-harness-args function:
   ```clojure
   (defn merge-harness-args
     "Merge harness_args maps: merge keys, concatenate per-harness lists.
      Global defaults come first (can be overridden by position)."
     [global-args project-args]
     (let [global-normalized (normalize-harness-args global-args)
           project-normalized (normalize-harness-args project-args)]
       (merge-with (fn [global-list project-list]
                     (vec (concat (or global-list [])
                                 (or project-list []))))
                   global-normalized
                   project-normalized)))
   ```

8. Update merge-configs to handle harness_args as map-of-lists:
   - Add `map-of-lists-keys #{:harness_args}` after scalar-keys
   - Add new cond clause in reduce:
   ```clojure
   (contains? map-of-lists-keys k)
   (let [global-val (get global-config k)
         project-val (get project-config k)]
     (if (or global-val project-val)
       (assoc acc k (merge-harness-args global-val project-val))
       acc))
   ```

Important: Place the map-of-lists-keys clause BEFORE the :else clause in the cond.
  </action>
  <verify>
Run REPL tests:
```bash
cd /home/jonasrodrigues/projects/harness && bb -e '
(require (quote [aishell.config :as cfg]))
;; Test known-keys includes harness_args
(assert (contains? cfg/known-keys :harness_args) "harness_args in known-keys")
;; Test known-harnesses exists
(assert (contains? cfg/known-harnesses "claude") "claude in known-harnesses")
(println "Config validation tests passed")
'
```
  </verify>
  <done>
- :harness_args is a valid config key (no warnings)
- Unknown harness names trigger warnings
- String values auto-convert to single-element lists
- Global and project harness_args merge correctly (global first, lists concatenate per-harness)
  </done>
</task>

<task type="auto">
  <name>Task 2: Inject default arguments at harness invocation</name>
  <files>src/aishell/run.clj</files>
  <action>
Update run-container in run.clj to prepend default args from config:

1. After cfg is loaded (line 86), extract and merge defaults:
   ```clojure
   ;; Extract defaults for this harness (if any)
   defaults (when (and cfg cmd)
              (get-in cfg [:harness_args (keyword cmd)] []))

   ;; Ensure defaults is a vector
   defaults-vec (vec (or defaults []))

   ;; Merge: defaults first, then CLI args (CLI can override by position)
   merged-args (vec (concat defaults-vec harness-args))
   ```

2. Add verbose output for applied defaults (after existing verbose outputs, around line 95):
   ```clojure
   _ (when (seq defaults-vec)
       (output/verbose (str "Applying " cmd " defaults: "
                           (clojure.string/join " " defaults-vec))))
   ```

3. Update container-cmd to use merged-args instead of harness-args:
   - Change line 118: `harness-args` -> `merged-args`
   - Change line 122: `harness-args` -> `merged-args`

The final container-cmd block should look like:
```clojure
container-cmd (case cmd
                "claude"
                (into ["claude" "--dangerously-skip-permissions"]
                      merged-args)

                "opencode"
                (into ["opencode"] merged-args)

                ;; Default: bash shell
                ["/bin/bash"])
```
  </action>
  <verify>
Run REPL tests:
```bash
cd /home/jonasrodrigues/projects/harness && bb -e '
(require (quote [aishell.run :as run]))
;; run.clj loads without errors
(println "run.clj loads successfully")
'
```

Manual verification (requires Docker):
```bash
# Create test config
mkdir -p /tmp/test-harness-args/.aishell
cat > /tmp/test-harness-args/.aishell/config.yaml << 'EOF'
harness_args:
  claude:
    - "--verbose"
EOF

# Would test: cd /tmp/test-harness-args && aishell claude --help
# Expected: claude receives --verbose --help
```
  </verify>
  <done>
- Default arguments from config are prepended to CLI args
- Verbose mode shows which defaults are being applied
- CLI args appear after defaults (allowing override by position)
- Works for both claude and opencode harnesses
  </done>
</task>

</tasks>

<verification>
1. Config parsing:
   - `harness_args` is recognized as valid config key
   - Unknown harness names trigger warning (e.g., harness_args.invalid: [...])
   - String values normalized to lists

2. Config merging:
   - Global config: `harness_args: {claude: ["--a"]}`
   - Project config: `harness_args: {claude: ["--b"], opencode: ["--c"]}`
   - Merged result: `harness_args: {claude: ["--a", "--b"], opencode: ["--c"]}`

3. Argument injection:
   - Config defaults: `harness_args: {claude: ["--plugin", "context7"]}`
   - CLI invocation: `aishell claude --help`
   - Container receives: `claude --dangerously-skip-permissions --plugin context7 --help`

4. Verbose output:
   - With `-v`: Shows "Applying claude defaults: --plugin context7"
   - Without `-v`: No extra output
</verification>

<success_criteria>
- [ ] harness_args key accepted in config.yaml without warning
- [ ] Unknown harness names in harness_args trigger warning
- [ ] String values in harness_args auto-convert to single-element lists
- [ ] Global and project harness_args merge (concatenate per-harness)
- [ ] Defaults prepended to CLI args at invocation
- [ ] Verbose mode shows applied defaults
- [ ] All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/18.1-default-harness-args/18.1-01-SUMMARY.md`
</output>
