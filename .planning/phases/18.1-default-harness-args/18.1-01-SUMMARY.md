---
phase: 18.1-default-harness-args
plan: 01
subsystem: config
tags: [clojure, babashka, yaml, config, harness-args]

# Dependency graph
requires:
  - phase: 18-user-config
    provides: "Config loading and merging infrastructure"
provides:
  - "harness_args config key for defining per-harness default arguments"
  - "Automatic argument merging (defaults + CLI args) at runtime"
  - "DX convenience: string values auto-normalize to single-element lists"
affects: [user-config, cli-interface]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Map-of-lists config merging pattern (concatenates per-key lists)"
    - "Normalization layer for user convenience (strings â†’ lists)"

key-files:
  created: []
  modified:
    - src/aishell/config.clj
    - src/aishell/run.clj

key-decisions:
  - "Global defaults prepend to project defaults (concatenate lists per harness)"
  - "String values auto-normalize to single-element lists for better DX"
  - "Defaults prepend to CLI args (CLI can override by position)"

patterns-established:
  - "Map-of-lists merging: merge keys, concatenate per-key values"
  - "Normalization functions separate from validation for clean concerns"

# Metrics
duration: 2min
completed: 2026-01-22
---

# Phase 18.1 Plan 01: Default Harness Arguments Summary

**Per-harness default arguments in config.yaml with automatic prepending to CLI args at invocation**

## Performance

- **Duration:** 2 min
- **Started:** 2026-01-22T21:12:06Z
- **Completed:** 2026-01-22T21:14:28Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- Users can define `harness_args` in config.yaml mapping harness names to argument lists
- Default arguments automatically prepend to CLI arguments on every harness invocation
- Global and project configs merge correctly (global defaults first, then project defaults)
- String values auto-normalize to single-element lists for better DX

## Task Commits

Each task was committed atomically:

1. **Task 1: Add harness_args config parsing and validation** - `e5fb325` (feat)
2. **Task 2: Inject default arguments at harness invocation** - `d45b8c0` (feat)

## Files Created/Modified
- `src/aishell/config.clj` - Added harness_args parsing, validation, normalization, and map-of-lists merging
- `src/aishell/run.clj` - Added default argument extraction and prepending at container invocation

## Decisions Made

**1. Global defaults prepend to project defaults**
- Rationale: Allows global config to set base defaults while project config can add project-specific args
- Implementation: merge-with concatenates lists per harness name

**2. String values auto-normalize to lists**
- Rationale: DX improvement - users can write `harness_args: {claude: "--verbose"}` instead of requiring `["--verbose"]`
- Implementation: normalize-harness-arg function converts strings to single-element vectors

**3. Defaults prepend to CLI args (not append)**
- Rationale: CLI arguments can override positional defaults
- Trade-off: Position matters for some flags, but gives user final control

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## Next Phase Readiness

- Config infrastructure ready for Phase 19 (core framework) and beyond
- harness_args pattern established and tested
- No blockers for subsequent v2.1 phases

---
*Phase: 18.1-default-harness-args*
*Completed: 2026-01-22*
