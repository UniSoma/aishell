---
phase: 35-foundation-image-split
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/templates.clj
  - src/aishell/docker/build.clj
  - src/aishell/cli.clj
autonomous: true

must_haves:
  truths:
    - "Foundation image builds with Debian, Node.js, system tools, babashka, gosu, gitleaks, tmux but no harness npm packages"
    - "Foundation image is tagged aishell:foundation, not aishell:base"
    - "Foundation image only rebuilds when Dockerfile template changes, not when harness versions change"
    - "Build output shows 'aishell:foundation' in messages"
  artifacts:
    - path: "src/aishell/docker/templates.clj"
      provides: "Foundation Dockerfile template without harness installation blocks"
      contains: "Foundation Image"
    - path: "src/aishell/docker/build.clj"
      provides: "Simplified build logic without harness version checking"
      contains: "aishell:foundation"
    - path: "src/aishell/cli.clj"
      provides: "CLI build/update commands using foundation image"
      contains: "build-foundation-image"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/docker/build.clj"
      via: "build/build-foundation-image call"
      pattern: "build/build-foundation-image"
    - from: "src/aishell/docker/build.clj"
      to: "src/aishell/docker/templates.clj"
      via: "templates/base-dockerfile reference for hash"
      pattern: "templates/base-dockerfile"
---

<objective>
Strip harness tool installations from the Dockerfile template and change the image tag from `aishell:base` to `aishell:foundation`, creating a stable foundation image that only contains system dependencies.

Purpose: Eliminate harness version changes as a trigger for foundation image rebuilds, which is the root cause of cascade invalidation in extension images.
Output: Modified templates.clj (no harness blocks), simplified build.clj (no harness version logic), updated cli.clj (calls foundation build).
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-foundation-image-split/35-RESEARCH.md
@src/aishell/docker/templates.clj
@src/aishell/docker/build.clj
@src/aishell/cli.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Strip harness installations from Dockerfile template</name>
  <files>src/aishell/docker/templates.clj</files>
  <action>
  In `templates.clj`, modify the `base-dockerfile` string:

  1. Change the header comment from "# Aishell Base Image" to "# Aishell Foundation Image" and update the description to say "stable foundation layer with system dependencies" instead of mentioning harnesses.

  2. REMOVE the harness ARG declarations (current lines 19-26):
     - `ARG WITH_CLAUDE=false`
     - `ARG WITH_OPENCODE=false`
     - `ARG WITH_CODEX=false`
     - `ARG WITH_GEMINI=false`
     - `ARG CLAUDE_VERSION=""`
     - `ARG OPENCODE_VERSION=""`
     - `ARG CODEX_VERSION=""`
     - `ARG GEMINI_VERSION=""`

  3. REMOVE the harness installation RUN blocks (current lines 100-142):
     - Claude Code npm install block (lines 100-108)
     - OpenCode native binary install block (lines 110-122)
     - Codex CLI npm install block (lines 124-132)
     - Gemini CLI npm install block (lines 134-142)

  4. KEEP everything else unchanged:
     - Multi-stage Node.js copy (lines 12-60)
     - System packages apt-get install (lines 34-52)
     - Babashka install (lines 62-67)
     - Gosu install (lines 69-76)
     - Gitleaks install (lines 78-94) - this is a security infrastructure tool, not a harness
     - tmux mouse mode config (lines 96-98)
     - entrypoint.sh and bashrc.aishell COPY (lines 144-152)

  5. KEEP `entrypoint-script` and `bashrc-content` defs completely unchanged.
  </action>
  <verify>
  Read the modified file and confirm:
  - No occurrences of WITH_CLAUDE, WITH_OPENCODE, WITH_CODEX, WITH_GEMINI in base-dockerfile
  - No occurrences of CLAUDE_VERSION, OPENCODE_VERSION, CODEX_VERSION, GEMINI_VERSION in base-dockerfile
  - No `npm install -g @anthropic-ai` or `npm install -g @openai/codex` or `npm install -g @google/gemini-cli` in base-dockerfile
  - No `opencode.ai/install` in base-dockerfile
  - Gitleaks install block is still present
  - "Foundation Image" appears in the header comment
  - entrypoint-script and bashrc-content are unchanged
  </verify>
  <done>base-dockerfile string contains only system dependencies (Debian, Node.js, babashka, gosu, gitleaks, tmux, system packages) with zero harness-related ARGs or installation blocks</done>
</task>

<task type="auto">
  <name>Task 2: Update build orchestration for foundation image</name>
  <files>src/aishell/docker/build.clj, src/aishell/cli.clj</files>
  <action>
  **In `build.clj`:**

  1. Change `base-image-tag` value from `"aishell:base"` to `"aishell:foundation"` (line 18). Also add a `foundation-image-tag` def pointing to same value, and keep `base-image-tag` as an alias for backward compat during transition:
     ```clojure
     (def foundation-image-tag "aishell:foundation")
     (def base-image-tag foundation-image-tag)
     ```

  2. REMOVE the `version-changed?` function entirely (lines 38-61). Foundation has no harness versions to track.

  3. SIMPLIFY `build-docker-args` (lines 70-85):
     - Remove all harness-related build args (WITH_CLAUDE, WITH_OPENCODE, WITH_CODEX, WITH_GEMINI and their version args)
     - Keep the WITH_GITLEAKS build arg (gitleaks stays in foundation)
     - Keep the dockerfile-hash label
     - The function signature should accept only `{:keys [with-gitleaks]} dockerfile-hash`

  4. SIMPLIFY `build-base-image` (lines 128-210):
     - Rename to `build-foundation-image`
     - Also define `build-base-image` as an alias: `(def build-base-image build-foundation-image)`
     - Remove the `version-changed?` call from cache check (line 154) - just use `needs-rebuild?`
     - Remove harness version printing from success output (lines 187-194)
     - Remove harness keys from return map (lines 199-206: :with-claude, :with-opencode, etc.)
     - Keep :with-gitleaks in the opts destructuring since it is still passed to build-docker-args
     - Update docstring to describe foundation image (system deps only)

  5. REMOVE `format-harness-line` function (lines 97-100) - no longer needed.

  **In `cli.clj`:**

  1. In `handle-build` (around line 169): Change `build/build-base-image` call to `build/build-foundation-image`. The opts map passed should KEEP all the harness flags for now (they will be used by Phase 36 volume logic), but the foundation build call only needs `{:with-gitleaks ..., :verbose ..., :force ...}`. Pass only those three keys to the foundation build. The harness flags remain in state persistence (lines 183-195) for use by Phase 36.

  2. In `handle-update` (around line 219): Same change - call `build/build-foundation-image` with only `{:with-gitleaks ..., :verbose ..., :force true}`. The harness version printing above (lines 209-216) should STAY because it shows what will be installed (Phase 36 will handle actual installation).

  3. Update the "Replacing existing image..." message (line 165) to reference `build/foundation-image-tag` instead of `build/base-image-tag`.

  4. Update state persistence (line 193) to save `:image-tag (:image result)` which will now be `"aishell:foundation"`.
  </action>
  <verify>
  Run: `grep -n "aishell:base" src/aishell/docker/build.clj` - should return nothing
  Run: `grep -n "version-changed?" src/aishell/docker/build.clj` - should return nothing
  Run: `grep -n "foundation" src/aishell/docker/build.clj` - should show tag definition and function name
  Run: `grep -n "build-foundation-image\|build-base-image" src/aishell/cli.clj` - should show foundation calls
  Run: `bb -cp src -e "(require 'aishell.docker.build) (println aishell.docker.build/base-image-tag)"` - should print "aishell:foundation"
  </verify>
  <done>build.clj defines foundation-image-tag as "aishell:foundation", build-foundation-image builds without harness args, cli.clj calls build-foundation-image with only gitleaks/verbose/force opts, state persists foundation tag</done>
</task>

</tasks>

<verification>
1. `grep -rn "WITH_CLAUDE\|WITH_OPENCODE\|WITH_CODEX\|WITH_GEMINI" src/aishell/docker/templates.clj` returns empty (no harness ARGs in template)
2. `grep -rn "aishell:base" src/aishell/docker/build.clj` returns empty (tag changed)
3. `grep -n "version-changed?" src/aishell/docker/build.clj` returns empty (function removed)
4. `bb -cp src -e "(require 'aishell.docker.build) (println aishell.docker.build/foundation-image-tag)"` prints "aishell:foundation"
5. Foundation Dockerfile template still contains: Debian, Node.js, babashka, gosu, gitleaks, tmux, system packages
</verification>

<success_criteria>
- Foundation Dockerfile template has zero harness-related content
- Image tag is "aishell:foundation" everywhere in build.clj
- build-foundation-image function exists and works without harness version logic
- CLI calls foundation build with only system-level options
- State file will record "aishell:foundation" as image-tag after build
</success_criteria>

<output>
After completion, create `.planning/phases/35-foundation-image-split/35-01-SUMMARY.md`
</output>
