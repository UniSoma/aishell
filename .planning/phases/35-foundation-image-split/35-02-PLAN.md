---
phase: 35-foundation-image-split
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - src/aishell/docker/extension.clj
  - src/aishell/run.clj
  - src/aishell/check.clj
autonomous: true

must_haves:
  truths:
    - "User's .aishell/Dockerfile using FROM aishell:base produces clear error with instructions to change to FROM aishell:foundation"
    - "Extension builds still work correctly when .aishell/Dockerfile uses FROM aishell:foundation"
    - "Runtime resolve-image-tag passes foundation tag to extension logic"
  artifacts:
    - path: "src/aishell/docker/extension.clj"
      provides: "validate-base-tag function that detects legacy FROM aishell:base"
      contains: "validate-base-tag"
    - path: "src/aishell/run.clj"
      provides: "Validation call before extension build in resolve-image-tag"
      contains: "validate-base-tag"
    - path: "src/aishell/check.clj"
      provides: "Validation call before extension rebuild check"
      contains: "validate-base-tag"
  key_links:
    - from: "src/aishell/run.clj"
      to: "src/aishell/docker/extension.clj"
      via: "ext/validate-base-tag call before build"
      pattern: "ext/validate-base-tag"
    - from: "src/aishell/check.clj"
      to: "src/aishell/docker/extension.clj"
      via: "ext/validate-base-tag call before rebuild check"
      pattern: "ext/validate-base-tag"
    - from: "src/aishell/docker/extension.clj"
      to: "output/error"
      via: "Error exit with migration instructions"
      pattern: "output/error"
---

<objective>
Add validation that detects legacy `FROM aishell:base` usage in project Dockerfiles and provides clear error messages with migration instructions. Wire this validation into extension build and run paths.

Purpose: Prevent silent breakage when users upgrade to v2.8.0 with existing `.aishell/Dockerfile` files that reference the old base tag.
Output: New validate-base-tag function in extension.clj, validation calls in run.clj and check.clj.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-foundation-image-split/35-RESEARCH.md
@.planning/phases/35-foundation-image-split/35-01-SUMMARY.md
@src/aishell/docker/extension.clj
@src/aishell/run.clj
@src/aishell/check.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validate-base-tag function to extension.clj</name>
  <files>src/aishell/docker/extension.clj</files>
  <action>
  Add a new public function `validate-base-tag` to extension.clj that:

  1. Takes `project-dir` as argument
  2. Uses existing `project-dockerfile` function to check if .aishell/Dockerfile exists
  3. If no Dockerfile exists, returns nil (no validation needed)
  4. If Dockerfile exists, reads its content with `slurp`
  5. Searches for `FROM aishell:base` using regex `#"(?i)FROM\s+aishell:base\b"` (case-insensitive, word boundary to avoid matching `aishell:base-something`)
  6. If found, calls `output/error` (which exits the process) with this exact message:

  ```
  Legacy base image tag in .aishell/Dockerfile

  Found:    FROM aishell:base
  Expected: FROM aishell:foundation

  Why: v2.8.0 splits the base image into a stable foundation layer and
       volume-mounted harness tools to prevent cascade rebuilds.

  Fix: Edit .aishell/Dockerfile and change:
       FROM aishell:base  ->  FROM aishell:foundation
  ```

  7. If not found, returns nil (Dockerfile is fine)

  Place the function after `project-dockerfile` and before `get-base-image-id` (around line 29).

  Also update the namespace docstring to mention validation: "Per-project Dockerfile extension support with legacy tag validation."
  </action>
  <verify>
  Read extension.clj and confirm:
  - `validate-base-tag` function exists
  - It uses `project-dockerfile` to check for Dockerfile existence
  - It uses regex with word boundary to match FROM aishell:base
  - Error message includes "FROM aishell:foundation" as the fix
  - Function is public (not defn-)
  </verify>
  <done>validate-base-tag function exists in extension.clj, detects FROM aishell:base with case-insensitive regex, exits with clear migration error message</done>
</task>

<task type="auto">
  <name>Task 2: Wire validation into extension build and run paths</name>
  <files>src/aishell/run.clj, src/aishell/check.clj</files>
  <action>
  **In `run.clj` - `resolve-image-tag` function (around line 41-57):**

  Add `ext/validate-base-tag` call BEFORE the extension rebuild check. Specifically, after the `if-let [_dockerfile (ext/project-dockerfile project-dir)]` check confirms a Dockerfile exists, call `(ext/validate-base-tag project-dir)` before `(ext/needs-extended-rebuild? ...)`. This ensures legacy tag detection happens before any build attempt.

  The modified flow should be:
  ```clojure
  (if-let [_dockerfile (ext/project-dockerfile project-dir)]
    (let [extended-tag (ext/compute-extended-tag project-dir)]
      ;; Validate base tag before attempting build
      (ext/validate-base-tag project-dir)
      (when (ext/needs-extended-rebuild? extended-tag base-tag project-dir)
        (ext/build-extended-image ...))
      extended-tag)
    base-tag)
  ```

  **In `check.clj` - around line 100 where `ext/needs-extended-rebuild?` is called:**

  Read check.clj first to understand the exact context. Add `(ext/validate-base-tag project-dir)` call before the `needs-extended-rebuild?` check, similar to run.clj. The validation should happen before any extension build logic.

  **Important:** Both files already require `aishell.docker.extension :as ext`, so no new requires needed.
  </action>
  <verify>
  Run: `grep -n "validate-base-tag" src/aishell/run.clj src/aishell/check.clj` - should show calls in both files
  Run: `bb -cp src -e "(require 'aishell.docker.extension) (println (aishell.docker.extension/validate-base-tag \"/tmp/nonexistent\"))"` - should print nil (no Dockerfile)

  Create a temp test:
  ```bash
  mkdir -p /tmp/test-aishell/.aishell
  echo "FROM aishell:base" > /tmp/test-aishell/.aishell/Dockerfile
  bb -cp src -e "(require 'aishell.docker.extension) (aishell.docker.extension/validate-base-tag \"/tmp/test-aishell\")" 2>&1 || true
  ```
  Should output error message containing "Legacy base image tag" and "FROM aishell:foundation".

  Then test the happy path:
  ```bash
  echo "FROM aishell:foundation" > /tmp/test-aishell/.aishell/Dockerfile
  bb -cp src -e "(require 'aishell.docker.extension) (println (aishell.docker.extension/validate-base-tag \"/tmp/test-aishell\"))"
  ```
  Should print nil (no error).

  Clean up: `rm -rf /tmp/test-aishell`
  </verify>
  <done>validate-base-tag is called in both run.clj (resolve-image-tag) and check.clj before extension build logic, legacy FROM aishell:base triggers clear error, FROM aishell:foundation passes silently</done>
</task>

</tasks>

<verification>
1. `grep -rn "validate-base-tag" src/` shows function definition in extension.clj and calls in run.clj and check.clj
2. Creating a test .aishell/Dockerfile with `FROM aishell:base` triggers error with migration instructions
3. Creating a test .aishell/Dockerfile with `FROM aishell:foundation` produces no error
4. Projects without .aishell/Dockerfile are unaffected (no validation needed)
5. `bb -cp src -e "(require 'aishell.docker.extension)"` loads without errors (namespace compiles)
</verification>

<success_criteria>
- validate-base-tag exists and is public in extension.clj
- Error message clearly states the problem, expected fix, and why the change happened
- Validation runs before any extension build attempt in both run and check paths
- Projects without .aishell/Dockerfile are unaffected
- Projects with FROM aishell:foundation work normally
</success_criteria>

<output>
After completion, create `.planning/phases/35-foundation-image-split/35-02-SUMMARY.md`
</output>
