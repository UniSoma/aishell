---
phase: 14-docker-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/spinner.clj
  - src/aishell/docker/hash.clj
autonomous: true

must_haves:
  truths:
    - "Spinner shows animated progress in TTY environments"
    - "Spinner shows static message in non-TTY/CI environments"
    - "Hash computation produces consistent 12-char hex strings"
    - "Same content always produces same hash"
  artifacts:
    - path: "src/aishell/docker/spinner.clj"
      provides: "Progress indicator for long-running builds"
      exports: ["should-animate?", "with-spinner"]
    - path: "src/aishell/docker/hash.clj"
      provides: "SHA-256 hashing for Dockerfile cache invalidation"
      exports: ["compute-hash"]
  key_links:
    - from: "src/aishell/docker/spinner.clj"
      to: "java.lang.System"
      via: "System/console for TTY detection"
      pattern: "System/console"
    - from: "src/aishell/docker/hash.clj"
      to: "java.security.MessageDigest"
      via: "SHA-256 computation"
      pattern: "MessageDigest/getInstance.*SHA-256"
---

<objective>
Create supporting utilities for Docker builds: spinner for progress feedback and hash computation for cache invalidation

Purpose: Build operations need progress indicators (spinner) and cache tracking (hash). These are reusable utilities separated from build logic.
Output: src/aishell/docker/spinner.clj and src/aishell/docker/hash.clj
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-docker-integration/14-CONTEXT.md
@.planning/phases/14-docker-integration/14-RESEARCH.md

# Existing modules for patterns
@src/aishell/output.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create spinner module for build progress</name>
  <files>src/aishell/docker/spinner.clj</files>
  <action>
Create src/aishell/docker/spinner.clj with:

1. Namespace: aishell.docker.spinner

2. Private constant:
   (def ^:private spinner-chars [\| \/ \- \\])

3. Functions:

should-animate? []
- Return true only when:
  - (some? (System/console)) - has terminal
  - (nil? (System/getenv "CI")) - not in CI
- Both conditions must be true

with-spinner [message f]
- If not should-animate?: print message to stderr, call (f), return result
- If animate:
  - Create (atom true) for running state
  - Start (future ...) that loops while @running:
    - Print \r + spinner char + " " + message + " " to *err*
    - (flush)
    - (Thread/sleep 100)
    - Increment counter for spinner char cycling
  - Call (f) in try block
  - In finally: (reset! running false)
  - Clear spinner line: print \r + spaces + \r to *err*
  - Return function result

Use (binding [*out* *err*] ...) for all progress output (stderr).
Match the pattern from 14-RESEARCH.md Simple Spinner Implementation.
  </action>
  <verify>
```bash
cd /home/jonasrodrigues/projects/harness && bb -e "
(require '[aishell.docker.spinner :as s])
(println \"Should animate:\" (s/should-animate?))
(println \"Testing spinner...\")
(s/with-spinner \"Working\" #(do (Thread/sleep 500) :done))
(println \"Result returned correctly\")"
```
Should show spinner animation (if TTY) or static message, then print "Result returned correctly"
  </verify>
  <done>
- spinner.clj exists in src/aishell/docker/
- should-animate? correctly detects TTY and CI environments
- with-spinner shows animated progress and returns function result
- Spinner cleans up properly (no leftover characters)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create hash module for Dockerfile caching</name>
  <files>src/aishell/docker/hash.clj</files>
  <action>
Create src/aishell/docker/hash.clj with:

1. Namespace: aishell.docker.hash
   (no requires needed - using Java interop directly)

2. Functions:

compute-hash [content]
- Use Java MessageDigest directly (no external deps):
  ```clojure
  (let [md (java.security.MessageDigest/getInstance "SHA-256")
        bytes (.digest md (.getBytes content "UTF-8"))]
    (subs (apply str (map #(format "%02x" (bit-and % 0xff)) bytes)) 0 12))
  ```
- Returns first 12 characters of SHA-256 hex string
- This matches existing bash behavior: sha256sum | cut -c1-12

Follow the pattern from 14-RESEARCH.md compute-dockerfile-hash-native exactly.
  </action>
  <verify>
```bash
cd /home/jonasrodrigues/projects/harness && bb -e "
(require '[aishell.docker.hash :as h])
(println (h/compute-hash \"test content\"))
(println (h/compute-hash \"test content\"))
(println (= (h/compute-hash \"a\") (h/compute-hash \"a\")))
(println (not= (h/compute-hash \"a\") (h/compute-hash \"b\")))"
```
Should print: same hash twice, true, true
  </verify>
  <done>
- hash.clj exists in src/aishell/docker/
- compute-hash returns 12-char hex string
- Same input produces same output (deterministic)
- Different inputs produce different outputs
  </done>
</task>

</tasks>

<verification>
Both modules work correctly:
```bash
cd /home/jonasrodrigues/projects/harness
bb -e "(require '[aishell.docker.spinner :as s] '[aishell.docker.hash :as h])
       (println \"Spinner ready:\" (fn? s/with-spinner))
       (println \"Hash ready:\" (fn? h/compute-hash))
       (println \"Test hash:\" (h/compute-hash \"FROM debian:bookworm-slim\"))"
```
</verification>

<success_criteria>
- src/aishell/docker/spinner.clj exists and works
- src/aishell/docker/hash.clj exists and works
- Spinner properly handles TTY vs non-TTY environments
- Hash computation matches expected 12-char format
</success_criteria>

<output>
After completion, create `.planning/phases/14-docker-integration/14-02-SUMMARY.md`
</output>
