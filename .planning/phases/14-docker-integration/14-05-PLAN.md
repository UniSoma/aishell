---
phase: 14-docker-integration
plan: 05
type: execute
wave: 3
depends_on: ["14-03", "14-04"]
files_modified:
  - src/aishell/cli.clj
  - src/aishell/output.clj
autonomous: false

must_haves:
  truths:
    - "User sees 'Docker not running' when daemon unavailable"
    - "User sees 'No image built. Run: aishell build' when image missing"
    - "Default command (no args) checks for image before proceeding"
    - "CLI structure ready to add build command in Phase 15"
  artifacts:
    - path: "src/aishell/cli.clj"
      provides: "Updated CLI with Docker integration hooks"
      modified: true
    - path: "src/aishell/output.clj"
      provides: "error-no-build function for missing image"
      modified: true
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/docker.clj"
      via: "check-docker! and image-exists?"
      pattern: "docker/check-docker!|docker/image-exists\\?"
---

<objective>
Integrate Docker checks into CLI and add "no image built" error message

Purpose: Users get clear feedback when Docker isn't running or image hasn't been built yet
Output: Updated cli.clj with Docker checks, output.clj with error-no-build function
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-docker-integration/14-CONTEXT.md

# Prior plan summaries
@.planning/phases/14-docker-integration/14-01-SUMMARY.md
@.planning/phases/14-docker-integration/14-03-SUMMARY.md
@.planning/phases/14-docker-integration/14-04-SUMMARY.md

# Current implementation
@src/aishell/cli.clj
@src/aishell/output.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add error-no-build to output module</name>
  <files>src/aishell/output.clj</files>
  <action>
Add to src/aishell/output.clj:

(defn error-no-build
  "Print error when no image has been built for the project"
  []
  (binding [*out* *err*]
    (println (str RED "Error:" NC " No image built. Run: " CYAN "aishell build" NC)))
  (System/exit 1))

This matches the success criteria: "No image built. Run: aishell build"
Keep the existing error-unknown-command and other functions unchanged.
  </action>
  <verify>
```bash
cd /home/jonasrodrigues/projects/harness && bb -e "
(require '[aishell.output :as o])
(println (fn? o/error-no-build))"
```
Should print true
  </verify>
  <done>
- error-no-build function exists in output.clj
- Outputs colored error message to stderr
- Includes hint to run "aishell build"
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLI to integrate Docker checks</name>
  <files>src/aishell/cli.clj</files>
  <action>
Update src/aishell/cli.clj:

1. Add require for docker module:
   [aishell.docker :as docker]

2. Update handle-default function to check Docker when no command given:

Current flow (lines 32-46):
- version/help handling
- unknown command error
- else: error about no image

New flow:
- version/help handling (unchanged)
- unknown command error (unchanged)
- else (default action - will be shell entry):
  - (docker/check-docker!)  ; exits if Docker unavailable
  - (output/error-no-build) ; for now, always say no image

Note: The actual image check will come in Phase 15 when we have state management.
For Phase 14, we just ensure Docker is checked and show the "no image" message.

The check-docker! function from docker.clj already handles:
- "Docker is not installed" error
- "Docker not running" error

So cli.clj just needs to call it before attempting any Docker operation.
  </action>
  <verify>
```bash
cd /home/jonasrodrigues/projects/harness && bb -e "
(require '[aishell.cli :as cli])
(require '[aishell.docker :as docker])
(println \"CLI loaded with docker integration\")"
```
Should print confirmation without errors
  </verify>
  <done>
- cli.clj requires aishell.docker
- Default action calls check-docker! before proceeding
- Clear error flow: Docker check -> image check -> proceed
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Docker integration with error messages for unavailable daemon and missing image</what-built>
  <how-to-verify>
1. Test Docker not running error (if you can stop Docker briefly):
   - Stop Docker daemon
   - Run: cd /home/jonasrodrigues/projects/harness && ./aishell.clj
   - Should see: "Error: Docker not running"

2. Test no image built error (with Docker running):
   - Ensure Docker is running
   - Run: cd /home/jonasrodrigues/projects/harness && ./aishell.clj
   - Should see: "Error: No image built. Run: aishell build"

3. Test version still works:
   - Run: cd /home/jonasrodrigues/projects/harness && ./aishell.clj --version
   - Should see: "aishell 2.0.0"

4. Test help still works:
   - Run: cd /home/jonasrodrigues/projects/harness && ./aishell.clj --help
   - Should see help text with commands

5. Test unknown command still works:
   - Run: cd /home/jonasrodrigues/projects/harness && ./aishell.clj badcmd
   - Should see: "Error: Unknown command: badcmd" with suggestion
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Phase 14 Docker integration complete:
- docker.clj: availability checks, image inspection
- docker/spinner.clj: progress indicators
- docker/hash.clj: SHA-256 for cache
- docker/build.clj: embedded templates, build logic (for Phase 15)
- docker/extension.clj: project Dockerfile support (for Phase 15)
- cli.clj: Docker checks integrated
- output.clj: error-no-build message
</verification>

<success_criteria>
Phase 14 success criteria met:
1. "Docker not running" error when daemon unavailable - check-docker! in docker.clj
2. "No image built. Run: aishell build" when no image - error-no-build in output.clj
3. Build from embedded Dockerfile template - templates.clj + build.clj (ready for Phase 15)
4. Cache builds via hash - hash.clj + needs-rebuild? in build.clj
5. Per-project Dockerfile extension - extension.clj (ready for Phase 15)
</success_criteria>

<output>
After completion, create `.planning/phases/14-docker-integration/14-05-SUMMARY.md`
</output>
