---
phase: 50-attach-command-rewrite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/attach.clj
  - src/aishell/cli.clj
  - src/aishell/docker/naming.clj
  - src/aishell/run.clj
autonomous: true

must_haves:
  truths:
    - "aishell attach <name> opens bash shell in running container"
    - "--session and --shell flags no longer accepted by attach"
    - "Attach validates TTY before attempting docker exec"
    - "Attach validates container exists and is running before exec"
    - "Attach takes a single positional argument, not --name flag"
  artifacts:
    - path: "src/aishell/attach.clj"
      provides: "Simplified attach module with attach-to-container function"
      contains: "attach-to-container"
    - path: "src/aishell/cli.clj"
      provides: "Updated attach dispatch with positional argument parsing"
      contains: "aishell attach <name>"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/attach.clj"
      via: "attach/attach-to-container call"
      pattern: "attach/attach-to-container"
    - from: "src/aishell/attach.clj"
      to: "docker exec -it"
      via: "p/exec process replacement"
      pattern: "p/exec.*docker.*exec.*-it"
---

<objective>
Rewrite the attach command from tmux session management to direct Docker exec bash attachment.

Purpose: With tmux removed from containers (Phases 46-49), attach no longer connects to tmux sessions. It becomes a simple docker exec -it bash wrapper with TTY and container state validation.

Output: Simplified attach.clj with single attach-to-container function, updated CLI dispatch accepting positional argument instead of --name flag.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/aishell/attach.clj
@src/aishell/cli.clj
@src/aishell/docker/naming.clj
@src/aishell/run.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite attach.clj - replace tmux functions with docker exec bash</name>
  <files>src/aishell/attach.clj</files>
  <action>
Rewrite src/aishell/attach.clj to remove all tmux logic and replace with direct docker exec bash.

KEEP these functions unchanged (they are NOT tmux-specific):
- resolve-term (validates TERM inside container via infocmp)
- validate-tty! (checks System/console for interactive terminal)
- validate-container-state! (checks container exists and is running)

UPDATE validate-container-state! error messages: change "aishell attach --name X" to "aishell attach X" in any guidance strings. Keep "--detach" references as-is (Phase 51 will remove those).

DELETE these functions entirely:
- validate-tmux-enabled! (tmux removed from containers)
- validate-session-exists! (no tmux sessions)
- ensure-bashrc! (dead code after Phase 49 entrypoint simplification)
- attach-to-session (replaced by attach-to-container)
- attach-shell (replaced by attach-to-container)

CREATE new public function attach-to-container:
```clojure
(defn attach-to-container
  "Attach to a running container by opening a bash shell.

   Performs pre-flight validations:
   1. Interactive terminal check
   2. Container exists and is running

   On success, uses p/exec to replace current process with docker exec,
   opening an interactive bash shell in the container."
  [name]
  (let [project-dir (System/getProperty "user.dir")
        container-name (naming/container-name project-dir name)]
    ;; Run all validations
    (validate-tty!)
    (validate-container-state! container-name name)

    ;; Resolve TERM valid inside the container (host TERM may lack terminfo)
    (let [term (resolve-term container-name)
          colorterm (or (System/getenv "COLORTERM") "truecolor")]
      ;; All checks passed - exec into bash (replaces current process)
      (p/exec "docker" "exec" "-it" "-u" "developer"
              "-e" (str "TERM=" term)
              "-e" (str "COLORTERM=" colorterm)
              "-e" "LANG=C.UTF-8"
              "-e" "LC_ALL=C.UTF-8"
              container-name
              "/bin/bash"))))
```

UPDATE the namespace docstring from "Attach to running container's tmux session" to "Attach to running container via docker exec bash."

The require list stays the same (babashka.process, clojure.string, aishell.docker.naming, aishell.output). clojure.string can be removed since only validate-session-exists! used str/split-lines and str/join, but it's harmless to keep. Remove it for cleanliness.

CRITICAL (from project memory): Before deleting any function, grep the entire src/ directory for all callers. SCI resolves symbols at analysis time, so even dead code paths will crash. The callers of deleted functions are:
- attach-to-session: called from cli.clj line 553 (will be updated in Task 2)
- attach-shell: called from cli.clj line 550 (will be updated in Task 2)
- validate-tmux-enabled!, validate-session-exists!, ensure-bashrc!: all private (defn-), only called within attach.clj itself
  </action>
  <verify>
Run: cd /home/jonasrodrigues/projects/harness && grep -rn "attach-to-session\|attach-shell\|validate-tmux-enabled\|validate-session-exists\|ensure-bashrc" src/aishell/attach.clj
Expected: No matches (all deleted functions gone from attach.clj)

Run: grep -rn "attach-to-container" src/aishell/attach.clj
Expected: Function definition present

Run: grep -rn "tmux" src/aishell/attach.clj
Expected: No matches (all tmux references removed)
  </verify>
  <done>
attach.clj contains only: resolve-term, validate-tty!, validate-container-state!, and attach-to-container. No tmux references remain. The module exports attach-to-container as its single public entry point.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLI dispatch and cross-file attach references</name>
  <files>src/aishell/cli.clj, src/aishell/docker/naming.clj, src/aishell/run.clj</files>
  <action>
Update all files that reference the old attach syntax to use the new positional argument pattern.

**src/aishell/cli.clj - Attach dispatch (lines ~508-553):**

Replace the entire "attach" case in the dispatch function. The new logic:
1. Parse rest-args (everything after "attach")
2. If -h or --help in rest-args: show updated help
3. If empty rest-args: show error with new usage
4. Otherwise: call (attach/attach-to-container (first rest-args))

New help text for attach:
```
Usage: aishell attach <name>

Attach to a running container (opens bash shell).

Options:
  -h, --help    Show this help

Examples:
  aishell attach claude
      Open bash shell in the 'claude' container

  aishell attach shell
      Open bash shell in the 'shell' container

Notes:
  Use 'aishell ps' to list running containers.
  The container must be running (started with 'aishell <harness> --detach').
```

Note: Keep the "--detach" reference in the notes since Phase 51 hasn't removed it yet.

New error message when no name provided:
```
Container name required.

Usage: aishell attach <name>

Use 'aishell ps' to list running containers.
```

The dispatch case should be simplified to:
```clojure
"attach" (let [rest-args (vec (rest clean-args))]
           (cond
             (some #{"-h" "--help"} rest-args)
             (do
               ;; print help
               )
             (empty? rest-args)
             (output/error "Container name required.\n\nUsage: aishell attach <name>\n\nUse 'aishell ps' to list running containers.")
             :else
             (attach/attach-to-container (first rest-args))))
```

No more --name, --session, --shell flag parsing. No more cli/parse-opts for attach.

**src/aishell/cli.clj - Attach help description (line ~106):**
Change the attach line in print-help from "Attach to running container" to keep it as-is (it's already generic enough).

**src/aishell/cli.clj - PS command hint (line ~456):**
Change `"\nTo attach: aishell attach --name <name>"` to `"\nTo attach: aishell attach <name>"`

**src/aishell/docker/naming.clj - ensure-name-available! (line ~99):**
Change `"To attach: aishell attach --name " harness-name` to `"To attach: aishell attach " harness-name`

**src/aishell/run.clj - detach mode message (line ~251):**
Change `"  Attach:  aishell attach --name " name-part` to `"  Attach:  aishell attach " name-part`

CRITICAL: After all changes, grep the entire src/ directory for "attach --name" to confirm no stale references remain. Also grep for "attach-to-session" and "attach-shell" to confirm no callers of deleted functions remain.
  </action>
  <verify>
Run: cd /home/jonasrodrigues/projects/harness && grep -rn "attach --name" src/
Expected: No matches (all --name references updated)

Run: grep -rn "attach-to-session\|attach-shell" src/
Expected: No matches (all callers updated to attach-to-container)

Run: grep -rn "\\-\\-session\|\\-\\-shell" src/aishell/cli.clj
Expected: No matches in attach section (flags removed)

Run: grep -rn "tmux" src/aishell/cli.clj | grep -i attach
Expected: No matches (tmux references removed from attach help/dispatch)

Run: bb -cp src -e "(require 'aishell.cli)" 2>&amp;1
Expected: No errors (SCI can resolve all symbols at analysis time)
  </verify>
  <done>
CLI dispatch calls attach/attach-to-container with positional argument. No --name, --session, or --shell flags in attach parsing. All cross-file references updated from "aishell attach --name X" to "aishell attach X". bb -cp src loads without symbol resolution errors.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "tmux" src/aishell/attach.clj` returns nothing
2. `grep -rn "attach --name" src/` returns nothing
3. `grep -rn "attach-to-session\|attach-shell\|ensure-bashrc\|validate-tmux-enabled\|validate-session-exists" src/` returns nothing
4. `grep -rn "attach-to-container" src/aishell/attach.clj` shows the function definition
5. `grep -rn "attach/attach-to-container" src/aishell/cli.clj` shows the call site
6. `bb -cp src -e "(require 'aishell.cli)"` succeeds without errors
</verification>

<success_criteria>
- aishell attach <name> calls docker exec -it -u developer ... /bin/bash
- --session and --shell flags completely removed from attach command
- --name flag replaced with positional argument
- TTY validation occurs before docker exec
- Container existence and running state validated before exec
- No tmux references remain in attach.clj
- No "attach --name" references remain anywhere in src/
- No dangling references to deleted functions (SCI analysis-time safe)
</success_criteria>

<output>
After completion, create `.planning/phases/50-attach-command-rewrite/50-01-SUMMARY.md`
</output>
