---
phase: 25-cli-runtime
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/run.clj
autonomous: true

must_haves:
  truths:
    - "Codex config directory (~/.codex/) is mounted when it exists"
    - "Gemini config directory (~/.gemini/) is mounted when it exists"
    - "CODEX_API_KEY environment variable is passed through"
    - "GEMINI_API_KEY and GOOGLE_API_KEY are passed through"
    - "GOOGLE_APPLICATION_CREDENTIALS file is mounted read-only when set"
  artifacts:
    - path: "src/aishell/docker/run.clj"
      provides: "Config mounts and env var passthrough for Codex/Gemini"
      contains: ".codex"
  key_links:
    - from: "src/aishell/docker/run.clj"
      to: "Docker container"
      via: "build-docker-args function"
      pattern: "codex.*gemini"
---

<objective>
Add Docker runtime support for Codex and Gemini harnesses.

Purpose: Enable Codex and Gemini CLIs to access their configuration directories and API keys when running inside containers.

Output: Updated docker/run.clj with config mounts, environment variable passthrough, and GCP credentials file mounting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-cli-runtime/25-RESEARCH.md
@src/aishell/docker/run.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Codex and Gemini config directory mounts</name>
  <files>src/aishell/docker/run.clj</files>
  <action>
Update the `build-harness-config-mounts` function to add Codex and Gemini config directories:

1. Add ~/.codex mount (Codex uses this for auth.json and config.toml):
   ```clojure
   [(str home "/.codex") (str home "/.codex")]
   ```

2. Add ~/.gemini mount (Gemini uses this for settings.json):
   ```clojure
   [(str home "/.gemini") (str home "/.gemini")]
   ```

The existing filter pattern `(filter (fn [[src _]] (fs/exists? src)))` already handles non-existent directories gracefully.

Placement: Add after the OpenCode config paths, before the closing bracket.
  </action>
  <verify>
Run REPL verification:
```bash
cd /home/jonasrodrigues/projects/harness && bb -e '
(require (quote [aishell.docker.run :as run]))
(let [mounts (str (run/build-harness-config-mounts))]
  (and (re-find #"codex" mounts) (re-find #"gemini" mounts)))'
```
Should return true (or nil if directories don't exist, which is fine).
  </verify>
  <done>
build-harness-config-mounts function includes ~/.codex and ~/.gemini paths in config-paths vector.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Codex and Gemini API key environment variables</name>
  <files>src/aishell/docker/run.clj</files>
  <action>
Update the `api-key-vars` def to include Codex and Gemini API keys:

1. Add "CODEX_API_KEY" - Used by Codex in exec mode
2. Add "GEMINI_API_KEY" - Primary Gemini API key
3. Add "GOOGLE_API_KEY" - Alternative Gemini API key
4. Add "GOOGLE_CLOUD_LOCATION" - Required for Vertex AI

Current api-key-vars already includes GOOGLE_APPLICATION_CREDENTIALS and GOOGLE_CLOUD_PROJECT.

Add after existing keys (OPENAI_API_KEY is a good anchor point since Codex also uses it).

Order:
```clojure
(def api-key-vars
  ["ANTHROPIC_API_KEY"
   "OPENAI_API_KEY"
   "CODEX_API_KEY"
   "GEMINI_API_KEY"
   "GOOGLE_API_KEY"
   "GROQ_API_KEY"
   "GITHUB_TOKEN"
   "AWS_ACCESS_KEY_ID"
   "AWS_SECRET_ACCESS_KEY"
   "AWS_REGION"
   "AWS_PROFILE"
   "AZURE_OPENAI_API_KEY"
   "AZURE_OPENAI_ENDPOINT"
   "GOOGLE_CLOUD_PROJECT"
   "GOOGLE_CLOUD_LOCATION"
   "GOOGLE_APPLICATION_CREDENTIALS"])
```
  </action>
  <verify>
Run REPL verification:
```bash
cd /home/jonasrodrigues/projects/harness && bb -e '
(require (quote [aishell.docker.run :as run]))
(let [vars run/api-key-vars]
  (and (some #{"CODEX_API_KEY"} vars)
       (some #{"GEMINI_API_KEY"} vars)
       (some #{"GOOGLE_API_KEY"} vars)
       (some #{"GOOGLE_CLOUD_LOCATION"} vars)))'
```
Should return true.
  </verify>
  <done>
api-key-vars includes CODEX_API_KEY, GEMINI_API_KEY, GOOGLE_API_KEY, and GOOGLE_CLOUD_LOCATION.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add GCP credentials file mount</name>
  <files>src/aishell/docker/run.clj</files>
  <action>
Add a new function to mount the GOOGLE_APPLICATION_CREDENTIALS file and integrate it into build-docker-args.

1. Add new private function after build-api-env-args:
```clojure
(defn- build-gcp-credentials-mount
  "Mount GCP service account credentials file if GOOGLE_APPLICATION_CREDENTIALS is set.
   The env var is passed through separately; this mounts the file it references."
  []
  (when-let [creds-path (System/getenv "GOOGLE_APPLICATION_CREDENTIALS")]
    (when (fs/exists? creds-path)
      ["-v" (str creds-path ":" creds-path ":ro")])))
```

2. In build-docker-args, add the mount after harness config mounts:
```clojure
;; GCP credentials file mount (for Vertex AI authentication)
(into (or (build-gcp-credentials-mount) []))
```

Place this after the `(into (build-harness-config-mounts))` line.

Why :ro? The credentials file is read-only; container should not modify it.
  </action>
  <verify>
Run REPL verification with mock env:
```bash
cd /home/jonasrodrigues/projects/harness && bb -e '
(require (quote [aishell.docker.run :as run]))
;; Function exists and returns nil when env not set
(nil? (run/build-gcp-credentials-mount))'
```
Should return true (since GOOGLE_APPLICATION_CREDENTIALS is likely not set).
  </verify>
  <done>
build-gcp-credentials-mount function exists and is called in build-docker-args.
GOOGLE_APPLICATION_CREDENTIALS file is mounted read-only when the env var is set and file exists.
  </done>
</task>

</tasks>

<verification>
All tasks verified with REPL checks. Run full verification:

```bash
cd /home/jonasrodrigues/projects/harness && bb -e '
(require (quote [aishell.docker.run :as run]))
(let [;; Check config mounts include codex/gemini paths
      mounts-fn-exists (fn? run/build-harness-config-mounts)
      ;; Check api-key-vars includes new keys
      vars run/api-key-vars
      has-codex-key (some #{"CODEX_API_KEY"} vars)
      has-gemini-key (some #{"GEMINI_API_KEY"} vars)
      has-google-key (some #{"GOOGLE_API_KEY"} vars)
      ;; Check GCP mount function exists
      gcp-fn-exists (fn? run/build-gcp-credentials-mount)]
  {:mounts-fn mounts-fn-exists
   :codex-key has-codex-key
   :gemini-key has-gemini-key
   :google-key has-google-key
   :gcp-fn gcp-fn-exists})'
```

Expected output: All values truthy.
</verification>

<success_criteria>
- build-harness-config-mounts includes ~/.codex and ~/.gemini paths
- api-key-vars includes CODEX_API_KEY, GEMINI_API_KEY, GOOGLE_API_KEY, GOOGLE_CLOUD_LOCATION
- build-gcp-credentials-mount function exists and is integrated into build-docker-args
- All REPL verifications pass
</success_criteria>

<output>
After completion, create `.planning/phases/25-cli-runtime/25-01-SUMMARY.md`
</output>
