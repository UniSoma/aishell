---
phase: 25-cli-runtime
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/cli.clj
  - src/aishell/run.clj
  - src/aishell/config.clj
  - src/aishell/output.clj
autonomous: true

must_haves:
  truths:
    - "User can run aishell codex [args] with arguments passing through"
    - "User can run aishell gemini [args] with arguments passing through"
    - "Codex harness not installed error shows correct build command"
    - "Gemini harness not installed error shows correct build command"
    - "harness_args.codex and harness_args.gemini are recognized in config.yaml"
    - "Help text shows codex and gemini commands"
  artifacts:
    - path: "src/aishell/cli.clj"
      provides: "CLI dispatch for codex and gemini commands"
      contains: "codex"
    - path: "src/aishell/run.clj"
      provides: "Harness verification and container command construction"
      contains: "Codex CLI"
    - path: "src/aishell/config.clj"
      provides: "Known harnesses validation"
      contains: "codex"
    - path: "src/aishell/output.clj"
      provides: "Command suggestions for typos"
      contains: "codex"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/run.clj"
      via: "run/run-container call"
      pattern: "codex.*run-container"
    - from: "src/aishell/run.clj"
      to: "container execution"
      via: "container-cmd case statement"
      pattern: "codex.*into.*merged-args"
---

<objective>
Add CLI dispatch and runtime support for Codex and Gemini harnesses.

Purpose: Enable users to run `aishell codex` and `aishell gemini` commands with proper argument pass-through, harness verification, and default args from config.yaml.

Output: Updated cli.clj (dispatch), run.clj (verification, command construction), config.clj (known-harnesses), output.clj (command suggestions).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-cli-runtime/25-RESEARCH.md
@src/aishell/cli.clj
@src/aishell/run.clj
@src/aishell/config.clj
@src/aishell/output.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add codex and gemini to CLI dispatch and help</name>
  <files>src/aishell/cli.clj</files>
  <action>
Update cli.clj to route codex and gemini commands and update help text:

1. In the `dispatch` function case statement (around line 243-246), add codex and gemini cases after opencode:
```clojure
(case (first clean-args)
  "claude" (run/run-container "claude" (vec (rest clean-args)) {:unsafe unsafe?})
  "opencode" (run/run-container "opencode" (vec (rest clean-args)) {:unsafe unsafe?})
  "codex" (run/run-container "codex" (vec (rest clean-args)) {:unsafe unsafe?})
  "gemini" (run/run-container "gemini" (vec (rest clean-args)) {:unsafe unsafe?})
  "gitleaks" (run/run-container "gitleaks" (vec (rest clean-args)) {:unsafe unsafe? :skip-pre-start true})
  ;; rest of dispatch
```

2. In `print-help` function (around line 79-82), add codex and gemini commands after opencode:
```clojure
(println (str "  " output/CYAN "claude" output/NC "     Run Claude Code"))
(println (str "  " output/CYAN "opencode" output/NC "   Run OpenCode"))
(println (str "  " output/CYAN "codex" output/NC "      Run Codex CLI"))
(println (str "  " output/CYAN "gemini" output/NC "     Run Gemini CLI"))
(println (str "  " output/CYAN "gitleaks" output/NC "   Run Gitleaks secret scanner"))
```

3. In `print-help` function examples section (around line 90), update to show codex/gemini:
```clojure
(println (str "  " output/CYAN "aishell build --with-claude" output/NC "     Build with Claude Code"))
(println (str "  " output/CYAN "aishell claude" output/NC "                  Run Claude Code"))
(println (str "  " output/CYAN "aishell codex" output/NC "                   Run Codex CLI"))
(println (str "  " output/CYAN "aishell" output/NC "                         Enter shell"))
```
  </action>
  <verify>
Grep verification:
```bash
cd /home/jonasrodrigues/projects/harness && grep -c '"codex"' src/aishell/cli.clj && grep -c '"gemini"' src/aishell/cli.clj
```
Should show at least 2 occurrences each (dispatch + help).
  </verify>
  <done>
cli.clj dispatch routes codex and gemini commands to run-container.
Help text includes codex and gemini commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add codex and gemini to run.clj harness verification and command construction</name>
  <files>src/aishell/run.clj</files>
  <action>
Update run.clj to verify Codex/Gemini installation and construct container commands:

1. Update `verify-harness-available` function (around line 18-27) to include codex and gemini cases:
```clojure
(defn- verify-harness-available
  "Check that harness was included in build. Exit with error if not."
  [harness-name state-key state]
  (when-not (get state state-key)
    (output/error
      (str (case harness-name
             "claude" "Claude Code"
             "opencode" "OpenCode"
             "codex" "Codex CLI"
             "gemini" "Gemini CLI")
           " not installed. Run: aishell build --with-"
           harness-name))))
```

2. Update the verification case statement in run-container (around line 83-86) to include codex and gemini:
```clojure
(case cmd
  "claude" (verify-harness-available "claude" :with-claude state)
  "opencode" (verify-harness-available "opencode" :with-opencode state)
  "codex" (verify-harness-available "codex" :with-codex state)
  "gemini" (verify-harness-available "gemini" :with-gemini state)
  nil)
```

3. Update container-cmd case statement (around line 151-163) to include codex and gemini:
```clojure
container-cmd (case cmd
                "claude"
                (into ["claude" "--dangerously-skip-permissions"]
                      merged-args)

                "opencode"
                (into ["opencode"] merged-args)

                "codex"
                (into ["codex"] merged-args)

                "gemini"
                (into ["gemini"] merged-args)

                "gitleaks"
                (into ["gitleaks"] harness-args)

                ;; Default: bash shell
                ["/bin/bash"])
```

Note: Both codex and gemini use simple pass-through like opencode (no special flags needed).
  </action>
  <verify>
Grep verification:
```bash
cd /home/jonasrodrigues/projects/harness && grep -c '"codex"' src/aishell/run.clj && grep -c '"gemini"' src/aishell/run.clj
```
Should show at least 3 occurrences each (verify-harness-available case, verification call, container-cmd case).
  </verify>
  <done>
run.clj verifies Codex/Gemini installation status before running.
run.clj constructs correct container commands for Codex and Gemini.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add codex and gemini to config.clj known-harnesses and output.clj known-commands</name>
  <files>src/aishell/config.clj, src/aishell/output.clj</files>
  <action>
1. In config.clj, update `known-harnesses` set (around line 13-15):
```clojure
(def known-harnesses
  "Valid harness names for harness_args validation."
  #{"claude" "opencode" "codex" "gemini"})
```

2. In output.clj, update `known-commands` set (around line 19):
```clojure
(def known-commands #{"build" "update" "claude" "opencode" "codex" "gemini" "gitleaks"})
```

This ensures:
- Config validation accepts harness_args.codex and harness_args.gemini without warning
- Typo suggestions include codex and gemini commands
  </action>
  <verify>
Grep verification:
```bash
cd /home/jonasrodrigues/projects/harness && grep 'known-harnesses' src/aishell/config.clj && grep 'known-commands' src/aishell/output.clj
```
Both should show codex and gemini in the sets.
  </verify>
  <done>
config.clj known-harnesses includes "codex" and "gemini".
output.clj known-commands includes "codex" and "gemini".
  </done>
</task>

</tasks>

<verification>
All tasks verified with grep checks. Run comprehensive verification:

```bash
cd /home/jonasrodrigues/projects/harness

# 1. Dispatch routes exist
echo "=== CLI Dispatch ==="
grep -n '"codex"' src/aishell/cli.clj | head -3
grep -n '"gemini"' src/aishell/cli.clj | head -3

# 2. Run.clj has all three occurrences
echo "=== Run Verification ==="
grep -c 'codex' src/aishell/run.clj
grep -c 'gemini' src/aishell/run.clj

# 3. Known harnesses/commands
echo "=== Known Sets ==="
grep 'known-harnesses' src/aishell/config.clj
grep 'known-commands' src/aishell/output.clj

# 4. Compile check
echo "=== Compile Check ==="
bb -e '(require (quote [aishell.cli :as cli]) (quote [aishell.run :as run]) (quote [aishell.config :as config]) (quote [aishell.output :as output])) :ok'
```

Expected: All greps show codex/gemini, compile check returns :ok
</verification>

<success_criteria>
- `aishell codex [args]` routes to run-container with "codex" command
- `aishell gemini [args]` routes to run-container with "gemini" command
- verify-harness-available handles codex and gemini with correct error messages
- container-cmd constructs correct command vectors for codex and gemini
- known-harnesses includes codex and gemini (no config warnings)
- known-commands includes codex and gemini (typo suggestions work)
- Help text shows codex and gemini commands
- All files compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/25-cli-runtime/25-02-SUMMARY.md`
</output>
