---
phase: 38-volume-cleanup-documentation
plan: 03
type: execute
wave: 3
depends_on: ["38-01", "38-02"]
files_modified:
  - README.md
  - CHANGELOG.md
  - docs/ARCHITECTURE.md
  - docs/CONFIGURATION.md
  - docs/HARNESSES.md
  - docs/TROUBLESHOOTING.md
  - docs/DEVELOPMENT.md
autonomous: true

must_haves:
  truths:
    - "README.md reflects foundation/volume architecture and new commands"
    - "ARCHITECTURE.md documents 2-tier architecture (foundation image + harness volume)"
    - "CONFIGURATION.md documents harness flags and version pinning"
    - "HARNESSES.md documents volume-based harness tool management"
    - "TROUBLESHOOTING.md includes volume-related troubleshooting"
    - "DEVELOPMENT.md documents foundation build and volume population internals"
    - "CHANGELOG.md has single v2.8.0 entry covering phases 35-38"
  artifacts:
    - path: "CHANGELOG.md"
      provides: "v2.8.0 changelog entry"
      contains: "v2.8.0"
    - path: "docs/ARCHITECTURE.md"
      provides: "Foundation/volume architecture documentation"
      contains: "foundation"
    - path: "README.md"
      provides: "Updated usage with volumes command"
      contains: "volumes"
  key_links:
    - from: "README.md"
      to: "docs/ARCHITECTURE.md"
      via: "See docs/ARCHITECTURE.md reference"
      pattern: "ARCHITECTURE"
    - from: "CHANGELOG.md"
      to: "README.md"
      via: "v2.8.0 version reference"
      pattern: "2.8.0"
---

<objective>
Update all documentation files and create v2.8.0 changelog entry covering the foundation/volume architecture changes from phases 35-38.

Purpose: Documentation must reflect the new 2-tier architecture (foundation image + harness volume), new commands (update redesign, volumes), and changed behavior so users understand how to manage their environments.

Output: Updated README.md, CHANGELOG.md, docs/ARCHITECTURE.md, docs/CONFIGURATION.md, docs/HARNESSES.md, docs/TROUBLESHOOTING.md, docs/DEVELOPMENT.md
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-volume-cleanup-documentation/38-CONTEXT.md
@README.md
@CHANGELOG.md
@docs/ARCHITECTURE.md
@docs/CONFIGURATION.md
@docs/HARNESSES.md
@docs/TROUBLESHOOTING.md
@docs/DEVELOPMENT.md
@src/aishell/cli.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update README.md, CHANGELOG.md, and version bump</name>
  <files>README.md, CHANGELOG.md, src/aishell/cli.clj</files>
  <action>
  1. Bump version in `src/aishell/cli.clj`: change `(def version "2.7.1")` to `(def version "2.8.0")`

  2. Update README.md:
     - Update any version references from 2.7.x to 2.8.0
     - Add `volumes` to the commands list/table
     - Update the `update` command description to reflect new behavior (refresh harness tools, --force for foundation rebuild)
     - Add brief mention of foundation/volume architecture in overview (if applicable)
     - Ensure build examples show --with-claude, --with-opencode flags
     - Add `aishell volumes` and `aishell volumes prune` to usage examples

  3. Add v2.8.0 changelog entry to CHANGELOG.md (at top, before any existing entries):
     ```markdown
     ## v2.8.0 - Decouple Harness Tools

     Split monolithic base image into stable foundation layer and volume-mounted harness tools.
     Harness version updates no longer force multi-gigabyte extension rebuilds.

     ### Changed
     - **Architecture:** 2-tier system — foundation image (Debian, Node.js, system tools) + harness volume (npm packages, binaries)
     - **`aishell update`:** Now refreshes harness volume only (delete + recreate for clean slate). Use `--force` to also rebuild foundation image.
     - **Image tag:** `aishell:base` renamed to `aishell:foundation` (backward-compat error message guides migration)
     - **Extension cache:** Invalidation now uses foundation image ID, not base image ID

     ### Added
     - **`aishell volumes`** command to list harness volumes with active/orphaned status
     - **`aishell volumes prune`** to remove orphaned harness volumes
     - **`aishell update --force`** flag to rebuild foundation image alongside volume refresh
     - **OpenCode binary installation** via GitHub releases (separate from npm harnesses)
     - **Volume-based harness tools** mounted read-only at `/tools` in containers
     - **`/etc/profile.d/aishell.sh`** for tmux new-window environment consistency
     - Harness volume labels for metadata (hash, version, harness list)

     ### Fixed
     - Harness version updates no longer invalidate Docker extension cache
     - tmux new-window sessions now inherit harness tool PATH correctly

     ### Internal
     - State schema: added `foundation-hash`, `harness-volume-hash`, `harness-volume-name` fields
     - `dockerfile-hash` deprecated in favor of `foundation-hash` (still written for backward compat)
     - Foundation image builds only on Dockerfile template changes
     - Per-project volumes keyed by harness combination hash (shared across identical configs)
     ```
  </action>
  <verify>
  - `grep "2.8.0" src/aishell/cli.clj` shows version bump
  - `grep "2.8.0" CHANGELOG.md` shows changelog entry
  - `grep "volumes" README.md` shows new command documented
  </verify>
  <done>
  - Version bumped to 2.8.0 in cli.clj
  - CHANGELOG.md has comprehensive v2.8.0 entry covering all phases 35-38 changes
  - README.md reflects new commands and architecture
  </done>
</task>

<task type="auto">
  <name>Task 2: Update docs/ files for foundation/volume architecture</name>
  <files>docs/ARCHITECTURE.md, docs/CONFIGURATION.md, docs/HARNESSES.md, docs/TROUBLESHOOTING.md, docs/DEVELOPMENT.md</files>
  <action>
  Read each file first, then make targeted updates:

  1. **docs/ARCHITECTURE.md** — Document the 2-tier architecture:
     - Add section on foundation image vs harness volume separation
     - Explain what goes in foundation (Debian, Node.js, git, tmux, babashka, gosu, gitleaks) vs what goes in volume (npm harness packages, OpenCode binary)
     - Explain volume naming: `aishell-harness-{hash}` where hash is derived from enabled harnesses + versions
     - Explain volume sharing: identical configurations share volumes across projects
     - Explain mount point: volume mounted read-only at `/tools` with `/tools/npm` for npm packages and `/tools/bin` for binaries
     - Explain PATH setup: `/tools/npm/bin` and `/tools/bin` prepended via entrypoint + profile.d

  2. **docs/CONFIGURATION.md** — Update build configuration:
     - Ensure harness flags documented: --with-claude, --with-opencode, --with-codex, --with-gemini
     - Document version pinning: --with-claude=2.0.22
     - Document --without-gitleaks
     - Add update command configuration: `aishell update` vs `aishell update --force`
     - Note that update uses last build config (no harness selection flags)

  3. **docs/HARNESSES.md** — Update harness management:
     - Explain volume-based installation (not baked into image)
     - Document that harness updates via `aishell update` don't require image rebuild
     - Document OpenCode as Go binary (separate from npm packages)
     - Add volume management section: `aishell volumes`, `aishell volumes prune`

  4. **docs/TROUBLESHOOTING.md** — Add volume troubleshooting:
     - "Harness command not found" -> check if volume is populated, run `aishell build` or `aishell update`
     - "Volume disk usage growing" -> use `aishell volumes` to check for orphaned volumes, `aishell volumes prune` to clean up
     - "Update seems to hang" -> volume population downloads npm packages, may be slow on first run or slow network
     - "tmux new window missing tools" -> should be fixed in v2.8.0 via /etc/profile.d/aishell.sh
     - "Legacy FROM aishell:base error" -> change to FROM aishell:foundation in .aishell/Dockerfile

  5. **docs/DEVELOPMENT.md** — Update internals documentation:
     - Document key files: templates.clj, build.clj, volume.clj, run.clj, state.clj
     - Explain build flow: foundation image build -> volume hash computation -> volume creation -> volume population
     - Explain state schema v2.8.0 fields
     - Document volume population: temporary container with --rm, npm install to /tools/npm, binary download to /tools/bin
     - Document extension cache invalidation: uses foundation image ID label
  </action>
  <verify>
  - `grep -l "foundation" docs/*.md` returns at least ARCHITECTURE.md and DEVELOPMENT.md
  - `grep -l "volumes" docs/*.md` returns at least HARNESSES.md and TROUBLESHOOTING.md
  - `grep "volume" docs/ARCHITECTURE.md` shows volume architecture documented
  - All 5 docs files have been updated (check git diff)
  </verify>
  <done>
  - ARCHITECTURE.md documents 2-tier foundation/volume architecture
  - CONFIGURATION.md documents build flags and update command
  - HARNESSES.md documents volume-based harness management
  - TROUBLESHOOTING.md includes volume-related troubleshooting entries
  - DEVELOPMENT.md documents build flow and state schema internals
  - All documentation consistent with implemented behavior
  </done>
</task>

</tasks>

<verification>
1. All 7 files updated: README.md, CHANGELOG.md, docs/ARCHITECTURE.md, docs/CONFIGURATION.md, docs/HARNESSES.md, docs/TROUBLESHOOTING.md, docs/DEVELOPMENT.md
2. Version bumped to 2.8.0 in src/aishell/cli.clj
3. CHANGELOG.md has single comprehensive v2.8.0 entry
4. All docs reference foundation/volume architecture consistently
5. New commands (volumes, volumes prune, update --force) documented
6. No stale references to old "base image" monolithic architecture
</verification>

<success_criteria>
- v2.8.0 changelog covers all changes from phases 35-38 in a single entry
- All six docs/ files updated to reflect foundation/volume architecture
- README.md shows current command set including volumes
- Version bumped to 2.8.0
- Documentation is internally consistent (no contradictions between files)
</success_criteria>

<output>
After completion, create `.planning/phases/38-volume-cleanup-documentation/38-03-SUMMARY.md`
</output>
