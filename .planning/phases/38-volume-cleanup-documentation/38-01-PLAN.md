---
phase: 38-volume-cleanup-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/cli.clj
  - src/aishell/output.clj
autonomous: true

must_haves:
  truths:
    - "`aishell update` repopulates harness volume unconditionally (delete + recreate)"
    - "`aishell update --force` rebuilds foundation image AND repopulates harness volume"
    - "`aishell update` shows target harness versions during repopulation (before/after diff deferred — would require querying volume contents before deletion, marginal value)"
    - "`aishell update` does not accept harness selection flags (uses last build config)"
    - "`aishell update` with no harnesses enabled succeeds silently (no volume work)"
    - "`aishell update` with no prior build shows error directing to `aishell build`"
  artifacts:
    - path: "src/aishell/cli.clj"
      provides: "Redesigned handle-update function"
      contains: "remove-volume"
    - path: "src/aishell/cli.clj"
      provides: "Updated update-spec with --force flag"
      contains: ":force"
    - path: "src/aishell/output.clj"
      provides: "volumes command in known-commands set"
      contains: "volumes"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/docker/volume.clj"
      via: "vol/remove-volume then vol/create-volume then vol/populate-volume"
      pattern: "remove-volume.*create-volume.*populate-volume"
---

<objective>
Redesign `aishell update` to focus on harness volume refresh instead of foundation image rebuild.

Purpose: The update command currently rebuilds the foundation image every time (always --no-cache). With the volume-based architecture, update should focus on refreshing harness tools to latest versions. Foundation rebuild becomes opt-in via --force.

Output: Updated handle-update function with unconditional volume repopulation (delete + recreate), --force flag for foundation rebuild, and target version display.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-volume-cleanup-documentation/38-CONTEXT.md
@.planning/phases/38-volume-cleanup-documentation/38-RESEARCH.md
@src/aishell/cli.clj
@src/aishell/docker/volume.clj
@src/aishell/state.clj
@src/aishell/output.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Redesign handle-update and update-spec in cli.clj</name>
  <files>src/aishell/cli.clj, src/aishell/output.clj</files>
  <action>
  1. Update `update-spec` to add --force flag:
     ```clojure
     (def update-spec
       {:force   {:coerce :boolean :desc "Also rebuild foundation image (--no-cache)"}
        :verbose {:alias :v :coerce :boolean :desc "Show full build and install output"}
        :help    {:alias :h :coerce :boolean :desc "Show update help"}})
     ```

  2. Add `print-update-help` function (following print-build-help pattern):
     - Usage: `aishell update [OPTIONS]`
     - Description: "Refresh harness tools to latest versions using existing configuration."
     - Options: --force, --verbose, --help
     - Notes: Refreshes harnesses from last build, to change harnesses use `aishell build`, volume is deleted and recreated for clean slate
     - Examples: `aishell update`, `aishell update --force`

  3. Rewrite `handle-update` function. The new logic:
     a. Read state. Error if no state file exists ("No previous build found. Run: aishell build").
     b. If --help, show print-update-help and return.
     c. Print "Updating with preserved configuration..." and list enabled harnesses with target versions (same display as current).
     d. If --force: rebuild foundation image with `build/build-foundation-image` using `{:with-gitleaks (:with-gitleaks state true) :verbose (:verbose opts) :force true}`.
     e. If NO --force: skip foundation rebuild entirely (this is the key behavioral change).
     f. Volume repopulation (unconditional, delete + recreate):
        - Check if any harness is enabled: `(some #(get state %) [:with-claude :with-opencode :with-codex :with-gemini])`
        - If harnesses enabled:
          - Get volume-name from state: `(:harness-volume-name state)` — if nil, compute it from `(vol/volume-name (vol/compute-harness-hash state))`
          - Print "Repopulating harness volume..."
          - Delete existing volume: `(vol/remove-volume volume-name)`
          - Create volume with labels: `(vol/create-volume volume-name {"aishell.harness.hash" (:harness-volume-hash state) "aishell.harness.version" "2.8.0"})`
          - Populate volume: `(vol/populate-volume volume-name state {:verbose (:verbose opts)})`
          - If populate fails, remove volume and call `(output/error "Failed to populate harness volume")`
        - If no harnesses enabled: print "No harnesses enabled. Nothing to update." (silent success, no error)
     g. Update state with new build-time (and foundation-hash if --force was used). Do NOT change harness-volume-hash or harness-volume-name (config didn't change).

  4. Add "volumes" to `known-commands` set in output.clj (for typo suggestions).

  5. Update the help text for `update` in `print-help`: change "Rebuild with latest versions" to "Refresh harness tools to latest versions".
  </action>
  <verify>
  - `bb -e '(load-file "src/aishell/cli.clj")'` compiles without errors
  - `grep -c "remove-volume" src/aishell/cli.clj` returns at least 1 (unconditional delete)
  - `grep ":force" src/aishell/cli.clj` shows force in update-spec
  - `grep "volumes" src/aishell/output.clj` shows volumes in known-commands
  </verify>
  <done>
  - `aishell update` repopulates harness volume unconditionally (delete + recreate) WITHOUT rebuilding foundation
  - `aishell update --force` rebuilds foundation AND repopulates volume
  - `aishell update` shows target versions during repopulation
  - `aishell update --help` shows help with --force documentation
  - No harness selection flags accepted by update command
  - No harnesses enabled results in informational message, not error
  </done>
</task>

</tasks>

<verification>
1. `bb -e '(load-file "src/aishell/cli.clj")'` compiles successfully
2. handle-update function contains vol/remove-volume call (unconditional delete)
3. handle-update function contains conditional foundation rebuild (only with --force)
4. update-spec contains :force flag
5. "volumes" appears in known-commands set in output.clj
6. print-help shows updated description for update command
</verification>

<success_criteria>
- handle-update redesigned: default = volume refresh only, --force = foundation + volume
- Volume repopulation uses delete-and-recreate strategy (clean slate)
- aishell update shows target versions (not before/after diff — would require pre-deletion volume query for marginal value)
- Help text clearly explains separation between build (select harnesses) and update (refresh existing)
- Edge case: no harnesses enabled handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/38-volume-cleanup-documentation/38-01-SUMMARY.md`
</output>
