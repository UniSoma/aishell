---
phase: 33-attach-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/attach.clj
  - src/aishell/cli.clj
autonomous: true

must_haves:
  truths:
    - "aishell attach --name <name> connects to running container's default tmux session 'main'"
    - "aishell attach --name <name> --session <session> connects to a specific tmux session"
    - "Attaching to non-existent container shows clear error with guidance (not raw Docker error)"
    - "Attaching to stopped container shows clear error with restart guidance"
    - "User can detach with Ctrl+B D and container continues running"
    - "Multiple clients can attach to same container simultaneously (tmux native)"
  artifacts:
    - path: "src/aishell/attach.clj"
      provides: "Attach command implementation with pre-flight validations"
      min_lines: 60
    - path: "src/aishell/cli.clj"
      provides: "CLI dispatch integration for attach subcommand"
      contains: "attach"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/attach.clj"
      via: "require and function call in dispatch case"
      pattern: "attach/attach-to-session"
    - from: "src/aishell/attach.clj"
      to: "src/aishell/docker/naming.clj"
      via: "container-name, container-exists?, container-running?"
      pattern: "naming/container"
    - from: "src/aishell/attach.clj"
      to: "docker exec -it"
      via: "p/exec for terminal takeover"
      pattern: "p/exec.*docker.*exec.*-it"
---

<objective>
Implement the `aishell attach` command that reconnects users to running containers' tmux sessions.

Purpose: Complete the detached-mode workflow (Phase 32) by providing the reconnection path. Users start containers with `aishell claude --detach`, then reconnect with `aishell attach --name claude`.

Output: New `src/aishell/attach.clj` namespace and CLI integration in `src/aishell/cli.clj`.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-attach-command/33-RESEARCH.md

@src/aishell/cli.clj
@src/aishell/docker/naming.clj
@src/aishell/output.clj
@src/aishell/run.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create attach.clj with pre-flight validations and docker exec</name>
  <files>src/aishell/attach.clj</files>
  <action>
Create `src/aishell/attach.clj` with namespace `aishell.attach`.

Required requires:
- `[babashka.process :as p]`
- `[clojure.string :as str]`
- `[aishell.docker.naming :as naming]`
- `[aishell.output :as output]`

Implement these private validation functions:

1. `validate-tty!` — Check `(System/console)` is not nil. If nil, call `(output/error "Attach requires an interactive terminal.\nCannot attach from non-interactive contexts (scripts, pipes, CI).")`.

2. `validate-container-state!` [container-name short-name] — Two checks:
   - If `(naming/container-exists? container-name)` is false: error with "Container '<short-name>' not found." and suggest `aishell ps` and how to start.
   - If `(naming/container-running? container-name)` is false: error with "Container '<short-name>' is not running." and suggest how to start with `--detach`.

3. `validate-session-exists!` [container-name session-name short-name] — Use `(p/shell {:out :string :err :string :continue true} "docker" "exec" container-name "tmux" "has-session" "-t" session-name)`. If exit is non-zero:
   - Run `tmux list-sessions` in container to get available sessions.
   - If sessions exist, show them in error message.
   - If no sessions, show "No tmux sessions found" with restart guidance.

Implement the public function:

4. `attach-to-session` — Two arities: `([name])` calls `(attach-to-session name "main")`, and `([name session])`:
   - Compute `project-dir` from `(System/getProperty "user.dir")`
   - Compute `container-name` from `(naming/container-name project-dir name)`
   - Call all three validations in order: tty, container-state, session-exists
   - On success: `(p/exec "docker" "exec" "-it" container-name "tmux" "attach-session" "-t" session)`

CRITICAL: Use `p/exec` (NOT `p/shell`) for the final docker exec. This replaces the current process, giving tmux full terminal control. Do NOT wrap tmux command in `sh -c` — pass each argument directly to avoid TTY allocation failures.

CRITICAL: Use `defn-` for private validation functions (Babashka convention in this codebase).
  </action>
  <verify>
Verify file exists and compiles:
```
bb -e "(require '[aishell.attach])" 2>&1
```
Should load without errors (may warn about missing Docker, that's OK).

Verify the public function exists:
```
grep "defn attach-to-session" src/aishell/attach.clj
```

Verify p/exec is used (not p/shell) for the final docker exec:
```
grep "p/exec" src/aishell/attach.clj
```

Verify no sh -c wrapping:
```
grep -c "sh.*-c" src/aishell/attach.clj
```
Should return 0.
  </verify>
  <done>
- `src/aishell/attach.clj` exists with ~70-100 lines
- `attach-to-session` function with 2 arities (default session "main")
- Three pre-flight validations: TTY, container state, session existence
- Uses `p/exec` for terminal takeover (not p/shell)
- Uses `naming/container-name`, `naming/container-exists?`, `naming/container-running?` from Phase 30
- Error messages are user-friendly with actionable guidance
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate attach into CLI dispatch and help</name>
  <files>src/aishell/cli.clj</files>
  <action>
Modify `src/aishell/cli.clj` to add the attach command:

1. Add require: Add `[aishell.attach :as attach]` to the ns requires.

2. Add "attach" case to the dispatch function: In the `(case (first clean-args) ...)` block, add between "exec" and "claude":
```clojure
"attach" (let [rest-args (vec (rest clean-args))
               parsed (cli/parse-opts rest-args {:spec {:name {} :session {} :help {:alias :h :coerce :boolean}}})
               opts (:opts parsed)]
           (cond
             (:help opts)
             (do
               (println (str output/BOLD "Usage:" output/NC " aishell attach --name <name> [OPTIONS]"))
               (println)
               (println "Attach to a running container's tmux session.")
               (println)
               (println (str output/BOLD "Options:" output/NC))
               (println "  --name <name>       Container name to attach to")
               (println "  --session <session>  Tmux session name (default: main)")
               (println "  -h, --help           Show this help")
               (println)
               (println (str output/BOLD "Examples:" output/NC))
               (println (str "  " output/CYAN "aishell attach --name claude" output/NC))
               (println (str "      Attach to the 'claude' container's main session"))
               (println)
               (println (str "  " output/CYAN "aishell attach --name experiment --session debug" output/NC))
               (println (str "      Attach to specific session in 'experiment' container"))
               (println)
               (println (str output/BOLD "Notes:" output/NC))
               (println "  Press Ctrl+B then D to detach without stopping the container.")
               (println "  Multiple users can attach to the same container simultaneously."))

             (not (:name opts))
             (output/error "Container name required.\n\nUsage: aishell attach --name <name>\n\nUse 'aishell ps' to list running containers.")

             :else
             (attach/attach-to-session (:name opts) (or (:session opts) "main"))))
```

3. Add "attach" to print-help: After the "exec" line, add:
```clojure
(println (str "  " output/CYAN "attach" output/NC "     Attach to running container"))
```

Note: "attach" is already in `known-commands` set in output.clj (line 19), so typo suggestions already work.

IMPORTANT: The attach command does NOT need --unsafe, --detach, or --name extraction from the pre-dispatch section. It parses its own --name flag from its own args. Place it in the case statement BEFORE the harness commands so it's handled cleanly.
  </action>
  <verify>
Verify the CLI loads:
```
bb -e "(require '[aishell.cli])" 2>&1
```

Verify attach is in the dispatch:
```
grep '"attach"' src/aishell/cli.clj
```

Verify help text includes attach:
```
grep 'attach' src/aishell/cli.clj | head -5
```

Test help output:
```
bb -cp src -m aishell.core -- attach --help 2>&1
```
Should show attach help text.

Test missing name:
```
bb -cp src -m aishell.core -- attach 2>&1
```
Should show "Container name required" error.
  </verify>
  <done>
- `aishell attach --help` shows usage, options, examples, and detach instructions
- `aishell attach` (no --name) shows clear error with usage hint
- `aishell attach --name claude` dispatches to attach/attach-to-session
- `aishell attach --name claude --session debug` passes session to attach function
- Help text includes "attach" command in command list
  </done>
</task>

</tasks>

<verification>
End-to-end verification (requires a running detached container):

1. Build and start a detached container:
```
aishell claude --detach --name test-attach
```

2. Verify attach works:
```
aishell attach --name test-attach
```
Should connect to tmux session "main". Press Ctrl+B D to detach.

3. Verify session flag:
```
aishell attach --name test-attach --session main
```
Should connect to same session.

4. Verify wrong session error:
```
aishell attach --name test-attach --session nonexistent
```
Should show "Session 'nonexistent' not found" with available sessions listed.

5. Verify non-existent container:
```
aishell attach --name does-not-exist
```
Should show "Container 'does-not-exist' not found" with guidance.

6. Stop container and verify stopped error:
```
docker stop <container-name>
aishell attach --name test-attach
```
Should show "Container 'test-attach' is not running" with guidance.

7. Verify help:
```
aishell attach --help
```
Should show usage, options, examples, and Ctrl+B D note.
</verification>

<success_criteria>
- `aishell attach --name <name>` connects to running container's tmux session "main" via docker exec -it
- `aishell attach --name <name> --session <session>` connects to specific tmux session
- Non-existent container: clear error with `aishell ps` suggestion
- Stopped container: clear error with restart guidance
- Invalid session: clear error listing available sessions
- Help text documents usage, --session flag, and Ctrl+B D detach
- No new dependencies, no entrypoint changes, no Docker image rebuild
</success_criteria>

<output>
After completion, create `.planning/phases/33-attach-command/33-01-SUMMARY.md`
</output>
