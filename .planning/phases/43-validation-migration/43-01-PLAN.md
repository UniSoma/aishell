---
phase: 43-validation-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/attach.clj
  - src/aishell/migration.clj
  - src/aishell/cli.clj
autonomous: true

must_haves:
  truths:
    - "aishell attach --name X fails with helpful error when container has no tmux"
    - "aishell attach --name X --shell fails with helpful error when container has no tmux"
    - "Users upgrading from v2.7-2.8 see one-time migration warning about tmux opt-in change"
    - "Migration warning does not appear on fresh installs (no state.edn)"
    - "Migration warning does not appear after being shown once (marker file)"
  artifacts:
    - path: "src/aishell/attach.clj"
      provides: "validate-tmux-enabled! function and default session 'harness'"
      contains: "validate-tmux-enabled!"
    - path: "src/aishell/migration.clj"
      provides: "Migration warning namespace with version detection and one-time display"
      exports: ["show-v2.9-migration-warning!"]
    - path: "src/aishell/cli.clj"
      provides: "Migration warning integration on build/run commands"
      contains: "migration"
  key_links:
    - from: "src/aishell/attach.clj"
      to: "docker exec which tmux"
      via: "validate-tmux-enabled! shell call"
      pattern: "which.*tmux"
    - from: "src/aishell/migration.clj"
      to: "src/aishell/state.clj"
      via: "read-state for version detection"
      pattern: "state/read-state"
    - from: "src/aishell/cli.clj"
      to: "src/aishell/migration.clj"
      via: "require and call show-v2.9-migration-warning!"
      pattern: "migration/show-v2.9-migration-warning!"
---

<objective>
Add tmux validation to attach commands and migration warning for v2.7-2.8 upgraders.

Purpose: TMUX-04 ensures graceful failure when attaching to containers without tmux. TMUX-05 communicates the breaking behavioral change (tmux now opt-in) to existing users upgrading from v2.7-2.8.

Output: Updated attach.clj with tmux pre-flight check, new migration.clj namespace, cli.clj integration.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-validation-migration/43-RESEARCH.md
@src/aishell/attach.clj
@src/aishell/cli.clj
@src/aishell/state.clj
@src/aishell/output.clj
@src/aishell/util.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tmux validation to attach commands</name>
  <files>src/aishell/attach.clj</files>
  <action>
1. Add `validate-tmux-enabled!` function to `attach.clj` following existing validation pattern:
   - Uses `docker exec -u developer CONTAINER which tmux` to check tmux availability
   - On failure, calls `output/error` with 3-part message:
     - Problem: "Container 'NAME' does not have tmux enabled."
     - Context: "The 'attach' command requires tmux for session management."
     - Corrective action: "To enable tmux:\n  1. Rebuild: aishell build --with-tmux\n  2. Restart: aishell NAME --detach\n  3. Attach: aishell attach --name NAME"

2. Add `validate-tmux-enabled!` call in `attach-to-session` AFTER `validate-container-state!` and BEFORE `validate-session-exists!`:
   ```
   (validate-tty!)
   (validate-container-state! container-name name)
   (validate-tmux-enabled! container-name name)  ;; NEW
   (validate-session-exists! container-name session name)
   ```

3. Add `validate-tmux-enabled!` call in `attach-shell` AFTER `validate-container-state!` and BEFORE `ensure-bashrc!`:
   ```
   (validate-tty!)
   (validate-container-state! container-name name)
   (validate-tmux-enabled! container-name name)  ;; NEW
   (ensure-bashrc! container-name)
   ```

4. Change default session name in `attach-to-session` single-arity from "main" to "harness":
   - Update: `([name] (attach-to-session name "harness"))`
   - Update docstring to reflect "harness" as default session

5. Update the docstring for `attach-to-session` to say "default session 'harness'" instead of "default session 'main'".
  </action>
  <verify>
- `grep -n "validate-tmux-enabled" src/aishell/attach.clj` shows the function and both call sites
- `grep "harness" src/aishell/attach.clj` shows "harness" as default session
- `bb -e '(require (quote aishell.attach))'` compiles without error
  </verify>
  <done>
- validate-tmux-enabled! exists and is called before session validation in both attach-to-session and attach-shell
- Default session name is "harness" (not "main")
- 3-part error message includes problem, context, and corrective action with rebuild instructions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create migration warning namespace and integrate into CLI</name>
  <files>src/aishell/migration.clj, src/aishell/cli.clj</files>
  <action>
1. Create `src/aishell/migration.clj` with the following:

   ```clojure
   (ns aishell.migration
     "One-time migration warnings for version upgrades."
     (:require [babashka.fs :as fs]
               [aishell.state :as state]
               [aishell.util :as util]
               [aishell.output :as output]))
   ```

   Functions to implement:

   a. `(defn- migration-marker-file [] ...)` - Returns path `(str (util/config-dir) "/.migration-v2.9-warned")`

   b. `(defn- needs-migration-warning? [] ...)` - Returns true when ALL of:
      - `(state/read-state)` returns non-nil (not fresh install)
      - State lacks `:harness-volume-hash` key (pre-v2.9.0 state schema)
      - Marker file does NOT exist

   c. `(defn show-v2.9-migration-warning! [] ...)` - When `needs-migration-warning?` is true:
      - Print blank line
      - `(output/warn "aishell v2.9.0: Breaking changes to tmux behavior")`
      - Print to stderr (binding [*out* *err*]):
        - "tmux is now OPT-IN (was always-enabled in v2.7-2.8):"
        - "  - Your existing containers: tmux remains enabled (no action needed)"
        - "  - New builds after v2.9.0: tmux disabled by default"
        - "  - To enable tmux: aishell build --with-tmux"
        - blank line
        - "Session name changed:"
        - "  - Old default: main"
        - "  - New default: harness"
        - blank line
        - "This affects:"
        - "  - 'aishell attach' command (requires tmux)"
        - "  - Session persistence (tmux-resurrect)"
        - "  - Multiple windows/panes in container"
        - blank line
        - "For details: docs/ARCHITECTURE.md"
        - "This message shows once."
      - Create marker file: `(util/ensure-dir (util/config-dir))` then `(spit (migration-marker-file) (str "Warned: " (java.time.Instant/now)))`

2. Integrate into `cli.clj`:

   a. Add require: `[aishell.migration :as migration]` to the ns form

   b. Call `(migration/show-v2.9-migration-warning!)` at the START of `handle-build` (before the if/help check). This is the natural first-touch point for upgrading users.

   c. Also call `(migration/show-v2.9-migration-warning!)` inside `dispatch` just before the `case` statement (covers run commands like `aishell claude`). Place it after the clean-args processing but before the case dispatch.

   IMPORTANT: Do NOT call it inside `handle-default` when there are no args (shell mode) - that path also shows the migration warning via the dispatch-level call.
  </action>
  <verify>
- `bb -e '(require (quote aishell.migration))'` compiles without error
- `bb -e '(require (quote aishell.cli))'` compiles without error
- `grep -n "migration" src/aishell/cli.clj` shows require and call sites
- `grep -n "needs-migration-warning" src/aishell/migration.clj` shows detection logic
- `grep -n "migration-marker-file" src/aishell/migration.clj` shows marker file path
  </verify>
  <done>
- migration.clj exists with needs-migration-warning? (state-based version detection) and show-v2.9-migration-warning! (one-time display with marker file)
- cli.clj calls migration warning on build and dispatch entry points
- Fresh installs (no state.edn) never see the warning
- After first display, marker file prevents repeat warnings
  </done>
</task>

</tasks>

<verification>
- `bb -e '(require (quote aishell.cli))'` - Full compilation check (cli requires migration requires attach)
- `grep -rn "validate-tmux-enabled" src/` - Function exists and is called
- `grep -rn "migration" src/aishell/cli.clj` - Integration points exist
- `grep -rn "harness-volume-hash" src/aishell/migration.clj` - Version detection uses correct field
- `grep "harness" src/aishell/attach.clj` - Default session is "harness"
</verification>

<success_criteria>
- TMUX-04: attach commands validate tmux availability with 3-part error message
- TMUX-05: migration warning appears once for v2.7-2.8 upgraders, never for fresh installs
- Default session name updated from "main" to "harness"
- All code compiles cleanly via bb
</success_criteria>

<output>
After completion, create `.planning/phases/43-validation-migration/43-01-SUMMARY.md`
</output>
