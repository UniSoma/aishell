---
phase: 43-validation-migration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/cli.clj
  - src/aishell/docker/volume.clj
  - src/aishell/config.clj
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "aishell attach connects to tmux 'harness' session by default"
    - "tmux-resurrect plugin loaded when resurrect: true configured"
    - "No spurious warning when resurrect is not configured (nil value)"
  artifacts:
    - path: "src/aishell/cli.clj"
      provides: "Correct default session name"
      contains: '"harness"'
    - path: "src/aishell/docker/volume.clj"
      provides: "Uses pre-computed :tmux-plugins from state"
      contains: ":tmux-plugins state"
    - path: "src/aishell/config.clj"
      provides: "Nil guard in parse-resurrect-config"
      contains: "nil? resurrect-value"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/attach.clj"
      via: "attach-to-session call with default session name"
      pattern: '"harness"'
    - from: "src/aishell/docker/volume.clj"
      to: "state[:tmux-plugins]"
      via: "direct state key access instead of recalculating from config"
      pattern: ":tmux-plugins state"
---

<objective>
Fix two UAT-identified bugs blocking v2.9.0 release: (1) attach command defaults to "main" session instead of "harness", (2) resurrect plugin not loading because populate-volume recalculates plugins from raw config instead of using pre-computed state.

Purpose: Close the last 2 gaps before v2.9.0 ships.
Output: Working attach default + working resurrect plugin injection.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/aishell/cli.clj
@src/aishell/docker/volume.clj
@src/aishell/config.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix attach default session name and resurrect nil guard</name>
  <files>src/aishell/cli.clj, src/aishell/config.clj</files>
  <action>
  In src/aishell/cli.clj, fix 3 locations in the attach command handler:

  1. Line 535: Change help text from `"  --session <session>  Tmux session name (default: main)"` to `"  --session <session>  Tmux session name (default: harness)"`

  2. Line 541: Change example text from `"      Attach to the 'claude' container's main session"` to `"      Attach to the 'claude' container's harness session"`

  3. Line 570: Change `(or (:session opts) "main")` to `(or (:session opts) "harness")`

  In src/aishell/config.clj, fix parse-resurrect-config to handle nil without warning:

  Add a nil check BEFORE the `:else` clause (between the `(map? ...)` clause and `:else`):

  ```clojure
  (nil? resurrect-value)
  nil
  ```

  This prevents spurious "Invalid tmux.resurrect value" warnings when resurrect is simply not configured (nil means "not set", not "invalid").
  </action>
  <verify>
  Run: `grep -n '"harness"' src/aishell/cli.clj` — should show 3 matches in the attach section (lines ~535, ~541, ~570).
  Run: `grep -n 'nil?' src/aishell/config.clj` — should show the nil guard in parse-resurrect-config.
  Run: `grep -n '"main"' src/aishell/cli.clj` — should return NO matches (all "main" references replaced).
  </verify>
  <done>
  - `aishell attach --name X` connects to "harness" session by default
  - Help text and examples say "harness" not "main"
  - `parse-resurrect-config nil` returns nil silently (no warning)
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix populate-volume to use pre-computed tmux-plugins from state</name>
  <files>src/aishell/docker/volume.clj</files>
  <action>
  In src/aishell/docker/volume.clj, replace lines 334-341 in populate-volume. Currently the code recalculates plugins from raw config:

  ```clojure
  tmux-plugins (when (:with-tmux state)
                 (let [plugins (get-in opts [:config :tmux :plugins])
                       resurrect-val (get-in opts [:config :tmux :resurrect])
                       resurrect-enabled? (cond
                                            (true? resurrect-val) true
                                            (map? resurrect-val) (get resurrect-val :enabled true)
                                            :else false)]
                   (inject-resurrect-plugin plugins resurrect-enabled?)))
  ```

  Replace with direct state access:

  ```clojure
  tmux-plugins (when (:with-tmux state)
                 (:tmux-plugins state))
  ```

  This uses the pre-computed `:tmux-plugins` from the state map, which was already correctly calculated in cli.clj (lines 192-200) with resurrect plugin injection and deduplication. The recalculation was bypassing that logic because it read from raw config opts instead of state.

  Note: The state[:tmux-plugins] is already used in compute-harness-hash (line 53 of volume.clj), so this aligns populate-volume with the hash computation.
  </action>
  <verify>
  Run: `grep -n ':tmux-plugins state' src/aishell/docker/volume.clj` — should show the new line in populate-volume.
  Run: `grep -n 'get-in opts \[:config :tmux :plugins\]' src/aishell/docker/volume.clj` — should return NO matches (old code removed).
  Run: `grep -n 'inject-resurrect-plugin' src/aishell/docker/volume.clj` — should show only the function definition, NOT a call in populate-volume.
  </verify>
  <done>
  - populate-volume uses state[:tmux-plugins] directly
  - Resurrect plugin is included when resurrect: true configured (because cli.clj already injects it into state)
  - No duplicate plugin calculation logic in volume.clj
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `grep -rn '"main"' src/aishell/cli.clj` returns no matches
2. `grep -n ':tmux-plugins state' src/aishell/docker/volume.clj` shows usage in both compute-harness-hash and populate-volume
3. `grep -n 'nil? resurrect-value' src/aishell/config.clj` shows nil guard exists
4. Build succeeds: `bb -cp src -e '(require (quote aishell.cli))'` or equivalent build command
</verification>

<success_criteria>
- Default attach session is "harness" everywhere (help, examples, default value)
- populate-volume uses pre-computed :tmux-plugins from state, not recalculated from raw config
- parse-resurrect-config handles nil silently (no warning)
- All 3 files modified, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/43-validation-migration/43-03-SUMMARY.md`
</output>
