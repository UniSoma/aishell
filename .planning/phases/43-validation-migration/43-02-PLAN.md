---
phase: 43-validation-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - README.md
  - docs/ARCHITECTURE.md
  - docs/CONFIGURATION.md
  - docs/HARNESSES.md
  - docs/TROUBLESHOOTING.md
  - docs/DEVELOPMENT.md
autonomous: true

must_haves:
  truths:
    - "README reflects tmux as opt-in (--with-tmux flag documented)"
    - "ARCHITECTURE documents tmux opt-in, plugin management, resurrect persistence, and session name 'harness'"
    - "CONFIGURATION documents tmux section (plugins, resurrect) in config.yaml"
    - "TROUBLESHOOTING has tmux-specific entries (attach without tmux, plugin issues)"
    - "All docs show 'Last updated: v2.9.0'"
    - "No references to session name 'main' as current default (only in migration/backward compat context)"
  artifacts:
    - path: "README.md"
      provides: "Updated features list and usage examples for tmux opt-in"
      contains: "--with-tmux"
    - path: "docs/ARCHITECTURE.md"
      provides: "tmux architecture section, updated entrypoint flow, state schema"
      contains: "with-tmux"
    - path: "docs/CONFIGURATION.md"
      provides: "tmux config section (plugins list, resurrect map)"
      contains: "tmux:"
    - path: "docs/HARNESSES.md"
      provides: "Updated tmux section reflecting opt-in behavior"
      contains: "--with-tmux"
    - path: "docs/TROUBLESHOOTING.md"
      provides: "tmux troubleshooting entries"
      contains: "tmux not enabled"
    - path: "docs/DEVELOPMENT.md"
      provides: "Updated version references"
      contains: "v2.9.0"
  key_links:
    - from: "README.md"
      to: "docs/CONFIGURATION.md"
      via: "tmux config reference"
      pattern: "CONFIGURATION"
    - from: "docs/ARCHITECTURE.md"
      to: "docs/CONFIGURATION.md"
      via: "tmux config reference"
      pattern: "CONFIGURATION"
---

<objective>
Update all user-facing documentation to reflect v2.9.0 changes: tmux opt-in, plugin management, resurrect persistence, session name change, migration path.

Purpose: DOCS-01 ensures users can discover, configure, and troubleshoot all v2.9.0 features. Stale documentation is the top source of user confusion.

Output: All 6 docs files updated consistently for v2.9.0.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-validation-migration/43-RESEARCH.md
@.planning/REQUIREMENTS.md
@README.md
@docs/ARCHITECTURE.md
@docs/CONFIGURATION.md
@docs/HARNESSES.md
@docs/TROUBLESHOOTING.md
@docs/DEVELOPMENT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update all documentation for v2.9.0</name>
  <files>README.md, docs/ARCHITECTURE.md, docs/CONFIGURATION.md, docs/HARNESSES.md, docs/TROUBLESHOOTING.md, docs/DEVELOPMENT.md</files>
  <action>
Read each file fully before editing. Apply these changes:

**README.md:**
1. Update features list: Change "tmux integration - All containers run inside tmux for session persistence" to "tmux integration - Opt-in tmux support with plugin management and session persistence"
2. In build examples section, add `--with-tmux` example:
   ```
   # Build with tmux support
   aishell build --with-claude --with-tmux
   ```
3. In "Detached mode" section, add note: tmux must be enabled via `--with-tmux` at build time for attach/detach to work
4. Update `--session main` references to `--session harness` in examples
5. In "Detached Mode & Attach" section, update "All containers run inside a tmux session named `main`" to explain tmux is opt-in
6. Add tmux config example to Runtime configuration section:
   ```yaml
   # tmux plugin and session persistence (requires --with-tmux)
   tmux:
     plugins:
       - tmux-plugins/tmux-sensible
     resurrect: true
   ```

**docs/ARCHITECTURE.md:**
1. Change "Last updated: v2.8.0" to "Last updated: v2.9.0"
2. Add to key architectural principles: "7. **tmux Opt-in:** tmux multiplexer is optional, enabled via `--with-tmux` build flag"
3. Add new section "## tmux Architecture" after the 2-Tier Architecture section:
   - Explain opt-in behavior (`:with-tmux` in state.edn)
   - Plugin management: TPM installed to `/tools/tmux/plugins/tpm` in harness volume, plugins declared in config.yaml, installed at build time
   - Plugin bridging: entrypoint symlinks `/tools/tmux/plugins` to `~/.tmux/plugins`
   - TPM initialization: runtime config at `~/.tmux.conf.runtime` sourced from user config
   - User config mounting: `~/.tmux.conf` mounted read-only when tmux enabled
   - Resurrect: optional session persistence with state directory at `~/.aishell/resurrect/{project-hash}/`
   - Session name: "harness" (changed from "main" in v2.9.0)
4. Update entrypoint flow in "Container Execution" section:
   - Change step 6 from "Start tmux session 'main'" to "Start tmux session 'harness' (if tmux enabled)"
   - Change step 7 from "Execute harness command in tmux" to "Execute harness command in tmux (or directly if tmux disabled)"
   - Add steps: "Set up plugin bridging (symlink /tools/tmux/plugins)", "Source TPM initialization", "Auto-restore resurrect state"
5. Update state schema to include `:with-tmux`, `:tmux-plugins`, `:resurrect-config` fields
6. Add to "Migration from v2.7.0" section (rename to "Migration") a v2.9.0 subsection:
   - tmux changed from always-enabled to opt-in
   - Session name changed from "main" to "harness"
   - `attach` command now validates tmux is enabled
   - One-time migration warning shown on first use after upgrade
7. Update Docker Run diagram: remove hardcoded "Start tmux session 'main'", make tmux conditional
8. Fix the `docker run` example in the Run Phase section: change `aishell:base` to `aishell:foundation`
9. Update Extension System section: change `aishell:base` references to `aishell:foundation` (the example Dockerfile still says `FROM aishell:base`)

**docs/CONFIGURATION.md:**
1. Change "Last updated: v2.8.0" to "Last updated: v2.9.0"
2. Add `tmux` to the Table of Contents
3. Add new section "### tmux" between `detection` and `Common Patterns`:
   - `tmux.plugins`: List of plugin strings in `owner/repo` format
   - `tmux.resurrect`: Boolean or map `{restore_processes: true/false}`
   - Explain: requires `--with-tmux` at build time, silently ignored when tmux disabled
   - Example:
     ```yaml
     tmux:
       plugins:
         - tmux-plugins/tmux-sensible
         - tmux-plugins/tmux-yank
       resurrect: true
       # Or with options:
       # resurrect:
       #   restore_processes: true
     ```
   - Merge behavior: plugins list concatenates (global + project), resurrect is scalar (project wins)
4. Add `--with-tmux` to Build Options section:
   ```
   ### --with-tmux
   **Purpose:** Enable tmux multiplexer in containers.
   **Usage:** `aishell build --with-claude --with-tmux`
   **Behavior:** Enables tmux session management, plugin support, and attach/detach capability.
   **State tracking:** Stored as `:with-tmux true` in state.edn.
   ```
5. Update the full annotated example to include tmux section

**docs/HARNESSES.md:**
1. Change "Last updated: v2.8.0" to "Last updated: v2.9.0"
2. Update "Detached Mode & tmux" section:
   - Change "All containers run inside a tmux session named `main`" to explain tmux is opt-in via `--with-tmux`
   - Update session name from `main` to `harness` in all examples
   - Add note: `aishell attach` requires tmux to be enabled at build time
   - Add build example: `aishell build --with-claude --with-tmux`
3. Update `--session main` references to `--session harness` in all examples
4. Add section on tmux plugins:
   ```
   ### tmux Plugins
   Configure plugins in .aishell/config.yaml:
   ```yaml
   tmux:
     plugins:
       - tmux-plugins/tmux-sensible
   ```

**docs/TROUBLESHOOTING.md:**
1. Change "Last updated: v2.8.0" to "Last updated: v2.9.0"
2. Add "tmux Issues" to Table of Contents
3. Add new section "## tmux Issues" before "Getting Help":

   a. **Symptom: "Container does not have tmux enabled" when running attach**
      - Cause: Container was built without `--with-tmux` flag
      - Resolution: Rebuild with `aishell build --with-claude --with-tmux`, restart container, then attach

   b. **Symptom: "attach" works but "main" session not found**
      - Cause: Session name changed from "main" to "harness" in v2.9.0
      - Resolution: Use `aishell attach --name X --session harness` or omit `--session` for default

   c. **Symptom: tmux plugins not loading**
      - Cause: Plugins installed at build time but TPM not initialized
      - Resolution: Rebuild with `aishell update`, verify plugins in config.yaml use `owner/repo` format

   d. **Symptom: tmux-resurrect not restoring sessions**
      - Cause: Resurrect not configured or state directory not mounted
      - Resolution: Add `tmux: { resurrect: true }` to config.yaml, rebuild, verify `~/.aishell/resurrect/` exists on host

   e. **Symptom: Migration warning keeps appearing**
      - Cause: Marker file missing or unwritable
      - Resolution: Check `~/.aishell/.migration-v2.9-warned` exists, verify write permissions on `~/.aishell/`

4. Update "Detached Mode & Attach Issues" section to mention tmux requirement for attach

**docs/DEVELOPMENT.md:**
1. Change "Last updated: v2.8.0" to "Last updated: v2.9.0"
2. Add `migration.clj` to project structure tree:
   ```
   ├── migration.clj          # Version migration warnings (NEW in v2.9.0)
   ```
3. Add `migration.clj` to namespace responsibilities note
4. Update state schema example to include `:with-tmux`, `:tmux-plugins`, `:resurrect-config`

IMPORTANT: Search each file for "main" session references and update to "harness" where appropriate. Keep "main" only in migration/backward-compat context.
IMPORTANT: Search each file for "aishell:base" and update to "aishell:foundation" where still outdated.
  </action>
  <verify>
- `grep -rn "Last updated.*v2.9.0" docs/` shows all 5 docs files updated
- `grep -rn "with-tmux" README.md docs/` shows tmux flag documented across files
- `grep -rn "session.*main" README.md docs/ | grep -v migration | grep -v backward | grep -v "Old"` shows NO stale "main" session references in current-usage context
- `grep -rn "tmux:" docs/CONFIGURATION.md` shows tmux config section exists
- `grep -rn "tmux not enabled\|does not have tmux" docs/TROUBLESHOOTING.md` shows troubleshooting entry
- `grep -rn "migration.clj" docs/DEVELOPMENT.md` shows new namespace listed
- `grep -c "aishell:base" docs/ARCHITECTURE.md` should be 1 or 0 (only in migration context, not in current examples)
  </verify>
  <done>
- All 6 docs files updated to v2.9.0
- tmux opt-in behavior documented (build flag, config, plugins, resurrect)
- Session name "harness" used in all current-context examples
- Troubleshooting has 5 tmux-specific entries
- CONFIGURATION has tmux section with plugins and resurrect
- ARCHITECTURE has tmux architecture section and updated entrypoint flow
- No stale "main" session or "aishell:base" references in current-usage context
  </done>
</task>

</tasks>

<verification>
- All 6 files show "v2.9.0" version marker
- `grep -rn "with-tmux" README.md docs/` returns results from all relevant files
- `grep -rn "session.*harness" README.md docs/` shows updated session name
- `grep -rn "resurrect" docs/CONFIGURATION.md` shows resurrect documentation
- `grep -rn "tmux-plugins" docs/CONFIGURATION.md` shows plugin documentation
- No broken internal links between docs
</verification>

<success_criteria>
- DOCS-01: All 6 user-facing docs reflect v2.9.0 changes
- tmux opt-in, plugins, resurrect, session name change, and migration all documented
- Troubleshooting guide covers common tmux failure modes
- No stale v2.8.0 information contradicting v2.9.0 behavior
</success_criteria>

<output>
After completion, create `.planning/phases/43-validation-migration/43-02-SUMMARY.md`
</output>
