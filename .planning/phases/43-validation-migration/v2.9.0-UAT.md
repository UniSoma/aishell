---
status: diagnosed
phase: v2.9.0-milestone
source: [39-01-SUMMARY.md, 39-02-SUMMARY.md, 40-01-SUMMARY.md, 40-02-SUMMARY.md, 40-03-SUMMARY.md, 40-04-SUMMARY.md, 41-01-SUMMARY.md, 42-01-SUMMARY.md, 42-02-SUMMARY.md, 43-01-SUMMARY.md, 43-02-SUMMARY.md]
started: 2026-02-03T12:00:00Z
updated: 2026-02-03T12:20:00Z
---

## Current Test

[testing complete]

## Tests

### 1. Build without --with-tmux runs in shell mode
expected: Run `aishell build` (no --with-tmux flag), then `aishell run`. Container starts directly into a shell prompt — no tmux session, no status bar.
result: pass

### 2. Build with --with-tmux enables tmux session
expected: Run `aishell build --with-tmux`, then `aishell run`. Container starts inside a tmux session with a status bar at the bottom. Session name is "harness".
result: pass

### 3. Attach validates tmux is enabled
expected: After building WITHOUT --with-tmux, run `aishell attach`. You should see a helpful error message explaining tmux is not enabled, with instructions to rebuild with --with-tmux.
result: pass

### 4. Attach connects to tmux session
expected: After building WITH --with-tmux, start container with `aishell run`, then from another terminal run `aishell attach`. You connect to the existing tmux "harness" session.
result: issue
reported: "failed. attach looks for session 'main' but session is named 'harness'. Error: Session 'main' not found in container."
severity: major

### 5. Plugin declaration and installation
expected: Add tmux plugins to config.yaml under `tmux: plugins:` (e.g. `tmux-plugins/tmux-sensible`), then `aishell build --with-tmux`. Build output shows plugin installation. Inside container, the plugin is active.
result: pass

### 6. Invalid plugin format shows warning
expected: Add an invalid plugin format to config.yaml (e.g. `tmux: plugins: ["not-a-valid-format"]`), then run any aishell command that loads config. You see a warning about invalid plugin format but the command still proceeds.
result: pass

### 7. Update refreshes plugins
expected: After initial build with plugins, run `aishell update`. Plugins are refreshed/updated without errors. Existing plugins remain intact.
result: pass

### 8. User tmux.conf is mounted
expected: Create or verify you have a ~/.tmux.conf on the host. Build with --with-tmux and run. Inside the container, your tmux.conf settings are active (e.g. custom keybindings, status bar theme).
result: pass

### 9. Missing tmux.conf handled gracefully
expected: If you do NOT have a ~/.tmux.conf on the host, build with --with-tmux and run. Container starts normally with a default tmux config — no errors about missing config.
result: pass

### 10. Resurrect config enables session persistence
expected: Add `tmux: resurrect: true` to config.yaml, build with --with-tmux. Inside the container, tmux-resurrect plugin is loaded (check with `tmux list-keys | grep resurrect` or prefix+Ctrl-s to save). State directory exists at ~/.aishell/resurrect/ on host.
result: issue
reported: "tmux: resurrect: true in config.yaml but tmux list-keys | grep resurrect gives nothing inside the container"
severity: major

### 11. Migration warning for existing users
expected: If you previously built with v2.7 or v2.8 (state.edn exists but lacks :harness-volume-hash), running `aishell build` shows a one-time migration warning about tmux now being opt-in. The warning only appears once.
result: pass

### 12. Documentation reflects v2.9.0
expected: Check README.md — it mentions --with-tmux build flag, tmux plugin configuration, and session name "harness". Check docs/CONFIGURATION.md — it has a tmux configuration section with plugins and resurrect examples.
result: pass

## Summary

total: 12
passed: 10
issues: 2
pending: 0
skipped: 0

## Gaps

- truth: "aishell attach connects to tmux 'harness' session"
  status: failed
  reason: "User reported: attach looks for session 'main' but session is named 'harness'. Error: Session 'main' not found in container."
  severity: major
  test: 4
  root_cause: "CLI parser in cli.clj hardcodes 'main' as default session name, overriding attach.clj's correct 'harness' default"
  artifacts:
    - path: "src/aishell/cli.clj"
      issue: "Line 570: (or (:session opts) \"main\") should be \"harness\"; Line 535: help text says 'main'; Line 541: example says 'main session'"
  missing:
    - "Change default session name from 'main' to 'harness' in CLI parser (3 locations in cli.clj)"
  debug_session: ".planning/debug/attach-session-name.md"

- truth: "tmux-resurrect plugin loaded when resurrect: true configured"
  status: failed
  reason: "User reported: tmux: resurrect: true in config.yaml but tmux list-keys | grep resurrect gives nothing inside the container"
  severity: major
  test: 10
  root_cause: "populate-volume in volume.clj ignores pre-computed :tmux-plugins from state and recalculates from raw config, losing the auto-injected resurrect plugin. Secondary: parse-resurrect-config treats nil as invalid, causing spurious warnings."
  artifacts:
    - path: "src/aishell/docker/volume.clj"
      issue: "Lines 334-341: reads plugins from opts[:config] instead of state[:tmux-plugins], bypassing inject-resurrect-plugin"
    - path: "src/aishell/config.clj"
      issue: "Lines 130-133: parse-resurrect-config :else clause treats nil as invalid instead of 'not configured'"
  missing:
    - "Use state[:tmux-plugins] in populate-volume instead of recalculating from raw config"
    - "Add nil guard to parse-resurrect-config before :else clause"
  debug_session: ".planning/debug/resurrect-not-loading.md"
