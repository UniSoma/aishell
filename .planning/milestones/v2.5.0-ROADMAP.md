# Milestone v2.5.0: Optimization & Polish

**Status:** ✅ SHIPPED 2026-01-26
**Phases:** 28-29
**Total Plans:** 4

## Overview

Optimization and polish milestone focusing on UX improvements (dynamic help, exec command), build customization (conditional Gitleaks), and config flexibility (pre-start list format). Binary install approach was investigated and abandoned after finding native binaries are larger than npm packages.

## Phases

### Phase 28: Dynamic Help & Config Improvements

**Goal**: Users can customize build behavior and see context-aware help output.
**Depends on**: None (builds on v2.4.0 stable base)
**Plans**: 2 plans

Plans:
- [x] 28-01: Pre-start list format + Gitleaks build flag infrastructure
- [x] 28-02: Dynamic help output + Documentation updates

**Details:**

Requirements satisfied:
- CLI-01: Help output shows only installed harness commands (reads build state)
- CLI-02: Build command accepts `--without-gitleaks` flag to skip Gitleaks installation
- CLI-03: Gitleaks installation state tracked in ~/.aishell/state.edn
- CFG-01: Pre-start config accepts YAML list format
- CFG-02: List items joined with ` && ` to form single command
- CFG-03: String format remains supported (backwards compatible)
- DOC-01: CONFIGURATION.md updated for pre_start list format with examples
- DOC-02: CONFIGURATION.md updated for --without-gitleaks build flag

Files modified:
- src/aishell/config.clj — normalize-pre-start function
- src/aishell/cli.clj — installed-harnesses, --without-gitleaks, dynamic help
- src/aishell/state.clj — :with-gitleaks schema
- src/aishell/docker/build.clj — WITH_GITLEAKS build arg
- src/aishell/docker/templates.clj — Conditional Gitleaks install
- docs/CONFIGURATION.md — v2.5.0, pre_start list, build flags

---

### Phase 29: Exec Command

**Goal**: Users can run one-off commands in the container without entering interactive shell.
**Depends on**: Phase 28 (stable base)
**Plans**: 2 plans

Plans:
- [x] 29-01: Core exec infrastructure (TTY detection, run-exec, CLI dispatch)
- [x] 29-02: Documentation (README, TROUBLESHOOTING)

**Details:**

Requirements satisfied:
- CLI-04: New `aishell exec <command>` subcommand runs command in container
- CLI-05: Exec command uses all standard mounts/env from config
- CLI-06: Exec command auto-detects TTY (allocate when stdin is terminal)
- CLI-07: Exec command requires prior build (clear error if image missing)
- DOC-05: README.md updated for `aishell exec` command usage
- DOC-07: TROUBLESHOOTING.md updated for common exec issues

Files modified:
- src/aishell/docker/run.clj — build-docker-args-for-exec
- src/aishell/run.clj — run-exec
- src/aishell/cli.clj — exec dispatch, help text
- src/aishell/output.clj — exec in known-commands
- README.md — exec command section
- docs/TROUBLESHOOTING.md — exec issues section

---

## Milestone Summary

**Key Decisions:**

- Pre-start list normalization at YAML load time (single point of normalization)
- --without-gitleaks opt-out flag (maintains backwards compatibility)
- Positive state tracking with :with-gitleaks (state reflects what is installed)
- Show all harnesses in help when no state file (aids discoverability)
- Always show gitleaks in help (may work via host installation)
- Abandon binary install approach (native binary 213MB, larger than npm)
- System/console for TTY detection (portable, already used in codebase)
- Skip detection/pre_start for exec (fast path for one-off commands)
- Always include -i flag for exec (required for piped input)
- p/shell with :inherit for exec (captures exit code for propagation)

**Issues Resolved:**

- Binary install investigation concluded: npm approach is more size-efficient
- Pre-start config limited to string format — now supports list

**Issues Deferred:**

- Security pattern audit (deferred to future milestone)

**Technical Debt Incurred:**

None — zero tech debt across both phases.

---
*For current project status, see .planning/PROJECT.md*
