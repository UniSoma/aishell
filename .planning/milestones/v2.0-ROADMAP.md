# Milestone v2.0: Babashka Rewrite

**Status:** SHIPPED 2026-01-21
**Phases:** 13-18
**Total Plans:** 22

## Overview

This milestone rewrote aishell from 1,655 LOC Bash to Clojure Babashka for cross-platform support (Linux, macOS) and simpler implementation. The journey started with CLI foundation and Docker integration, then built the build command, run commands, and validation layers. Distribution via uberscript completed the rewrite with feature parity to v1.2.

## Phases

### Phase 13: Foundation

**Goal**: Establish project structure and core CLI that all subsequent phases build on
**Depends on**: Nothing (first phase of v2.0)
**Requirements**: CLI-01, CLI-02, CLI-08, PLAT-03
**Plans**: 2 plans

Plans:
- [x] 13-01-PLAN.md - Project structure and core CLI (dispatch, version, help)
- [x] 13-02-PLAN.md - Path utilities and enhanced error messages

**Success Criteria:**
1. User can run `./aishell --version` and see version number
2. User can run `./aishell --help` and see available commands with descriptions
3. User sees clear error message when running invalid command (e.g., `./aishell foo`)
4. Path handling works correctly on both Linux and macOS (forward slashes, home expansion)

### Phase 14: Docker Integration

**Goal**: Provide Docker operations that build and run commands depend on
**Depends on**: Phase 13
**Requirements**: DOCK-01, DOCK-02, DOCK-03, DOCK-07, DOCK-08
**Plans**: 5 plans

Plans:
- [x] 14-01-PLAN.md - Docker wrapper module with availability checks
- [x] 14-02-PLAN.md - Spinner and hash utilities for build support
- [x] 14-03-PLAN.md - Embedded Dockerfile templates and build logic
- [x] 14-04-PLAN.md - Per-project Dockerfile extension support
- [x] 14-05-PLAN.md - CLI integration and error messages

**Success Criteria:**
1. User sees clear error "Docker not running" when Docker daemon unavailable
2. User sees clear error "No image built" when running without prior build
3. Tool can build Docker image from embedded Dockerfile template
4. Tool caches image builds (second build is instant if nothing changed)
5. Per-project Dockerfile extension (.aishell/Dockerfile) is detected and applied

### Phase 15: Build Command

**Goal**: Users can build their sandbox environment with harness version pinning
**Depends on**: Phase 14
**Requirements**: CLI-03, CONF-07, CONF-08
**Plans**: 3 plans

Plans:
- [x] 15-01-PLAN.md - State persistence module (EDN read/write)
- [x] 15-02-PLAN.md - Build subcommand with flag parsing and validation
- [x] 15-03-PLAN.md - Gap closure: fix version type coercion and Docker command vector

**Success Criteria:**
1. User can run `./aishell build` and see image being built
2. User can run `./aishell build --with-claude=1.0.0` to pin version (single flag design)
3. Build flags are persisted in `~/.aishell/state.edn`
4. Subsequent builds use persisted flags without re-specifying
5. Build with no flags clears previous state (base image only)

### Phase 16: Run Commands

**Goal**: Users can enter shell or run harnesses directly with full configuration support
**Depends on**: Phase 15
**Requirements**: CLI-04, CLI-05, CLI-06, DOCK-04, DOCK-05, DOCK-06, CONF-01, CONF-02, CONF-03, CONF-04, CONF-05, CONF-06, PLAT-01, PLAT-02
**Plans**: 5 plans

Plans:
- [x] 16-01-PLAN.md - YAML config loading with project-first, global-fallback strategy
- [x] 16-02-PLAN.md - Docker run argument building (mounts, env, ports, git identity)
- [x] 16-03-PLAN.md - CLI integration for shell, claude, and opencode commands
- [x] 16-04-PLAN.md - Gap closure: env array format and pass-through args
- [x] 16-05-PLAN.md - Gap closure: pass-through args for harness commands

**Success Criteria:**
1. User can run `./aishell` and enter a shell inside the container
2. User can run `./aishell claude` and Claude Code starts in the container
3. User can run `./aishell opencode` and OpenCode starts in the container
4. Project is mounted at same path as host (e.g., /home/user/project inside container)
5. Git identity (user.name, user.email) is available inside container
6. Container is ephemeral (destroyed on exit, only mounted files persist)
7. Per-project config.yaml mounts, env, ports, docker_args, pre_start work
8. Tool works on Linux (x86_64, aarch64) and macOS (x86_64, aarch64)

### Phase 17: Validation & Polish

**Goal**: Security validations and update awareness matching v1.2 hardening
**Depends on**: Phase 16
**Requirements**: CLI-07, VAL-01, VAL-02, VAL-03
**Plans**: 4 plans

Plans:
- [x] 17-01-PLAN.md - Build --force flag, dockerfile hash storage, update command
- [x] 17-02-PLAN.md - Dangerous args validation and stale image warnings
- [x] 17-03-PLAN.md - Gap closure: vector docker_args and version cache invalidation
- [x] 17-04-PLAN.md - Gap closure: tokenize-docker-args vector handling

**Success Criteria:**
1. User can run `./aishell update` to check for updates
2. Invalid version strings (e.g., `1.0; rm -rf /`) are rejected with clear error
3. Dangerous docker_args patterns (--privileged, docker.sock) trigger warnings
4. User is warned when embedded Dockerfile changed since last build

### Phase 18: Distribution

**Goal**: Users can install aishell via curl|bash one-liner
**Depends on**: Phase 17
**Requirements**: DIST-01, DIST-02, DIST-03
**Plans**: 3 plans

Plans:
- [x] 18-01-PLAN.md - Build script and uberscript packaging
- [x] 18-02-PLAN.md - curl|bash installer with checksum verification
- [x] 18-03-PLAN.md - Legacy cleanup and documentation update

**Success Criteria:**
1. User can run `curl -fsSL ... | bash` to install aishell
2. aishell is distributed as single-file uberscript (one .clj file)
3. Installer assumes Babashka is installed (provides clear error if missing)

---

## Milestone Summary

**Decimal Phases:** None (clean execution)

**Key Decisions:**

- Static requires in core.clj for uberscript compatibility
- Version in cli.clj (not core.clj) to avoid circular dependency
- YAML config.yaml replaces bash run.conf
- Pre-dispatch command interception for pass-through args
- Advisory security warnings (never block execution)

**Issues Resolved:**

- Circular dependency between core.clj and cli.clj (uberscript blocker)
- Pass-through args parsed by babashka.cli instead of forwarding
- Version type coercion errors (Double vs String)
- Docker command vector spreading for babashka.process
- Vector docker_args validation (join with spaces)

**Issues Deferred:** None

**Technical Debt Incurred:** None

---

*Archived: 2026-01-21*
*For current project status, see .planning/ROADMAP.md (next milestone)*
