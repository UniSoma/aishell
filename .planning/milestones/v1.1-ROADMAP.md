# Milestone v1.1: Per-project Runtime Configuration

**Status:** SHIPPED 2026-01-19
**Phases:** 9-10
**Total Plans:** 4

## Overview

Per-project runtime configuration via `.aishell/run.conf` for custom volume mounts, environment variables, port mappings, docker arguments, and pre-start commands for sidecar services.

## Phases

### Phase 9: Runtime Config Core

**Goal**: Enable per-project runtime configuration via `.aishell/run.conf`
**Depends on**: Phase 8 (explicit build/update commands)
**Plans**: 3 plans

Plans:
- [x] 09-01: Config file parser with validation and error handling
- [x] 09-02: Argument builders and integration into main()
- [x] 09-03: UAT gap closure (error display, MOUNTS format, ENV passthrough)

**Requirements covered:**
- RCONF-01, RCONF-02, RCONF-03 (config file)
- MOUNT-01, MOUNT-02, MOUNT-03 (volume mounts)
- ENV-01, ENV-02, ENV-03 (environment variables)
- PORT-01, PORT-02 (port mappings)
- DARG-01, DARG-02 (docker arguments)

**Key implementation notes:**
- Config is sourced after validation (whitelist allowed variable names)
- Mounts expand $HOME before passing to docker
- ENV supports both passthrough (VAR) and literal (VAR=value) syntax
- All config is applied at `docker run` time, not build time

### Phase 10: Pre-Start Command

**Goal**: Enable background services/sidecars via pre-start hook
**Depends on**: Phase 9
**Plans**: 1 plan

Plans:
- [x] 10-01: PRE_START whitelist, env passthrough, and entrypoint execution

**Requirements covered:**
- PRE-01, PRE-02, PRE-03

**Key implementation notes:**
- PRE_START runs in entrypoint.sh before exec to main command
- Uses `sh -c "$PRE_START" > /tmp/pre-start.log 2>&1 &` for background execution
- No nohup/disown needed (exec replaces shell entirely)
- Stdout/stderr captured in /tmp/pre-start.log

---

## Milestone Summary

**Key Decisions:**

- Shell-style config format (run.conf) — Native to Bash, no parser dependencies
- Whitelist-based config parsing — Prevents injection attacks
- printf for docker flags — Avoids echo -e interpretation issues
- sh -c for PRE_START — Handles complex commands properly
- PRE_START output to /tmp — Prevents sidecar output from polluting terminal
- return 1 vs exit 1 in parse_run_conf — Better for function composition and testing

**Issues Resolved:**

- Config errors now display with colored "Error:" prefix using error() function
- MOUNTS supports both source-only (/path) and source:destination (/host:/container) formats
- ENV passthrough verified working independently

**Issues Deferred:**

- None

**Technical Debt Incurred:**

- None

---

*For current project status, see .planning/ROADMAP.md (deleted — fresh for next milestone)*
*Archived: 2026-01-19 as part of v1.1 milestone completion*
