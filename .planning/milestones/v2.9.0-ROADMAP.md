# Milestone v2.9.0: tmux Opt-in & Plugin Support

**Status:** ✅ SHIPPED 2026-02-03
**Phases:** 39-43
**Total Plans:** 12

## Overview

Make tmux opt-in, add plugin management, support user config mounting, enable session persistence. Completes the tmux story started in v2.7.0 by giving users full control over tmux behavior.

## Phases

### Phase 39: State Schema & Config Mounting

**Goal**: Establish opt-in flag and mount user tmux configuration
**Depends on**: Phase 38
**Requirements**: TMUX-01, TMUX-02, CONF-01, CONF-02
**Plans**: 2 plans

Plans:
- [x] 39-01: CLI --with-tmux flag, state schema, config tmux section
- [x] 39-02: Conditional tmux config mount in docker run

**Details:**
- `--with-tmux` build flag stored as `:with-tmux` in state.edn
- tmux config section validated with scalar merge strategy (project replaces global)
- `~/.tmux.conf` auto-mounted read-only when tmux enabled
- Missing config on host handled gracefully (no error)
- Auto-mount skipped if user has explicit .tmux.conf in config mounts

### Phase 40: Plugin Installation in Volume

**Goal**: Install TPM and declared plugins into harness volume at build time
**Depends on**: Phase 39
**Requirements**: PLUG-01, PLUG-02, PLUG-03, PLUG-06
**Plans**: 4 plans

Plans:
- [x] 40-01: Plugin format validation in config parsing
- [x] 40-02: TPM and plugin installation in volume population
- [x] 40-03: Gap closure: volume hash includes tmux state, idempotent TPM clone
- [x] 40-04: Gap closure: fix plugin declaration path for TPM install_plugins

**Details:**
- Plugin format validation uses `owner/repo` regex pattern (warning-only)
- TPM installed to /tools/tmux/plugins/tpm during volume population
- Plugin declarations written to ~/.tmux.conf for TPM AWK parser
- Volume hash includes tmux state (:with-tmux + sorted plugin list)
- Idempotent git clone uses pull-if-exists pattern

### Phase 41: TPM Initialization in Entrypoint

**Goal**: Make installed plugins discoverable to tmux at runtime
**Depends on**: Phase 40
**Requirements**: TMUX-03, PLUG-04, PLUG-05
**Plans**: 1 plan

Plans:
- [x] 41-01: Entrypoint plugin bridging, config injection, conditional tmux/shell startup + WITH_TMUX env var

**Details:**
- Symlink from /tools/tmux/plugins to ~/.tmux/plugins in entrypoint
- TPM initialization appended to runtime config (~/.tmux.conf.runtime)
- WITH_TMUX passed as env var to container (simpler than mounting state.edn)
- Conditional startup: tmux session when enabled, direct shell when disabled
- Session name changed from "main" to "harness" for project naming consistency

### Phase 42: Resurrect State Persistence

**Goal**: Enable optional session state persistence via tmux-resurrect
**Depends on**: Phase 41
**Requirements**: PERS-01, PERS-02, PERS-03
**Plans**: 2 plans

Plans:
- [x] 42-01: Config parsing for resurrect (boolean/map) and host state directory mount
- [x] 42-02: Plugin auto-injection, entrypoint resurrect config and auto-restore

**Details:**
- `resurrect: true` expands to `{:enabled true :restore_processes false}` (sensible default)
- Per-project state directory at ~/.aishell/resurrect/{project-hash}/
- Auto-inject tmux-resurrect plugin when resurrect enabled (no manual declaration)
- Deduplicate resurrect plugin if user already declared it (silent)
- Process restoration defaults to 'false'; explicit `restore_processes: true` enables ':all:' mode
- Auto-restore runs via run-shell after TPM initialization
- RESURRECT_ENABLED and RESURRECT_RESTORE_PROCESSES env vars to entrypoint
- Resurrect config silently ignored when tmux disabled

### Phase 43: Validation & Migration

**Goal**: Ensure graceful failures and smooth upgrade path for existing users
**Depends on**: Phase 42
**Requirements**: TMUX-04, TMUX-05, DOCS-01
**Plans**: 3 plans

Plans:
- [x] 43-01: Attach tmux validation and v2.9.0 migration warning
- [x] 43-02: Documentation updates for v2.9.0 (all 6 docs files)
- [x] 43-03: Gap closure: fix attach default session, resurrect plugin loading, nil guard

**Details:**
- Attach validates tmux enabled, shows helpful error when not
- Migration warning: schema-based detection (state exists + lacks :harness-volume-hash)
- One-time warning with marker file (~/.aishell/.migration-v2.9-warned)
- Fresh installs never see migration warning (no state.edn)
- Default attach session changed to "harness" (consistency with templates.clj)
- populate-volume uses pre-computed state[:tmux-plugins] instead of recalculating
- Nil guard for resurrect config (not configured is valid, not an error)
- All 6 docs files updated: README, ARCHITECTURE, CONFIGURATION, HARNESSES, TROUBLESHOOTING, DEVELOPMENT

---

## Milestone Summary

**Key Decisions:**
- tmux opt-in via --with-tmux flag (default = no tmux) per TMUX-01 requirement
- Plugin format: owner/repo validated with warning-only approach (consistent with existing framework)
- TPM install path at /tools/tmux/plugins (harness volume layer, not foundation)
- Volume hash includes tmux state for proper invalidation
- Session name changed from "main" to "harness" for project naming consistency
- WITH_TMUX as env var rather than mounting state.edn (simpler pattern)
- Runtime config at ~/.tmux.conf.runtime (discoverable, not in /tmp)
- Resurrect: true → sensible defaults (enabled, no process restoration)
- Per-project resurrect state at ~/.aishell/resurrect/{project-hash}/
- Migration detection via schema (presence of state without :harness-volume-hash)

**Issues Resolved:**
- Attach session name mismatch ("main" vs "harness") — fixed in 43-03
- Resurrect plugin not loading (volume recalculated instead of using state) — fixed in 43-03
- TPM plugin discovery failure (host config staged at neutral path) — fixed between phases
- Plugin declaration path (AWK parser needs ~/.tmux.conf) — fixed in 40-04

**Issues Deferred:**
- Plugin version pinning (specific git tags/commits) — PLUG-F01
- Incremental plugin updates (add/remove without full volume rebuild) — PLUG-F02
- tmux-plugins troubleshooting command — PLUG-F03
- tmux-continuum auto-save integration — PERS-F01

**Technical Debt Incurred:**
None. All features complete and production-ready.

---

_For current project status, see .planning/ROADMAP.md_

---
*Archived: 2026-02-03 as part of v2.9.0 milestone completion*
