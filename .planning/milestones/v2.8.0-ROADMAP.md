# Milestone v2.8.0: Decouple Harness Tools

**Status:** âœ… SHIPPED 2026-02-01
**Phases:** 35-38
**Total Plans:** 14

## Overview

Eliminate cascade invalidation by splitting the monolithic base image into a stable foundation layer and volume-mounted harness tools, so harness version updates no longer force multi-gigabyte extension rebuilds.

## Phases

### Phase 35: Foundation Image Split

**Goal**: Create stable foundation image without harness tools, with clean migration path from old `aishell:base` tag
**Depends on**: Phase 34 (v2.7.0 complete)
**Plans**: 2 plans

Plans:
- [x] 35-01: Update Dockerfile template to remove harness installations, change tag to foundation
- [x] 35-02: Add base-tag validation with clear error messages for legacy extensions

**Details:**
- Removed all harness ARGs and installation blocks from Dockerfile template
- Changed image tag from aishell:base to aishell:foundation
- Eliminated harness version tracking from build cache logic
- Kept gitleaks in foundation layer (security infrastructure, not harness)
- Legacy FROM aishell:base detection with case-insensitive regex and clear migration error

### Phase 36: Harness Volume Core

**Goal**: Harness tools installed into Docker named volumes and mounted at runtime with correct PATH configuration
**Depends on**: Phase 35
**Plans**: 3 plans

Plans:
- [x] 36-01: Implement harness hash computation from flags and versions
- [x] 36-02: Create volume population logic with npm install commands
- [x] 36-03: Wire volume mount into docker run with PATH/NODE_PATH environment configuration

**Details:**
- Deterministic SHA-256 hash-based volume naming (aishell-harness-{hash})
- NPM package installation via temporary Docker containers with proper permissions
- Volume mounted read-only at /tools with PATH/NODE_PATH configured in entrypoint
- OpenCode excluded from npm (Go binary), installed separately

### Phase 37: Build Integration & Migration

**Goal**: Transparent build UX with automatic state migration and lazy volume population
**Depends on**: Phase 36
**Plans**: 6 plans

Plans:
- [x] 37-01: Update state schema with foundation-hash and harness-volume-hash fields, implement backward-compatible migration
- [x] 37-02: Implement lazy volume population with staleness detection on container run
- [x] 37-03: Update extension cache invalidation to use foundation image ID
- [x] 37-04: Wire foundation build and volume population into unified build command flow
- [x] 37-05: Add OpenCode binary installation to volume population (GAP-01 fix)
- [x] 37-06: Fix tmux new-window environment loss via /etc/profile.d script (GAP-02 fix)

**Details:**
- Additive state schema migration (new fields default to nil)
- Lazy volume population on first run if volume is empty or stale
- Extension cache invalidation uses foundation image ID (aishell.foundation.id label)
- Unified build command handles foundation + volume transparently
- OpenCode binary downloaded from GitHub releases to /tools/bin
- Profile.d script ensures PATH survives tmux new-window sessions

### Phase 38: Volume Cleanup & Documentation

**Goal**: Repurpose update command for harness refresh, add volume management commands, and comprehensive documentation for new architecture
**Depends on**: Phase 37
**Plans**: 3 plans

Plans:
- [x] 38-01: Redesign `aishell update` for volume refresh (--force for foundation rebuild)
- [x] 38-02: Implement `aishell volumes` list and prune commands with orphan detection
- [x] 38-03: Update all documentation files and create v2.8.0 changelog

**Details:**
- Update command redesigned: default refreshes harness volume, --force rebuilds foundation
- Volume management with list, prune, orphan detection, and in-use safety checks
- All 6 documentation files updated (README, ARCHITECTURE, CONFIGURATION, HARNESSES, TROUBLESHOOTING, DEVELOPMENT)
- Comprehensive v2.8.0 changelog covering phases 35-38

---

## Milestone Summary

**Key Decisions:**
- 2-tier architecture: Foundation image + harness volume (not separate harness image)
- Volume-based injection over COPY --link layer inversion (simpler for local dev workflow)
- Clean break from aishell:base to aishell:foundation (no backward compat alias)
- Per-project volumes keyed by harness combination hash (shared across identical configs)
- Lazy volume population on first container run (not eager on build)
- Gitleaks stays in foundation (security infrastructure, not harness)
- Read-only volume mount at /tools for security
- Update command default: volume refresh only (foundation rebuild opt-in via --force)
- OpenCode binary install via curl | tar (Go binary, not npm)
- Profile.d script for login shell environment (tmux new-window fix)

**Issues Resolved:**
- Cascade invalidation eliminated (harness updates no longer force extension rebuilds)
- tmux new-window environment loss fixed via /etc/profile.d/aishell.sh
- OpenCode binary installation gap closed (not npm-installable)
- Legacy FROM aishell:base usage caught with clear migration message

**Issues Deferred:**
- Host-native bind mounts for harness tools (requires host Node.js assumption)
- Volume size reporting in aishell doctor
- Volume age reporting and auto-cleanup policy

**Technical Debt Incurred:**
- :dockerfile-hash maintained alongside :foundation-hash for backward compatibility
- base-image-id-label alias in build.clj for transition period

---

_For current project status, see .planning/ROADMAP.md_
