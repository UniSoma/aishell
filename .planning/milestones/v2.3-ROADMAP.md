# Milestone v2.3.0: Safe AI Context Protection

**Status:** SHIPPED 2026-01-24
**Phases:** 18.1-23
**Total Plans:** 11

## Overview

Proactively warn users about sensitive data in their project directory before AI agents access it. Implements filename-based detection for fast pre-container checks and Gitleaks integration for deep content-based secret scanning.

## Phases

### Phase 18.1: Default Harness Arguments (INSERTED)

**Goal**: Users can specify per-harness default arguments in config.yaml that are automatically applied on every invocation
**Depends on**: v2.0 complete (Phase 18)
**Plans**: 1 plan

Plans:
- [x] 18.1-01: Implement harness_args config parsing and argument injection

**Details:**
- `harness_args` key maps harness names (claude, opencode) to default argument lists
- Default arguments automatically prepend to user-provided arguments
- Global and project configs merge correctly (global defaults first, then project defaults)
- String values auto-normalize to single-element lists for better DX

### Phase 19: Core Detection Framework

**Goal**: Users see warnings about sensitive files with severity tiers when running aishell commands
**Depends on**: v2.0 complete (Phase 18)
**Plans**: 1 plan

Plans:
- [x] 19-01: Detection framework with severity tiers and display

**Details:**
- Created detection/core.clj with scan-project, display-warnings, confirm-if-needed
- Created detection/formatters.clj with severity-config and defmulti format-finding
- Added --unsafe flag extraction for CI/automation bypass
- High-severity requires y/n in interactive mode, exit 1 in non-interactive
- Medium/low severity auto-proceeds in all modes

### Phase 20: Filename-based Detection

**Goal**: Users are warned about sensitive files detected by filename patterns (no content inspection)
**Depends on**: Phase 19
**Plans**: 2 plans

Plans:
- [x] 20-01: Environment file detection with threshold-based grouping
- [x] 20-02: SSH key, key container, and PEM/key file detection

**Details:**
- Environment files: .env, .env.local, .env.production, .envrc (medium severity)
- Template files: .env.example, .env.sample (low severity)
- SSH keys: id_rsa, id_dsa, id_ed25519, id_ecdsa, *.ppk (high severity)
- Key containers: *.p12, *.pfx, *.jks, *.keystore (high severity)
- PEM/key files: *.pem, *.key (medium severity)
- Threshold-of-3 grouping: show files individually if <=3, summarize with count if >3

### Phase 21: Extended Filename Patterns

**Goal**: Users are warned about additional sensitive files detected by filename/path patterns
**Depends on**: Phase 20
**Plans**: 2 plans

Plans:
- [x] 21-01: Cloud credential file detection (GCP ADC, terraform state, kubeconfig)
- [x] 21-02: Package manager and application secret file detection

**Details:**
- GCP: application_default_credentials.json (high severity)
- Terraform: terraform.tfstate, terraform.tfstate.backup (high severity)
- Kubernetes: kubeconfig, .kube/config (medium severity)
- Package managers: .pypirc, .netrc (high severity)
- Tool configs: .npmrc, .yarnrc.yml, .docker/config.json, .terraformrc (medium severity)
- Rails: master.key (high severity), credentials*.yml.enc
- Secret patterns: secret.*, secrets.*, vault.*, token.*, apikey.*, private.* (medium severity)
- Database: .pgpass, .my.cnf, database.yml (medium severity)

### Phase 22: Gitleaks Integration

**Goal**: Users can run gitleaks for deep content-based secret scanning inside the container
**Depends on**: Phase 21
**Plans**: 2 plans

Plans:
- [x] 22-01: Add gitleaks to base Dockerfile and create gitleaks command
- [x] 22-02: Scan freshness tracking and staleness warning

**Details:**
- Gitleaks v8.30.0 binary in base container image (multi-arch: amd64, arm64, armv7)
- `aishell gitleaks` command for one-shot scan with all passthrough args
- Skip-pre-start via `-e PRE_START=` to unset env var in entrypoint
- Per-project scan timestamp tracking in ~/.local/state/aishell/gitleaks-scans.edn
- 7-day staleness warnings before container launch
- Config toggle: gitleaks_freshness_check (default: enabled)

### Phase 23: Context & Configuration

**Goal**: Users can customize filename detection and get extra warnings for unprotected sensitive files
**Depends on**: Phase 22
**Plans**: 3 plans

Plans:
- [x] 23-01: Gitignore awareness for high-severity findings
- [x] 23-02: Custom patterns and allowlist configuration
- [x] 23-03: UAT gap fixes (custom severity, allowlist nil paths)

**Details:**
- Gitignore status annotation for high-severity findings: "(risk: may be committed)"
- Custom patterns in .aishell/config.yaml extend defaults (don't replace)
- Allowlist for suppressing false positives with path and reason
- Safe YAML parsing (no arbitrary object instantiation)
- Shorthand YAML syntax support: `"*.ext": high`

---

## Milestone Summary

**Decimal Phases:**
- Phase 18.1: Default Harness Arguments (inserted after Phase 18 for v2.1 prep)

**Key Decisions:**

- Advisory-only warnings: Never block, just inform (consistent with v2.0 pattern)
- Content detection delegated to Gitleaks (runs inside container via `aishell gitleaks`)
- Filename detection stays in aishell (pre-container, fast checks)
- High-severity requires y/n in interactive mode, --unsafe in CI
- Default staleness threshold: 7 days (balances nudging without annoyance)
- Custom patterns extend defaults via concatenation (not replacement)
- Allowlist entries require map format with :path and :reason keys

**Issues Resolved:**

- Babashka.fs glob quirk: `**/secret.*` doesn't match root directory files
- fs/match returns collection not boolean: use seq for truthy check
- YAML shorthand syntax: keyword/string opts used directly as severity
- Nil path handling: summary findings bypass allowlist entirely

**Issues Deferred:**

- PKEY-01, CLOD-01, PKGM-01: Content-based detection delegated to Gitleaks
- CTXT-02: Mount source indication (full paths provide sufficient context)

**Technical Debt Incurred:**

None - all phases completed without deferred items or anti-patterns.

---

_For current project status, see .planning/ROADMAP.md_
