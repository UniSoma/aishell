---
phase: 66-global-base-image-customization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/aishell/docker/base.clj
  - src/aishell/cli.clj
autonomous: true
requirements:
  - BASE-01
  - BASE-02
  - BASE-03
  - BASE-04
  - BASE-06

must_haves:
  truths:
    - "`aishell:base` tag always exists after setup — either custom-built from `~/.aishell/Dockerfile` or as a tag alias for `aishell:foundation`"
    - "When `~/.aishell/Dockerfile` exists and content changes, the base image is rebuilt on next setup/update --force"
    - "`aishell setup --force` rebuilds the base image (and re-tags if no global Dockerfile)"
    - "`aishell update --force` rebuilds the base image"
  artifacts:
    - path: "src/aishell/docker/base.clj"
      provides: "Global base image build, tag-alias, staleness detection"
      contains: "global-dockerfile-path"
    - path: "src/aishell/cli.clj"
      provides: "Setup and update integration with base image"
      contains: "ensure-base-image"
  key_links:
    - from: "src/aishell/cli.clj"
      to: "src/aishell/docker/base.clj"
      via: "require + function calls in handle-setup and handle-update"
      pattern: "base/ensure-base-image"
---

<objective>
Create the core `aishell:base` intermediate image layer module and integrate it into the setup and update commands.

Purpose: Establish the three-tier image chain (`aishell:foundation` -> `aishell:base` -> `aishell:ext-{hash}`) so that advanced users can globally customize their base image via `~/.aishell/Dockerfile`.

Output: New `docker/base.clj` module; updated `cli.clj` with base image tagging in setup and update paths.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/66-global-base-image-customization/66-CONTEXT.md
@src/aishell/docker/build.clj
@src/aishell/docker/extension.clj
@src/aishell/cli.clj
@src/aishell/docker.clj
@src/aishell/docker/hash.clj
@src/aishell/docker/spinner.clj
@src/aishell/util.clj
@src/aishell/output.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create docker/base.clj module</name>
  <files>src/aishell/docker/base.clj</files>
  <action>
Create a new Clojure namespace `aishell.docker.base` with these functions:

1. **`base-image-tag`** — constant `"aishell:base"`

2. **`global-dockerfile-path`** — returns `(str (fs/path (util/config-dir) "Dockerfile"))` i.e. `~/.aishell/Dockerfile`

3. **`global-dockerfile-exists?`** — returns true if `~/.aishell/Dockerfile` exists

4. **`global-dockerfile-hash`** — returns 12-char SHA-256 hash of global Dockerfile content (using `hash/compute-hash (slurp path)`) or nil if no file

5. **Docker label constants:**
   - `base-dockerfile-hash-label` = `"aishell.base.dockerfile.hash"`
   - `base-foundation-id-label` = `"aishell.base.foundation.id"`

6. **`tag-foundation-as-base`** — runs `docker tag aishell:foundation aishell:base` using `p/shell`. This is the "alias" path for when no global Dockerfile exists. Returns `{:success true :image "aishell:base" :alias true}`.

7. **`needs-base-rebuild?`** — checks if custom base image needs rebuilding:
   - If `aishell:base` doesn't exist -> true
   - If stored `base-dockerfile-hash-label` differs from current `global-dockerfile-hash` -> true
   - If stored `base-foundation-id-label` differs from current foundation image ID (use `ext/get-foundation-image-id`) -> true
   - Otherwise false

8. **`build-base-image`** — builds `aishell:base` from `~/.aishell/Dockerfile`:
   - Takes opts map `{:force :verbose}`
   - Gets foundation image ID, global Dockerfile hash
   - Builds with labels: `base-dockerfile-hash-label`, `base-foundation-id-label`
   - Uses spinner/with-spinner "Building global base image" for non-verbose mode
   - On success: prints confirmation line "Global base image built"
   - On failure: calls `output/error` with Docker build output (hard-stop per decision)
   - Returns `{:success true :image "aishell:base"}` on success

9. **`ensure-base-image`** — main entry point, called from run path and setup:
   - Takes opts map `{:force :verbose :quiet}`
   - If global Dockerfile exists:
     - If `needs-base-rebuild?` or `:force` -> `build-base-image`
     - Else: base is up to date (when not quiet, print "Base image aishell:base is up to date")
   - If global Dockerfile does NOT exist:
     - If `aishell:base` doesn't exist OR the base image has a custom dockerfile hash label (it was previously custom-built) -> `tag-foundation-as-base` (re-alias)
     - Else: base tag already points to foundation, nothing to do
   - Returns the result map from whichever path executed

Require: `babashka.process`, `babashka.fs`, `clojure.string`, `aishell.docker`, `aishell.docker.hash`, `aishell.docker.extension` (for `get-foundation-image-id`), `aishell.docker.spinner`, `aishell.output`, `aishell.util`

Follow the exact coding style from `docker/build.clj` and `docker/extension.clj`:
- Docstrings on all public functions
- `defn-` for private helpers
- p/shell with `:out :string :err :string :continue true` for docker commands
  </action>
  <verify>
Run `bb -e "(require '[aishell.docker.base]) (println 'OK')"` from project root to verify the namespace loads without errors. SCI resolves all symbols at analysis time, so a successful load means no undefined references.
  </verify>
  <done>
`src/aishell/docker/base.clj` exists with all 9 items above. Namespace loads cleanly under Babashka.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate base image into setup and update commands</name>
  <files>src/aishell/cli.clj</files>
  <action>
Modify `src/aishell/cli.clj`:

1. **Add require:** Add `[aishell.docker.base :as base]` to the ns requires.

2. **Update `handle-setup`:**
   After the foundation image build succeeds (after `result` is bound from `build/build-foundation-image`), call:
   ```
   (base/ensure-base-image {:force (:force opts) :verbose (:verbose opts)})
   ```
   This ensures `aishell:base` always exists after setup. If user has `~/.aishell/Dockerfile`, it builds from it. Otherwise, it tags foundation as base.

   Place this call right after the foundation image build result, before the harness volume section.

3. **Update `handle-update`:**
   After the conditional foundation image rebuild (the `result` binding with `when (:force opts)`), add a base image ensure call:
   ```
   (when (:force opts)
     (base/ensure-base-image {:force true :verbose (:verbose opts)}))
   ```
   This ensures `--force` also rebuilds the base image (per locked decision: "`aishell setup --force` rebuilds base").

   When `--force` is NOT passed, still ensure the base tag exists (in case user just added or removed their global Dockerfile):
   ```
   (when-not (:force opts)
     (base/ensure-base-image {:verbose (:verbose opts) :quiet true}))
   ```

Note: Do NOT touch the run path integration here — that's Plan 66-02.
  </action>
  <verify>
Run `bb -e "(require '[aishell.cli]) (println 'OK')"` from project root to verify the full CLI namespace loads cleanly. This validates all requires resolve and no undefined symbols exist.
  </verify>
  <done>
`cli.clj` requires `aishell.docker.base`, and both `handle-setup` and `handle-update` call `base/ensure-base-image` at appropriate points. Full namespace loads under Babashka.
  </done>
</task>

</tasks>

<verification>
1. `bb -e "(require '[aishell.docker.base]) (println 'loaded')"` succeeds
2. `bb -e "(require '[aishell.cli]) (println 'loaded')"` succeeds
3. `aishell --help` still works (no regressions in CLI loading)
</verification>

<success_criteria>
- New `docker/base.clj` module exists with global Dockerfile detection, build, tag-alias, and staleness check functions
- `handle-setup` calls `ensure-base-image` after foundation build
- `handle-update` calls `ensure-base-image` (force or quiet depending on --force flag)
- All namespaces load cleanly under Babashka (no SCI resolution errors)
</success_criteria>

<output>
After completion, create `.planning/phases/66-global-base-image-customization/66-01-SUMMARY.md`
</output>
