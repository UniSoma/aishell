---
phase: 66-global-base-image-customization
plan: 03
type: execute
wave: 3
depends_on:
  - 66-02
files_modified:
  - README.md
  - docs/ARCHITECTURE.md
  - docs/CONFIGURATION.md
  - docs/HARNESSES.md
  - docs/TROUBLESHOOTING.md
  - docs/DEVELOPMENT.md
autonomous: true
requirements:
  - BASE-09

must_haves:
  truths:
    - "README.md mentions global base image customization via `~/.aishell/Dockerfile`"
    - "ARCHITECTURE.md documents the three-tier image chain"
    - "CONFIGURATION.md explains how to create and use `~/.aishell/Dockerfile`"
    - "TROUBLESHOOTING.md covers base image build failures and reset procedure"
    - "DEVELOPMENT.md explains the base image module for contributors"
  artifacts:
    - path: "README.md"
      provides: "Feature mention in project overview"
      contains: "~/.aishell/Dockerfile"
    - path: "docs/ARCHITECTURE.md"
      provides: "Three-tier image chain diagram"
      contains: "aishell:foundation.*aishell:base.*aishell:ext"
    - path: "docs/CONFIGURATION.md"
      provides: "Global Dockerfile usage guide with examples"
      contains: "~/.aishell/Dockerfile"
  key_links:
    - from: "docs/CONFIGURATION.md"
      to: "docs/ARCHITECTURE.md"
      via: "cross-reference to image chain"
      pattern: "ARCHITECTURE.md"
---

<objective>
Update all user-facing documentation to cover global base image customization.

Purpose: Users need clear guidance on how to create `~/.aishell/Dockerfile`, what the three-tier image chain means, common use cases, and how to troubleshoot base image issues.

Output: Updated README.md and all 5 docs/ files.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/66-global-base-image-customization/66-CONTEXT.md
@.planning/phases/66-global-base-image-customization/66-02-SUMMARY.md
@README.md
@docs/ARCHITECTURE.md
@docs/CONFIGURATION.md
@docs/HARNESSES.md
@docs/TROUBLESHOOTING.md
@docs/DEVELOPMENT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update README.md, ARCHITECTURE.md, CONFIGURATION.md</name>
  <files>README.md, docs/ARCHITECTURE.md, docs/CONFIGURATION.md</files>
  <action>
**README.md:**
- In the features or setup section, add a brief mention of global base image customization
- Example: "Advanced users can customize the base image globally via `~/.aishell/Dockerfile` (extra system packages, shell config, dev tools)"
- Keep it brief — 2-3 sentences max with a pointer to CONFIGURATION.md for details

**ARCHITECTURE.md:**
- Update the image architecture section to document the three-tier chain:
  ```
  aishell:foundation -> aishell:base -> aishell:ext-{hash}
  ```
- Explain: foundation is system dependencies (unchanged by setup), base is either an alias for foundation (default) or a custom build from `~/.aishell/Dockerfile`, ext is per-project extensions
- Document the Docker labels used for cache tracking:
  - `aishell.base.dockerfile.hash` — content hash of global Dockerfile
  - `aishell.base.foundation.id` — foundation image ID at base build time
- Note that base image changes cascade to extension rebuilds

**CONFIGURATION.md:**
- Add a new section "## Global Base Image Customization" (or similar heading, placed logically)
- Explain:
  - Create `~/.aishell/Dockerfile` to customize the base image globally
  - The file should start with `FROM aishell:foundation` (recommended but not enforced)
  - Changes are detected automatically — the base image rebuilds on next `aishell` run
  - To remove customizations, delete `~/.aishell/Dockerfile` and run `aishell volumes prune`
- Include 2-3 use case examples per locked decision:
  1. Extra system packages: `RUN apt-get update && apt-get install -y python3-pip`
  2. Shell configuration: `COPY .bashrc /etc/skel/.bashrc` or `RUN echo 'alias ll="ls -la"' >> /etc/bash.bashrc`
  3. Dev tools: `RUN pip3 install httpie` or `RUN cargo install just`
- Note: project `.aishell/Dockerfile` can use `FROM aishell:base` (recommended) or `FROM aishell:foundation` (both accepted)
  </action>
  <verify>
Read through each file to confirm the new sections are present, well-formatted, and consistent with existing doc style. No broken markdown.
  </verify>
  <done>
README.md mentions global base image. ARCHITECTURE.md documents three-tier chain with labels. CONFIGURATION.md has full guide with 2-3 examples.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update HARNESSES.md, TROUBLESHOOTING.md, DEVELOPMENT.md</name>
  <files>docs/HARNESSES.md, docs/TROUBLESHOOTING.md, docs/DEVELOPMENT.md</files>
  <action>
**HARNESSES.md:**
- If there's a section about project extension Dockerfiles, update it to mention that `FROM aishell:base` is now the recommended base (instead of `FROM aishell:foundation`)
- Note that `aishell:base` inherits any global customizations from `~/.aishell/Dockerfile`
- Keep it brief — most detail lives in CONFIGURATION.md

**TROUBLESHOOTING.md:**
- Add a section "### Base Image Build Failures" covering:
  - Symptom: base image build fails with Docker error output
  - Cause: syntax error or invalid command in `~/.aishell/Dockerfile`
  - Fix: edit `~/.aishell/Dockerfile` to fix the error, or delete it to revert to default
  - Build output is shown in full when it fails (hard-stop behavior)
- Add a section "### Reset Global Base Image" covering:
  - To reset: delete `~/.aishell/Dockerfile`
  - On next run, `aishell:base` reverts to foundation alias
  - Run `aishell volumes prune` to clean up orphaned base image

**DEVELOPMENT.md:**
- Add entry in the module/file reference section for `docker/base.clj`
  - Purpose: Global base image customization — detects `~/.aishell/Dockerfile`, builds `aishell:base`, manages tag alias
  - Key functions: `ensure-base-image`, `global-dockerfile-exists?`, `needs-base-rebuild?`, `build-base-image`, `tag-foundation-as-base`
- Update any existing image chain documentation to reflect the three-tier model
- If there's a "adding a new feature" or contributor guide section, note the base image module as an example of the lazy-build pattern
  </action>
  <verify>
Read through each file to confirm new sections present, consistent with doc style, no broken markdown.
  </verify>
  <done>
HARNESSES.md recommends `FROM aishell:base`. TROUBLESHOOTING.md covers base build failures and reset. DEVELOPMENT.md documents `docker/base.clj` module.
  </done>
</task>

</tasks>

<verification>
1. All 6 documentation files mention `~/.aishell/Dockerfile` or base image customization
2. Three-tier chain documented in ARCHITECTURE.md
3. Use case examples present in CONFIGURATION.md
4. Troubleshooting covers build failures and reset
5. DEVELOPMENT.md lists the new module
</verification>

<success_criteria>
- All 6 user-facing doc files updated with base image customization content
- Documentation includes 2-3 use case examples (system packages, shell config, dev tools)
- Both `FROM aishell:base` and `FROM aishell:foundation` documented as valid
- Reset procedure documented (delete file + volumes prune)
</success_criteria>

<output>
After completion, create `.planning/phases/66-global-base-image-customization/66-03-SUMMARY.md`
</output>
