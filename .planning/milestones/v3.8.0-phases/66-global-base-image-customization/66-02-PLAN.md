---
phase: 66-global-base-image-customization
plan: 02
type: execute
wave: 2
depends_on:
  - 66-01
files_modified:
  - src/aishell/docker/extension.clj
  - src/aishell/run.clj
  - src/aishell/check.clj
  - src/aishell/cli.clj
autonomous: true
requirements:
  - BASE-04
  - BASE-05
  - BASE-07
  - BASE-08

must_haves:
  truths:
    - "Project extension images build FROM aishell:base (inheriting global customizations)"
    - "Lazy base image build triggers on container run when `~/.aishell/Dockerfile` exists and base is stale"
    - "`aishell check` displays base image status — custom or default alias"
    - "`aishell volumes prune` can clean up orphaned base images"
    - "`FROM aishell:base` in project Dockerfiles is accepted (no validation error)"
  artifacts:
    - path: "src/aishell/docker/extension.clj"
      provides: "Extension builds using aishell:base as parent"
      contains: "base/base-image-tag"
    - path: "src/aishell/run.clj"
      provides: "Lazy base image build before container run"
      contains: "base/ensure-base-image"
    - path: "src/aishell/check.clj"
      provides: "Base image status in check output"
      contains: "check-base-image-custom"
  key_links:
    - from: "src/aishell/run.clj"
      to: "src/aishell/docker/base.clj"
      via: "require + ensure-base-image call before resolve-image-tag"
      pattern: "base/ensure-base-image"
    - from: "src/aishell/docker/extension.clj"
      to: "src/aishell/docker/base.clj"
      via: "base-image-tag as parent for extension builds"
      pattern: "base/base-image-tag"
---

<objective>
Wire the base image layer into the run path, extension builds, check command, and volumes prune.

Purpose: Complete the three-tier chain by making extensions build from `aishell:base`, adding lazy base build on container run, and providing visibility/cleanup for the base image.

Output: Updated extension.clj, run.clj, check.clj, cli.clj with base image integration.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/66-global-base-image-customization/66-CONTEXT.md
@.planning/phases/66-global-base-image-customization/66-01-SUMMARY.md
@src/aishell/docker/base.clj
@src/aishell/docker/extension.clj
@src/aishell/docker/build.clj
@src/aishell/run.clj
@src/aishell/check.clj
@src/aishell/cli.clj
@src/aishell/docker.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update extension.clj and run.clj for base image layer</name>
  <files>src/aishell/docker/extension.clj, src/aishell/run.clj</files>
  <action>
**extension.clj changes:**

1. **Add require:** `[aishell.docker.base :as base]`

2. **Remove `validate-base-tag` function entirely.** This function rejects `FROM aishell:base` in project Dockerfiles — the exact opposite of what we want now. Per locked decision: "Accept both FROM lines — project Dockerfiles can use `FROM aishell:foundation` or `FROM aishell:base`".

3. **Update `needs-extended-rebuild?`:** Change the foundation image ID tracking to also check if the base image ID has changed. The extension now builds FROM `aishell:base`, so we need to track the base image ID, not the foundation image ID.
   - Replace `foundation-image-id-label` constant with `base-image-id-label` = `"aishell.base.id"` (tracks parent `aishell:base` image ID)
   - In `needs-extended-rebuild?`, compare against `(get-foundation-image-id base/base-image-tag)` instead of the foundation tag
   - This means when the base image changes (whether due to global Dockerfile edit or foundation rebuild), extensions auto-rebuild

4. **Update `build-extended-image`:**
   - The `foundation-tag` parameter is now the base image tag (`aishell:base`), not `aishell:foundation`
   - The foundation-id label stored on extensions should track the base image ID (since that's what FROM references)
   - Callers will pass `base/base-image-tag` instead of `build/foundation-image-tag`

**run.clj changes:**

1. **Add require:** `[aishell.docker.base :as base]`

2. **Update `resolve-image-tag`:**
   - Before extension resolution, ensure the base image is up to date by calling `(base/ensure-base-image {})` (lazy build — no force, no verbose, no quiet so user sees build output)
   - Change `base-tag` usage: the function currently receives `base-tag` from caller. Update so the extension builds use `base/base-image-tag` ("aishell:base") as the parent tag
   - When no extension exists, return `base/base-image-tag` (not the raw foundation tag)

3. **Remove `validate-base-tag` calls:** There are two call sites:
   - `resolve-image-tag` calls `(ext/validate-base-tag project-dir)` — remove this call
   - These were the enforcement points for the old "reject FROM aishell:base" behavior

4. **Update `run-container`:**
   - In the `let` binding, change `base-tag` to use `base/base-image-tag` instead of `(or (:image-tag state) "aishell:base")`
   - The base image existence check (`when-not (docker/image-exists? base-tag)`) should check for `base/base-image-tag`
   - Add a `(base/ensure-base-image {})` call early in the run path, before the base image existence check — this is the lazy build trigger

5. **Update `run-exec`:**
   - Same changes as `run-container`: use `base/base-image-tag`, add `(base/ensure-base-image {})` call before extension resolution
  </action>
  <verify>
Run `bb -e "(require '[aishell.run]) (println 'OK')"` from project root. Verify no SCI resolution errors.
Also: `grep -rn "validate-base-tag" src/` should return zero results.
  </verify>
  <done>
Extension builds use `aishell:base` as parent. `validate-base-tag` is fully removed. Run path calls `ensure-base-image` before every container run (lazy build). All namespaces load cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update check command and volumes prune for base image</name>
  <files>src/aishell/check.clj, src/aishell/cli.clj</files>
  <action>
**check.clj changes:**

1. **Add require:** `[aishell.docker.base :as base]`

2. **Add `check-base-image-custom` function** (new, placed after `check-base-image`):
   Per locked decision: "`aishell check` always shows base image status"
   ```
   (defn- check-base-image-custom []
     (if (base/global-dockerfile-exists?)
       (if (base/needs-base-rebuild?)
         (print-status :warn "Base image: custom (~/.aishell/Dockerfile) — needs rebuild")
         (print-status :ok "Base image: custom (~/.aishell/Dockerfile)"))
       (print-status :ok "Base image: default (foundation alias)")))
   ```

3. **Update `check-extension`:** Remove the `(ext/validate-base-tag project-dir)` call from `check-extension`. This was the third call site for the removed function.

4. **Wire `check-base-image-custom` into `run-check`:**
   Add the call in the Setup section, right after the `check-dockerfile-staleness` call and before the extension check:
   ```
   (check-base-image-custom)
   ```

**cli.clj changes (volumes prune):**

5. **Update `handle-volumes-prune`:** Per locked decision: "`aishell volumes prune` includes orphaned base images".
   After the existing orphaned volume pruning logic, add a check for orphaned base images:
   - If `aishell:base` image exists AND has a custom dockerfile hash label (i.e., `(docker/get-image-label "aishell:base" "aishell.base.dockerfile.hash")` returns non-nil) AND `~/.aishell/Dockerfile` does NOT exist, then the custom base image is orphaned
   - Print "Orphaned custom base image found" and re-tag foundation as base (call `base/tag-foundation-as-base`)
   - This handles the "Delete file to reset" decision: cleanup happens via `volumes prune`

   Add `[aishell.docker.base :as base]` to requires if not already present (it was added in Plan 66-01).
  </action>
  <verify>
Run `bb -e "(require '[aishell.check]) (println 'OK')"` and `bb -e "(require '[aishell.cli]) (println 'OK')"` from project root.
`grep -rn "validate-base-tag" src/` should return zero results (was removed in Task 1 from extension.clj, now removed from check.clj too).
  </verify>
  <done>
`aishell check` displays base image status (custom vs default). `aishell volumes prune` detects and cleans up orphaned custom base images. `validate-base-tag` has zero references anywhere in the codebase.
  </done>
</task>

</tasks>

<verification>
1. `bb -e "(require '[aishell.docker.extension]) (println 'loaded')"` succeeds
2. `bb -e "(require '[aishell.run]) (println 'loaded')"` succeeds
3. `bb -e "(require '[aishell.check]) (println 'loaded')"` succeeds
4. `bb -e "(require '[aishell.cli]) (println 'loaded')"` succeeds
5. `grep -rn "validate-base-tag" src/` returns zero matches
6. `aishell --help` still works
</verification>

<success_criteria>
- Extension images build FROM `aishell:base` (three-tier chain complete)
- `validate-base-tag` fully removed from codebase (all 3 call sites + definition)
- Run path lazily builds/tags base image before every container run
- `aishell check` shows base image status
- `volumes prune` handles orphaned base images
</success_criteria>

<output>
After completion, create `.planning/phases/66-global-base-image-customization/66-02-SUMMARY.md`
</output>
