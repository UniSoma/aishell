---
phase: 63-core-openspec-integration
plan: 02
type: execute
wave: 2
depends_on: [63-01]
files_modified:
  - src/aishell/run.clj
  - src/aishell/check.clj
autonomous: true
requirements: [BUILD-03, VOL-01, VOL-02]

must_haves:
  truths:
    - "Running aishell shell after building with --with-openspec mounts the harness volume containing openspec"
    - "Toggling OpenSpec off and running aishell shell no longer mounts the volume (if no other harnesses enabled)"
    - "aishell check shows OpenSpec installed status and version"
    - "Volume is lazily populated when OpenSpec is the only enabled tool"
  artifacts:
    - path: "src/aishell/run.clj"
      provides: "OpenSpec included in harness volume trigger check"
      contains: ":with-openspec"
    - path: "src/aishell/check.clj"
      provides: "OpenSpec shown in check harness status display"
      contains: "OpenSpec"
  key_links:
    - from: "src/aishell/run.clj"
      to: "src/aishell/docker/volume.clj"
      via: "ensure-harness-volume checks :with-openspec to decide if volume needed"
      pattern: ":with-openspec"
    - from: "src/aishell/check.clj"
      to: "src/aishell/state.clj"
      via: "check-harnesses reads :with-openspec from state"
      pattern: ":with-openspec.*:openspec-version"
---

<objective>
Wire OpenSpec into the runtime path (container launch and status checks) so that the harness volume is mounted when OpenSpec is the only enabled tool and `aishell check` displays OpenSpec status.

Purpose: Complete the runtime integration — without this, `aishell shell` wouldn't mount the volume when OpenSpec is the only enabled tool, and `aishell check` wouldn't show OpenSpec status.

Output: Full end-to-end integration where building with `--with-openspec`, running `aishell shell`, and checking with `aishell check` all work correctly.
</objective>

<execution_context>
@/home/jonasrodrigues/.claude/get-shit-done/workflows/execute-plan.md
@/home/jonasrodrigues/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-core-openspec-integration/63-CONTEXT.md
@.planning/phases/63-core-openspec-integration/63-01-SUMMARY.md

# Key source files
@src/aishell/run.clj
@src/aishell/check.clj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OpenSpec to runtime volume trigger</name>
  <files>src/aishell/run.clj</files>
  <action>
In `src/aishell/run.clj`, modify the `ensure-harness-volume` function:

1. Add `:with-openspec` to the `(some #(get state %) [...])` check on line ~49 that determines whether any harness/tool needs a volume. The current list is `[:with-claude :with-opencode :with-codex :with-gemini :with-pi]` — add `:with-openspec` to this vector.

This is the critical change: without it, if OpenSpec is the ONLY enabled tool (no Claude, no OpenCode, etc.), `ensure-harness-volume` returns nil, the volume is not mounted, and `openspec` command won't be available inside the container.

No other changes needed in run.clj. OpenSpec has:
- No `aishell openspec` subcommand (not in `verify-harness-available` case)
- No config directory mounts (not in `harness-config-dirs` in docker/run.clj)
- No API key passthrough (not in `harness-api-keys` in docker/run.clj)
- No harness alias (not in `build-harness-alias-env-args` in docker/run.clj)
  </action>
  <verify>
Run `grep ":with-openspec" src/aishell/run.clj` — should show exactly 1 match in the `ensure-harness-volume` function's `some` check.

Verify the vector now contains all 6 keys: `[:with-claude :with-opencode :with-codex :with-gemini :with-pi :with-openspec]`
  </verify>
  <done>The harness volume is mounted at runtime when OpenSpec is enabled, even if it's the only enabled tool. The `openspec` command will be available inside the container via the /tools volume PATH.</done>
</task>

<task type="auto">
  <name>Task 2: Add OpenSpec to check command status display</name>
  <files>src/aishell/check.clj</files>
  <action>
In `src/aishell/check.clj`, modify the `check-harnesses` function:

1. Add `["OpenSpec" :with-openspec :openspec-version]` to the `harnesses` vector in `check-harnesses`. Place it after the Pi entry and before the Gitleaks entry, maintaining the pattern:
   ```clojure
   [["Claude Code" :with-claude :claude-version]
    ["OpenCode" :with-opencode :opencode-version]
    ["Codex CLI" :with-codex :codex-version]
    ["Gemini CLI" :with-gemini :gemini-version]
    ["Pi" :with-pi :pi-version]
    ["OpenSpec" :with-openspec :openspec-version]
    ["Gitleaks" :with-gitleaks nil]]
   ```

This ensures `aishell check` displays OpenSpec installed/not-installed status alongside other tools. The existing display logic handles the version display automatically (shows version if pinned, nothing if latest).
  </action>
  <verify>
Run `grep -A1 "OpenSpec" src/aishell/check.clj` — should show the entry in the harnesses vector.

Run `grep -c "openspec" src/aishell/check.clj` — should show 2 matches (the display name and the state key).
  </verify>
  <done>`aishell check` displays OpenSpec installation status and version (if pinned) in the Harnesses section, consistent with all other tools.</done>
</task>

</tasks>

<verification>
1. `grep -rn ":with-openspec" src/aishell/run.clj src/aishell/check.clj` shows OpenSpec in both files
2. In run.clj: `:with-openspec` appears in the `ensure-harness-volume` some-check vector
3. In check.clj: `"OpenSpec"` appears in the harnesses display vector with correct state/version keys
4. No OpenSpec references in docker/run.clj (no config mounts, no API keys, no aliases — correct per decision "not a harness")
</verification>

<success_criteria>
- `aishell shell` mounts harness volume when OpenSpec is the only enabled tool
- `aishell check` shows "OpenSpec installed" when enabled, "OpenSpec not installed" when disabled
- `aishell check` shows pinned version when `--with-openspec=1.2.3` was used
- No config directory mounts for OpenSpec (per decision: "No host config file mounts")
- No API key passthrough for OpenSpec (per decision: "OpenSpec requires no API keys")
- No `aishell openspec` subcommand (per decision: "Not a harness")
</success_criteria>

<output>
After completion, create `.planning/phases/63-core-openspec-integration/63-02-SUMMARY.md`
</output>
