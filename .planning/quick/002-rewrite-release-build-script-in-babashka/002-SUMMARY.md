---
phase: quick
plan: 002
type: quick-task
subsystem: build-tooling
tags: [babashka, clojure, build-scripts, sha256, uberscript]

requires:
  - "Babashka CLI (phases 13-18)"
  - "bb uberscript command"

provides:
  - "Babashka-based release build script"
  - "Native SHA-256 checksum generation"
  - "Consistent tooling (Clojure for all scripts)"

affects:
  - "Release process"
  - "CI/CD build pipeline"

tech-stack:
  added: []
  patterns:
    - "Java MessageDigest for SHA-256"
    - "babashka.fs for file operations"
    - "babashka.process for shell commands"

key-files:
  created:
    - scripts/build-release.clj
  modified: []
  deleted:
    - scripts/build-release.sh

decisions:
  - key: "compute-sha256-full-64-chars"
    decision: "Use full 64-character SHA-256 hash for release checksums"
    context: "Unlike cache invalidation (12 chars), release checksums need full hash for security verification"
    phase: "quick-002"
  - key: "native-shebang-injection"
    decision: "Use slurp/spit for shebang injection instead of sed"
    context: "Avoids platform-specific sed -i syntax differences, pure Clojure solution"
    phase: "quick-002"

metrics:
  duration: "1.1 min"
  completed: "2026-01-21"
---

# Quick Task 002: Rewrite Release Build Script in Babashka Summary

**One-liner:** Rewrote bash build-release.sh in Babashka using Java MessageDigest for SHA-256 checksums

## What Was Built

Replaced the bash release build script with a native Babashka implementation:

1. **scripts/build-release.clj**: Full rewrite of build-release.sh in Clojure
   - Uses babashka.fs for file operations (create-dirs, delete-if-exists, read-all-bytes)
   - Uses babashka.process for shell commands (bb uberscript, chmod)
   - Native shebang injection via slurp/spit (no sed platform issues)
   - Java MessageDigest for SHA-256 checksum (zero external dependencies)
   - Identical output format to bash version

2. **Removed scripts/build-release.sh**: Legacy bash script no longer needed

## Artifacts

**Build outputs (generated by script):**
- `dist/aishell`: Executable uberscript with #!/usr/bin/env bb shebang
- `dist/aishell.sha256`: Checksum file in standard format: `{64-char-hash}  aishell`

**Verification:**
```bash
./scripts/build-release.clj
cd dist && sha256sum -c aishell.sha256
```

## Technical Implementation

### SHA-256 Checksum Generation

```clojure
(defn compute-sha256
  "Compute SHA-256 hash of file, returning 64-character hex string."
  [file-path]
  (let [md (java.security.MessageDigest/getInstance "SHA-256")
        bytes (.digest md (fs/read-all-bytes file-path))]
    (apply str (map #(format "%02x" (bit-and % 0xff)) bytes))))
```

**Key difference from aishell.docker.hash:**
- Full 64-character hash (not truncated to 12 chars)
- Release checksums need full hash for security verification
- Cache invalidation uses 12-char truncation for brevity

### Native Shebang Injection

```clojure
;; Replace platform-specific sed -i with pure Clojure
(let [content (slurp output-file)]
  (spit output-file (str "#!/usr/bin/env bb\n" content)))
```

**Benefits:**
- No macOS/Linux sed -i syntax differences
- Pure Clojure solution (consistent with rest of codebase)
- Simpler and more maintainable

### Build Process

1. Create dist/ directory
2. Delete existing uberscript (bb uberscript refuses to overwrite)
3. Run `bb uberscript dist/aishell -m aishell.core`
4. Inject shebang via slurp/spit
5. Make executable with chmod +x
6. Generate SHA-256 checksum in standard format
7. Print completion message with checksum

## Decisions Made

### 1. Full 64-character SHA-256 for Release Checksums

**Context:** The docker.hash namespace truncates SHA-256 to 12 characters for cache invalidation (brevity, human-readable).

**Decision:** Release checksums use full 64-character hash.

**Rationale:**
- Security verification requires full hash strength
- Matches standard sha256sum/shasum output format
- Used by curl|bash installer for integrity verification

### 2. Native Shebang Injection (slurp/spit vs sed)

**Context:** Bash version used platform-specific sed -i syntax (different for macOS vs Linux).

**Decision:** Use Clojure slurp/spit for shebang injection.

**Rationale:**
- Eliminates platform-specific code branches
- Pure Clojure solution (consistent with rest of codebase)
- More maintainable and easier to understand
- No external tool dependencies

## Deviations from Plan

None - plan executed exactly as written.

## Task Breakdown

| Task | Description | Commit | Files |
|------|-------------|--------|-------|
| 1 | Create Babashka build-release script | df2c7d3 | scripts/build-release.clj |
| 2 | Remove legacy bash script | 8022940 | scripts/build-release.sh (deleted) |

## Testing Performed

**Verification tests:**
1. Script execution: `./scripts/build-release.clj`
2. Output files exist: `dist/aishell` and `dist/aishell.sha256`
3. Executable permission: `test -x dist/aishell`
4. Shebang present: `head -1 dist/aishell | grep "#!/usr/bin/env bb"`
5. Checksum format: `cat dist/aishell.sha256 | grep -E "^[a-f0-9]{64}  aishell$"`
6. Checksum valid: `cd dist && sha256sum -c aishell.sha256`
7. Full integration test (all checks combined)

**All tests passed.**

## Benefits

1. **Consistent tooling**: All build scripts now in same language as application
2. **Platform independence**: No sed -i platform quirks
3. **Zero external dependencies**: Uses Java MessageDigest built-in
4. **Maintainability**: Easier for Clojure developers to understand and modify
5. **Reliability**: Same checksum algorithm as hash.clj (proven pattern)

## Next Phase Readiness

**No blockers.**

This is a quick task for improving build tooling consistency. The release build script now matches the language and patterns of the rest of the v2.0 Babashka codebase.

**Future consideration:**
- CI/CD pipelines may need to update from `./scripts/build-release.sh` to `./scripts/build-release.clj`
- Both produce identical outputs, so this is a simple path change
