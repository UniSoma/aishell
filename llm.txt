# aishell

> Docker sandbox for running AI coding agents in ephemeral containers.

aishell runs AI coding agents (Claude Code, OpenCode, Codex CLI, Gemini CLI) inside isolated Docker containers. It preserves paths, forwards git identity, manages configuration and mounts, and scans for secrets — replacing long `docker run` commands.

Version: 3.4.1
License: MIT
Repository: https://github.com/UniSoma/aishell
Requirements: Linux, macOS, Windows, or WSL2; Docker; Babashka (https://babashka.org)

---

## How It Works

aishell builds a foundation Docker image (Debian bookworm-slim with Node.js 24, git, and CLI tools) and populates a Docker volume with harness tools (npm packages and binaries). Each harness launch creates an ephemeral container with your project mounted at its real host path, your git identity forwarded, and the harness tools available.

Key design principles:

- Containers are ephemeral and stateless. All work happens in the mounted project directory.
- Your project mounts at its real host path (e.g., `/home/you/project` stays `/home/you/project`), so AI agent file references remain valid.
- Git identity (user.name, user.email) passes through automatically; commits appear under your name.
- The container user matches your host UID/GID, keeping file ownership correct.
- Harness tools live in a Docker volume mounted read-only at `/tools`, separate from the foundation image, so updates are fast.

---

## Installation

### Linux / macOS / WSL2

```
curl -fsSL https://raw.githubusercontent.com/UniSoma/aishell/main/install.sh | bash
export PATH="$HOME/.local/bin:$PATH"
```

### Windows (PowerShell)

```
irm https://raw.githubusercontent.com/UniSoma/aishell/main/install.ps1 | iex
```

Both installers auto-install Babashka if not found.

---

## Commands

### setup

Build the foundation image and install harnesses. Run once, or again to change harness selection.

```
aishell setup --with-claude
aishell setup --with-claude --with-opencode
aishell setup --with-claude=2.0.22
```

Options:
- `--with-claude[=VERSION]` - Install Claude Code. Optionally pin a version.
- `--with-opencode[=VERSION]` - Install OpenCode.
- `--with-codex[=VERSION]` - Install Codex CLI.
- `--with-gemini[=VERSION]` - Install Gemini CLI.
- `--with-gitleaks` - Include Gitleaks secret scanner.
- `--force` - Rebuild everything, bypass Docker cache.
- `--verbose`, `-v` - Show full Docker build output.

### Running Harnesses

Run any installed harness. Arguments after the harness name pass through to the underlying binary.

```
aishell claude
aishell claude --model sonnet
aishell opencode
aishell codex
aishell gemini
aishell gitleaks detect --verbose
```

Common options for all harnesses:
- `--name NAME` - Custom container name (default: harness name).
- `--unsafe` - Skip sensitive file detection.

### Default (No Command)

Enter an interactive bash shell inside the container.

```
aishell
aishell --name my-shell
aishell --unsafe
```

### exec

Run a one-off command in the container. Same mounts and environment as harnesses, but skips pre-start hooks and sensitive file detection.

```
aishell exec ls -la
aishell exec npm test
echo "hello" | aishell exec cat
```

Auto-detects TTY for interactive vs piped usage.

### update

Refresh harness tools to their latest versions. Preserves harness selection from the last setup.

```
aishell update           # Recreate harness volume only (fast)
aishell update --force   # Also rebuild foundation image
```

Does not change harness selection; use `aishell setup` for that.

### check

Validate the project without launching a container.

```
aishell check
```

Checks: Docker availability, setup state, image existence, Dockerfile staleness, harness versions, project extensions, configuration validity, mount sources, dangerous Docker options, sensitive files, Gitleaks scan freshness.

### ps

List running and stopped containers for the current project.

```
aishell ps
```

Output: table with NAME, STATUS, CREATED.

### attach

Open a bash shell in a running container.

```
aishell attach claude
aishell attach reviewer
```

Takes a positional argument: the container name used when starting it (e.g., `aishell claude --name reviewer`).

### volumes

Manage harness volumes.

```
aishell volumes              # List all volumes with status and size
aishell volumes list         # Same as above
aishell volumes prune        # Remove orphaned volumes (prompts for confirmation)
aishell volumes prune --yes  # Remove without confirmation
```

### vscode

Open VSCode attached to the aishell container as the `developer` user. Experimental — API subject to change.

```
aishell vscode            # Open VSCode (blocks until closed, then stops container)
aishell vscode --detach   # Run in background (container persists)
aishell vscode --stop     # Stop a detached vscode container
```

What this does:
1. Ensures VSCode per-image config exists (defaults `remoteUser` to `developer`).
2. Starts the container in detached mode if not already running.
3. Mounts `~/.vscode-server` for server persistence across restarts.
4. Opens VSCode using the `vscode-remote://attached-container+` URI scheme.
5. By default, waits for VSCode to close, then stops the container. Multiple instances can run simultaneously.

Prerequisites: VSCode with `code` CLI on PATH, Dev Containers extension installed, `aishell setup` completed.

### upgrade

Self-upgrade aishell to the latest version (or a specific version). Downloads from GitHub releases with SHA-256 checksum verification.

```
aishell upgrade           # Upgrade to latest version
aishell upgrade 3.4.0     # Upgrade to specific version
aishell upgrade 3.2.0     # Downgrade to older version (shows warning)
```

Requires `curl` or `wget`. On Windows, also updates the `aishell.bat` wrapper.

### --version

```
aishell --version       # Human-readable version
aishell --version --json  # JSON output
```

---

## Configuration

aishell reads YAML configuration from two files:

- `~/.aishell/config.yaml` - Global defaults for all projects.
- `.aishell/config.yaml` - Project-specific overrides.

### Config Inheritance

The `extends` key in project config controls merging:

- `extends: global` (default) - Merge with global config.
  - Lists (mounts, ports, docker_args): concatenate.
  - Maps (env): shallow merge, project keys win.
  - Map-of-lists (harness_args): merge keys, concatenate per-harness lists.
  - Scalars (pre_start, gitleaks_freshness_check): project replaces global.
  - Detection: enabled = project wins, custom_patterns = map merge, allowlist = concatenate.
- `extends: none` - Ignore global config entirely.

### All Configuration Keys

#### mounts

Mount host directories into the container.

```yaml
mounts:
  - ~/.gitconfig                      # Same path inside container
  - ~/data:/data                      # Custom mapping
  - ~/.aws:/home/user/.aws:ro         # Read-only
```

Tilde (`~`) expands to the home directory. Append `:ro` for read-only mounts.

#### env

Set environment variables. Prefer map format.

```yaml
env:
  DEBUG: "true"                       # Literal value
  DATABASE_URL: "postgres://db/app"   # Literal value
  EDITOR:                             # Passthrough from host (empty value)
```

Alternative list format:

```yaml
env:
  - DEBUG=true
  - EDITOR                            # Passthrough (no =)
```

#### ports

Expose container ports.

```yaml
ports:
  - "8080:8080"                       # All interfaces
  - "127.0.0.1:5432:5432"             # Localhost only
  - "9090:9090/udp"                   # UDP
```

#### docker_args

Extra arguments passed to `docker run`.

```yaml
docker_args:
  - "--cpus=2"
  - "--memory=4g"
  - "--hostname=aishell"
```

Dangerous flags (--privileged, --network=host, --cap-add=ALL, etc.) trigger warnings.

#### pre_start

Commands that run inside the container before the harness starts. Runs in background via `nohup`; output goes to `/tmp/pre-start.log`.

```yaml
pre_start: "redis-server --daemonize yes"
```

List format (items join with &&):

```yaml
pre_start:
  - "redis-server --daemonize yes"
  - "sleep 2"
  - "echo 'Ready'"
```

#### harness_args

Default arguments for harnesses, prepended to CLI args.

```yaml
harness_args:
  claude:
    - "--plugin"
    - "context7"
    - "--model"
    - "sonnet"
  opencode:
    - "--provider"
    - "anthropic"
```

Argument order: [global defaults] + [project defaults] + [CLI args].

#### gitleaks_freshness_check

Boolean (default: true). Warns before container launch if the Gitleaks scan is older than 7 days. Advisory only; never blocks.

```yaml
gitleaks_freshness_check: false
```

#### detection

Configure sensitive file detection.

```yaml
detection:
  enabled: true                       # Global toggle (default: true)

  custom_patterns:                    # Add project-specific patterns
    "*.secret":
      severity: high
      reason: "Project secret file"
    "*.key": high                     # Shorthand

  allowlist:                          # Suppress false positives
    - path: ".env.test"
      reason: "Test template, no secrets"
    - path: "test/fixtures/*.key"
      reason: "Test fixture keys"
```

Severities: high (requires confirmation), medium (warning), low (notice).

Default detected patterns include: .env*, *.pem, *.key, gcloud-credentials.json, .aws/credentials, SSH private keys, and more.

### Project Extension (Dockerfile)

Create `.aishell/Dockerfile` to extend the foundation image:

```dockerfile
FROM aishell:foundation
RUN apt-get update && apt-get install -y postgresql-client \
    && rm -rf /var/lib/apt/lists/*
```

Builds automatically before container launch. Rebuilds only when Dockerfile content changes.

---

## Environment Variables

aishell passes these to containers when set on the host:

### Harness Authentication

- `ANTHROPIC_API_KEY` - Claude Code API access
- `OPENAI_API_KEY` - Codex CLI login, OpenCode
- `CODEX_API_KEY` - Codex CLI (exec mode only)
- `GEMINI_API_KEY` - Gemini CLI
- `GOOGLE_API_KEY` - Gemini / Vertex AI
- `GROQ_API_KEY` - Groq API

### Cloud Providers

- `GOOGLE_APPLICATION_CREDENTIALS` - Vertex AI service account (path to JSON key file)
- `GOOGLE_CLOUD_PROJECT` - GCP project ID
- `GOOGLE_CLOUD_LOCATION` - GCP region
- `AWS_ACCESS_KEY_ID` - AWS access key
- `AWS_SECRET_ACCESS_KEY` - AWS secret key
- `AWS_REGION` - AWS region
- `AWS_PROFILE` - AWS named profile
- `AZURE_OPENAI_API_KEY` - Azure OpenAI
- `AZURE_OPENAI_ENDPOINT` - Azure OpenAI endpoint

### Other

- `GITHUB_TOKEN` - GitHub API access
- `AISHELL_SKIP_PERMISSIONS` - Set to "false" to re-enable Claude Code permission prompts (default: permissions are skipped)
- `NO_COLOR` - Disable colored output

---

## Authentication

Each harness authenticates differently:

### Claude Code

- **OAuth (recommended):** Run `aishell claude` and follow prompts. Uses a copy-paste URL flow that works in containers.
- **API key:** Set `ANTHROPIC_API_KEY`.

### OpenCode

- Set the relevant API key for your provider (ANTHROPIC_API_KEY, OPENAI_API_KEY, GOOGLE_API_KEY, etc.).
- Config directories (`~/.config/opencode`, `~/.local/share/opencode`) mount from the host.

### Codex CLI

- **OAuth:** Run `aishell codex`. For containers, use `codex login --device-auth` (displays a code to enter at a URL).
- **API key:** Set `OPENAI_API_KEY` for interactive mode, or `CODEX_API_KEY` for `codex exec` only.

### Gemini CLI

- **OAuth:** Authenticate on the host first (`gemini login`), then run `aishell gemini`. Gemini CLI lacks device code flow in containers.
- **API key:** Set `GEMINI_API_KEY` or `GOOGLE_API_KEY`.

Harness config directories (`~/.claude`, `~/.codex`, `~/.gemini`, `~/.config/opencode`) mount from the host, so authentication persists between sessions.

---

## Security

Three security layers run before container launch:

### 1. Sensitive File Detection

Scans the project for files matching known sensitive patterns:

- **High** (SSH keys, private keys, cloud credentials, package tokens) — requires confirmation.
- **Medium** (environment files, tool configs) — warning.
- **Low** (template files like .env.example) — notice.

Bypass with `--unsafe`. Customize with `detection` config key. Allowlist false positives.

### 2. Gitleaks Integration

Content-based secret scanning. Run manually:

```
aishell gitleaks detect
aishell gitleaks detect --verbose --no-git
```

Tracks last scan timestamp per project. Warns when scans exceed 7 days old (advisory; never blocks). Disable with `gitleaks_freshness_check: false`.

### 3. Configuration Validation

Warns about dangerous `docker_args` (--privileged, --network=host, --cap-add=ALL, etc.) and dangerous mount paths (/etc, /var/run/docker.sock).

---

## Container Naming and Lifecycle

Containers are named `aishell-{project-hash}-{name}` where:
- `project-hash` — 8-char SHA-256 prefix of the project directory path.
- `name` — the harness name or a custom name from `--name`.

This isolates projects from each other and allows multiple instances per project.

Conflict handling:
- Same name already running — aishell shows an error with guidance.
- Same name stopped — aishell removes it and proceeds.

---

## Multi-Container Workflow

Run multiple containers and reconnect later:

```
aishell claude --name reviewer             # Start in one terminal
aishell claude --name feature-work         # Start in another terminal
aishell ps                                 # List project containers
aishell attach reviewer                    # Open shell in running container
docker stop aishell-<hash>-reviewer        # Stop container
```

---

## Foundation Image Contents

Built on debian:bookworm-slim:

- **Runtimes:** Node.js 24 (npm, npx), Babashka
- **Security:** Gitleaks v8.30.0 (optional)
- **Tools:** git, curl, jq, ripgrep, vim, tree, less, file, unzip, watch, htop, sqlite3, sudo
- **User switching:** gosu (matches host UID/GID)
- **Harness tools** are in a separate volume at `/tools`, not in the image

---

## State and Files

### Host Files

- `~/.aishell/state.edn` - Build state (harnesses, versions, image tags, volume names, timestamps). EDN format.
- `~/.aishell/config.yaml` - Global configuration.
- `~/.aishell/gitleaks-scan.edn` - Per-project Gitleaks scan timestamps.
- `.aishell/config.yaml` - Project-specific configuration.
- `.aishell/Dockerfile` - Optional project extension Dockerfile.

### Volume Architecture

Foundation image and harness tools are separate:

- **Foundation image** (`aishell:foundation`) — Stable system tools. Rebuilds only on Dockerfile changes or `aishell update --force`.
- **Harness volume** (`aishell-harness-{hash}`) — npm packages and binaries at `/tools`, mounted read-only. Recreated by `aishell update`. The hash derives from enabled harnesses and versions; projects with identical harness configs share a volume.

---

## Common Workflows

### First-time setup and use

```
aishell setup --with-claude
aishell claude
```

### Multiple harnesses

```
aishell setup --with-claude --with-opencode --with-codex --with-gemini
aishell claude
aishell opencode
```

### Multiple containers

```
aishell claude --name feature-work         # Terminal 1
aishell claude --name code-review          # Terminal 2
aishell ps                                 # List running containers
aishell attach feature-work                # Open shell in container
```

### Project-specific configuration

Create `.aishell/config.yaml`:

```yaml
mounts:
  - ~/.gitconfig
env:
  DATABASE_URL: "postgres://localhost/mydb"
ports:
  - "3000:3000"
pre_start: "redis-server --daemonize yes"
harness_args:
  claude:
    - "--plugin"
    - "context7"
```

### Project-specific system dependencies

Create `.aishell/Dockerfile`:

```dockerfile
FROM aishell:foundation
RUN apt-get update && apt-get install -y python3 postgresql-client \
    && rm -rf /var/lib/apt/lists/*
```

### Update harness tools

```
aishell update                    # Fast: recreate volume only
aishell update --force            # Also rebuild foundation image
```

### Validate everything

```
aishell check
```

### Secret scanning

```
aishell gitleaks detect --verbose
```

---

## Troubleshooting

### "No previous setup found"

Run `aishell setup --with-claude` (or your preferred harness).

### "Claude Code not installed" (or other harness)

Setup did not include this harness. Run `aishell setup --with-claude`.

### "Docker is not installed" or "Cannot connect to Docker daemon"

Install Docker and start the daemon. Your user must belong to the docker group or use sudo.

### Container exits immediately

Check `pre_start` in config.yaml. Test the command manually with `aishell` (interactive shell). View container logs with `docker logs <container-id>`.

### Files not found inside container

Verify mount paths in config.yaml are absolute and exist on the host.

### Harness command not found inside container

Run `aishell update` to recreate the harness volume. Verify PATH includes `/tools/npm/bin` and `/tools/bin`.

### Git safe.directory warnings

aishell handles this automatically. If you mount your host `~/.gitconfig`, the safe.directory entry writes to the host file. To prevent this, omit the `~/.gitconfig` mount.

### Credentials not persisting between sessions

Verify harness config directories exist on the host (`~/.claude`, `~/.codex`, `~/.gemini`, `~/.config/opencode`).

### Port not accessible from host

Add port mapping in config.yaml under `ports`. Verify the host port is free.

---

## Exit Codes

- 0 - Success
- 1 - Error
